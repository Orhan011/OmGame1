// MelodiX - Sesli HafÄ±za Oyunu JavaScript

// Ses Ã¶ÄŸelerini yÃ¼kle
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
const notes = {
  do: 261.63, // C4
  re: 293.66, // D4
  mi: 329.63, // E4
  fa: 349.23, // F4
  sol: 392.00, // G4
  la: 440.00, // A4
  si: 493.88, // B4
  do2: 523.25, // C5
  re2: 587.33, // D5
  mi2: 659.25, // E5
  fa2: 698.46, // F5
  sol2: 783.99, // G5
  la2: 880.00, // A5
  si2: 987.77, // B5
  do3: 1046.50, // C6
  re3: 1174.66  // D6
};

// DOM Ã¶ÄŸeleri
const soundPads = document.querySelectorAll('.sound-pad');
const startBtn = document.getElementById('start-btn');
const resetBtn = document.getElementById('reset-btn');
const levelCount = document.getElementById('level-count');
const scoreCount = document.getElementById('score-count');
const statusMessage = document.getElementById('status-message');
const progressBar = document.getElementById('progress-bar');
const levelUpModal = document.getElementById('level-up-modal');
const newLevelSpan = document.getElementById('new-level');
const continueBtn = document.getElementById('continue-btn');
// Mode buttons removed

// Oyun deÄŸiÅŸkenleri
let gamePattern = [];
let playerPattern = [];
let level = 1;
let score = 0;
let gameStarted = false;
let playerTurn = false;
let currentMode = 'classic';
let currentDifficulty = 'easy';
let visiblePads = 4; // BaÅŸlangÄ±Ã§ta gÃ¶rÃ¼nÃ¼r pad sayÄ±sÄ±
let complexityFactor = 1; // Melodilerin karmaÅŸÄ±klÄ±k faktÃ¶rÃ¼

// Renkleri ayarla
soundPads.forEach(pad => {
  pad.style.backgroundColor = pad.getAttribute('data-color');
});

// Zorluk butonlarÄ±nÄ± ayarla
const difficultyBtns = document.querySelectorAll('.difficulty-btn');
difficultyBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    // Aktif sÄ±nÄ±fÄ± kaldÄ±r
    difficultyBtns.forEach(b => b.classList.remove('active'));
    
    // Yeni seÃ§ilen zorluk dÃ¼zeyini aktif yap
    btn.classList.add('active');
    
    // Zorluk deÄŸiÅŸkenini ayarla
    currentDifficulty = btn.getAttribute('data-difficulty');
    
    // Zorluk seviyesine gÃ¶re gÃ¶rÃ¼nÃ¼r pad sayÄ±sÄ±nÄ± ayarla
    switch (currentDifficulty) {
      case 'easy':
        visiblePads = 4;
        complexityFactor = 1;
        break;
      case 'medium':
        visiblePads = 6;
        complexityFactor = 2;
        break;
      case 'hard':
        visiblePads = 9;
        complexityFactor = 3;
        break;
    }
    
    // GÃ¶rÃ¼nÃ¼r padleri gÃ¼ncelle
    updateVisiblePads();
    
    // EÄŸer oyun baÅŸlamÄ±ÅŸsa, yeni oyun baÅŸlat
    if (gameStarted) {
      resetGame();
      startLevel();
    }
  });
});

// BaÅŸlangÄ±Ã§ta padleri ayarla
updateVisiblePads();

// Olay dinleyicileri
startBtn.addEventListener('click', () => {
  if (!gameStarted) {
    startGame();
  }
});

resetBtn.addEventListener('click', () => {
  resetGame();
});

continueBtn.addEventListener('click', () => {
  levelUpModal.style.display = 'none';
  setTimeout(() => {
    startLevel();
  }, 500);
});

soundPads.forEach((pad, index) => {
  pad.addEventListener('click', () => {
    if (playerTurn && pad.style.display !== 'none') {
      const note = pad.getAttribute('data-note');
      playSound(note);
      animatePad(pad);
      
      // ParÃ§acÄ±k efekti oluÅŸtur
      createParticles(pad);
      
      checkAnswer(index);
    }
  });
});

// Ses Ã§alma
function playSound(note, duration = 0.5) {
  // Ses kaynaÄŸÄ± oluÅŸtur
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  // SinÃ¼s dalgasÄ±
  oscillator.type = 'sine';
  oscillator.frequency.value = notes[note];
  
  // Fade in/out iÃ§in
  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
  gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);
  
  // BaÄŸlantÄ±larÄ± yap
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  // BaÅŸlat ve durdur
  oscillator.start();
  oscillator.stop(audioContext.currentTime + duration);
}

// YastÄ±k animasyonu
function animatePad(pad) {
  // Aktif sÄ±nÄ±fÄ±nÄ± ekle
  pad.classList.add('active');
  
  // Animasyon sÃ¼resi sonunda kaldÄ±r
  setTimeout(() => {
    pad.classList.remove('active');
  }, 300);
  
  // TitreÅŸim efekti
  if ('vibrate' in navigator) {
    navigator.vibrate(50);
  }
}

// ParÃ§acÄ±k efekti
function createParticles(element) {
  const rect = element.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  
  for (let i = 0; i < 10; i++) {
    const particle = document.createElement('div');
    const size = Math.random() * 8 + 5;
    
    particle.style.position = 'fixed';
    particle.style.width = `${size}px`;
    particle.style.height = `${size}px`;
    particle.style.backgroundColor = element.getAttribute('data-color');
    particle.style.borderRadius = '50%';
    particle.style.pointerEvents = 'none';
    particle.style.left = `${centerX}px`;
    particle.style.top = `${centerY}px`;
    particle.style.opacity = '1';
    particle.style.zIndex = '100';
    
    document.body.appendChild(particle);
    
    const angle = Math.random() * Math.PI * 2;
    const velocity = Math.random() * 10 + 10;
    const vx = Math.cos(angle) * velocity;
    const vy = Math.sin(angle) * velocity;
    
    let posX = centerX;
    let posY = centerY;
    
    const animate = () => {
      posX += vx;
      posY += vy;
      
      particle.style.left = `${posX}px`;
      particle.style.top = `${posY}px`;
      particle.style.opacity = parseFloat(particle.style.opacity) - 0.02;
      
      if (parseFloat(particle.style.opacity) > 0) {
        requestAnimationFrame(animate);
      } else {
        particle.remove();
      }
    };
    
    requestAnimationFrame(animate);
  }
}

// Oyunu baÅŸlat
function startGame() {
  gameStarted = true;
  score = 0;
  level = 1;
  scoreCount.textContent = score;
  levelCount.textContent = level;
  startBtn.textContent = 'Oyun BaÅŸladÄ±';
  updateStatusMessage('Dikkatlice dinle ve sÄ±rayÄ± hatÄ±rla!');
  
  // Padleri hazÄ±rla
  updateVisiblePads();
  
  // Ä°lk seviyeyi baÅŸlat
  startLevel();
}

// Oyunu sÄ±fÄ±rla
function resetGame() {
  gameStarted = false;
  playerTurn = false;
  gamePattern = [];
  playerPattern = [];
  score = 0;
  level = 1;
  scoreCount.textContent = score;
  levelCount.textContent = level;
  startBtn.textContent = 'BaÅŸla';
  updateStatusMessage('BaÅŸlamak iÃ§in "BaÅŸla" butonuna basÄ±n');
}

// Zorluk seviyesine gÃ¶re gÃ¶rÃ¼nÃ¼r padleri gÃ¼ncelle
function updateVisiblePads() {
  soundPads.forEach((pad, index) => {
    if (index < visiblePads) {
      pad.style.display = 'block';
    } else {
      pad.style.display = 'none';
    }
  });
}

// Seviyeyi baÅŸlat
function startLevel() {
  playerTurn = false;
  playerPattern = [];
  updateStatusMessage(`Seviye ${level}: SÄ±rayÄ± dinle`);
  
  // Seviyeye gÃ¶re zorluk artÄ±ÅŸÄ±
  if (level > 5 && currentDifficulty === 'easy') {
    setDifficulty('medium');
  } else if (level > 10 && currentDifficulty === 'medium') {
    setDifficulty('hard');
  }
  
  // Yeni desen oluÅŸtur
  generateComplexPattern();
  
  // Ä°lerleme Ã§ubuÄŸunu gÃ¶ster
  updateProgressBar(0);
  
  // KÄ±sa bir gecikme sonra deseni Ã§al
  setTimeout(playGamePattern, 1000);
}

// Kompleks desen oluÅŸtur
function generateComplexPattern() {
  // Ã–nceki desenin uzunluÄŸunu koru
  const patternLength = gamePattern.length;
  
  // Her seviyede bir not ekle
  if (currentDifficulty === 'easy' || gamePattern.length === 0) {
    // Kolay mod: her seviyede yalnÄ±zca bir yeni not ekle
    const randomPadIndex = Math.floor(Math.random() * visiblePads);
    gamePattern.push(randomPadIndex);
  } else {
    // Orta ve zor mod: daha karmaÅŸÄ±k desenler oluÅŸtur
    // Ã–nceki deseni belli bir olasÄ±lÄ±kla deÄŸiÅŸtir
    if (Math.random() < 0.3 * complexityFactor && gamePattern.length > 2) {
      // Ã–nceki desende rastgele bir pozisyonu deÄŸiÅŸtir
      const changeIndex = Math.floor(Math.random() * gamePattern.length);
      gamePattern[changeIndex] = Math.floor(Math.random() * visiblePads);
    }
    
    // Yeni bir not ekle
    const randomPadIndex = Math.floor(Math.random() * visiblePads);
    gamePattern.push(randomPadIndex);
    
    // Zor modda tekrarlanan veya ardÄ±ÅŸÄ±k notlar olabilir
    if (currentDifficulty === 'hard' && Math.random() < 0.4) {
      // Son notu tekrarla veya benzer bir not ekle
      if (Math.random() < 0.5) {
        gamePattern.push(randomPadIndex); // AynÄ± notu tekrarla
      } else {
        // YakÄ±n bir not ekle (bir yukarÄ± veya aÅŸaÄŸÄ±)
        let adjacentNote = randomPadIndex + (Math.random() < 0.5 ? 1 : -1);
        adjacentNote = Math.max(0, Math.min(adjacentNote, visiblePads - 1));
        gamePattern.push(adjacentNote);
      }
    }
  }
  
  console.log('Desen:', gamePattern);
}

// Oyun desenini Ã§al
function playGamePattern() {
  let i = 0;
  const playNext = () => {
    if (i < gamePattern.length) {
      const padIndex = gamePattern[i];
      const pad = soundPads[padIndex];
      const note = pad.getAttribute('data-note');
      
      // Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
      updateProgressBar((i + 1) / gamePattern.length * 100);
      
      // Sesi Ã§al ve animasyonu gÃ¶ster
      playSound(note);
      animatePad(pad);
      
      i++;
      
      // Zorluk seviyesine gÃ¶re hÄ±zÄ± ayarla
      let speed;
      switch (currentDifficulty) {
        case 'easy': speed = 1000; break;
        case 'medium': speed = 800; break;
        case 'hard': speed = 600; break;
        default: speed = 1000;
      }
      
      // Desen hÄ±zÄ±nÄ± seviyeye gÃ¶re artÄ±r (belirli bir limite kadar)
      const levelFactor = Math.max(0.6, 1 - (level * 0.02));
      speed = Math.max(400, speed * levelFactor);
      
      setTimeout(playNext, speed);
    } else {
      // Desen tamamlanÄ±nca oyuncunun sÄ±rasÄ±nÄ± baÅŸlat
      setTimeout(() => {
        playerTurn = true;
        updateStatusMessage('Åimdi senin sÄ±ran! SÄ±rayÄ± tekrarla.');
      }, 500);
    }
  };
  
  playNext();
}

// Oyuncunun cevabÄ±nÄ± kontrol et
function checkAnswer(index) {
  playerPattern.push(index);
  
  // Åimdiye kadarki girdileri kontrol et
  const currentStep = playerPattern.length - 1;
  
  if (playerPattern[currentStep] === gamePattern[currentStep]) {
    // DoÄŸru! Devam et.
    
    // Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
    updateProgressBar(playerPattern.length / gamePattern.length * 100);
    
    // Desen tamamlandÄ± mÄ±?
    if (playerPattern.length === gamePattern.length) {
      // Oyuncu baÅŸarÄ±lÄ±!
      playerTurn = false;
      
      // Skoru ve seviyeyi gÃ¼ncelle
      score += level * 10 * complexityFactor;
      scoreCount.textContent = score;
      
      // Seviye atladÄ±
      level++;
      levelCount.textContent = level;
      
      // Seviye atlama animasyonu
      setTimeout(() => {
        levelUp();
      }, 500);
    }
  } else {
    // YanlÄ±ÅŸ! Oyun bitti.
    gameOver();
  }
}

// Oyun sonu
function gameOver() {
  playerTurn = false;
  gameStarted = false;
  updateStatusMessage('Oyun bitti! Tekrar denemek iÃ§in "BaÅŸla" butonuna basÄ±n.');

  // Patlama efekti
  soundPads.forEach(pad => {
    setTimeout(() => {
      animatePad(pad);
    }, Math.random() * 500);
  });

  // Skoru kaydet
  saveScore();

  startBtn.textContent = 'Tekrar BaÅŸla';
}

// Skoru sunucuya gÃ¶nderme
function saveScore() {
  // Skor 0 ise kaydetmeye gerek yok
  if (score <= 0) {
    console.log('Kaydedilecek skor yok');
    return;
  }
  
  console.log(`Skor gÃ¶nderiliyor: ${score}`);
  
  // Backend'e skoru gÃ¶nder
  fetch('/api/save-score', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      game_type: 'audio_memory',
      score: score
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP hata! Durum: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Skor baÅŸarÄ±yla kaydedildi:', data);
    
    if (data.success && data.achievement) {
      // BaÅŸarÄ± bildirimi gÃ¶ster
      const notification = document.createElement('div');
      notification.className = 'achievement-notification';
      notification.textContent = `ğŸ† BaÅŸarÄ±: ${data.achievement.title}`;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.padding = '15px';
      notification.style.background = 'linear-gradient(135deg, rgba(106, 90, 224, 0.9), rgba(90, 55, 200, 0.9))';
      notification.style.color = 'white';
      notification.style.borderRadius = '10px';
      notification.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.2)';
      notification.style.zIndex = '1000';
      notification.style.transform = 'translateX(120%)';
      notification.style.transition = 'transform 0.3s ease-in-out';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        setTimeout(() => {
          notification.style.transform = 'translateX(120%)';
          setTimeout(() => {
            notification.remove();
          }, 500);
        }, 3000);
      }, 100);
    }
  })
  .catch(error => {
    console.error('Skor gÃ¶nderme hatasÄ±:', error);
  });
}

// Durum mesajÄ±nÄ± gÃ¼ncelle
function updateStatusMessage(message) {
  statusMessage.textContent = message;
}

// Ä°lerleme Ã§ubuÄŸunu gÃ¼ncelle
function updateProgressBar(percent) {
  progressBar.style.width = `${percent}%`;
}

// Seviye atladÄ±
function levelUp() {
  // Seviye atlama modalÄ±nÄ± gÃ¶ster
  newLevelSpan.textContent = level;
  levelUpModal.style.display = 'flex';
  
  // Konfeti efekti
  createConfetti();
}

// Konfeti efekti
function createConfetti() {
  const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];
  
  for (let i = 0; i < 100; i++) {
    const confetti = document.createElement('div');
    const size = Math.random() * 10 + 5;
    const color = colors[Math.floor(Math.random() * colors.length)];
    
    confetti.style.position = 'fixed';
    confetti.style.width = `${size}px`;
    confetti.style.height = `${size}px`;
    confetti.style.backgroundColor = color;
    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
    confetti.style.pointerEvents = 'none';
    confetti.style.left = `${Math.random() * 100}vw`;
    confetti.style.top = '-10px';
    confetti.style.opacity = '1';
    confetti.style.zIndex = '90';
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
    
    document.body.appendChild(confetti);
    
    const delay = Math.random() * 3;
    const duration = Math.random() * 3 + 2;
    
    confetti.animate([
      { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
      { transform: `translateY(${Math.random() * 70 + 30}vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
    ], {
      duration: duration * 1000,
      delay: delay * 1000,
      fill: 'forwards'
    });
    
    setTimeout(() => {
      confetti.remove();
    }, (delay + duration) * 1000);
  }
}

// Zorluk seviyesini ayarla
function setDifficulty(difficulty) {
  // Aktif dÃ¼ÄŸmeyi gÃ¼ncelle
  difficultyBtns.forEach(btn => {
    if (btn.getAttribute('data-difficulty') === difficulty) {
      btn.click();
    }
  });
}

// Sayfa yÃ¼klendikten sonra baÅŸlangÄ±Ã§ iÅŸlemleri
document.addEventListener('DOMContentLoaded', () => {
  updateStatusMessage('BaÅŸlamak iÃ§in "BaÅŸla" butonuna basÄ±n');
  updateProgressBar(0);
  updateVisiblePads();
});
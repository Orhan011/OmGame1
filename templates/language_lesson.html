{% extends "layout.html" %}

{% block content %}
<div class="container language-lesson-container">
  <div class="lesson-header">
    <a href="{{ url_for('language_learning') }}" class="back-btn">
      <i class="fas fa-arrow-left"></i> Geri
    </a>
    <div class="lesson-title-container">
      <h1>{{ lesson.title }}</h1>
      <p>{{ lesson.description }}</p>
    </div>
    <div class="progress-indicator">
      <div class="hearts">
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
        <i class="fas fa-heart"></i>
        <span>3</span>
      </div>
    </div>
  </div>
  
  <div class="lesson-content">
    {% if lesson.exercises %}
      <div class="exercise-container" id="exercise-container">
        <!-- Burada egzersizler dinamik olarak gösterilecek -->
      </div>
      
      <div class="lesson-navigation">
        <button id="check-answer-btn" class="action-btn check-btn disabled">Kontrol Et</button>
        <button id="continue-btn" class="action-btn continue-btn" style="display: none;">Devam Et</button>
      </div>
      
      <div class="progress-bar-container">
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%;" id="lesson-progress-bar"></div>
        </div>
        <div class="progress-text">
          <span id="current-exercise">1</span> / <span id="total-exercises">{{ lesson.exercises|length }}</span>
        </div>
      </div>
    {% else %}
      <div class="no-exercises">
        <i class="fas fa-tools"></i>
        <h2>Bu ders henüz hazırlanıyor</h2>
        <p>Çok yakında burada interaktif egzersizler olacak.</p>
        <a href="{{ url_for('language_learning') }}" class="back-link">Derslere Dön</a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Ders verileri
    const lessonData = {{ lesson|tojson|safe }};
    const exercises = lessonData.exercises;
    let currentExerciseIndex = 0;
    let correctAnswers = 0;
    let userChoices = null;
    
    const exerciseContainer = document.getElementById('exercise-container');
    const checkBtn = document.getElementById('check-answer-btn');
    const continueBtn = document.getElementById('continue-btn');
    const progressBar = document.getElementById('lesson-progress-bar');
    const currentExerciseEl = document.getElementById('current-exercise');
    
    // Eğer egzersiz yoksa erken çık
    if (!exercises || exercises.length === 0) return;
    
    // İlk egzersizi göster
    showExercise(currentExerciseIndex);
    
    // Kontrol Et butonuna tıklama olay dinleyicisi
    if (checkBtn) {
      checkBtn.addEventListener('click', function() {
        if (checkBtn.classList.contains('disabled')) return;
        
        // Kullanıcının cevabını kontrol et
        checkAnswer();
      });
    }
    
    // Devam Et butonuna tıklama olay dinleyicisi
    if (continueBtn) {
      continueBtn.addEventListener('click', function() {
        currentExerciseIndex++;
        
        if (currentExerciseIndex < exercises.length) {
          // Sonraki egzersizi göster
          showExercise(currentExerciseIndex);
          // İlerleme çubuğunu güncelle
          updateProgressBar();
          
          continueBtn.style.display = 'none';
          checkBtn.style.display = 'block';
          checkBtn.classList.add('disabled');
        } else {
          // Dersi tamamla
          showLessonComplete();
        }
      });
    }
    
    // Egzersizi görüntüle
    function showExercise(index) {
      if (!exerciseContainer) return;
      
      const exercise = exercises[index];
      
      // Mevcut egzersiz numarasını güncelle
      if (currentExerciseEl) {
        currentExerciseEl.textContent = index + 1;
      }
      
      let html = '';
      
      // Egzersiz tipine göre HTML oluştur
      if (exercise.type === 'translation') {
        html = `
          <div class="exercise translation-exercise">
            <div class="exercise-prompt">
              <h2>"${exercise.question}" ne demek?</h2>
            </div>
            <div class="options-container">
              ${exercise.options.map((option, i) => `
                <div class="option" data-index="${i}">
                  <span>${option}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if (exercise.type === 'multiple_choice') {
        html = `
          <div class="exercise multiple-choice-exercise">
            <div class="exercise-prompt">
              <h2>${exercise.question}</h2>
            </div>
            <div class="options-container">
              ${exercise.options.map((option, i) => `
                <div class="option" data-index="${i}">
                  <span>${option}</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if (exercise.type === 'matching') {
        html = `
          <div class="exercise matching-exercise">
            <div class="exercise-prompt">
              <h2>Eşleştirmeleri doğru şekilde yapın</h2>
            </div>
            <div class="matching-container">
              <div class="matching-pairs">
                ${exercise.pairs.map((pair, i) => `
                  <div class="matching-pair">
                    <div class="native-term" data-index="${i}">${pair.native}</div>
                    <div class="foreign-term unmatched" data-index="${i}">${pair.foreign}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }
      
      // HTML'i sayfaya ekle
      exerciseContainer.innerHTML = html;
      
      // Egzersiz tipine göre olay dinleyicileri ekle
      if (exercise.type === 'translation' || exercise.type === 'multiple_choice') {
        const options = document.querySelectorAll('.option');
        
        options.forEach(option => {
          option.addEventListener('click', function() {
            // Önceden seçilmiş seçeneği temizle
            document.querySelectorAll('.option.selected').forEach(el => {
              el.classList.remove('selected');
            });
            
            // Bu seçeneği seçili olarak işaretle
            this.classList.add('selected');
            
            // Kontrol butonunu aktifleştir
            if (checkBtn) {
              checkBtn.classList.remove('disabled');
            }
            
            // Kullanıcı seçimini kaydet
            userChoices = parseInt(this.getAttribute('data-index'));
          });
        });
      } else if (exercise.type === 'matching') {
        // Matching egzersizleri için işaretleme sistemi eklenecek
        // Basitlik için şimdilik bir yöntem ekleyeceğiz
        const matchingTerms = document.querySelectorAll('.foreign-term');
        
        matchingTerms.forEach(term => {
          term.addEventListener('click', function() {
            // Bu terimi seçili yap 
            if (!this.classList.contains('selected')) {
              document.querySelectorAll('.foreign-term.selected').forEach(el => {
                el.classList.remove('selected');
              });
              this.classList.add('selected');
            } else {
              this.classList.remove('selected');
            }
            
            // Tüm terimler eşleştirildiğinde kontrol butonunu aktifleştir
            const allMatched = document.querySelectorAll('.foreign-term.matched').length === exercise.pairs.length;
            if (allMatched && checkBtn) {
              checkBtn.classList.remove('disabled');
              userChoices = true;
            }
          });
        });
        
        // Basitleştirilmiş eşleştirme - gerçek uygulamada sürükle bırak kullanılabilir
        const nativeTerms = document.querySelectorAll('.native-term');
        
        nativeTerms.forEach(term => {
          term.addEventListener('click', function() {
            const selectedForeign = document.querySelector('.foreign-term.selected');
            
            if (selectedForeign) {
              const nativeIndex = parseInt(this.getAttribute('data-index'));
              const foreignIndex = parseInt(selectedForeign.getAttribute('data-index'));
              
              // Doğru eşleştirme yapıldıysa
              if (nativeIndex === foreignIndex) {
                selectedForeign.classList.remove('selected', 'unmatched');
                selectedForeign.classList.add('matched');
                this.classList.add('matched');
              } else {
                // Yanlış eşleştirme - görsel geri bildirim
                term.classList.add('error');
                selectedForeign.classList.add('error');
                
                setTimeout(() => {
                  term.classList.remove('error');
                  selectedForeign.classList.remove('error', 'selected');
                }, 800);
              }
              
              // Tüm terimler eşleştirildiğinde kontrol butonunu aktifleştir
              const allMatched = document.querySelectorAll('.foreign-term.matched').length === exercise.pairs.length;
              if (allMatched && checkBtn) {
                checkBtn.classList.remove('disabled');
                userChoices = true;
              }
            }
          });
        });
      }
    }
    
    // Kullanıcının cevabını kontrol et
    function checkAnswer() {
      const exercise = exercises[currentExerciseIndex];
      let isCorrect = false;
      
      if (exercise.type === 'translation' || exercise.type === 'multiple_choice') {
        const selectedOption = document.querySelector('.option.selected');
        if (!selectedOption) return;
        
        const selectedIndex = parseInt(selectedOption.getAttribute('data-index'));
        isCorrect = exercise.options[selectedIndex] === exercise.correct;
        
        // Görsel geri bildirim
        if (isCorrect) {
          selectedOption.classList.add('correct');
          correctAnswers++;
        } else {
          selectedOption.classList.add('incorrect');
          
          // Doğru cevabı göster
          const correctIndex = exercise.options.indexOf(exercise.correct);
          const options = document.querySelectorAll('.option');
          if (options[correctIndex]) {
            options[correctIndex].classList.add('correct');
          }
        }
      } else if (exercise.type === 'matching') {
        // Tüm eşleştirmeler tamamlandıysa, zaten doğru kabul edilir
        isCorrect = true;
        correctAnswers++;
      }
      
      // Kontrol butonunu gizle, devam butonunu göster
      if (checkBtn) checkBtn.style.display = 'none';
      if (continueBtn) continueBtn.style.display = 'block';
    }
    
    // İlerleme çubuğunu güncelle
    function updateProgressBar() {
      if (!progressBar) return;
      
      const progress = ((currentExerciseIndex + 1) / exercises.length) * 100;
      progressBar.style.width = `${progress}%`;
    }
    
    // Ders tamamlandı ekranını göster
    function showLessonComplete() {
      if (!exerciseContainer) return;
      
      const accuracy = Math.floor((correctAnswers / exercises.length) * 100);
      
      exerciseContainer.innerHTML = `
        <div class="lesson-complete">
          <div class="lesson-complete-header">
            <i class="fas fa-trophy"></i>
            <h2>Tebrikler! Dersi tamamladınız.</h2>
          </div>
          <div class="lesson-results">
            <div class="result-item">
              <span class="result-label">Doğruluk:</span>
              <span class="result-value">${accuracy}%</span>
            </div>
            <div class="result-item">
              <span class="result-label">Doğru Cevaplar:</span>
              <span class="result-value">${correctAnswers} / ${exercises.length}</span>
            </div>
            <div class="result-item">
              <span class="result-label">Kazanılan XP:</span>
              <span class="result-value">+${Math.max(5, correctAnswers * 5)} XP</span>
            </div>
          </div>
          <div class="lesson-complete-actions">
            <a href="{{ url_for('language_learning') }}" class="action-btn back-to-lessons">Derslere Dön</a>
            <a href="/games/language-learning/lesson/{{ lesson_id }}?lang={{ selected_language }}" class="action-btn retry-lesson">Dersi Tekrarla</a>
          </div>
        </div>
      `;
      
      // Navigasyon butonlarını gizle
      const navigation = document.querySelector('.lesson-navigation');
      if (navigation) {
        navigation.style.display = 'none';
      }
    }
    
    // İlk ilerleme çubuğu güncellemesi
    updateProgressBar();
  });
</script>
{% endblock %}

{% block extra_css %}
<style>
  .language-lesson-container {
    padding-bottom: 60px;
  }
  
  /* Ders başlığı */
  .lesson-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 30px;
    padding: 20px 30px;
    background: linear-gradient(135deg, #2c3e50, #1a1a2e);
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  
  .back-btn {
    color: white;
    text-decoration: none;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    padding: 8px 15px;
    border-radius: 50px;
    background: rgba(255, 255, 255, 0.1);
  }
  
  .back-btn i {
    margin-right: 8px;
  }
  
  .back-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(-5px);
  }
  
  .lesson-title-container {
    text-align: center;
  }
  
  .lesson-title-container h1 {
    color: white;
    font-size: 1.8rem;
    margin-bottom: 5px;
  }
  
  .lesson-title-container p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
  }
  
  .hearts {
    display: flex;
    align-items: center;
    color: #e74c3c;
    font-size: 1.3rem;
  }
  
  .hearts i {
    margin-right: 5px;
  }
  
  .hearts span {
    margin-left: 5px;
    color: white;
    font-weight: 600;
  }
  
  /* Ders içeriği */
  .lesson-content {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    padding: 30px;
    min-height: 400px;
    position: relative;
  }
  
  /* Egzersiz stilleri */
  .exercise {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .exercise-prompt {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .exercise-prompt h2 {
    font-size: 1.8rem;
    color: #2c3e50;
    margin-bottom: 10px;
  }
  
  /* Seçenek stilleri */
  .options-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    width: 100%;
  }
  
  .option {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .option:hover {
    border-color: #6a5ae0;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  }
  
  .option.selected {
    border-color: #6a5ae0;
    background: rgba(106, 90, 224, 0.05);
  }
  
  .option.correct {
    border-color: #2ecc71;
    background: rgba(46, 204, 113, 0.1);
  }
  
  .option.incorrect {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
  }
  
  .option span {
    font-size: 1.1rem;
    color: #2c3e50;
    font-weight: 500;
  }
  
  /* Eşleştirme egzersizi stilleri */
  .matching-container {
    width: 100%;
  }
  
  .matching-pairs {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  
  .matching-pair {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .native-term, .foreign-term {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 45%;
    text-align: center;
    font-size: 1.1rem;
    color: #2c3e50;
  }
  
  .native-term:hover, .foreign-term:hover {
    border-color: #6a5ae0;
    transform: translateY(-3px);
  }
  
  .foreign-term.selected {
    border-color: #6a5ae0;
    background: rgba(106, 90, 224, 0.05);
  }
  
  .native-term.matched, .foreign-term.matched {
    border-color: #2ecc71;
    background: rgba(46, 204, 113, 0.1);
    cursor: default;
  }
  
  .native-term.error, .foreign-term.error {
    border-color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
    animation: shake 0.5s;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  
  /* Buton stilleri */
  .lesson-navigation {
    display: flex;
    justify-content: center;
    margin-top: 40px;
  }
  
  .action-btn {
    border: none;
    border-radius: 50px;
    padding: 12px 30px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .check-btn {
    background: linear-gradient(to right, #6a5ae0, #8170ff);
    color: white;
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.3);
  }
  
  .check-btn:hover {
    background: linear-gradient(to right, #8170ff, #9a8eff);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(106, 90, 224, 0.4);
  }
  
  .check-btn.disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  
  .continue-btn {
    background: linear-gradient(to right, #2ecc71, #27ae60);
    color: white;
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
  }
  
  .continue-btn:hover {
    background: linear-gradient(to right, #27ae60, #219653);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(46, 204, 113, 0.4);
  }
  
  /* İlerleme çubuğu */
  .progress-bar-container {
    margin-top: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  .progress-bar {
    width: 100%;
    max-width: 400px;
    height: 8px;
    background-color: #f1f3f5;
    border-radius: 4px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(to right, #6a5ae0, #8170ff);
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  
  .progress-text {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #666;
  }
  
  /* Egzersiz yok mesajı */
  .no-exercises {
    text-align: center;
    padding: 50px 0;
  }
  
  .no-exercises i {
    font-size: 5rem;
    color: #6a5ae0;
    margin-bottom: 20px;
  }
  
  .no-exercises h2 {
    font-size: 2rem;
    color: #2c3e50;
    margin-bottom: 15px;
  }
  
  .no-exercises p {
    color: #666;
    font-size: 1.1rem;
    margin-bottom: 25px;
  }
  
  .back-link {
    display: inline-block;
    background: linear-gradient(to right, #6a5ae0, #8170ff);
    color: white;
    padding: 12px 30px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.3);
  }
  
  .back-link:hover {
    background: linear-gradient(to right, #8170ff, #9a8eff);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(106, 90, 224, 0.4);
  }
  
  /* Ders tamamlama ekranı */
  .lesson-complete {
    text-align: center;
    padding: 30px 0;
  }
  
  .lesson-complete-header {
    margin-bottom: 30px;
  }
  
  .lesson-complete-header i {
    font-size: 5rem;
    color: #f39c12;
    margin-bottom: 20px;
    text-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
  }
  
  .lesson-complete-header h2 {
    font-size: 2rem;
    color: #2c3e50;
  }
  
  .lesson-results {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 400px;
    margin: 0 auto 30px;
  }
  
  .result-item {
    display: flex;
    justify-content: space-between;
    padding: 15px 20px;
    background: #f8f9fa;
    border-radius: 10px;
  }
  
  .result-label {
    font-weight: 600;
    color: #2c3e50;
  }
  
  .result-value {
    font-weight: 700;
    color: #6a5ae0;
  }
  
  .lesson-complete-actions {
    display: flex;
    gap: 20px;
    justify-content: center;
  }
  
  .back-to-lessons {
    background: linear-gradient(to right, #2c3e50, #3498db);
    text-decoration: none;
  }
  
  .back-to-lessons:hover {
    background: linear-gradient(to right, #3498db, #2980b9);
  }
  
  .retry-lesson {
    background: linear-gradient(to right, #6a5ae0, #8170ff);
    text-decoration: none;
  }
  
  .retry-lesson:hover {
    background: linear-gradient(to right, #8170ff, #9a8eff);
  }
  
  /* Mobil uyumluluk */
  @media (max-width: 768px) {
    .lesson-header {
      flex-direction: column;
      gap: 15px;
      padding: 20px 15px;
    }
    
    .lesson-content {
      padding: 20px 15px;
    }
    
    .options-container {
      grid-template-columns: 1fr;
    }
    
    .matching-pair {
      flex-direction: column;
      gap: 10px;
    }
    
    .native-term, .foreign-term {
      width: 100%;
    }
    
    .lesson-complete-actions {
      flex-direction: column;
      gap: 15px;
    }
  }
</style>
{% endblock %}
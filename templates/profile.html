{% extends 'layout.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block title %}Profil - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="container profile-page">
  <div class="profile-avatar" style="position: relative; z-index: 100; margin-bottom: -50px; text-align: center;">
  {% if current_user.avatar_url %}
    <img src="{{ current_user.avatar_url }}" alt="{{ current_user.username }} Avatar" style="border: 4px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);">
  {% else %}
    <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; color: white; margin: 0 auto; border: 4px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);">
      {{ current_user.username[0]|upper }}
    </div>
  {% endif %}
</div>

<div class="profile-header glass-effect">
    <div class="profile-info">
      <div class="profile-details">
        <h1 class="profile-username">{{ current_user.username }}</h1>
        <div class="profile-rank">{{ current_user.rank }}</div>
        <div class="profile-progress-card">
          <div class="profile-progress-header">
            <div class="level-badge">{{ current_user.experience_points // 1000 + 1 }}</div>
            <div class="progress-info">
              <div class="progress-title">Seviye {{ current_user.experience_points // 1000 + 1 }}</div>
              <div class="progress-subtitle">{{ current_user.rank }}</div>
            </div>
          </div>
          <div class="profile-exp-bar">
            <div class="exp-progress" style="width: {{ (current_user.experience_points % 1000) / 10 }}%;"></div>
            <div class="exp-text">{{ current_user.experience_points % 1000 }} / 1000 XP</div>
          </div>
          <div class="profile-stats-summary">
            <div class="stats-summary-item">
              <i class="fas fa-gamepad"></i> 
              <span>{{ current_user.total_games_played }} Oyun</span>
            </div>
            <div class="stats-summary-item">
              <i class="fas fa-trophy"></i> 
              <span>{{ current_user.highest_score }} Puan</span>
            </div>
          </div>
        </div>
        <div class="profile-badges">
          {% if current_user.badges %}
            {% for badge in current_user.badges %}
              <div class="badge-item" data-tooltip="{{ badge.name }}">
                <i class="{{ badge.icon }}"></i>
              </div>
            {% endfor %}
          {% endif %}
        </div>

      </div>
    </div>
  </div>
  
  <div class="settings-section">
    <div class="settings-tabs">
      <div class="settings-tab active" data-tab="personal" data-tooltip="Kişisel Bilgiler">
        <span><i class="fas fa-user"></i></span>
      </div>
      <div class="settings-tab" data-tab="security" data-tooltip="Güvenlik">
        <span><i class="fas fa-lock"></i></span>
      </div>
      <div class="settings-tab" data-tab="account" data-tooltip="Hesap">
        <span><i class="fas fa-user-cog"></i></span>
      </div>
      <div class="settings-tab" data-tab="avatar" data-tooltip="Profil Fotoğrafı">
        <span><i class="fas fa-image"></i></span>
      </div>
      <div class="tab-indicator"></div>
    </div>
    
    <div class="settings-content active" id="personal-content">
      <div class="row">
        <div class="col-md-12">
          <div class="settings-card glass-effect">
            <h3 class="settings-title"><i class="fas fa-user-edit"></i> Kişisel Bilgiler</h3>
            <form class="settings-form" method="POST" action="{{ url_for('update_profile') }}">
              <div class="form-group">
                <label>Tam İsim</label>
                <input type="text" class="form-control" value="{{ current_user.full_name }}" name="full_name">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" class="form-control" value="{{ current_user.email }}" name="email">
              </div>
              <div class="form-group">
                <label>Yaş</label>
                <input type="number" class="form-control" value="{{ current_user.age }}" name="age">
              </div>
              <div class="form-group">
                <label>Konum</label>
                <input type="text" class="form-control" value="{{ current_user.location }}" name="location">
              </div>
              <div class="form-group">
                <label>Hakkında</label>
                <textarea class="form-control" name="bio">{{ current_user.bio }}</textarea>
              </div>
              <button type="submit" class="btn btn-primary">Kaydet</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    

    
    <div class="settings-content" id="security-content">
      <div class="row">
        <div class="col-md-12">
          <div class="settings-card glass-effect">
            <h3 class="settings-title"><i class="fas fa-key"></i> Şifre Değiştir</h3>
            <form class="settings-form" method="POST" action="{{ url_for('update_password') }}">
              <div class="form-group">
                <label>Mevcut Şifre</label>
                <input type="password" class="form-control" name="current_password" required>
              </div>
              <div class="form-group">
                <label>Yeni Şifre</label>
                <input type="password" class="form-control" name="new_password" required>
              </div>
              <div class="form-group">
                <label>Yeni Şifre (Tekrar)</label>
                <input type="password" class="form-control" name="confirm_password" required>
              </div>
              <button type="submit" class="btn btn-primary">Şifreyi Güncelle</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    

    
    <div class="settings-content" id="account-content">
      <div class="row">
        <div class="col-md-12">
          <div class="settings-card glass-effect danger-zone">
            <h3 class="settings-title"><i class="fas fa-exclamation-triangle"></i> Tehlikeli Bölge</h3>
            <p>Bu işlemler geri alınamaz ve hesabınıza kalıcı olarak zarar verebilir.</p>
            <form class="settings-form" method="POST" action="{{ url_for('deactivate_account') }}">
              <button type="submit" class="btn btn-danger" onclick="return confirm('Hesabınızı devre dışı bırakmak istediğinizden emin misiniz? Giriş yaparak tekrar aktive edebilirsiniz.');">Hesabı Devre Dışı Bırak</button>
            </form>
            <form class="settings-form mt-3" method="POST" action="{{ url_for('delete_account') }}">
              <button type="submit" class="btn btn-danger" onclick="return confirm('Hesabınızı kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!');">Hesabı Kalıcı Olarak Sil</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <div class="settings-content" id="avatar-content">
      <div class="row">
        <div class="col-md-12">
          <div class="settings-card glass-effect">
            <h3 class="settings-title"><i class="fas fa-user-circle"></i> Profil Fotoğrafı</h3>
            <form id="avatarForm" action="{{ url_for('update_avatar') }}" method="POST" enctype="multipart/form-data">
              <h5>Yükle veya Seç</h5>
              <div class="avatar-upload-container">
                <div class="avatar-preview mb-3">
                  {% if current_user.avatar_url %}
                    <img src="{{ current_user.avatar_url }}" alt="Avatar Preview" class="avatar-preview-img" id="avatarPreview">
                  {% else %}
                    <div class="avatar-placeholder preview" id="avatarPreview">{{ current_user.username[0]|upper }}</div>
                  {% endif %}
                </div>
                <input type="file" id="avatarInput" name="avatar" accept="image/*" class="form-control">
              </div>
              <div class="avatar-options mt-3">
                <h6>Hazır Avatarlar</h6>
                <div class="preset-avatars">
                  <div class="preset-avatar" data-avatar="avatar1.svg">
                    <img src="{{ url_for('static', filename='images/avatars/avatar1.svg') }}" alt="Avatar 1">
                  </div>
                  <div class="preset-avatar" data-avatar="avatar2.svg">
                    <img src="{{ url_for('static', filename='images/avatars/avatar2.svg') }}" alt="Avatar 2">
                  </div>
                  <div class="preset-avatar" data-avatar="avatar3.svg">
                    <img src="{{ url_for('static', filename='images/avatars/avatar3.svg') }}" alt="Avatar 3">
                  </div>
                  <div class="preset-avatar" data-avatar="avatar4.svg">
                    <img src="{{ url_for('static', filename='images/avatars/avatar4.svg') }}" alt="Avatar 4">
                  </div>
                </div>
              </div>
              <input type="hidden" name="selected_avatar" id="selectedAvatar" value="">
              <button type="submit" class="btn btn-primary mt-3">Kaydet</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Avatar yükleme önizleme
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const selectedAvatarInput = document.getElementById('selectedAvatar');
    
    if (avatarInput) {
      avatarInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            if (avatarPreview.tagName === 'IMG') {
              avatarPreview.src = e.target.result;
            } else {
              // Placeholder div'i resim ile değiştir
              const img = document.createElement('img');
              img.src = e.target.result;
              img.classList.add('avatar-preview-img');
              img.id = 'avatarPreview';
              avatarPreview.parentNode.replaceChild(img, avatarPreview);
            }
            // Hazır avatar seçimini temizle
            selectedAvatarInput.value = '';
            document.querySelectorAll('.preset-avatar').forEach(el => {
              el.classList.remove('selected');
            });
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Hazır avatar seçimi
    const presetAvatars = document.querySelectorAll('.preset-avatar');
    presetAvatars.forEach(avatar => {
      avatar.addEventListener('click', function() {
        const avatarName = this.getAttribute('data-avatar');
        selectedAvatarInput.value = avatarName;
        
        // Seçili sınıfını değiştir
        presetAvatars.forEach(a => a.classList.remove('selected'));
        this.classList.add('selected');
        
        // Önizlemeyi güncelle
        const avatarSrc = this.querySelector('img').src;
        if (avatarPreview.tagName === 'IMG') {
          avatarPreview.src = avatarSrc;
        } else {
          const img = document.createElement('img');
          img.src = avatarSrc;
          img.classList.add('avatar-preview-img');
          img.id = 'avatarPreview';
          avatarPreview.parentNode.replaceChild(img, avatarPreview);
        }
        
        // Dosya girdisini temizle
        avatarInput.value = '';
      });
    });
    
    // Tema renk seçimi
    const colorOptions = document.querySelectorAll('.color-option');
    const themeColorInput = document.getElementById('themeColor');
    
    colorOptions.forEach(option => {
      option.addEventListener('click', function() {
        const color = this.getAttribute('data-color');
        themeColorInput.value = color;
        
        colorOptions.forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
      });
    });
    
    // Tema modu seçimi
    const themeOptions = document.querySelectorAll('.theme-option');
    
    themeOptions.forEach(option => {
      option.addEventListener('click', function() {
        const theme = this.getAttribute('data-theme');
        const radioInput = this.querySelector('input[type="radio"]');
        radioInput.checked = true;
        
        themeOptions.forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
      });
    });
    
    // Ayarlar tablarını değiştirme ve animasyonlu gösterge
    const settingsTabs = document.querySelectorAll('.settings-tab');
    const tabIndicator = document.querySelector('.tab-indicator');
    
    // İlk yüklemede tab göstergesini doğru konumlandır
    function positionTabIndicator(activeTab) {
      if (!tabIndicator) return;
      
      const tabLeft = activeTab.offsetLeft;
      const tabWidth = activeTab.offsetWidth;
      
      // Tab göstergesini konumlandır - yuvarlak butonlar için alt ortalamaya ayarla
      tabIndicator.style.width = `${tabWidth / 2}px`;
      tabIndicator.style.left = `${tabLeft + tabWidth/4}px`;
    }
    
    // Tooltip işlevselliği ekle
    function setupTooltips() {
      settingsTabs.forEach(tab => {
        const tooltip = document.createElement('div');
        tooltip.className = 'tab-tooltip';
        tooltip.textContent = tab.getAttribute('data-tooltip');
        tab.appendChild(tooltip);
        
        tab.addEventListener('mouseenter', () => {
          tooltip.style.opacity = '1';
          tooltip.style.transform = 'translateY(0)';
        });
        
        tab.addEventListener('mouseleave', () => {
          tooltip.style.opacity = '0';
          tooltip.style.transform = 'translateY(10px)';
        });
      });
    }
    
    // İlk sayfa yüklendiğinde aktif tab'a göre göstergeyi konumlandır ve tooltipleri ayarla
    const initialActiveTab = document.querySelector('.settings-tab.active');
    if (initialActiveTab) {
      setTimeout(() => {
        positionTabIndicator(initialActiveTab);
        setupTooltips(); // Tooltip işlevselliğini başlat
      }, 100); // Sayfa tam yüklendikten sonra çalıştırmak için kısa bir gecikme
    }
    
    // Tab değiştiğinde animasyonlar
    settingsTabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        
        // Aktif tab'ı değiştir ve göstergeyi animasyonla hareket ettir
        settingsTabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        positionTabIndicator(this);
        
        // İçerik alanlarını değiştir - önce mevcut içeriği gizle
        const currentContent = document.querySelector('.settings-content.active');
        const newContent = document.getElementById(`${tabName}-content`);
        
        if (currentContent) {
          currentContent.style.opacity = '0';
          currentContent.style.transform = 'translateY(20px)';
          
          // Kısa bir gecikme sonrasında eski içeriği gizle ve yeni içeriği göster
          setTimeout(() => {
            document.querySelectorAll('.settings-content').forEach(content => {
              content.classList.remove('active');
            });
            newContent.classList.add('active');
          }, 300);
        } else {
          // İlk yükleme için doğrudan göster
          newContent.classList.add('active');
        }
      });
    });
    
    // Pencere boyutu değiştiğinde tab göstergesini yeniden konumlandır
    window.addEventListener('resize', () => {
      const activeTab = document.querySelector('.settings-tab.active');
      if (activeTab) {
        positionTabIndicator(activeTab);
      }
    });
    

  });
</script>
{% endblock %}
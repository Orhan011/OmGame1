{% extends 'layout.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block title %}Profil - {{ current_user.username }}{% endblock %}

{% block content %}
<!-- Yeni Modern Profil Sayfası -->
<div class="container-fluid profile-container">
  <div class="row">
    <!-- Sol Kenar Çubuğu - Profil Bilgileri -->
    <div class="col-lg-3">
      <div class="profile-sidebar">
        <!-- Profil Kartı -->
        <div class="profile-card glass-effect">
          <div class="profile-cover-area">
            <div class="profile-cover-gradient"></div>
          </div>
          
          <div class="profile-card-content">
            <!-- Profil Resmi -->
            <div class="profile-avatar-container">
              {% if current_user.avatar_url %}
                <img src="{{ url_for('static', filename=current_user.avatar_url) }}" alt="{{ current_user.username }}" class="profile-avatar">
              {% else %}
                <div class="profile-avatar profile-avatar-placeholder">
                  {{ current_user.username[0]|upper }}
                </div>
              {% endif %}
              
              <div class="profile-status online" title="Çevrimiçi"></div>
            </div>
            
            <!-- Kullanıcı Bilgileri -->
            <div class="profile-info">
              <h2 class="profile-name">{{ current_user.username }}</h2>
              <div class="profile-title">{{ current_user.rank }}</div>
              
              <div class="profile-stats">
                <div class="stat-item">
                  <span class="stat-value">{{ current_user.total_games_played }}</span>
                  <span class="stat-label">Oyun</span>
                </div>
                <div class="stat-divider"></div>
                <div class="stat-item">
                  <span class="stat-value">{{ current_user.highest_score }}</span>
                  <span class="stat-label">En Yüksek Skor</span>
                </div>
              </div>
            </div>
            
            <!-- Seviye İlerleme Çubuğu -->
            <div class="level-progress-container">
              <div class="level-badge">{{ current_user.experience_points // 1000 + 1 }}</div>
              <div class="level-progress-bar">
                <div class="level-progress" style="width: {{ (current_user.experience_points % 1000) / 10 }}%;"></div>
              </div>
              <div class="level-text">{{ current_user.experience_points % 1000 }} / 1000 XP</div>
            </div>
            
            <!-- Profil Rozet Alanı -->
            <div class="profile-badges-container">
              <h3 class="section-title"><i class="fas fa-award"></i> Rozetler</h3>
              <div class="profile-badges">
                {% if current_user.badges %}
                  {% for badge in current_user.badges %}
                    <div class="badge-item" data-tooltip="{{ badge.name }}">
                      <i class="{{ badge.icon }}"></i>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="empty-badges">
                    <p>Henüz rozet kazanmadınız. Oyunları oynayarak rozetler kazanabilirsiniz!</p>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Hızlı İstatistikler -->
        <div class="quick-stats glass-effect">
          <h3 class="section-title"><i class="fas fa-chart-line"></i> İstatistikler</h3>
          
          <div class="stats-grid">
            <div class="stat-grid-item">
              <div class="stat-icon">
                <i class="fas fa-brain"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ user_scores.wordPuzzle }}</div>
                <div class="stat-label">Kelime Bulmaca</div>
              </div>
            </div>
            
            <div class="stat-grid-item">
              <div class="stat-icon">
                <i class="fas fa-memory"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ user_scores.memoryMatch }}</div>
                <div class="stat-label">Hafıza Oyunu</div>
              </div>
            </div>
            
            <div class="stat-grid-item">
              <div class="stat-icon">
                <i class="fas fa-map-signs"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ user_scores.labyrinth }}</div>
                <div class="stat-label">Labirent</div>
              </div>
            </div>
            
            <div class="stat-grid-item">
              <div class="stat-icon">
                <i class="fas fa-puzzle-piece"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value">{{ user_scores.puzzle }}</div>
                <div class="stat-label">Bulmaca</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bağlantılar -->
        <div class="profile-links glass-effect">
          <a href="{{ url_for('leaderboard') }}" class="profile-link">
            <i class="fas fa-trophy"></i> Sıralama Tablosu
          </a>
          <a href="{{ url_for('articles') }}" class="profile-link">
            <i class="fas fa-newspaper"></i> Makaleler
          </a>
          <a href="{{ url_for('tips') }}" class="profile-link">
            <i class="fas fa-lightbulb"></i> İpuçları
          </a>
        </div>
      </div>
    </div>
    
    <!-- Sağ İçerik Alanı - Ayarlar ve Düzenleme -->
    <div class="col-lg-9">
      <div class="profile-content">
        <!-- Üst Sekmeler -->
        <div class="profile-tabs glass-effect">
          <div class="nav nav-tabs" id="profile-tab" role="tablist">
            <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab" aria-controls="personal" aria-selected="true">
              <i class="fas fa-user-edit"></i> Kişisel Bilgiler
            </button>
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
              <i class="fas fa-lock"></i> Güvenlik
            </button>
            <button class="nav-link" id="avatar-tab" data-bs-toggle="tab" data-bs-target="#avatar" type="button" role="tab" aria-controls="avatar" aria-selected="false">
              <i class="fas fa-user-circle"></i> Profil Fotoğrafı
            </button>
            <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="false">
              <i class="fas fa-cog"></i> Hesap
            </button>
          </div>
        </div>
        
        <!-- Sekme İçerikleri -->
        <div class="tab-content" id="profileTabContent">
          <!-- Kişisel Bilgiler Sekmesi -->
          <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
            <div class="profile-form-container glass-effect">
              <h3 class="form-title"><i class="fas fa-user-edit"></i> Kişisel Bilgiler</h3>
              
              <form class="profile-form" method="POST" action="{{ url_for('update_profile') }}">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="fullName" name="full_name" value="{{ current_user.full_name }}" placeholder="Tam İsim">
                      <label for="fullName">Tam İsim</label>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="email" class="form-control" id="email" name="email" value="{{ current_user.email }}" placeholder="Email">
                      <label for="email">Email</label>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="number" class="form-control" id="age" name="age" value="{{ current_user.age }}" placeholder="Yaş">
                      <label for="age">Yaş</label>
                    </div>
                  </div>
                  
                  <div class="col-md-6">
                    <div class="form-floating mb-3">
                      <input type="text" class="form-control" id="location" name="location" value="{{ current_user.location }}" placeholder="Konum">
                      <label for="location">Konum</label>
                    </div>
                  </div>
                </div>
                
                <div class="form-floating mb-3">
                  <textarea class="form-control" id="bio" name="bio" style="height: 120px;" placeholder="Hakkında">{{ current_user.bio }}</textarea>
                  <label for="bio">Hakkında</label>
                </div>
                
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Değişiklikleri Kaydet
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Güvenlik Sekmesi -->
          <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="profile-form-container glass-effect">
              <h3 class="form-title"><i class="fas fa-key"></i> Şifre Değiştir</h3>
              
              <form class="profile-form" method="POST" action="{{ url_for('update_password') }}">
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="currentPassword" name="current_password" placeholder="Mevcut Şifre" required>
                  <label for="currentPassword">Mevcut Şifre</label>
                </div>
                
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="newPassword" name="new_password" placeholder="Yeni Şifre" required>
                  <label for="newPassword">Yeni Şifre</label>
                </div>
                
                <div class="form-floating mb-3">
                  <input type="password" class="form-control" id="confirmPassword" name="confirm_password" placeholder="Yeni Şifre (Tekrar)" required>
                  <label for="confirmPassword">Yeni Şifre (Tekrar)</label>
                </div>
                
                <div class="password-strength" id="passwordStrength">
                  <div class="strength-meter">
                    <div class="strength-meter-fill" data-strength="0"></div>
                  </div>
                  <div class="password-feedback" id="passwordFeedback">Şifre gücü: Zayıf</div>
                </div>
                
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-lock"></i> Şifreyi Güncelle
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Profil Fotoğrafı Sekmesi -->
          <div class="tab-pane fade" id="avatar" role="tabpanel" aria-labelledby="avatar-tab">
            <div class="profile-form-container glass-effect">
              <h3 class="form-title"><i class="fas fa-user-circle"></i> Profil Fotoğrafı</h3>
              
              <form id="avatarForm" action="{{ url_for('update_avatar') }}" method="POST" enctype="multipart/form-data" class="profile-form">
                <div class="avatar-editor">
                  <div class="current-avatar">
                    {% if current_user.avatar_url %}
                      <img src="{{ url_for('static', filename=current_user.avatar_url) }}" alt="Avatar" id="avatarPreview" class="avatar-preview">
                    {% else %}
                      <div class="avatar-preview-placeholder" id="avatarPreview">
                        {{ current_user.username[0]|upper }}
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="avatar-upload">
                    <label for="avatarInput" class="avatar-upload-label">
                      <i class="fas fa-upload"></i> Fotoğraf Yükle
                    </label>
                    <input type="file" id="avatarInput" name="avatar" accept="image/*" class="form-control" style="display: none;">
                  </div>
                </div>
                
                <div class="avatar-gallery">
                  <h4 class="gallery-title">Hazır Avatarlar</h4>
                  
                  <div class="avatar-options">
                    <div class="preset-avatar" data-avatar="avatar1.svg">
                      <img src="{{ url_for('static', filename='images/avatars/avatar1.svg') }}" alt="Avatar 1">
                    </div>
                    <div class="preset-avatar" data-avatar="avatar2.svg">
                      <img src="{{ url_for('static', filename='images/avatars/avatar2.svg') }}" alt="Avatar 2">
                    </div>
                    <div class="preset-avatar" data-avatar="avatar3.svg">
                      <img src="{{ url_for('static', filename='images/avatars/avatar3.svg') }}" alt="Avatar 3">
                    </div>
                    <div class="preset-avatar" data-avatar="avatar4.svg">
                      <img src="{{ url_for('static', filename='images/avatars/avatar4.svg') }}" alt="Avatar 4">
                    </div>
                  </div>
                </div>
                
                <input type="hidden" name="selected_avatar" id="selectedAvatar" value="">
                
                <div class="form-actions">
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Profil Fotoğrafını Kaydet
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <!-- Hesap Sekmesi -->
          <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
            <div class="profile-form-container glass-effect">
              <h3 class="form-title"><i class="fas fa-exclamation-triangle"></i> Tehlikeli Bölge</h3>
              <div class="danger-zone">
                <div class="warning-message">
                  <p><i class="fas fa-exclamation-circle"></i> Bu işlemler geri alınamaz ve hesabınıza kalıcı olarak zarar verebilir.</p>
                </div>
                
                <div class="danger-actions">
                  <form class="settings-form" method="POST" action="{{ url_for('deactivate_account') }}">
                    <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Hesabınızı devre dışı bırakmak istediğinizden emin misiniz? Giriş yaparak tekrar aktive edebilirsiniz.');">
                      <i class="fas fa-user-slash"></i> Hesabı Devre Dışı Bırak
                    </button>
                  </form>
                  
                  <form class="settings-form mt-3" method="POST" action="{{ url_for('delete_account') }}">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Hesabınızı kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!');">
                      <i class="fas fa-trash-alt"></i> Hesabı Kalıcı Olarak Sil
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Son Aktiviteler Kartı -->
        <div class="recent-activity glass-effect">
          <h3 class="section-title"><i class="fas fa-history"></i> Son Aktiviteler</h3>
          
          <div class="activity-timeline">
            <div class="activity-item">
              <div class="activity-icon">
                <i class="fas fa-gamepad"></i>
              </div>
              <div class="activity-content">
                <div class="activity-title">Kelime Bulmaca oynadınız</div>
                <div class="activity-time">1 saat önce</div>
              </div>
              <div class="activity-score">+{{ user_scores.wordPuzzle }} puan</div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon">
                <i class="fas fa-puzzle-piece"></i>
              </div>
              <div class="activity-content">
                <div class="activity-title">Hafıza Kartları oynadınız</div>
                <div class="activity-time">2 gün önce</div>
              </div>
              <div class="activity-score">+{{ user_scores.memoryMatch }} puan</div>
            </div>
            
            <div class="activity-item">
              <div class="activity-icon">
                <i class="fas fa-map-signs"></i>
              </div>
              <div class="activity-content">
                <div class="activity-title">Labirent oynadınız</div>
                <div class="activity-time">3 gün önce</div>
              </div>
              <div class="activity-score">+{{ user_scores.labyrinth }} puan</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Avatar önizleme işlevselliği
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const selectedAvatarInput = document.getElementById('selectedAvatar');
    
    // Dosya yükleme
    if (avatarInput) {
      avatarInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            if (avatarPreview.tagName === 'IMG') {
              avatarPreview.src = e.target.result;
              avatarPreview.classList.add('updated');
            } else {
              // Placeholder div'i resim ile değiştir
              const img = document.createElement('img');
              img.src = e.target.result;
              img.classList.add('avatar-preview', 'updated');
              img.id = 'avatarPreview';
              avatarPreview.parentNode.replaceChild(img, avatarPreview);
            }
            
            // Hazır avatar seçimini temizle
            selectedAvatarInput.value = '';
            document.querySelectorAll('.preset-avatar').forEach(el => {
              el.classList.remove('selected');
            });
            
            // Anında animasyon efekti ekleme
            setTimeout(() => {
              document.querySelector('.updated')?.classList.remove('updated');
            }, 1000);
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Hazır avatar seçimi
    const presetAvatars = document.querySelectorAll('.preset-avatar');
    presetAvatars.forEach(avatar => {
      avatar.addEventListener('click', function() {
        const avatarName = this.getAttribute('data-avatar');
        selectedAvatarInput.value = avatarName;
        
        // Seçili sınıfını değiştir
        presetAvatars.forEach(a => a.classList.remove('selected'));
        this.classList.add('selected');
        
        // Önizlemeyi güncelle
        const avatarSrc = this.querySelector('img').src;
        if (avatarPreview.tagName === 'IMG') {
          avatarPreview.src = avatarSrc;
          avatarPreview.classList.add('updated');
        } else {
          const img = document.createElement('img');
          img.src = avatarSrc;
          img.classList.add('avatar-preview', 'updated');
          img.id = 'avatarPreview';
          avatarPreview.parentNode.replaceChild(img, avatarPreview);
        }
        
        // Animasyon sınıfını kaldır
        setTimeout(() => {
          document.querySelector('.updated')?.classList.remove('updated');
        }, 1000);
        
        // Dosya girdisini temizle
        if (avatarInput) avatarInput.value = '';
      });
    });
    
    // Şifre gücü göstergesi
    const newPassword = document.getElementById('newPassword');
    const passwordStrength = document.getElementById('passwordStrength');
    const passwordFeedback = document.getElementById('passwordFeedback');
    const strengthMeter = document.querySelector('.strength-meter-fill');
    
    if (newPassword && passwordStrength) {
      newPassword.addEventListener('input', function() {
        const val = this.value;
        let strength = 0;
        let feedback = 'Şifre gücü: ';
        
        if (val.length >= 8) strength += 1;
        if (val.match(/[a-z]/)) strength += 1;
        if (val.match(/[A-Z]/)) strength += 1;
        if (val.match(/[0-9]/)) strength += 1;
        if (val.match(/[^a-zA-Z0-9]/)) strength += 1;
        
        switch (strength) {
          case 0:
          case 1:
            feedback += 'Çok Zayıf';
            strengthMeter.style.width = '20%';
            strengthMeter.style.backgroundColor = '#e74c3c';
            break;
          case 2:
            feedback += 'Zayıf';
            strengthMeter.style.width = '40%';
            strengthMeter.style.backgroundColor = '#e67e22';
            break;
          case 3:
            feedback += 'Orta';
            strengthMeter.style.width = '60%';
            strengthMeter.style.backgroundColor = '#f1c40f';
            break;
          case 4:
            feedback += 'Güçlü';
            strengthMeter.style.width = '80%';
            strengthMeter.style.backgroundColor = '#2ecc71';
            break;
          case 5:
            feedback += 'Çok Güçlü';
            strengthMeter.style.width = '100%';
            strengthMeter.style.backgroundColor = '#27ae60';
            break;
        }
        
        passwordFeedback.textContent = feedback;
        strengthMeter.setAttribute('data-strength', strength);
      });
    }
    
    // Tab değişiminde animasyon efektleri
    const tabLinks = document.querySelectorAll('.nav-link');
    tabLinks.forEach(tab => {
      tab.addEventListener('click', function() {
        setTimeout(() => {
          const activePane = document.querySelector('.tab-pane.show.active');
          if (activePane) {
            activePane.classList.add('tab-animation');
            setTimeout(() => {
              activePane.classList.remove('tab-animation');
            }, 500);
          }
        }, 50);
      });
    });
  });
</script>
{% endblock %}
{% extends 'layout.html' %}

{% block content %}
{% set current_year = 2025 %}
<div class="profile-container">
  <div class="row">
    <!-- Sol Taraf: Kullanıcı Bilgileri -->
    <div class="col-lg-4 mb-4">
      <div class="card glass-card">
        <div class="card-body text-center">
          <div class="profile-avatar-container mb-4">
            {% if user.avatar_url %}
              <img src="{{ user.avatar_url }}" alt="{{ user.username }}" class="img-fluid profile-avatar">
            {% else %}
              <div class="profile-avatar-placeholder">
                <i class="fas fa-user fa-4x"></i>
              </div>
            {% endif %}
          </div>

          <h3 class="profile-username mb-2">{{ user.username }}</h3>
          <p class="profile-email mb-3">{{ user.email }}</p>

          <div class="profile-stats mb-4">
            <div class="row g-0">
              <div class="col">
                <div class="profile-stat">
                  <div class="stat-value">{{ stats.total_games }}</div>
                  <div class="stat-label">Oyun</div>
                </div>
              </div>
              <div class="col">
                <div class="profile-stat">
                  <div class="stat-value">{{ stats.high_score }}</div>
                  <div class="stat-label">En Yüksek Puan</div>
                </div>
              </div>
              <div class="col">
                <div class="profile-stat">
                  <div class="stat-value">{{ stats.experience_points }}</div>
                  <div class="stat-label">XP</div>
                </div>
              </div>
            </div>
          </div>

          <div class="profile-rank mb-4">
            <span class="rank-badge">{{ stats.rank }}</span>
          </div>

          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="fas fa-edit me-2"></i>Profili Düzenle
          </button>
        </div>
      </div>
    </div>

    <!-- Sağ Taraf: Skorlar ve İstatistikler -->
    <div class="col-lg-8">
      <div class="card glass-card mb-4">
        <div class="card-header">
          <h4 class="mb-0"><i class="fas fa-trophy me-2"></i>Oyun Skorları</h4>
        </div>
        <div class="card-body">
          <ul class="nav nav-tabs" id="gameTabs" role="tablist">
            {% for game_type in game_types %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if loop.first %}active{% endif %}" 
                      id="{{ game_type }}-tab" 
                      data-bs-toggle="tab" 
                      data-bs-target="#{{ game_type }}-content" 
                      type="button" 
                      role="tab" 
                      aria-controls="{{ game_type }}-content" 
                      aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                {% if game_type == 'wordPuzzle' %}
                  <i class="fas fa-spell-check me-1"></i>Kelime Bulmaca
                {% elif game_type == 'memoryMatch' %}
                  <i class="fas fa-clone me-1"></i>Hafıza Kartları
                {% elif game_type == 'labyrinth' %}
                  <i class="fas fa-route me-1"></i>Labirent
                {% elif game_type == 'puzzle' %}
                  <i class="fas fa-puzzle-piece me-1"></i>Yapboz
                {% elif game_type == '3dRotation' %}
                  <i class="fas fa-cube me-1"></i>3D Döndürme
                {% else %}
                  {{ game_type }}
                {% endif %}
              </button>
            </li>
            {% endfor %}
          </ul>

          <div class="tab-content p-3" id="gameTabsContent">
            {% for game_type in game_types %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                 id="{{ game_type }}-content" 
                 role="tabpanel" 
                 aria-labelledby="{{ game_type }}-tab">

              <div class="game-score-summary mb-4">
                <div class="row align-items-center">
                  <div class="col-md-4 text-center mb-3 mb-md-0">
                    <div class="highest-score-display">
                      <div class="score-value">{{ scores[game_type].highest }}</div>
                      <div class="score-label">En Yüksek Puan</div>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="progress-container">
                      {% if game_type == 'wordPuzzle' %}
                        {% set next_milestone = 500 %}
                      {% elif game_type == 'memoryMatch' %}
                        {% set next_milestone = 1000 %}
                      {% elif game_type == 'labyrinth' %}
                        {% set next_milestone = 800 %}
                      {% elif game_type == 'puzzle' %}
                        {% set next_milestone = 1500 %}
                      {% else %}
                        {% set next_milestone = 2000 %}
                      {% endif %}

                      {% set progress = (scores[game_type].highest / next_milestone * 100)|int if scores[game_type].highest > 0 else 0 %}

                      <div class="progress-label d-flex justify-content-between mb-1">
                        <span>İlerleme</span>
                        <span>{{ progress }}%</span>
                      </div>
                      <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ progress }}%" 
                             aria-valuenow="{{ progress }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                      </div>
                      <div class="progress-description mt-1">
                        <small>Bir sonraki seviye: {{ next_milestone }} puan</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <h5 class="mb-3"><i class="fas fa-history me-2"></i>Son Skorlar</h5>

              {% if scores[game_type].recent %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Puan</th>
                        <th>Tarih</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for score in scores[game_type].recent %}
                      <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ score.score }}</td>
                        <td>{{ score.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-center py-4">
                  <div class="empty-state">
                    <i class="fas fa-gamepad fa-3x mb-3"></i>
                    <p>Henüz bu oyunda skor kaydınız bulunmuyor.</p>
                    {% if game_type == 'wordPuzzle' %}
                      <a href="{{ url_for('word_puzzle') }}" class="btn btn-primary btn-sm">Oynamak İçin Tıklayın</a>
                    {% elif game_type == 'memoryMatch' %}
                      <a href="{{ url_for('memory_match') }}" class="btn btn-primary btn-sm">Oynamak İçin Tıklayın</a>
                    {% elif game_type == 'labyrinth' %}
                      <a href="{{ url_for('labyrinth') }}" class="btn btn-primary btn-sm">Oynamak İçin Tıklayın</a>
                    {% elif game_type == 'puzzle' %}
                      <a href="{{ url_for('puzzle') }}" class="btn btn-primary btn-sm">Oynamak İçin Tıklayın</a>
                    {% elif game_type == '3dRotation' %}
                      <a href="{{ url_for('three_d_rotation') }}" class="btn btn-primary btn-sm">Oynamak İçin Tıklayın</a>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="card glass-card">
        <div class="card-header">
          <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i>İstatistikler</h4>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Kayıt Tarihi</div>
                  <div class="stat-value">{{ user.created_at.strftime('%d.%m.%Y') }}</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Son Aktivite</div>
                  <div class="stat-value">{{ user.last_active.strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-birthday-cake"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Doğum Yılı</div>
                  <div class="stat-value">{{ user.birth_year or 'Belirtilmemiş' }}</div>
                </div>
              </div>
            </div>

            <div class="col-md-6 mb-4">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-gamepad"></i>
                </div>
                <div class="stat-info">
                  <div class="stat-label">Toplam Oyun</div>
                  <div class="stat-value">{{ stats.total_games }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Basit Profil Düzenleme Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel"><i class="fas fa-user-edit"></i> Profil Düzenle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data" id="profileForm">
          <!-- Profil Resmi -->
          <div class="text-center mb-4">
            <div class="d-inline-block position-relative" style="width: 120px; height: 120px;">
              {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="{{ user.username }}" id="avatarPreview" class="img-fluid rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
              {% else %}
                <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center" id="avatarPlaceholder" style="width: 120px; height: 120px;">
                  <i class="fas fa-user fa-3x text-white"></i>
                </div>
                <img src="" alt="" id="avatarPreview" class="d-none">
              {% endif %}
            </div>
            
            <div class="mt-3">
              <label for="profile_image" class="btn btn-primary btn-sm mb-2">
                <i class="fas fa-upload me-1"></i> Fotoğraf Yükle
              </label>
              <input type="file" id="profile_image" name="profile_image" accept="image/*" class="d-none">
              <button type="button" class="btn btn-outline-danger btn-sm ms-2" id="removePhotoBtn">
                <i class="fas fa-trash-alt me-1"></i> Kaldır
              </button>
            </div>
            <small class="text-muted">JPG veya PNG, maks. 500KB</small>
            <!-- Hidden field for photo removal -->
            <input type="hidden" id="remove_photo" name="remove_photo" value="0">
          </div>
          
          <!-- Kullanıcı Adı -->
          <div class="mb-3">
            <label for="profile_username" class="form-label"><i class="fas fa-user me-1"></i> Kullanıcı Adı</label>
            <input type="text" class="form-control" id="profile_username" name="username" value="{{ user.username }}" required>
          </div>
          
          <!-- Doğum Yılı -->
          <div class="mb-3">
            <label for="profile_birth_year" class="form-label"><i class="fas fa-birthday-cake me-1"></i> Doğum Yılı</label>
            <input type="number" class="form-control" id="profile_birth_year" name="birth_year" value="{{ user.birth_year or '' }}" min="1900" max="2025" placeholder="YYYY">
          </div>
          
          <!-- Butonlar -->
          <div class="text-end mt-4">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
            <button type="submit" class="btn btn-primary" id="profileSaveBtn">
              <i class="fas fa-save me-1"></i> Kaydet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Basit profil sayfası JavaScript
    const profileForm = document.getElementById('profileForm');
    const profileImage = document.getElementById('profile_image');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const removePhotoBtn = document.getElementById('removePhotoBtn');
    const removePhotoInput = document.getElementById('remove_photo');
    const profileUsername = document.getElementById('profile_username');
    const profileBirthYear = document.getElementById('profile_birth_year');
    const profileSaveBtn = document.getElementById('profileSaveBtn');
    
    // Profil fotoğrafı işlemleri
    if (profileImage) {
      profileImage.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          const file = e.target.files[0];
          
          // Dosya boyutu kontrolü (500KB = 512000 bytes)
          if (file.size > 512000) {
            alert('Dosya boyutu çok büyük! Lütfen 500KB\'dan küçük bir dosya seçin.');
            return;
          }
          
          // Dosya tipi kontrolü
          if (!['image/jpeg', 'image/png'].includes(file.type)) {
            alert('Lütfen geçerli bir resim dosyası seçin (JPG veya PNG).');
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            if (avatarPreview) {
              avatarPreview.src = e.target.result;
              avatarPreview.classList.remove('d-none');
            }
            
            if (avatarPlaceholder) {
              avatarPlaceholder.classList.add('d-none');
            }
            
            // Fotoğrafı kaldırma bayrağını sıfırla
            if (removePhotoInput) {
              removePhotoInput.value = '0';
            }
          };
          
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Fotoğraf kaldır butonu
    if (removePhotoBtn) {
      removePhotoBtn.addEventListener('click', function() {
        if (avatarPreview) {
          avatarPreview.classList.add('d-none');
          avatarPreview.src = '';
        }
        
        if (avatarPlaceholder) {
          avatarPlaceholder.classList.remove('d-none');
        }
        
        if (profileImage) {
          profileImage.value = '';
        }
        
        if (removePhotoInput) {
          removePhotoInput.value = '1';
        }
      });
    }
    
    // Kullanıcı adı kontrolü
    if (profileUsername) {
      profileUsername.addEventListener('input', function() {
        const username = this.value.trim();
        
        if (username.length < 3) {
          this.setCustomValidity('Kullanıcı adı en az 3 karakter olmalıdır.');
        } else if (username.length > 20) {
          this.setCustomValidity('Kullanıcı adı en fazla 20 karakter olmalıdır.');
        } else if (!/^[a-zA-Z0-9_]+$/.test(username)) {
          this.setCustomValidity('Kullanıcı adı sadece harf, rakam ve alt çizgi (_) içerebilir.');
        } else {
          this.setCustomValidity('');
        }
      });
    }
    
    // Doğum yılı kontrolü
    if (profileBirthYear) {
      profileBirthYear.addEventListener('input', function() {
        const year = parseInt(this.value);
        const currentYear = new Date().getFullYear();
        
        if (isNaN(year)) {
          this.setCustomValidity('');
        } else if (year < 1900) {
          this.setCustomValidity('Doğum yılı 1900\'den küçük olamaz.');
        } else if (year > currentYear) {
          this.setCustomValidity('Doğum yılı günümüzden ileri olamaz.');
        } else {
          this.setCustomValidity('');
        }
      });
    }

    // Tab değişiminde aktif sekmeyi URL'ye ekle
    const gameTabs = document.querySelectorAll('#gameTabs .nav-link');
    if (gameTabs.length > 0) {
      gameTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const gameType = this.id.replace('-tab', '');
          history.replaceState(null, null, '#' + gameType);
        });
      });

      // Sayfa yüklendiğinde URL'de sekme varsa ona git
      if (location.hash) {
        const tabId = location.hash.substring(1) + '-tab';
        const tab = document.getElementById(tabId);
        if (tab) {
          const tabTrigger = new bootstrap.Tab(tab);
          tabTrigger.show();
        }
      }
    }
  });
</script>
{% endblock %}
{% extends 'layout.html' %}

{% block content %}
<div class="profile-container">
  <div class="row">
    <!-- Sol Taraf: Kullanıcı Bilgileri -->
    <div class="col-lg-4 mb-4">
      <div class="profile-card glass-card">
        <div class="card-body text-center">
          <div class="profile-avatar-container mb-4" id="profileAvatarContainer">
            {% if user.avatar_url %}
              <img src="{{ user.avatar_url }}?v={{ user.last_active|int }}" alt="{{ user.username }}" class="profile-avatar">
            {% else %}
              <div class="profile-avatar-placeholder">
                <i class="fas fa-user fa-4x"></i>
              </div>
            {% endif %}
            <div class="profile-avatar-overlay">
              <i class="fas fa-camera"></i>
              <span>Fotoğraf Değiştir</span>
            </div>
          </div>

          <h3 class="profile-username mb-2">{{ user.username }}</h3>
          <p class="profile-email mb-3">{{ user.email }}</p>

          <!-- Kullanıcı İstatistikleri -->
          <div class="profile-stats-grid">
            <div class="stat-box">
              <div class="stat-icon"><i class="fas fa-gamepad"></i></div>
              <div class="stat-value">{{ stats.total_games }}</div>
              <div class="stat-label">Toplam Oyun</div>
            </div>
            <div class="stat-box">
              <div class="stat-icon"><i class="fas fa-trophy"></i></div>
              <div class="stat-value">{{ stats.high_score }}</div>
              <div class="stat-label">En Yüksek Puan</div>
            </div>
            <div class="stat-box">
              <div class="stat-icon"><i class="fas fa-star"></i></div>
              <div class="stat-value">{{ stats.experience_points }}</div>
              <div class="stat-label">XP</div>
            </div>
          </div>

          <div class="profile-rank mt-4">
            <div class="rank-title">Seviye</div>
            <div class="rank-badge">{{ stats.rank }}</div>
          </div>

          <button class="btn btn-primary w-100 mt-4" data-bs-toggle="modal" data-bs-target="#editProfileModal">
            <i class="fas fa-edit me-2"></i>Profili Düzenle
          </button>
        </div>
      </div>
    </div>

    <!-- Sağ Taraf: Oyun Detayları -->
    <div class="col-lg-8">
      <div class="card glass-card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" role="tablist">
            {% for game_type in game_types %}
            <li class="nav-item" role="presentation">
              <button class="nav-link {% if loop.first %}active{% endif %}" 
                      id="{{ game_type }}-tab" 
                      data-bs-toggle="tab"
                      data-bs-target="#{{ game_type }}"
                      type="button"
                      role="tab">
                <i class="fas fa-{{ game_icons[game_type] }} me-2"></i>
                {{ game_names[game_type] }}
              </button>
            </li>
            {% endfor %}
          </ul>
        </div>

        <div class="card-body">
          <div class="tab-content">
            {% for game_type in game_types %}
            <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                 id="{{ game_type }}" 
                 role="tabpanel">

              <div class="game-stats-header">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="highest-score-display">
                      <div class="score-value">{{ game_stats[game_type].highest_score }}</div>
                      <div class="score-label">En Yüksek Puan</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="progress-container">
                      <div class="progress-info d-flex justify-content-between">
                        <span>Seviye İlerlemesi</span>
                        <span>{{ game_stats[game_type].progress }}%</span>
                      </div>
                      <div class="progress">
                        <div class="progress-bar" 
                             role="progressbar" 
                             style="width: {{ game_stats[game_type].progress }}%"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="game-history mt-4">
                <h5><i class="fas fa-history me-2"></i>Son Oyunlar</h5>
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Tarih</th>
                        <th>Puan</th>
                        <th>Süre</th>
                        <th>Seviye</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for game in game_stats[game_type].history %}
                      <tr>
                        <td>{{ game.date }}</td>
                        <td class="score">{{ game.score }}</td>
                        <td>{{ game.duration }}</td>
                        <td><span class="badge bg-primary">{{ game.level }}</span></td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profil Düzenleme Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-user-edit me-2"></i>Profili Düzenle
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="profileForm" action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data">
          <!-- Profil Fotoğrafı -->
          <div class="text-center mb-4">
            <div class="profile-upload-container">
              <img src="{{ user.avatar_url or '/static/images/default-avatar.png' }}" 
                   alt="Profil" 
                   class="profile-preview">
              <div class="upload-overlay">
                <i class="fas fa-camera"></i>
                <span>Fotoğraf Değiştir</span>
              </div>
            </div>
            <input type="file" 
                   id="avatar" 
                   name="avatar" 
                   accept="image/*" 
                   class="d-none">
          </div>

          <!-- Kullanıcı Bilgileri -->
          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-user me-2"></i>Kullanıcı Adı
            </label>
            <input type="text" 
                   class="form-control" 
                   name="username" 
                   value="{{ user.username }}"
                   required>
          </div>

          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-birthday-cake me-2"></i>Doğum Yılı
            </label>
            <input type="number" 
                   class="form-control" 
                   name="birth_year" 
                   value="{{ user.birth_year }}"
                   min="1900" 
                   max="2025">
          </div>

          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-map-marker-alt me-2"></i>Konum
            </label>
            <input type="text" 
                   class="form-control" 
                   name="location" 
                   value="{{ user.location }}">
          </div>

          <div class="mb-3">
            <label class="form-label">
              <i class="fas fa-info-circle me-2"></i>Hakkımda
            </label>
            <textarea class="form-control" 
                      name="bio" 
                      rows="3">{{ user.bio }}</textarea>
          </div>

          <div class="text-end">
            <button type="button" 
                    class="btn btn-secondary" 
                    data-bs-dismiss="modal">İptal</button>
            <button type="submit" 
                    class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Kaydet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Profil fotoğrafı yükleme işlemleri
  const avatarInput = document.getElementById('avatar');
  const profilePreview = document.querySelector('.profile-preview');
  const uploadOverlay = document.querySelector('.upload-overlay');

  if (uploadOverlay) {
    uploadOverlay.addEventListener('click', () => avatarInput.click());
  }

  if (avatarInput) {
    avatarInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];

        // Dosya boyutu kontrolü (max 500KB)
        if (file.size > 512000) {
          Swal.fire({
            icon: 'error',
            title: 'Dosya çok büyük',
            text: 'Lütfen 500KB\'dan küçük bir dosya seçin'
          });
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          profilePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Form gönderimi
  const profileForm = document.getElementById('profileForm');
  if (profileForm) {
    profileForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(this);

      fetch(this.action, {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Başarılı!',
            text: 'Profil bilgileriniz güncellendi',
            showConfirmButton: false,
            timer: 1500
          }).then(() => {
            location.reload();
          });
        } else {
          throw new Error(data.message || 'Bir hata oluştu');
        }
      })
      .catch(error => {
        Swal.fire({
          icon: 'error',
          title: 'Hata!',
          text: error.message
        });
      });
    });
  }
});
</script>
{% endblock %}

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Şifre Sıfırlama</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .password-strength {
      margin-top: 0.5rem;
      font-size: 0.85rem;
    }
    
    .strength-meter {
      height: 5px;
      border-radius: 3px;
      margin-top: 0.5rem;
      background: rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }
    
    .strength-meter-fill {
      height: 100%;
      width: 0;
      border-radius: 3px;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    
    .password-match {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      color: #94a3b8;
    }
    
    .match-icon {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .match-icon.visible {
      opacity: 1;
    }
    
    .match-success {
      color: #4CAF50;
    }
    
    .match-error {
      color: #f44336;
    }
  </style>
</head>
<body class="auth-only-body">
  <div class="fullscreen-auth">
    <div class="auth-container">
      <div class="auth-card glass-card">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="auth-logo-small">

        <div class="auth-header">
          <h2>Yeni Şifre Oluştur</h2>
          <p class="auth-subtitle">Lütfen yeni şifrenizi belirleyin</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category if category != '_' else 'info' }} alert-dismissible fade show">
                <i class="fas {% if category == 'danger' %}fa-exclamation-circle{% elif category == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('reset_password') }}" method="POST" class="auth-form">
          <input type="hidden" name="email" value="{{ email }}">
          <input type="hidden" name="token" value="{{ token }}">

          <div class="form-group floating-label">
            <div class="input-icon-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="password" name="password" class="form-control" placeholder=" " required minlength="6">
              <label for="password">Yeni Şifre</label>
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('password')">
                <i class="fas fa-eye" id="password-toggle-icon"></i>
              </button>
            </div>
            <div class="password-strength">
              <div class="strength-meter">
                <div class="strength-meter-fill" id="strength-meter-fill"></div>
              </div>
              <small class="form-text" id="password-strength-text">En az 6 karakter uzunluğunda olmalıdır</small>
            </div>
          </div>

          <div class="form-group floating-label">
            <div class="input-icon-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input type="password" id="confirm_password" name="confirm_password" class="form-control" placeholder=" " required minlength="6">
              <label for="confirm_password">Şifre Tekrar</label>
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirm_password')">
                <i class="fas fa-eye" id="confirm-password-toggle-icon"></i>
              </button>
            </div>
            <div class="password-match">
              <i class="fas fa-check-circle match-icon match-success" id="match-success"></i>
              <i class="fas fa-times-circle match-icon match-error" id="match-error"></i>
              <span id="match-text">Şifreler eşleşmelidir</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block btn-animated" id="submit-btn">
            <span class="btn-text">Şifreyi Değiştir</span>
            <i class="fas fa-check-circle btn-icon"></i>
          </button>
        </form>

        <div class="auth-links">
          <a href="{{ url_for('login') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Giriş Sayfasına Dön
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const passwordInput = document.getElementById('password');
      const confirmPasswordInput = document.getElementById('confirm_password');
      const strengthMeterFill = document.getElementById('strength-meter-fill');
      const strengthText = document.getElementById('password-strength-text');
      const matchSuccess = document.getElementById('match-success');
      const matchError = document.getElementById('match-error');
      const matchText = document.getElementById('match-text');
      const submitBtn = document.getElementById('submit-btn');
      const form = document.querySelector('.auth-form');
      
      let passwordsMatch = false;
      let passwordStrong = false;
      
      // Şifre gücünü ölç ve göster
      passwordInput.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        
        updateStrengthMeter(strength);
        checkPasswordMatch();
        updateSubmitButtonState();
      });
      
      // Şifre eşleşmesini kontrol et
      confirmPasswordInput.addEventListener('input', function() {
        checkPasswordMatch();
        updateSubmitButtonState();
      });
      
      function calculatePasswordStrength(password) {
        if (!password) return 0;
        
        let strength = 0;
        
        // Uzunluk kontrolü
        if (password.length >= 6) strength += 20;
        if (password.length >= 8) strength += 10;
        if (password.length >= 10) strength += 10;
        
        // Karakter çeşitliliği
        if (/[a-z]/.test(password)) strength += 15;
        if (/[A-Z]/.test(password)) strength += 15;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^a-zA-Z0-9]/.test(password)) strength += 15;
        
        return Math.min(strength, 100);
      }
      
      function updateStrengthMeter(strength) {
        let color, text;
        
        if (strength >= 80) {
          color = '#4CAF50'; // Güçlü - yeşil
          text = 'Güçlü şifre';
          passwordStrong = true;
        } else if (strength >= 50) {
          color = '#FF9800'; // Orta - turuncu
          text = 'Orta güçte şifre';
          passwordStrong = true;
        } else if (strength >= 30) {
          color = '#FFC107'; // Zayıf - sarı
          text = 'Zayıf şifre';
          passwordStrong = false;
        } else {
          color = '#F44336'; // Çok zayıf - kırmızı
          text = 'Çok zayıf şifre';
          passwordStrong = false;
        }
        
        strengthMeterFill.style.width = strength + '%';
        strengthMeterFill.style.backgroundColor = color;
        strengthText.textContent = text;
      }
      
      function checkPasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (!confirmPassword) {
          matchSuccess.classList.remove('visible');
          matchError.classList.remove('visible');
          matchText.textContent = 'Şifreler eşleşmelidir';
          passwordsMatch = false;
          return;
        }
        
        if (password === confirmPassword) {
          matchSuccess.classList.add('visible');
          matchError.classList.remove('visible');
          matchText.textContent = 'Şifreler eşleşiyor';
          matchText.className = 'match-success';
          passwordsMatch = true;
        } else {
          matchSuccess.classList.remove('visible');
          matchError.classList.add('visible');
          matchText.textContent = 'Şifreler eşleşmiyor';
          matchText.className = 'match-error';
          passwordsMatch = false;
        }
      }
      
      function updateSubmitButtonState() {
        const password = passwordInput.value;
        
        // Minimum şifre uzunluğu kontrolü
        const isLongEnough = password.length >= 6;
        
        // Butonun etkin/devre dışı durumunu güncelle
        if (isLongEnough && passwordsMatch) {
          submitBtn.disabled = false;
          submitBtn.classList.remove('disabled');
        } else {
          submitBtn.disabled = true;
          submitBtn.classList.add('disabled');
        }
      }
      
      // Form gönderimini kontrol et
      form.addEventListener('submit', function(e) {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (password.length < 6) {
          e.preventDefault();
          alert('Şifreniz en az 6 karakter uzunluğunda olmalıdır.');
          return;
        }
        
        if (password !== confirmPassword) {
          e.preventDefault();
          alert('Şifreler eşleşmiyor. Lütfen kontrol edin.');
          return;
        }
      });
    });
    
    // Şifre görünürlüğünü değiştir
    function togglePasswordVisibility(inputId) {
      const passwordInput = document.getElementById(inputId);
      const toggleIcon = document.getElementById(inputId === 'password' ? 'password-toggle-icon' : 'confirm-password-toggle-icon');

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.classList.replace('fa-eye', 'fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        toggleIcon.classList.replace('fa-eye-slash', 'fa-eye');
      }
    }
  </script>
</body>
</html>

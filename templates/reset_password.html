{% extends "layout.html" %}

{% block title %}OmGame - Şifre Sıfırlama{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
    .password-requirements {
        margin-top: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
        padding-left: 0.5rem;
    }
    
    .password-requirements ul {
        list-style: none;
        padding-left: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .password-requirements li {
        margin-bottom: 0.3rem;
        position: relative;
        padding-left: 1.5rem;
    }
    
    .password-requirements li::before {
        content: '•';
        position: absolute;
        left: 0;
        color: #8C66FF;
    }
    
    .password-strength-meter {
        height: 5px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        margin: 0.7rem 0;
    }
    
    .password-strength-meter div {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    
    .strength-weak {
        background: #ff4757;
        width: 25%;
    }
    
    .strength-medium {
        background: #ffa502;
        width: 50%;
    }
    
    .strength-good {
        background: #2ed573;
        width: 75%;
    }
    
    .strength-strong {
        background: #1e90ff;
        width: 100%;
    }
    
    .password-match-indicator {
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }
    
    .back-link {
        display: block;
        text-align: center;
        margin-top: 1.5rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
        text-decoration: none;
    }
    
    .back-link i {
        margin-right: 0.3rem;
    }
    
    .back-link:hover {
        color: #8C66FF;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card glass-card">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="OmGame Logo" class="auth-logo-small">
        
        <div class="auth-header">
            <h2>Şifre Yenileme</h2>
            <p class="auth-subtitle">Yeni şifrenizi belirleyin</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != '_' else 'info' }} alert-dismissible fade show">
                        <i class="fas {% if category == 'danger' %}fa-exclamation-circle{% elif category == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Kapat"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('reset_password', email=email, token=token) }}" class="auth-form" id="reset-password-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="email" value="{{ email }}">
            <input type="hidden" name="token" value="{{ token }}">
            
            <div class="form-group floating-label">
                <div class="input-icon-wrapper">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" name="password" id="password" class="form-control" placeholder=" " required>
                    <label for="password">Yeni Şifre</label>
                    <i class="fas fa-eye password-toggle" id="password-toggle-icon" onclick="togglePasswordVisibility('password')"></i>
                </div>
            </div>
            
            <div class="password-requirements">
                Şifreniz en az:
                <ul>
                    <li>4 karakter uzunluğunda olmalıdır</li>
                </ul>
            </div>
            
            <div class="form-group floating-label">
                <div class="input-icon-wrapper">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" name="confirm_password" id="confirm_password" class="form-control" placeholder=" " required>
                    <label for="confirm_password">Şifreyi Tekrarla</label>
                    <i class="fas fa-eye password-toggle" id="confirm-password-toggle-icon" onclick="togglePasswordVisibility('confirm_password')"></i>
                </div>
                <div id="password-match-indicator" class="password-match-indicator"></div>
            </div>

            <button type="submit" class="btn btn-primary btn-block">
                ŞİFRE SIFIRLA
            </button>
        </form>

        <a href="{{ url_for('login') }}" class="back-link">
            <i class="fas fa-arrow-left"></i> Giriş Sayfasına Dön
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function togglePasswordVisibility(inputId) {
        const passwordInput = document.getElementById(inputId);
        const iconId = inputId === 'password' ? 'password-toggle-icon' : 'confirm-password-toggle-icon';
        const toggleIcon = document.getElementById(iconId);
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    // Şifre uyumunu kontrol et
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const passwordMatchIndicator = document.getElementById('password-match-indicator');
    
    function checkPasswordMatch() {
        if (confirmPasswordInput.value === "") {
            passwordMatchIndicator.textContent = "";
            passwordMatchIndicator.className = "password-match-indicator";
        } else if (passwordInput.value === confirmPasswordInput.value) {
            passwordMatchIndicator.textContent = "Şifreler eşleşiyor";
            passwordMatchIndicator.className = "password-match-indicator text-success";
        } else {
            passwordMatchIndicator.textContent = "Şifreler eşleşmiyor";
            passwordMatchIndicator.className = "password-match-indicator text-danger";
        }
    }
    
    passwordInput.addEventListener('input', checkPasswordMatch);
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    
    // Form gönderilmeden önce kontrol et
    const form = document.getElementById('reset-password-form');
    form.addEventListener('submit', function(e) {
        if (passwordInput.value !== confirmPasswordInput.value) {
            e.preventDefault();
            alert('Şifreler eşleşmiyor. Lütfen kontrol edin.');
            return false;
        }
        return true;
    });
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}{{ get_current_user().username }} - Profil | OmGame{% endblock %}

{% block content %}
<div class="profile-container">
  <!-- Profile Card -->
  <div class="profile-card">
    <div class="avatar-section">
      {% if get_avatar_url() %}
      <img src="{{ url_for('static', filename=get_avatar_url()) }}" alt="{{ get_current_user().username }}" class="profile-avatar">
      {% else %}
      <div class="profile-avatar-placeholder">
        {{ get_current_user().username[0]|upper }}
      </div>
      {% endif %}
      <button class="avatar-upload-btn" data-bs-toggle="modal" data-bs-target="#avatarModal">
        <i class="fas fa-camera"></i>
      </button>
    </div>

    <div class="profile-info">
      <h2 class="username">{{ get_current_user().username }}</h2>
      <span class="user-status {{ get_current_user().account_status }}">
        {{ get_current_user().account_status|capitalize }}
      </span>
    </div>

    <div class="level-info">
      <div class="level-badge">
        <span class="level-number">{{ current_level }}</span>
        <span class="level-label">Level</span>
      </div>

      <div class="xp-bar-container">
        <div class="xp-bar">
          <div class="xp-progress" style="width: {{ xp_progress }}%"></div>
        </div>
        <div class="xp-text">
          {{ get_current_user().experience_points }} / {{ xp_for_next }} XP
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Tabs -->
  <div class="settings-container">
    <div class="settings-tabs">
      <button class="tab-btn active" data-tab="profile">Profil</button>
      <button class="tab-btn" data-tab="security">GÃ¼venlik</button>
      <button class="tab-btn" data-tab="notifications">Bildirimler</button>
    </div>

    <!-- Profile Tab -->
    <div class="tab-content active" id="profile-tab">
      <form class="settings-form" action="{{ url_for('update_profile') }}" method="post">
        <div class="form-group">
          <label>KullanÄ±cÄ± AdÄ±</label>
          <input type="text" name="username" value="{{ get_current_user().username }}">
        </div>
        <div class="form-group">
          <label>E-posta</label>
          <input type="email" name="email" value="{{ get_current_user().email }}">
        </div>
        <div class="form-group">
          <label>DoÄŸum YÄ±lÄ±</label>
          <input type="number" name="birth_year" value="{{ get_current_user().age }}">
        </div>
        <button type="submit" class="save-btn">Kaydet</button>
      </form>
    </div>

    <!-- Security Tab -->
    <div class="tab-content" id="security-tab">
      <form class="settings-form" action="{{ url_for('change_password') }}" method="post">
        <div class="form-group">
          <label>Mevcut Åžifre</label>
          <input type="password" name="current_password">
        </div>
        <div class="form-group">
          <label>Yeni Åžifre</label>
          <input type="password" name="new_password">
        </div>
        <div class="form-group">
          <label>Yeni Åžifre (Tekrar)</label>
          <input type="password" name="confirm_password">
        </div>
        <button type="submit" class="save-btn">Åžifreyi GÃ¼ncelle</button>
      </form>

      <div class="danger-zone">
        <h3>Tehlikeli BÃ¶lge</h3>
        <button class="danger-btn" data-bs-toggle="modal" data-bs-target="#suspendAccountModal">
          HesabÄ± Dondur
        </button>
        <button class="danger-btn" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
          HesabÄ± Sil
        </button>
      </div>
    </div>

    <!-- Notifications Tab -->
    <div class="tab-content" id="notifications-tab">
      <form class="settings-form" action="{{ url_for('update_notification_settings') }}" method="post">
        <div class="notification-option">
          <label class="switch">
            <input type="checkbox" name="email_notifications" 
                   {% if get_current_user().email_notifications %}checked{% endif %}>
            <span class="slider"></span>
          </label>
          <span>E-posta Bildirimleri</span>
        </div>
        <div class="notification-option">
          <label class="switch">
            <input type="checkbox" name="achievement_notifications"
                   {% if get_current_user().achievement_notifications %}checked{% endif %}>
            <span class="slider"></span>
          </label>
          <span>BaÅŸarÄ± Bildirimleri</span>
        </div>
        <button type="submit" class="save-btn">Kaydet</button>
      </form>
    </div>
  </div>
</div>

<!-- Level Up Modal -->
<div class="level-up-modal" id="levelUpModal">
  <div class="level-up-content">
    <div class="level-up-icon">ðŸŽ®</div>
    <h2>Level AtladÄ±n!</h2>
    <p>Tebrikler! Level <span id="newLevel"></span> oldun!</p>
  </div>
</div>

{% include 'partials/avatar_modal.html' %}
{% include 'partials/delete_account_modal.html' %}
{% include 'partials/suspend_account_modal.html' %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Tab switching
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));

      tab.classList.add('active');
      document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
    });
  });

  // Calculate XP progress for the progress bar
  const currentXP = {{ get_current_user().experience_points }};
  const xpForCurrent = {{ xp_for_current }};
  const xpForNext = {{ xp_for_next }};
  
  // Calculate percentage progress to next level
  const xpProgress = Math.min(100, Math.floor(((currentXP - xpForCurrent) / (xpForNext - xpForCurrent)) * 100));
  
  // Update XP progress bar
  const xpProgressBar = document.querySelector('.xp-progress');
  if (xpProgressBar) {
    xpProgressBar.style.width = xpProgress + '%';
  }

  // Level up animation
  function showLevelUp(level) {
    const modal = document.getElementById('levelUpModal');
    document.getElementById('newLevel').textContent = level;
    modal.classList.add('show');
    setTimeout(() => modal.classList.remove('show'), 3000);
  }


  // Password strength meter (merged and improved from original)
  const passwordInputs = document.querySelectorAll('input[type="password"]');
  passwordInputs.forEach(input => {
    input.addEventListener('input', function() {
      const parentForm = this.closest('form');
      const strengthMeter = parentForm.querySelector('.password-strength .progress-bar') || parentForm.querySelector('.strength-meter');
      const strengthText = parentForm.querySelector('#strength-text') || parentForm.querySelector('.strength-text span');

      if (strengthMeter && strengthText) {
        const strength = checkPasswordStrength(this.value);
        updatePasswordStrengthIndicator(strength, strengthMeter, strengthText);
      }
    });
  });

  function checkPasswordStrength(password) {
    let strength = 0;
    if (password.length < 6) return strength;
    if (password.length >= 8) strength += 1;
    if (password.length >= 12) strength += 1;
    if (/[A-Z]/.test(password)) strength += 1;
    if (/[a-z]/.test(password)) strength += 1;
    if (/[0-9]/.test(password)) strength += 1;
    if (/[^A-Za-z0-9]/.test(password)) strength += 1;
    return Math.min(5, strength);
  }

  function updatePasswordStrengthIndicator(strength, meter, text) {
    const strengthClasses = ['bg-danger', 'bg-warning', 'bg-info', 'bg-primary', 'bg-success'];
    const strengthLabels = ['Ã‡ok ZayÄ±f', 'ZayÄ±f', 'Orta', 'Ä°yi', 'MÃ¼kemmel'];

    meter.className = meter.classList.contains('progress-bar') ? 'progress-bar' : 'strength-meter';
    if (meter.classList.contains('progress-bar')) {
      meter.style.width = `${(strength / 5) * 100}%`;
      meter.classList.add(strengthClasses[Math.max(0, strength - 1)]);
    } else {
      meter.style.width = `${(strength / 5) * 100}%`;
      meter.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(strength <= 1 ? '--bs-danger' : strength <= 2 ? '--bs-warning' : strength <= 3 ? '--bs-info' : strength <= 4 ? '--bs-primary' : '--bs-success');
    }
    text.textContent = strengthLabels[Math.max(0, strength - 1)];
  }

  // Avatar preview functionality (from original)
  const avatarInput = document.getElementById('avatar');
  const avatarPreview = document.getElementById('avatar-preview');
  const removeAvatarBtn = document.getElementById('remove-avatar');

  if (avatarInput && avatarPreview) {
    avatarInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          if (avatarPreview.tagName.toLowerCase() === 'img') {
            avatarPreview.src = e.target.result;
          } else {
            const img = document.createElement('img');
            img.id = 'avatar-preview';
            img.className = 'profile-upload-preview';
            img.src = e.target.result;
            avatarPreview.parentNode.replaceChild(img, avatarPreview);
          }
        };
        reader.readAsDataURL(this.files[0]);
      }
    });
  }

  if (removeAvatarBtn && avatarPreview) {
    removeAvatarBtn.addEventListener('click', function() {
      if (avatarPreview.tagName.toLowerCase() === 'img') {
        const placeholder = document.createElement('div');
        placeholder.id = 'avatar-preview';
        placeholder.className = 'profile-upload-preview profile-avatar-placeholder';
        placeholder.innerHTML = '<i class="fas fa-user fa-3x"></i>';
        avatarPreview.parentNode.replaceChild(placeholder, avatarPreview);
      }
      if (avatarInput) {
        avatarInput.value = '';
      }
    });
  }

  // Theme toggle functionality (from original)
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('change', function() {
      const html = document.documentElement;
      if (this.checked) {
        html.classList.remove('dark');
        html.classList.add('light');
      } else {
        html.classList.remove('light');
        html.classList.add('dark');
      }
      fetch('/update-theme', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          theme: this.checked ? 'light' : 'dark'
        })
      });
    });
  }

  // Toggle password visibility (from original)
  const togglePasswordButtons = document.querySelectorAll('.toggle-password');
  togglePasswordButtons.forEach(button => {
    button.addEventListener('click', function() {
      const passwordInput = this.previousElementSibling;
      const icon = this.querySelector('i');
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });
  });
});
</script>
{% endblock %}
{% extends 'layout.html' %}

{% block title %}{{ user.username }} | Profil - OmGame{% endblock %}

{% block styles %}
<style>
  /* Animasyonlu avatarlar için stiller */
  .animated-avatars {
    margin-bottom: 20px;
  }
  
  .preset-avatar.animated {
    position: relative;
    transition: transform 0.3s ease;
    overflow: hidden;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .preset-avatar.animated:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    z-index: 2;
  }
  
  .preset-avatar.animated img {
    transition: all 0.3s ease;
  }
  
  .preset-avatar.animated:hover img {
    transform: scale(1.05);
  }
  
  .avatar-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(135deg, #ff7b00, #ff006a);
    color: white;
    font-size: 10px;
    font-weight: bold;
    padding: 3px 8px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 3;
    animation: pulse-badge 2s infinite;
  }
  
  @keyframes pulse-badge {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }
  
  /* Seçilen avatar için stil */
  .preset-avatar.animated.active {
    border: 3px solid #4CAF50;
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
  }
  
  .section-subtitle {
    font-size: 0.95rem;
    color: #666;
    margin-top: 10px;
    margin-bottom: 10px;
    font-weight: 600;
  }

  /* Bildirim stilleri */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    background: rgba(33, 37, 41, 0.9);
    color: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transform: translateY(-20px);
    opacity: 0;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    border-left: 5px solid #6a5ae0;
  }
  
  .notification.success {
    border-left-color: #28a745;
  }
  
  .notification.error {
    border-left-color: #dc3545;
  }
  
  .notification.show {
    transform: translateY(0);
    opacity: 1;
  }
  
  .notification-content {
    display: flex;
    align-items: center;
  }
  
  .notification-content i {
    margin-right: 10px;
    font-size: 1.2rem;
  }
  
  /* Avatar seçimi stilleri */
  .preset-avatar {
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 50%;
    overflow: hidden;
    transition: all 0.2s ease;
  }
  
  .preset-avatar:hover {
    transform: scale(1.05);
    border-color: rgba(106, 90, 224, 0.5);
    box-shadow: 0 0 10px rgba(106, 90, 224, 0.3);
  }
  
  .preset-avatar.active {
    border-color: #6a5ae0;
    box-shadow: 0 0 15px rgba(106, 90, 224, 0.5);
  }
  
  .avatar-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 50%;
    color: white;
    font-size: 1.5rem;
  }
  
  .profile-upload-preview:hover .avatar-overlay {
    opacity: 1;
  }
</style>
{% endblock %}

{% block content %}
<script>
window.addEventListener('error', function(e) {
  console.error("JavaScript Error:", e.message, "at line", e.lineno, "in", e.filename);
});
</script>
<div class="container profile-container">
  <div class="row">
    <!-- Sol Kolon - Profil Bilgileri -->
    <div class="col-lg-3">
      <div class="glass-card profile-card">
        <!-- Profil Resmi ve Statüsü -->
        <div class="profile-image-container">
          <div class="profile-avatar">
            {% if user.avatar_url %}
              <img src="{{ url_for('static', filename=user.avatar_url) }}" alt="{{ user.username }}" class="profile-img">
            {% else %}
              <div class="profile-avatar-placeholder">{{ user.username[0]|upper }}</div>
            {% endif %}
            <div class="profile-status online"></div>
          </div>
        </div>

        <!-- Kullanıcı Bilgileri -->
        <div class="profile-info">
          <h2 class="profile-name">{{ user.username }}</h2>
          <p class="profile-title">{{ user.rank }}</p>

          <!-- Seviye Bilgisi -->
          <div class="level-progress-container">
            <div class="level-badge">{{ current_level }}</div>
            <div class="level-progress-bar">
              <div class="level-progress" style="width: {{ ((user.experience_points - xp_for_current) / (xp_for_next - xp_for_current) * 100)|round }}%"></div>
            </div>
            <p class="level-text">{{ user.experience_points|int }} / {{ xp_for_next|int }} XP</p>
          </div>
          
          <!-- Kullanıcının sıralama bilgisi -->
          <div class="user-ranking-container mt-3">
            <div class="d-flex align-items-center justify-content-between">
              <div class="ranking-item" id="points-ranking-v2">
                <p class="ranking-title mb-0">Puan Sıralaması</p>
                <p class="ranking-value mb-0">
                  <span class="loading-spinner spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                  </span>
                </p>
              </div>
              <div class="ranking-item" id="level-ranking-v2">
                <p class="ranking-title mb-0">Seviye Sıralaması</p>
                <p class="ranking-value mb-0">
                  <span class="loading-spinner spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                  </span>
                </p>
              </div>
            </div>
          </div>
          
          <!-- Sıralama bilgisi için doğrudan script -->
          <script>
            // Sayfa yüklendiğinde sıralama bilgisini getir
            document.addEventListener('DOMContentLoaded', async function() {
              try {
                // Kullanıcı ID'sini al
                const currentUserId = {{ user.id }};
                
                // Sıralama bilgisini 1 saniye sonra getir
                setTimeout(async function() {
                  try {
                    // Puan sıralaması ve seviye sıralamasını getir
                    let pointRanking = null;
                    let levelRanking = null;
                    
                    try {
                      // Puan sıralaması
                      const pointsResponse = await fetch('/api/scores/aggregated?nocache=' + new Date().getTime());
                      if (!pointsResponse.ok) {
                        throw new Error('Puan sıralaması alınamadı: ' + pointsResponse.status);
                      }
                      const pointsText = await pointsResponse.text();
                      const pointsData = safeJSONParse(pointsText);
                      
                      if (Array.isArray(pointsData)) {
                        const pointIndex = pointsData.findIndex(user => user.is_current_user || user.user_id == currentUserId);
                        if (pointIndex >= 0) {
                          pointRanking = pointIndex + 1;
                        }
                      } else {
                        console.warn("Geçersiz puan sıralaması verisi:", pointsData);
                      }
                    } catch (error) {
                      console.error('Puan sıralaması alınırken hata:', error);
                    }
                    
                    try {
                      // Seviye sıralaması
                      const levelResponse = await fetch('/api/users/levels?limit=100&nocache=' + new Date().getTime());
                      if (!levelResponse.ok) {
                        throw new Error('Seviye sıralaması alınamadı: ' + levelResponse.status);
                      }
                      const levelText = await levelResponse.text();
                      const levelData = safeJSONParse(levelText);
                      
                      if (Array.isArray(levelData)) {
                        const levelIndex = levelData.findIndex(user => user.is_current_user || user.user_id == currentUserId);
                        if (levelIndex >= 0) {
                          levelRanking = levelIndex + 1;
                        }
                      } else {
                        console.warn("Geçersiz seviye sıralaması verisi:", levelData);
                      }
                    } catch (error) {
                      console.error('Seviye sıralaması alınırken hata:', error);
                    }
                    
                    // Puan sıralamasını göster
                    const pointsElement = document.querySelector('#points-ranking-v2 .ranking-value');
                    if (pointsElement) {
                      if (pointRanking) {
                        pointsElement.innerHTML = `<span class="rank-number">${pointRanking}.</span> sırada`;
                        
                        // İlk 10'da değilse özel stil ekle
                        if (pointRanking > 10) {
                          pointsElement.innerHTML += ' <small class="rank-info">(Top 10 dışında)</small>';
                        }
                      } else {
                        pointsElement.textContent = 'Henüz sıralamada değil';
                      }
                    }
                    
                    // Seviye sıralamasını göster
                    const levelElement = document.querySelector('#level-ranking-v2 .ranking-value');
                    if (levelElement) {
                      if (levelRanking) {
                        levelElement.innerHTML = `<span class="rank-number">${levelRanking}.</span> sırada`;
                        
                        // İlk 10'da değilse özel stil ekle
                        if (levelRanking > 10) {
                          levelElement.innerHTML += ' <small class="rank-info">(Top 10 dışında)</small>';
                        }
                      } else {
                        levelElement.textContent = 'Henüz sıralamada değil';
                      }
                    }
                  } catch (error) {
                    console.error('Sıralama bilgisi gösterilirken hata:', error);
                  }
                }, 1000);
              } catch (error) {
                console.error('Sıralama bilgisi gösterilirken hata:', error);
              }
            });
          </script>

          <!-- Toplam Oyun Puanı (Liderlik Tablosuna Yansıyan) -->
          <div class="total-score-container mt-3">
            <div class="d-flex align-items-center">
              <div class="score-icon me-2">
                <i class="fas fa-trophy"></i>
              </div>
              <div class="score-details">
                <p class="score-title mb-0">Liderlik Puanı</p>
                <p class="total-score-value mb-0" id="leaderboard-total-score">
                  <span class="loading-spinner spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Yükleniyor...</span>
                  </span>
                </p>
              </div>
            </div>
          </div>

          <!-- Puanı yüklemek için JavaScript -->
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              // Liderlik tablosu puanını getir - cache önleme ekle
              fetch('/api/leaderboard/all?nocache=' + new Date().getTime())
                .then(function(response) {
                  if (!response.ok) {
                    throw new Error('Ağ yanıtı başarısız: ' + response.status);
                  }
                  return response.text();
                })
                .then(function(text) {
                  // JSON hata yakalama ile parse et
                  const data = safeJSONParse(text);
                  const currentUserId = {{ user.id }};
                  
                  // Mevcut kullanıcının skorunu bul
                  let userScore = null;
                  if (Array.isArray(data)) {
                    userScore = data.find(function(score) { return score.user_id === currentUserId; });
                  } else {
                    console.warn("Beklenmeyen veri formatı, dizi değil:", data);
                  }

                  // Skoru göster
                  const scoreElement = document.getElementById('leaderboard-total-score');

                  if (userScore && userScore.total_score) {
                    // Mevcut değeri al
                    const currentScore = parseInt(scoreElement.textContent) || 0;

                    // Yeni skor farklıysa güncelle
                    if (currentScore !== userScore.total_score) {
                      // Yükleme animasyonunu kaldır
                      scoreElement.innerHTML = userScore.total_score;

                      // Puan değişimi animasyonu ekle
                      scoreElement.classList.add('score-change');

                      // Animasyonu bir süre sonra kaldır (tekrarlama için)
                      setTimeout(function() {
                        scoreElement.classList.remove('score-change');
                      }, 1500);

                      console.log("Kullanıcı puanı güncellendi: " + userScore.total_score);
                    }
                  } else {
                    scoreElement.textContent = '0';
                  }

                  // Tooltip ekle
                  scoreElement.setAttribute('title', 'Bu puan, tüm oyunlardaki en yüksek skorlarınızın toplamıdır ve liderlik tablosunda görünür.');
                })
                .catch(function(error) {
                  console.error('Puan bilgisi alınamadı:', error);
                  document.getElementById('leaderboard-total-score').textContent = '0';
                });
            });
          </script>
        </div>

        <!-- İstatistikler Kaldırıldı -->

        <!-- Kişisel Bilgiler -->
        <div class="personal-info-container">
          {% if user.full_name %}
          <div class="info-item">
            <i class="fas fa-user"></i>
            <span>{{ user.full_name }}</span>
          </div>
          {% endif %}

          {% if user.location %}
          <div class="info-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>{{ user.location }}</span>
          </div>
          {% endif %}

          <div class="info-item">
            <i class="fas fa-envelope"></i>
            <span>{{ user.email }}</span>
          </div>

          <div class="info-item">
            <i class="fas fa-calendar-alt"></i>
            <span>Kayıt: {{ user.created_at.strftime('%d.%m.%Y') }}</span>
          </div>
        </div>

        {% if user.bio %}
        <div class="bio-container">
          <h3 class="section-title">Hakkımda</h3>
          <p class="bio-text">{{ user.bio }}</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Sağ Kolon - Sekmeler -->
    <div class="col-lg-9">
      <div class="glass-card">
        <!-- Sekme Başlıkları -->
        <div class="profile-tab-container">
          <div class="tab-navigation">
            <button class="tab-button active" data-tab="security">
              <i class="fas fa-shield-alt"></i> Güvenlik
            </button>
            <button class="tab-button" data-tab="settings">
              <i class="fas fa-cog"></i> Ayarlar
            </button>
            <div class="tab-indicator"></div>
          </div>

          <!-- Sekme İçerikleri -->
          <div class="tab-content-container">

            <!-- Güvenlik Sekmesi -->
            <div class="tab-content active" id="security-tab">
              <h3 class="tab-title">Hesap Güvenliği</h3>

              <div class="security-settings">
                <!-- Şifre Değiştirme -->
                <div class="setting-card">
                  <div class="setting-header">
                    <div class="setting-icon">
                      <i class="fas fa-lock"></i>
                    </div>
                    <div class="setting-info">
                      <h4>Şifre Değiştir</h4>
                      <p>Hesabınızın güvenliği için şifrenizi düzenli olarak değiştirin</p>
                    </div>
                  </div>
                  <div class="setting-actions">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                      Şifre Değiştir
                    </button>
                  </div>
                </div>

                <!-- Email Güncelleme -->
                <div class="setting-card">
                  <div class="setting-header">
                    <div class="setting-icon">
                      <i class="fas fa-envelope"></i>
                    </div>
                    <div class="setting-info">
                      <h4>Email Adresi</h4>
                      <p>Mevcut email adresiniz: {{ user.email }}</p>
                    </div>
                  </div>
                  <div class="setting-actions">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changeEmailModal">
                      Email Değiştir
                    </button>
                  </div>
                </div>

                <!-- Hesap Silme -->
                <div class="setting-card danger-setting">
                  <div class="setting-header">
                    <div class="setting-icon danger">
                      <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="setting-info">
                      <h4>Hesabı Sil</h4>
                      <p>Hesabınız ve tüm verileriniz kalıcı olarak silinecektir</p>
                    </div>
                  </div>
                  <div class="setting-actions">
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                      Hesabı Sil
                    </button>
                  </div>
                </div>

                <!-- Hesabı Dondurma -->
                <div class="setting-card warning-setting">
                  <div class="setting-header">
                    <div class="setting-icon warning">
                      <i class="fas fa-snowflake"></i>
                    </div>
                    <div class="setting-info">
                      <h4>Hesabı Dondur</h4>
                      <p>Hesabınız geçici olarak devre dışı bırakılacak ve istediğiniz zaman tekrar aktifleştirebilirsiniz</p>
                    </div>
                  </div>
                  <div class="setting-actions">
                    <button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#suspendAccountModal">
                      Hesabı Dondur
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ayarlar Sekmesi -->
            <div class="tab-content" id="settings-tab">
              <h3 class="tab-title">Hesap Ayarları</h3>

              <div class="settings-container">
                <!-- Profil Bilgileri -->
                <div class="setting-section">
                  <h4 class="section-title">Profil Bilgileri</h4>

                  <form id="profile-form" action="{{ url_for('update_profile') }}" method="post" onsubmit="return handleProfileFormSubmit(event);">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="fullName" class="form-label">Ad Soyad</label>
                        <input type="text" class="form-control" id="fullName" name="full_name" value="{{ user.full_name or '' }}">
                      </div>
                      <div class="col-md-6">
                        <label for="username" class="form-label">Kullanıcı Adı</label>
                        <input type="text" class="form-control" id="username" name="username" value="{{ user.username }}" disabled>
                        <small class="text-muted">Kullanıcı adı değiştirilemez</small>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="location" class="form-label">Konum</label>
                        <input type="text" class="form-control" id="location" name="location" value="{{ user.location or '' }}">
                      </div>
                      <div class="col-md-6">
                        <label for="age" class="form-label">Yaş</label>
                        <input type="number" class="form-control" id="age" name="age" value="{{ user.age or '' }}">
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="bio" class="form-label">Hakkımda</label>
                      <textarea class="form-control" id="bio" name="bio" rows="3">{{ user.bio or '' }}</textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Değişiklikleri Kaydet
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Profil Fotoğrafı -->
                <div class="setting-section">
                  <h4 class="section-title">Profil Fotoğrafı</h4>

                  <form id="avatar-form" action="{{ url_for('update_avatar') }}" method="post" enctype="multipart/form-data" onsubmit="return handleAvatarFormSubmit(event);">
                    <input type="hidden" name="selected_avatar" id="selectedAvatar" value="{{ user.avatar_url if user.avatar_url else '' }}">
                    <div class="row align-items-center">
                      <div class="col-md-4">
                        <div class="profile-upload-preview">
                          {% if user.avatar_url %}
                            <img src="{{ url_for('static', filename=user.avatar_url) }}" alt="{{ user.username }}" id="avatar-preview">
                          {% else %}
                            <div class="avatar-placeholder" id="avatar-preview-placeholder">{{ user.username[0]|upper }}</div>
                          {% endif %}
                          <div class="avatar-overlay">
                            <i class="fas fa-camera"></i>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="mb-3">
                          <label for="avatarUpload" class="form-label">Fotoğraf Yükle</label>
                          <input class="form-control" type="file" id="avatarUpload" name="avatar" accept="image/*">
                          <small class="text-muted">Maksimum dosya boyutu: 5MB. İzin verilen formatlar: JPEG, PNG, GIF</small>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                          <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Fotoğrafı Güncelle
                          </button>
                          {% if user.avatar_url %}
                          <button type="button" class="btn btn-outline-danger" id="removeAvatar">
                            <i class="fas fa-trash-alt me-2"></i>Fotoğrafı Kaldır
                          </button>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </form>
                  <div class="avatar-gallery">
                    <h5 class="section-title">Hazır Avatarlar</h5>
                    
                    <!-- Yeni Animasyonlu Avatarlar -->
                    <h6 class="section-subtitle">Animasyonlu Modern Avatarlar</h6>
                    <div class="avatar-grid animated-avatars">
                      <div class="preset-avatar animated" data-avatar="avatars/animated/robot_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/robot_avatar.svg') }}" alt="Robot Avatar">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/digital_character.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/digital_character.svg') }}" alt="Dijital Karakter">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/cool_character.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/cool_character.svg') }}" alt="Cool Karakter">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <!-- Yeni Animasyonlu Avatarlar -->
                      <div class="preset-avatar animated" data-avatar="avatars/animated/wizard_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/wizard_avatar.svg') }}" alt="Büyücü Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/robot_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/robot_avatar.svg') }}" alt="Robot Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/cybercat_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/cybercat_avatar.svg') }}" alt="Siber Kedi Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/pirate_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/pirate_avatar.svg') }}" alt="Korsan Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/alien_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/alien_avatar.svg') }}" alt="Uzaylı Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/gamepad_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/gamepad_avatar.svg') }}" alt="Oyun Kumandası">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/snowspirit_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/snowspirit_avatar.svg') }}" alt="Kar Ruhu Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/fire_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/fire_avatar.svg') }}" alt="Ateş Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/rocker_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/rocker_avatar.svg') }}" alt="Rockçı Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/fairy_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/fairy_avatar.svg') }}" alt="Peri Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/ninja_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/ninja_avatar.svg') }}" alt="Ninja Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/photo_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/photo_avatar.svg') }}" alt="Fotoğraf Avatarı">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                      <div class="preset-avatar animated" data-avatar="avatars/animated/user_photo_avatar.svg">
                        <img src="{{ url_for('static', filename='avatars/animated/user_photo_avatar.svg') }}" alt="Gerçekçi Avatar">
                        <span class="avatar-badge">Yeni</span>
                      </div>
                    </div>
                    
                    <h6 class="section-subtitle mt-3">Standart Avatarlar</h6>
                    <div class="avatar-grid">
                      <!-- Bot Avatarları -->
                      <div class="preset-avatar" data-avatar="avatars/bots/avatar_male_1.svg">
                        <img src="{{ url_for('static', filename='avatars/bots/avatar_male_1.svg') }}" alt="Avatar 1">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/bots/avatar_male_2.svg">
                        <img src="{{ url_for('static', filename='avatars/bots/avatar_male_2.svg') }}" alt="Avatar 2">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/bots/avatar_male_3.svg">
                        <img src="{{ url_for('static', filename='avatars/bots/avatar_male_3.svg') }}" alt="Avatar 3">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/bots/avatar_female_1.svg">
                        <img src="{{ url_for('static', filename='avatars/bots/avatar_female_1.svg') }}" alt="Avatar 4">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/bots/avatar_female_2.svg">
                        <img src="{{ url_for('static', filename='avatars/bots/avatar_female_2.svg') }}" alt="Avatar 5">
                      </div>

                      <!-- Yeni Avatarlar -->
                      <div class="preset-avatar" data-avatar="avatars/avatar1.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar1.svg') }}" alt="Modern Avatar 1">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar2.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar2.svg') }}" alt="Modern Avatar 2">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar3.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar3.svg') }}" alt="Modern Avatar 3">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar4.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar4.svg') }}" alt="Modern Avatar 4">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar5.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar5.svg') }}" alt="Modern Avatar 5">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar6.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar6.svg') }}" alt="Modern Avatar 6">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar7.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar7.svg') }}" alt="Modern Avatar 7">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar8.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar8.svg') }}" alt="Modern Avatar 8">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar9.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar9.svg') }}" alt="Modern Avatar 9">
                      </div>
                      <div class="preset-avatar" data-avatar="avatars/avatar10.svg">
                        <img src="{{ url_for('static', filename='avatars/avatar10.svg') }}" alt="Modern Avatar 10">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Bildirim Ayarları -->
                <div class="setting-section">
                  <h4 class="section-title">Bildirim Ayarları</h4>

                  <form id="notification-form" action="{{ url_for('update_notification_settings') }}" method="post" onsubmit="return handleNotificationFormSubmit(event);">
                    <div class="notification-options">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="emailNotifications" name="email_notifications" {% if user.email_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="emailNotifications">
                          Email Bildirimleri
                          <small class="text-muted d-block">Önemli güncellemeler ve özel teklifler hakkında bildirimler alın</small>
                        </label>
                      </div>

                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="achievementNotifications" name="achievement_notifications" {% if user.achievement_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="achievementNotifications">
                          Başarı Bildirimleri
                          <small class="text-muted d-block">Yeni başarılar kazandığınızda bildirim alın</small>
                        </label>
                      </div>

                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="leaderboardNotifications" name="leaderboard_notifications" {% if user.leaderboard_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="leaderboardNotifications">
                          Skor Tablosu Bildirimleri
                          <small class="text-muted d-block">Skor tablolarındaki değişiklikler hakkında bildirim alın</small>
                        </label>
                      </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Bildirimleri Güncelle
                      </button>
                    </div>
                  </form>
                </div>

                <!-- Görünüm Ayarları bölümü kaldırıldı -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Şifre Değiştirme Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title" id="changePasswordModalLabel">Şifre Değiştir</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="change-password-form" action="{{ url_for('change_password') }}" method="post" onsubmit="return handlePasswordFormSubmit(event);">
          <div class="mb-3">
            <label for="currentPassword" class="form-label">Mevcut Şifre</label>
            <input type="password" class="form-control" id="currentPassword" name="current_password" required>
          </div>
          <div class="mb-3">
            <label for="newPassword" class="form-label">Yeni Şifre</label>
            <input type="password" class="form-control" id="newPassword" name="new_password" required>
            <small class="text-muted">Şifreniz en az 8 karakter olmalı ve en az bir rakam içermelidir</small>
          </div>
          <div class="mb-3">
            <label for="confirmPassword" class="form-label">Yeni Şifre (Tekrar)</label>
            <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Şifreyi Güncelle
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Email Değiştirme Modal -->
<div class="modal fade" id="changeEmailModal" tabindex="-1" aria-labelledby="changeEmailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title" id="changeEmailModalLabel">Email Değiştir</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="change-email-form" action="{{ url_for('update_security_settings') }}" method="post" onsubmit="return handleEmailFormSubmit(event);">
          <div class="mb-3">
            <label for="currentEmail" class="form-label">Mevcut Email</label>
            <input type="email" class="form-control" id="currentEmail" value="{{ user.email }}" disabled>
          </div>
          <div class="mb-3">
            <label for="newEmail" class="form-label">Yeni Email</label>
            <input type="email" class="form-control" id="newEmail" name="new_email" required>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Şifreniz</label>
            <input type="password" class="form-control" id="password" name="password" required>
            <small class="text-muted">Güvenlik için lütfen şifrenizi girin</small>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-2"></i>Email'i Güncelle
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Hesap Silme Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteAccountModalLabel">Hesabı Sil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Dikkat:</strong> Hesabınızı silmek tüm verilerinizi kalıcı olarak silecektir. Bu işlem geri alınamaz.
        </div>
        <form id="delete-account-form" action="{{ url_for('delete_account') }}" method="post" onsubmit="return handleDeleteAccountForm(event);">
          <div class="mb-3">
            <label for="confirmDelete" class="form-label">Onaylamak için "SİL" yazın</label>
            <input type="text" class="form-control" id="confirmDelete" name="confirm_delete" required>
          </div>
          <div class="mb-3">
            <label for="deletePassword" class="form-label">Şifreniz</label>
            <input type="password" class="form-control" id="deletePassword" name="password" required>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-danger">
              <i class="fas fa-trash-alt me-2"></i>Hesabı Kalıcı Olarak Sil
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Hesabı Dondurma Modal -->
<div class="modal fade" id="suspendAccountModal" tabindex="-1" aria-labelledby="suspendAccountModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-card">
      <div class="modal-header">
        <h5 class="modal-title" id="suspendAccountModalLabel">Hesabı Dondur</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-snowflake me-2"></i>
          <strong>Bilgi:</strong> Hesabınızı dondurduğunuzda tekrar giriş yapana kadar hesabınız devre dışı kalacaktır.
        </div>
        <form id="suspend-account-form" action="{{ url_for('suspend_account') }}" method="post" onsubmit="return handleSuspendAccountForm(event);">
          <div class="mb-3">
            <label for="suspendDuration" class="form-label">Dondurma Süresi</label>
            <select class="form-select" id="suspendDuration" name="suspend_duration">
              <option value="1">1 Hafta</option>
              <option value="2">2 Hafta</option>
              <option value="4">1 Ay</option>
              <option value="12">3 Ay</option>
              <option value="0">Tekrar giriş yapana kadar</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="suspendPassword" class="form-label">Şifreniz</label>
            <input type="password" class="form-control" id="suspendPassword" name="password" required>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-warning">
              <i class="fas fa-snowflake me-2"></i>Hesabı Dondur
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Debug kodu - sayfa yüklendiğinde
console.log('Profil sayfası (v2) yükleniyor...');
// JavaScript hata yakalama
window.addEventListener('error', function(e) {
  console.error('JavaScript hatası (Profil V2):', e.message, 'Satır:', e.lineno, 'Dosya:', e.filename);
});

// Global hata ayıklama helper fonksiyonu - Unexpected token hatalarını azaltmak için
function safeJSONParse(str) {
  try {
    return JSON.parse(str);
  } catch (e) {
    console.error('JSON ayrıştırma hatası:', e.message);
    return {};
  }
}
</script>
<script>
  // Form işlemleri için yardımcı fonksiyonlar
  function handleProfileFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('Form gönderme hatası:', error);
      showNotification('İstek gönderilirken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  function handleAvatarFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Dosya yükleme kontrolü
    const fileInput = document.getElementById('avatarUpload');
    if (fileInput && fileInput.files && fileInput.files.length > 0) {
      const file = fileInput.files[0];
      console.log("Yüklenen dosya:", file.name, "Boyut:", file.size, "Tip:", file.type);
      
      // Dosya formata ekle
      formData.append('avatar_file', file);
    }

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
        
        // Avatar güncellenirse ve avatarUrl varsa, profil resmini güncelle
        if (data.avatar_url) {
          updateAvatarPreview(data.avatar_url);
        }
        
        // 2 saniye sonra sayfayı yenile
        setTimeout(function() {
          window.location.reload();
        }, 2000);
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('Avatar güncelleme hatası:', error);
      showNotification('Avatar güncellenirken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  function handleNotificationFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('Bildirim ayarları güncelleme hatası:', error);
      showNotification('Bildirim ayarları güncellenirken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  // Tema değiştirme özelliği kaldırıldı
  
  function handlePasswordFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    
    // Şifre eşleşme kontrolü
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
      showNotification('Yeni şifre ve tekrarı eşleşmiyor!', 'error');
      return false;
    }
    
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
        // Modal'ı kapat
        const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
        if (modal) {
          modal.hide();
        }
        // Formu temizle
        form.reset();
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('Şifre değiştirme hatası:', error);
      showNotification('Şifre değiştirilirken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  function handleDeleteAccountForm(event) {
    event.preventDefault();
    const form = event.target;
    
    // SİL yazıp yazmadığını kontrol et
    const confirmText = document.getElementById('confirmDelete').value;
    if (confirmText !== 'SİL') {
      showNotification('Hesabı silmek için "SİL" yazmalısınız!', 'error');
      return false;
    }
    
    // Onay sorgusu
    if (!confirm('Hesabınızı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
      return false;
    }
    
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
        // Kullanıcı çıkış yapacağı için ana sayfaya yönlendir
        setTimeout(function() {
          window.location.href = '/';
        }, 2000);
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('Hesap silme hatası:', error);
      showNotification('Hesap silerken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  function handleEmailFormSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
        // Modal'ı kapat
        const modal = bootstrap.Modal.getInstance(document.getElementById('changeEmailModal'));
        if (modal) {
          modal.hide();
        }
        // Formu temizle
        form.reset();
        
        // E-posta değiştiği için sayfayı yenilememiz gerekebilir
        if (data.refresh) {
          setTimeout(function() {
            window.location.reload();
          }, 2000);
        }
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('E-posta değiştirme hatası:', error);
      showNotification('E-posta değiştirilirken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  function handleSuspendAccountForm(event) {
    event.preventDefault();
    const form = event.target;
    
    // Onay sorgusu
    if (!confirm('Hesabınızı dondurmak istediğinize emin misiniz? Tekrar giriş yapana kadar hesabınıza erişemeyeceksiniz.')) {
      return false;
    }
    
    const formData = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: formData
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        showNotification(data.message, 'success');
        // Kullanıcı çıkış yapacağı için ana sayfaya yönlendir
        setTimeout(function() {
          window.location.href = '/';
        }, 2000);
      } else {
        showNotification(data.message || 'Bir hata oluştu!', 'error');
      }
    })
    .catch(function(error) {
      console.error('Hesap dondurma hatası:', error);
      showNotification('Hesap dondurulurken bir sorun oluştu!', 'error');
    });
    
    return false;
  }
  
  function updateAvatarPreview(avatarUrl) {
    if (!avatarUrl) {
      return;
    }
  
    const previewImage = document.getElementById('avatar-preview');
    const previewPlaceholder = document.getElementById('avatar-preview-placeholder');
    
    // Avatar URL'ini düzelt
    let fullAvatarUrl = avatarUrl;
    if (!avatarUrl.startsWith('http') && !avatarUrl.startsWith('/')) {
      fullAvatarUrl = '/static/' + avatarUrl;
    } else if (avatarUrl.startsWith('/')) {
      // Zaten tam yol, değiştirme
      fullAvatarUrl = avatarUrl;
    }
    
    if (previewImage) {
      previewImage.src = fullAvatarUrl;
      previewImage.style.display = 'block';
      
      if (previewPlaceholder) {
        previewPlaceholder.style.display = 'none';
      }
    } else {
      // Önizleme resmi yoksa oluştur
      const newPreviewImage = document.createElement('img');
      newPreviewImage.src = fullAvatarUrl;
      newPreviewImage.id = 'avatar-preview';
      newPreviewImage.alt = 'Profil Önizleme';
      
      const previewContainer = document.querySelector('.profile-upload-preview');
      if (previewContainer) {
        if (previewPlaceholder) {
          previewPlaceholder.style.display = 'none';
        }
        previewContainer.insertBefore(newPreviewImage, previewContainer.firstChild);
      }
    }
  }
  
  // Bildirim göster
  function showNotification(message, type = 'success') {
    // Varsa eski bildirimi temizle
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(function(notification) {
      notification.remove();
    });
    
    // Yeni bildirim oluştur
    const notificationContainer = document.createElement('div');
    notificationContainer.className = `notification ${type}`;
    notificationContainer.innerHTML = `
      <div class="notification-content">
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${message}</span>
      </div>
    `;
    
    document.body.appendChild(notificationContainer);
    
    // Animasyon ile göster
    setTimeout(function() {
      notificationContainer.classList.add('show');
    }, 10);
    
    // 3 saniye sonra kaldır
    setTimeout(function() {
      notificationContainer.classList.remove('show');
      setTimeout(function() {
        notificationContainer.remove();
      }, 300);
    }, 3000);
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Tab navigasyonu
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const tabIndicator = document.querySelector('.tab-indicator');

    function positionTabIndicator(activeTab) {
      if (!tabIndicator || !activeTab) return;

      const tabLeft = activeTab.offsetLeft;
      const tabWidth = activeTab.offsetWidth;

      tabIndicator.style.width = `${tabWidth}px`;
      tabIndicator.style.left = `${tabLeft}px`;
    }

    // İlk yüklemede aktif sekmenin altını çiz
    const activeTab = document.querySelector('.tab-button.active');
    if (activeTab) {
      positionTabIndicator(activeTab);
    }

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Aktif sekme sınıfını kaldır
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));

        // Tıklanan sekmeyi ve içeriğini aktifleştir
        button.classList.add('active');
        const tabId = `${button.dataset.tab}-tab`;
        document.getElementById(tabId).classList.add('active');

        // Tab göstergesini konumlandır
        positionTabIndicator(button);
      });
    });

    // Profil resmi önizleme
    const avatarUpload = document.getElementById('avatarUpload');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarPlaceholder = document.getElementById('avatar-preview-placeholder');

    if (avatarUpload) {
      avatarUpload.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const reader = new FileReader();

          reader.onload = function(e) {
            if (avatarPreview) {
              avatarPreview.src = e.target.result;
              avatarPreview.style.display = 'block';
            }
            if (avatarPlaceholder) {
              avatarPlaceholder.style.display = 'none';
            }
          }

          reader.readAsDataURL(this.files[0]);
        }
      });
    }

    // Tema seçimi için event listener
    const themeOptions = document.querySelectorAll('.theme-option-card');
    themeOptions.forEach(option => {
      option.addEventListener('click', function() {
        themeOptions.forEach(opt => opt.classList.remove('active'));
        this.classList.add('active');
        const themeInput = this.querySelector('input[type="radio"]');
        if (themeInput) {
          themeInput.checked = true;
        }
      });
    });
    
    // Hazır avatar seçimi
    const presetAvatars = document.querySelectorAll('.preset-avatar');
    presetAvatars.forEach(avatar => {
      avatar.addEventListener('click', function() {
        // Seçimi görsel olarak göster
        presetAvatars.forEach(a => a.classList.remove('selected'));
        this.classList.add('selected');
        
        // Seçilen avatarı gizli input alanına kaydet
        const selectedAvatar = this.getAttribute('data-avatar');
        document.getElementById('selectedAvatar').value = selectedAvatar;
        
        // Avatar önizlemesini güncelle
        updateAvatarPreview(selectedAvatar);
        
        // Bildirim göster
        showNotification('Avatar seçildi. Kaydetmek için "Fotoğrafı Güncelle" butonuna tıklayın.', 'info');
      });
    });

    // Form işleyicileri artık handlePasswordFormSubmit ve handleDeleteAccountForm ile işleniyor
    // Bu yüzden eski doğrulama kodları kaldırıldı

    // Bildirim formunu otomatik gönder
    const notificationSwitches = document.querySelectorAll('#notification-form .form-check-input');
    notificationSwitches.forEach(switchElement => {
      switchElement.addEventListener('change', function() {
        // Formu otomatik gönder
        document.getElementById('notification-form').submit();
      });
    });
  });

  // Oyun skorlarını görüntülemek için JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    // Oyunların Türkçe isimleri
    const gameNames = {
      "wordle": "Wordle",
      "tetris": "Tetris",
      "chess": "Satranç",
      "snake_game": "Yılan Oyunu",
      "puzzle": "Bulmaca",
      "minesweeper": "Mayın Tarlası",
      "memory_match": "Hafıza Eşleştirme",
      "memoryCards": "Hafıza Kartları",
      "hangman": "Adam Asmaca",
      "color_match": "Renk Eşleştirme",
      "audioMemory": "Sesli Hafıza",
      "typing_speed": "Yazma Hızı",
      "math_challenge": "Matematik Mücadelesi",
      "2048": "2048",
      "numberChain": "Sayı Zinciri",
      "nBack": "N-Back",
      "wordPuzzle": "Kelime Bulmaca",
      "puzzle_slider": "Resim Bulmaca",
      "sudoku": "Sudoku",
      "numberSequence": "Sayı Dizisi",
      "labyrinth": "3D Labirent",
      "iqTest": "IQ Testi",
      "simonSays": "Simon Diyor ki"
    };

    // Zorluk seviyelerinin Türkçe karşılıkları
    const difficultyNames = {
      "easy": "Kolay",
      "medium": "Orta",
      "hard": "Zor",
      "expert": "Uzman"
    };

    // Tüm skorları getir
    function getAllScores() {
      fetch('/api/aggregated-scores')
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data && data.success) {
            displayScores(data.scores);
            updateScoreStats(data.scores);
          } else {
            // Hata durumunda boş göster
            displayNoScores();
          }
        })
        .catch(function(error) {
          console.error('Skorlar alınırken hata oluştu:', error);
          displayNoScores();
        });
    }

    // Skorları tabloda göster
    function displayScores(scores) {
      const tbody = document.getElementById('game-scores-tbody');

      // Tabloyu temizle
      tbody.innerHTML = '';

      if (!scores || Object.keys(scores).length === 0) {
        displayNoScores();
        return;
      }

      // Her oyun için skoru listele
      Object.keys(scores).forEach(function(gameType) {
        const gameScore = scores[gameType];
        if (!gameScore) { return; } // Veri yoksa atla

        const row = document.createElement('tr');

        // Oyun adı
        const nameCell = document.createElement('td');
        nameCell.className = 'game-name';

        const gameIcon = document.createElement('span');
        gameIcon.className = 'game-icon';
        gameIcon.innerHTML = getGameIcon(gameType);

        const gameName = document.createElement('span');
        gameName.textContent = gameNames[gameType] || gameType;

        nameCell.appendChild(gameIcon);
        nameCell.appendChild(gameName);

        // En yüksek puan
        const scoreCell = document.createElement('td');
        scoreCell.className = 'game-score';
        scoreCell.innerHTML = `<span class="score-value">${gameScore.highest_score}</span>`;

        // Zorluk seviyesi
        const difficultyCell = document.createElement('td');
        const difficulty = gameScore.difficulty || 'medium';
        difficultyCell.innerHTML = `<span class="difficulty-badge ${difficulty}">${difficultyNames[difficulty] || difficulty}</span>`;

        // Son oynanma tarihi
        const lastPlayedCell = document.createElement('td');
        lastPlayedCell.textContent = formatDate(gameScore.last_played);

        // Detay butonu
        const detailCell = document.createElement('td');
        const detailButton = document.createElement('button');
        detailButton.className = 'btn btn-sm btn-outline-primary';
        detailButton.innerHTML = '<i class="fas fa-chart-line"></i>';
        detailButton.setAttribute('data-game-type', gameType);
        detailButton.onclick = function() {
          showGameDetails(gameType);
        };

        detailCell.appendChild(detailButton);

        // Tüm hücreleri satıra ekle
        row.appendChild(nameCell);
        row.appendChild(scoreCell);
        row.appendChild(difficultyCell);
        row.appendChild(lastPlayedCell);
        row.appendChild(detailCell);

        // Satırı tabloya ekle
        tbody.appendChild(row);
      });
    }

    // Skor istatistiklerini güncelle
    function updateScoreStats(scores) {
      // Toplam puan hesapla
      let totalPoints = 0;
      let playedGamesCount = 0;

      Object.keys(scores).forEach(function(gameType) {
        if (scores[gameType]) {
          // Standardize edilmiş skorları (adjusted_score) kullan
          const gameScore = scores[gameType].adjusted_score || scores[gameType].highest_score || 0;
          totalPoints += gameScore;
          playedGamesCount++;
        }
      });

      // İstatistikleri göster
      document.getElementById('total-game-points').textContent = totalPoints;
      document.getElementById('played-games-count').textContent = playedGamesCount;
    }

    // Skor yoksa mesaj göster
    function displayNoScores() {
      const tbody = document.getElementById('game-scores-tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center no-data">
            <i class="fas fa-gamepad mb-2"></i>
            <p>Henüz oyun skorunuz bulunmuyor</p>
            <a href="/all_games" class="btn btn-primary btn-sm mt-2">Oyunları Keşfet</a>
          </td>
        </tr>
      `;

      // İstatistikleri sıfırla
      document.getElementById('total-game-points').textContent = '0';
      document.getElementById('played-games-count').textContent = '0';
    }

    // Oyun ikonunu getir
    function getGameIcon(gameType) {
      const icons = {
        "wordle": '<i class="fas fa-font"></i>',
        "tetris": '<i class="fas fa-th-large"></i>',
        "chess": '<i class="fas fa-chess"></i>',
        "snake_game": '<i class="fas fa-project-diagram"></i>',
        "puzzle": '<i class="fas fa-puzzle-piece"></i>',
        "minesweeper": '<i class="fas fa-bomb"></i>',
        "memory_match": '<i class="fas fa-th"></i>',
        "memoryCards": '<i class="fas fa-clone"></i>',
        "hangman": '<i class="fas fa-male"></i>',
        "color_match": '<i class="fas fa-palette"></i>',
        "audioMemory": '<i class="fas fa-music"></i>',
        "typing_speed": '<i class="fas fa-keyboard"></i>',
        "math_challenge": '<i class="fas fa-calculator"></i>',
        "2048": '<i class="fas fa-sort-numeric-up"></i>',
        "numberChain": '<i class="fas fa-link"></i>',
        "nBack": '<i class="fas fa-brain"></i>',
        "wordPuzzle": '<i class="fas fa-spell-check"></i>',
        "puzzle_slider": '<i class="fas fa-th"></i>',
        "sudoku": '<i class="fas fa-table"></i>',
        "numberSequence": '<i class="fas fa-list-ol"></i>',
        "labyrinth": '<i class="fas fa-cubes"></i>',
        "iqTest": '<i class="fas fa-lightbulb"></i>',
        "simonSays": '<i class="fas fa-gamepad"></i>'
      };

      return icons[gameType] || '<i class="fas fa-gamepad"></i>';
    }

    // Tarihi formatla
    function formatDate(dateString) {
      if (!dateString) return 'Bilinmiyor';

      const date = new Date(dateString);

      // Geçersiz tarih kontrolü
      if (isNaN(date.getTime())) return 'Bilinmiyor';

      return date.toLocaleDateString('tr-TR', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Oyun detaylarını göster
    function showGameDetails(gameType) {
      // Bu fonksiyon, gelecekte oyun detaylarının gösterilmesi için kullanılabilir
      alert(`${gameNames[gameType] || gameType} detayları yakında burada gösterilecek!`);

      // Burada olabilecek işlemler:
      // 1. Modal açılabilir
      // 2. Detaylı istatistikler yüklenebilir
      // 3. Gelişim grafiği gösterilebilir
    }

    // İlk yüklemede skorları getir
    getAllScores();

    // ===== AVATAR İŞLEVSELLİĞİ =====
    
    // Bildirim fonksiyonu
    function showNotification(message, type = 'success') {
      const notificationContainer = document.createElement('div');
      notificationContainer.className = `notification ${type}`;
      notificationContainer.innerHTML = `
        <div class="notification-content">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
          <span>${message}</span>
        </div>
      `;
      
      document.body.appendChild(notificationContainer);
      
      // Animasyon ile göster
      setTimeout(function() {
        notificationContainer.classList.add('show');
      }, 10);
      
      // 3 saniye sonra kaldır
      setTimeout(function() {
        notificationContainer.classList.remove('show');
        setTimeout(function() {
          document.body.removeChild(notificationContainer);
        }, 300);
      }, 3000);
    }
    
    // Fotoğraf önizleme
    const avatarUpload = document.getElementById('avatarUpload');
    if (avatarUpload) {
      avatarUpload.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const previewPlaceholder = document.getElementById('avatar-preview-placeholder');
            const previewImage = document.getElementById('avatar-preview');
            
            if (previewImage) {
              previewImage.src = e.target.result;
              previewImage.style.display = 'block';
              if (previewPlaceholder) {
                previewPlaceholder.style.display = 'none';
              }
            } else {
              // Eğer önizleme resmi yoksa oluştur
              const newPreviewImage = document.createElement('img');
              newPreviewImage.src = e.target.result;
              newPreviewImage.id = 'avatar-preview';
              newPreviewImage.alt = 'Profil Önizleme';
              
              const previewContainer = document.querySelector('.profile-upload-preview');
              if (previewContainer) {
                previewPlaceholder.style.display = 'none';
                previewContainer.insertBefore(newPreviewImage, previewContainer.firstChild);
              }
            }
          };
          
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Fotoğraf silme butonu
    const removeAvatarButton = document.getElementById('removeAvatar');
    if (removeAvatarButton) {
      removeAvatarButton.addEventListener('click', function() {
        if (confirm('Profil fotoğrafınızı silmek istediğinize emin misiniz?')) {
          // Avatar silme isteği gönder
          fetch('/profile/remove/avatar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Avatar kaldırıldı, UI'ı güncelle
              const previewImage = document.getElementById('avatar-preview');
              const previewPlaceholder = document.getElementById('avatar-preview-placeholder');
              
              if (previewImage) {
                previewImage.style.display = 'none';
              }
              
              if (previewPlaceholder) {
                previewPlaceholder.style.display = 'flex';
              } else {
                // Placeholder yoksa oluştur
                const newPlaceholder = document.createElement('div');
                newPlaceholder.id = 'avatar-preview-placeholder';
                newPlaceholder.className = 'avatar-placeholder';
                newPlaceholder.textContent = '{{ user.username[0]|upper }}';
                
                const previewContainer = document.querySelector('.profile-upload-preview');
                if (previewContainer) {
                  previewContainer.appendChild(newPlaceholder);
                }
              }
              
              // Silme butonunu gizle
              removeAvatarButton.style.display = 'none';
              
              // Kullanıcıya bildirim göster
              showNotification('Profil fotoğrafı başarıyla kaldırıldı!', 'success');
              
              // 1 saniye sonra sayfayı yenile
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              // Hata mesajı göster
              showNotification(data.message || 'Bir hata oluştu!', 'error');
            }
          })
          .catch(error => {
            console.error('Avatar kaldırma hatası:', error);
            showNotification('Profil fotoğrafı kaldırılırken bir sorun oluştu!', 'error');
          });
        }
      });
    }
    
    // Hazır avatar seçimi
    const presetAvatars = document.querySelectorAll('.preset-avatar');
    const selectedAvatarInput = document.getElementById('selectedAvatar');
    
    presetAvatars.forEach(function(avatar) {
      avatar.addEventListener('click', function() {
        // Seçilen avatar path'ini al
        const avatarPath = this.getAttribute('data-avatar');
        
        if (avatarPath && selectedAvatarInput) {
          // Seçilen avatar'ı form input'a kaydet
          selectedAvatarInput.value = avatarPath;
          
          // Diğer avatarlardan 'active' sınıfını kaldır
          presetAvatars.forEach(function(a) { a.classList.remove('active'); });
          
          // Seçilen avatar'a 'active' sınıfı ekle
          this.classList.add('active');
          
          // Avatar seçimi için form gönder
          fetch('/profile/update/avatar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              selected_avatar: avatarPath
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Avatar güncellendi, UI'ı güncelle
              const previewImage = document.getElementById('avatar-preview');
              const previewPlaceholder = document.getElementById('avatar-preview-placeholder');
              
              if (previewImage) {
                previewImage.src = '/static/' + avatarPath;
                previewImage.style.display = 'block';
                
                if (previewPlaceholder) {
                  previewPlaceholder.style.display = 'none';
                }
              } else {
                // Önizleme resmi yoksa oluştur
                const newPreviewImage = document.createElement('img');
                newPreviewImage.src = '/static/' + avatarPath;
                newPreviewImage.id = 'avatar-preview';
                newPreviewImage.alt = 'Profil Önizleme';
                
                const previewContainer = document.querySelector('.profile-upload-preview');
                if (previewContainer) {
                  if (previewPlaceholder) {
                    previewPlaceholder.style.display = 'none';
                  }
                  previewContainer.insertBefore(newPreviewImage, previewContainer.firstChild);
                }
              }
              
              // Silme butonunu göster
              if (removeAvatarButton) {
                removeAvatarButton.style.display = 'inline-block';
              }
              
              // Kullanıcıya bildirim göster
              showNotification('Avatar başarıyla güncellendi!', 'success');
              
              // 1 saniye sonra sayfayı yenile
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              // Hata mesajı göster
              showNotification(data.message || 'Bir hata oluştu!', 'error');
            }
          })
          .catch(error => {
            console.error('Avatar güncelleme hatası:', error);
            showNotification('Avatar güncellenirken bir sorun oluştu!', 'error');
          });
        }
      });
    });
  });
</script>
{% endblock %}

{% extends 'layout.html' %}

{% block title %}Matematik Mücadelesi - OmGame{% endblock %}

{% block content %}
<div class="game-container">
  <div class="game-header">
    <h1>Matematik Mücadelesi <span class="badge">Sayısal Beceri</span></h1>
    <p class="game-description">Hızlı düşünme ve matematiksel becerilerinizi test edin.</p>
  </div>

  <div class="math-modern-container">
    <div id="start-screen" class="math-screen">
      <h2>Matematik Mücadelesine Hoş Geldiniz!</h2>
      <p>Verilen süre içinde matematik problemlerini çözmeye çalışın.</p>
      
      <div class="game-options">
        <div class="option-section">
          <h3>Zorluk Seviyesi</h3>
          <div class="button-group">
            <button class="option-button active" data-difficulty="easy">Kolay</button>
            <button class="option-button" data-difficulty="medium">Orta</button>
            <button class="option-button" data-difficulty="hard">Zor</button>
          </div>
        </div>
        
        <div class="option-section">
          <h3>Süre</h3>
          <div class="button-group">
            <button class="option-button" data-time="30">30 Saniye</button>
            <button class="option-button active" data-time="60">60 Saniye</button>
            <button class="option-button" data-time="120">2 Dakika</button>
          </div>
        </div>
        
        <div class="option-section">
          <h3>İşlem Türleri</h3>
          <div class="operation-options">
            <label class="checkbox-container">
              <input type="checkbox" checked data-operation="addition">
              <span class="checkmark"></span>
              <span class="option-label">Toplama</span>
            </label>
            <label class="checkbox-container">
              <input type="checkbox" checked data-operation="subtraction">
              <span class="checkmark"></span>
              <span class="option-label">Çıkarma</span>
            </label>
            <label class="checkbox-container">
              <input type="checkbox" checked data-operation="multiplication">
              <span class="checkmark"></span>
              <span class="option-label">Çarpma</span>
            </label>
            <label class="checkbox-container">
              <input type="checkbox" data-operation="division">
              <span class="checkmark"></span>
              <span class="option-label">Bölme</span>
            </label>
          </div>
        </div>
      </div>
      
      <button id="start-game" class="btn btn-primary btn-lg">
        <i class="fas fa-play me-2"></i>Oyuna Başla
      </button>
    </div>

    <div id="game-screen" class="math-screen" style="display: none;">
      <div class="game-stats">
        <div class="stat-item">
          <div class="stat-label">Skor</div>
          <div class="stat-value" id="score">0</div>
        </div>
        <div class="stat-item timer-container">
          <div class="stat-label">Süre</div>
          <div class="stat-value" id="timer">60</div>
          <div class="timer-progress">
            <div class="timer-bar" id="timer-bar"></div>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Doğru</div>
          <div class="stat-value" id="correct">0</div>
        </div>
      </div>

      <div class="problem-container">
        <div class="problem-card">
          <div id="problem-text">5 + 3 = ?</div>
        </div>
      </div>

      <div class="answer-controls">
        <div class="answer-input">
          <input type="number" id="answer-input" placeholder="Cevabınız" inputmode="numeric" pattern="[0-9]*">
          <button id="submit-answer" class="btn btn-primary">
            <i class="fas fa-check me-2"></i>Kontrol Et
          </button>
        </div>
      </div>

      <div id="feedback" class="feedback"></div>
    </div>

    <div id="result-screen" class="math-screen" style="display: none;">
      <h2>Oyun Bitti!</h2>
      <div class="result-stats">
        <div class="result-stat">
          <div class="result-value" id="final-score">0</div>
          <div class="result-label">Toplam Puan</div>
        </div>
        <div class="result-stat">
          <div class="result-value" id="final-correct">0</div>
          <div class="result-label">Doğru Cevap</div>
        </div>
        <div class="result-stat">
          <div class="result-value" id="final-incorrect">0</div>
          <div class="result-label">Yanlış Cevap</div>
        </div>
      </div>
      
      <div class="result-details">
        <div class="detail-item">
          <span class="detail-label">Doğruluk Oranı:</span>
          <span class="detail-value" id="accuracy">0%</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Ortalama Yanıt Süresi:</span>
          <span class="detail-value" id="avg-time">0 saniye</span>
        </div>
      </div>
      
      <div class="result-actions">
        <button id="play-again" class="btn btn-primary">
          <i class="fas fa-redo-alt me-2"></i>Tekrar Oyna
        </button>
        <a href="{{ url_for('all_games') }}" class="btn btn-outline-light">
          <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  .game-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .math-modern-container {
    max-width: 700px;
    margin: 0 auto;
  }

  .math-screen {
    background: rgba(40, 44, 80, 0.7);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
    text-align: center;
    transition: all 0.3s ease;
  }
  
  .math-screen:hover {
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    transform: translateY(-5px);
  }

  .math-screen h2 {
    color: var(--accent-color);
    margin-bottom: 20px;
    font-size: 2rem;
    background: linear-gradient(135deg, #6a5ae0, #a890ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
  }

  .math-screen p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 25px;
    font-size: 1.1rem;
    line-height: 1.5;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }

  /* Game Options */
  .game-options {
    background: rgba(30, 34, 70, 0.7);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    text-align: left;
  }

  .option-section {
    margin-bottom: 20px;
  }

  .option-section:last-child {
    margin-bottom: 0;
  }

  .option-section h3 {
    color: white;
    font-size: 1.1rem;
    margin-bottom: 15px;
    position: relative;
    display: inline-block;
    padding-bottom: 5px;
  }
  
  .option-section h3:after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(to right, var(--accent-color), transparent);
  }

  .button-group {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .option-button {
    padding: 10px 15px;
    background: rgba(60, 64, 100, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-grow: 1;
    text-align: center;
    font-weight: 500;
  }

  .option-button:hover {
    background: rgba(80, 84, 120, 0.5);
    transform: translateY(-2px);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
  }

  .option-button.active {
    background: rgba(106, 90, 224, 0.5);
    border-color: var(--accent-color);
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.3);
  }

  .operation-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
  }

  .checkbox-container {
    display: flex;
    align-items: center;
    position: relative;
    padding-left: 35px;
    cursor: pointer;
    font-size: 1rem;
    color: white;
    user-select: none;
  }

  .checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }

  .checkmark {
    position: absolute;
    left: 0;
    height: 22px;
    width: 22px;
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .checkbox-container:hover .checkmark {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .checkbox-container input:checked ~ .checkmark {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
  }

  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 7px;
    top: 3px;
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .checkbox-container input:checked ~ .checkmark:after {
    display: block;
  }

  .option-label {
    font-weight: 500;
  }

  /* Game Stats */
  .game-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    background: rgba(30, 34, 70, 0.7);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .stat-item {
    flex: 1;
    text-align: center;
    position: relative;
  }
  
  .stat-item:not(:last-child):after {
    content: '';
    position: absolute;
    right: 0;
    top: 25%;
    height: 50%;
    width: 1px;
    background-color: rgba(255, 255, 255, 0.1);
  }

  .stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 5px;
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent-color);
    line-height: 1;
  }
  
  .timer-container {
    position: relative;
  }
  
  .timer-progress {
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 8px;
    width: 80%;
    margin-left: auto;
    margin-right: auto;
  }
  
  .timer-bar {
    height: 100%;
    background: var(--accent-color);
    width: 100%;
    transition: width 1s linear;
    border-radius: 2px;
  }

  /* Problem Container */
  .problem-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 25px;
    min-height: 150px;
  }

  .problem-card {
    background: rgba(50, 54, 100, 0.7);
    border-radius: 12px;
    padding: 25px;
    min-width: 70%;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }
  
  .problem-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2);
  }

  #problem-text {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  }

  /* Answer Controls */
  .answer-controls {
    margin-bottom: 20px;
  }

  .answer-input {
    display: flex;
    gap: 15px;
    max-width: 450px;
    margin: 0 auto;
  }

  #answer-input {
    flex: 1;
    padding: 12px 15px;
    background: rgba(60, 64, 100, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: white;
    font-size: 1.2rem;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  #answer-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 15px rgba(106, 90, 224, 0.3);
  }

  #submit-answer {
    padding: 12px 25px;
    font-size: 1.1rem;
    border-radius: 10px;
    background: linear-gradient(135deg, #6a5ae0, #a890ff);
    border: none;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.3);
    transition: all 0.3s ease;
  }
  
  #submit-answer:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(106, 90, 224, 0.4);
  }
  
  #submit-answer:active {
    transform: translateY(-1px);
  }

  /* Feedback */
  .feedback {
    font-size: 1.3rem;
    font-weight: 600;
    height: 40px;
    transition: all 0.3s ease;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  }

  .feedback.correct {
    color: #4CAF50;
  }

  .feedback.incorrect {
    color: #F44336;
  }

  /* Result Screen */
  .result-stats {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }

  .result-stat {
    background: rgba(50, 54, 100, 0.7);
    border-radius: 12px;
    padding: 20px;
    min-width: 120px;
    flex: 1;
    max-width: 180px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }
  
  .result-stat:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
  }

  .result-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 10px;
    background: linear-gradient(135deg, #6a5ae0, #a890ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .result-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .result-details {
    background: rgba(50, 54, 100, 0.7);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    color: white;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .detail-item:last-child {
    border-bottom: none;
  }

  .detail-label {
    color: rgba(255, 255, 255, 0.7);
  }

  .detail-value {
    font-weight: 600;
  }

  .result-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    max-width: 450px;
    margin: 0 auto;
  }
  
  #play-again {
    background: linear-gradient(135deg, #6a5ae0, #a890ff);
    border: none;
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: 600;
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.3);
    transition: all 0.3s ease;
  }
  
  #play-again:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(106, 90, 224, 0.4);
  }
  
  .btn-outline-light {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 12px 25px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  
  .btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  /* Start Game Button */
  #start-game {
    background: linear-gradient(135deg, #6a5ae0, #a890ff);
    border: none;
    padding: 16px 35px;
    border-radius: 30px;
    font-size: 1.2rem;
    font-weight: 600;
    box-shadow: 0 8px 20px rgba(106, 90, 224, 0.3);
    transition: all 0.3s ease;
    margin-top: 15px;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }
  
  #start-game:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 25px rgba(106, 90, 224, 0.4);
  }
  
  #start-game:active {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.2);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .math-screen {
      padding: 20px 15px;
    }
    
    .game-stats {
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .stat-item {
      flex: 1 0 30%;
    }
    
    .stat-item:after {
      display: none;
    }
    
    .stat-value {
      font-size: 1.5rem;
    }
    
    #problem-text {
      font-size: 2rem;
    }
    
    .operation-options {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .answer-input {
      flex-direction: column;
    }
    
    .result-stats {
      gap: 10px;
    }
    
    .result-stat {
      min-width: 100px;
      padding: 15px;
    }
    
    .result-value {
      font-size: 1.8rem;
    }
  }

  @media (max-width: 480px) {
    .math-screen h2 {
      font-size: 1.5rem;
    }
    
    .math-screen p {
      font-size: 0.95rem;
    }
    
    .option-section h3 {
      font-size: 1rem;
    }
    
    .button-group {
      flex-direction: column;
    }
    
    .option-button {
      width: 100%;
    }
    
    #problem-text {
      font-size: 1.7rem;
    }
    
    .result-actions {
      flex-direction: column;
    }
    
    #play-again, .btn-outline-light {
      width: 100%;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const resultScreen = document.getElementById('result-screen');
  
  const difficultyButtons = document.querySelectorAll('[data-difficulty]');
  const timeButtons = document.querySelectorAll('[data-time]');
  const operationCheckboxes = document.querySelectorAll('[data-operation]');
  
  const startGameBtn = document.getElementById('start-game');
  const playAgainBtn = document.getElementById('play-again');
  
  const problemText = document.getElementById('problem-text');
  const answerInput = document.getElementById('answer-input');
  const submitAnswerBtn = document.getElementById('submit-answer');
  const feedbackEl = document.getElementById('feedback');
  
  const scoreEl = document.getElementById('score');
  const correctEl = document.getElementById('correct');
  const timerEl = document.getElementById('timer');
  const timerBar = document.getElementById('timer-bar');
  
  const finalScoreEl = document.getElementById('final-score');
  const finalCorrectEl = document.getElementById('final-correct');
  const finalIncorrectEl = document.getElementById('final-incorrect');
  const accuracyEl = document.getElementById('accuracy');
  const avgTimeEl = document.getElementById('avg-time');

  // Game Configuration
  let gameConfig = {
    difficulty: 'easy',
    time: 60, // seconds
    operations: ['addition', 'subtraction', 'multiplication']
  };
  
  // Game State
  let gameState = {
    score: 0,
    correctAnswers: 0,
    incorrectAnswers: 0,
    currentAnswer: 0,
    timer: null,
    timeRemaining: 0,
    startTimestamp: 0,
    totalResponseTime: 0,
    problemStartTime: 0
  };

  // Event Listeners for Configuration
  difficultyButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      difficultyButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      gameConfig.difficulty = this.getAttribute('data-difficulty');
    });
  });

  timeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      timeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      gameConfig.time = parseInt(this.getAttribute('data-time'));
    });
  });

  // Start Game Button
  startGameBtn.addEventListener('click', function() {
    // Get selected operations
    gameConfig.operations = [];
    operationCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        gameConfig.operations.push(checkbox.getAttribute('data-operation'));
      }
    });
    
    // Make sure at least one operation is selected
    if (gameConfig.operations.length === 0) {
      alert('Lütfen en az bir işlem türü seçin!');
      return;
    }
    
    // Start the game
    startGame();
  });

  // Submit Answer Button
  submitAnswerBtn.addEventListener('click', checkAnswer);

  // Answer Input Enter Key
  answerInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      checkAnswer();
    }
  });

  // Play Again Button
  playAgainBtn.addEventListener('click', function() {
    showScreen(startScreen);
  });

  // Functions
  function startGame() {
    // Reset game state
    gameState.score = 0;
    gameState.correctAnswers = 0;
    gameState.incorrectAnswers = 0;
    gameState.totalResponseTime = 0;
    
    // Reset UI
    scoreEl.textContent = gameState.score;
    correctEl.textContent = gameState.correctAnswers;
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';
    
    // Set timer
    gameState.timeRemaining = gameConfig.time;
    timerEl.textContent = gameState.timeRemaining;
    timerBar.style.width = '100%';
    
    // Show game screen
    showScreen(gameScreen);
    
    // Focus answer input
    answerInput.value = '';
    answerInput.focus();
    
    // Generate first problem
    generateProblem();
    
    // Start timer
    gameState.startTimestamp = Date.now();
    gameState.problemStartTime = Date.now();
    gameState.timer = setInterval(updateTimer, 1000);
  }

  function generateProblem() {
    // Choose random operation from selected operations
    const operation = gameConfig.operations[Math.floor(Math.random() * gameConfig.operations.length)];
    
    let num1, num2, problem, answer;
    
    // Generate numbers based on difficulty and operation
    switch (operation) {
      case 'addition':
        if (gameConfig.difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 10) + 1;
        } else if (gameConfig.difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 50) + 1;
          num2 = Math.floor(Math.random() * 50) + 1;
        } else { // hard
          num1 = Math.floor(Math.random() * 100) + 1;
          num2 = Math.floor(Math.random() * 100) + 1;
        }
        problem = `${num1} + ${num2} = ?`;
        answer = num1 + num2;
        break;
        
      case 'subtraction':
        if (gameConfig.difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * num1) + 1;
        } else if (gameConfig.difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 50) + 10;
          num2 = Math.floor(Math.random() * num1) + 1;
        } else { // hard
          num1 = Math.floor(Math.random() * 100) + 20;
          num2 = Math.floor(Math.random() * num1) + 1;
        }
        problem = `${num1} - ${num2} = ?`;
        answer = num1 - num2;
        break;
        
      case 'multiplication':
        if (gameConfig.difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 5) + 1;
          num2 = Math.floor(Math.random() * 5) + 1;
        } else if (gameConfig.difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 10) + 1;
        } else { // hard
          num1 = Math.floor(Math.random() * 12) + 1;
          num2 = Math.floor(Math.random() * 12) + 1;
        }
        problem = `${num1} × ${num2} = ?`;
        answer = num1 * num2;
        break;
        
      case 'division':
        // For division, first generate the answer, then multiply to get the dividend
        if (gameConfig.difficulty === 'easy') {
          answer = Math.floor(Math.random() * 5) + 1;
          num2 = Math.floor(Math.random() * 5) + 1;
        } else if (gameConfig.difficulty === 'medium') {
          answer = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 10) + 1;
        } else { // hard
          answer = Math.floor(Math.random() * 12) + 1;
          num2 = Math.floor(Math.random() * 12) + 1;
        }
        num1 = answer * num2; // This ensures whole number answers
        problem = `${num1} ÷ ${num2} = ?`;
        break;
    }
    
    // Update UI
    problemText.textContent = problem;
    gameState.currentAnswer = answer;
    
    // Reset input
    answerInput.value = '';
    answerInput.focus();
    
    // Reset feedback
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';
    
    // Record problem start time
    gameState.problemStartTime = Date.now();
  }

  function checkAnswer() {
    // Get user's answer
    const userAnswer = parseInt(answerInput.value);
    
    // If input is empty or not a number, do nothing
    if (isNaN(userAnswer)) {
      return;
    }
    
    // Calculate response time
    const responseTime = (Date.now() - gameState.problemStartTime) / 1000;
    gameState.totalResponseTime += responseTime;
    
    // Check if answer is correct
    if (userAnswer === gameState.currentAnswer) {
      // Correct answer
      feedbackEl.textContent = 'Doğru!';
      feedbackEl.className = 'feedback correct';
      
      // Update score (faster answers get more points)
      const timeBonus = Math.max(0, 10 - Math.floor(responseTime));
      const difficultyMultiplier = gameConfig.difficulty === 'easy' ? 1 : (gameConfig.difficulty === 'medium' ? 2 : 3);
      const pointsEarned = 10 + timeBonus * difficultyMultiplier;
      
      // Add score animation
      const scoreAnimation = document.createElement('div');
      scoreAnimation.className = 'score-animation';
      scoreAnimation.textContent = `+${pointsEarned}`;
      scoreAnimation.style.position = 'absolute';
      scoreAnimation.style.top = '50%';
      scoreAnimation.style.left = '50%';
      scoreAnimation.style.transform = 'translate(-50%, -50%)';
      scoreAnimation.style.color = '#4CAF50';
      scoreAnimation.style.fontWeight = 'bold';
      scoreAnimation.style.fontSize = '1.5rem';
      scoreAnimation.style.zIndex = '10';
      scoreAnimation.style.pointerEvents = 'none';
      scoreAnimation.style.animation = 'scoreFloat 1s forwards';
      
      document.querySelector('.problem-container').appendChild(scoreAnimation);
      
      // Remove animation after it completes
      setTimeout(() => {
        scoreAnimation.remove();
      }, 1000);
      
      gameState.score += pointsEarned;
      gameState.correctAnswers++;
    } else {
      // Incorrect answer
      feedbackEl.textContent = `Yanlış! Doğru cevap: ${gameState.currentAnswer}`;
      feedbackEl.className = 'feedback incorrect';
      
      gameState.incorrectAnswers++;
    }
    
    // Update UI
    scoreEl.textContent = gameState.score;
    correctEl.textContent = gameState.correctAnswers;
    
    // Animate the score update
    scoreEl.parentElement.classList.add('flash');
    setTimeout(() => {
      scoreEl.parentElement.classList.remove('flash');
    }, 500);
    
    // Generate new problem after a short delay
    setTimeout(generateProblem, 1500);
  }

  function updateTimer() {
    gameState.timeRemaining--;
    
    // Update UI
    timerEl.textContent = gameState.timeRemaining;
    const percentLeft = (gameState.timeRemaining / gameConfig.time) * 100;
    timerBar.style.width = `${percentLeft}%`;
    
    // Change color when time is running out
    if (gameState.timeRemaining <= 10) {
      timerBar.style.backgroundColor = '#F44336';
    }
    
    // Check if time is up
    if (gameState.timeRemaining <= 0) {
      endGame();
    }
  }

  function endGame() {
    // Stop timer
    clearInterval(gameState.timer);
    
    // Calculate statistics
    const totalAnswers = gameState.correctAnswers + gameState.incorrectAnswers;
    const accuracy = totalAnswers > 0 ? Math.round((gameState.correctAnswers / totalAnswers) * 100) : 0;
    const avgTime = totalAnswers > 0 ? (gameState.totalResponseTime / totalAnswers).toFixed(1) : 0;
    
    // Update result screen
    finalScoreEl.textContent = gameState.score;
    finalCorrectEl.textContent = gameState.correctAnswers;
    finalIncorrectEl.textContent = gameState.incorrectAnswers;
    accuracyEl.textContent = `${accuracy}%`;
    avgTimeEl.textContent = `${avgTime} saniye`;
    
    // Save score
    saveScore(gameState.score);
    
    // Show result screen
    showScreen(resultScreen);
  }

  function showScreen(screen) {
    // Hide all screens
    startScreen.style.display = 'none';
    gameScreen.style.display = 'none';
    resultScreen.style.display = 'none';
    
    // Show the specified screen
    screen.style.display = 'block';
  }
  
  // Function to save score to the server
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        game_type: 'math_challenge',
        score: score
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Score saved:', data);
    })
    .catch(error => {
      console.error('Error saving score:', error);
    });
  }
  
  // Add score float animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes scoreFloat {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -60%) scale(1.2);
      }
      80% {
        opacity: 1;
        transform: translate(-50%, -100px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -120px) scale(0.8);
      }
    }
    
    @keyframes flash {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .flash {
      animation: flash 0.5s ease;
    }
  `;
  document.head.appendChild(style);
});
</script>
{% endblock %}

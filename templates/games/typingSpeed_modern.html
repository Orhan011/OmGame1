{% extends 'layout.html' %}

{% block title %}Yazma Hızı - ZekaPark{% endblock %}

{% block content %}
<div class="page-container">
  <div class="game-container">
    <div class="game-header">
      <h1>Yazma Hızı <span class="badge">Klavye Hız Testi</span></h1>
      <p class="game-description">Belirli metinleri hızlı ve doğru bir şekilde yazarak yazma becerilerinizi geliştirin.</p>
    </div>

    <div class="typing-container">
      <div class="typing-header">
        <div class="typing-stats">
          <div class="stat-item">
            <div class="stat-label">WPM</div>
            <div class="stat-value" id="wpm">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Doğruluk</div>
            <div class="stat-value" id="accuracy">100%</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Süre</div>
            <div class="stat-value" id="timer">60</div>
          </div>
        </div>
        
        <div class="typing-controls">
          <button id="start-test" class="btn btn-primary">
            <i class="fas fa-play me-2"></i>Başlat
          </button>
          <button id="restart-test" class="btn btn-outline-light" disabled>
            <i class="fas fa-redo-alt me-2"></i>Yeniden Başlat
          </button>
        </div>
      </div>
      
      <div class="typing-area">
        <div id="text-display" class="text-display">
          <div class="placeholder-text">Başlamak için "Başlat" butonuna tıklayın</div>
        </div>
        
        <div class="input-area">
          <textarea id="typing-input" class="typing-input" placeholder="Test başladığında buraya yazın..." disabled></textarea>
        </div>
      </div>
      
      <div class="typing-footer">
        <div class="typing-settings">
          <div class="setting-group">
            <label>Zorluk</label>
            <div class="button-group">
              <button class="setting-btn active" data-difficulty="easy">Kolay</button>
              <button class="setting-btn" data-difficulty="medium">Orta</button>
              <button class="setting-btn" data-difficulty="hard">Zor</button>
            </div>
          </div>
          
          <div class="setting-group">
            <label>Süre</label>
            <div class="button-group">
              <button class="setting-btn active" data-time="60">1 Dakika</button>
              <button class="setting-btn" data-time="120">2 Dakika</button>
              <button class="setting-btn" data-time="300">5 Dakika</button>
            </div>
          </div>
          
          <div class="setting-group">
            <label>Metin Türü</label>
            <div class="button-group">
              <button class="setting-btn active" data-text-type="paragraphs">Paragraflar</button>
              <button class="setting-btn" data-text-type="quotes">Alıntılar</button>
              <button class="setting-btn" data-text-type="code">Kod</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="result-modal" class="typing-modal">
      <div class="modal-content">
        <h2>Test Sonuçları</h2>
        
        <div class="result-stats">
          <div class="result-item">
            <div class="result-value" id="result-wpm">0</div>
            <div class="result-label">WPM</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="result-accuracy">0%</div>
            <div class="result-label">Doğruluk</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="result-cpm">0</div>
            <div class="result-label">CPM</div>
          </div>
        </div>
        
        <div class="result-details">
          <div class="detail-item">
            <span class="detail-label">Doğru Kelimeler:</span>
            <span class="detail-value" id="correct-words">0</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Yanlış Kelimeler:</span>
            <span class="detail-value" id="wrong-words">0</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Kesilen Kelimeler:</span>
            <span class="detail-value" id="missed-words">0</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Toplam Vuruş:</span>
            <span class="detail-value" id="total-keystrokes">0</span>
          </div>
        </div>
        
        <div class="result-actions">
          <button id="save-results" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>Sonuçları Kaydet
          </button>
          <button id="try-again" class="btn btn-outline-light">
            <i class="fas fa-redo-alt me-2"></i>Tekrar Dene
          </button>
          <a href="{{ url_for('all_games') }}" class="btn btn-outline-secondary">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modernize edici -->
{% include 'games/modernizer.html' %}

<style>
  .typing-container {
    max-width: 900px;
    margin: 0 auto;
    background: rgba(25, 25, 45, 0.7);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  
  .typing-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .typing-stats {
    display: flex;
    gap: 15px;
  }
  
  .stat-item {
    background: rgba(40, 40, 80, 0.5);
    border-radius: 8px;
    padding: 10px 15px;
    min-width: 80px;
    text-align: center;
  }
  
  .stat-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
    margin-bottom: 5px;
  }
  
  .stat-value {
    color: var(--accent-color);
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .typing-controls {
    display: flex;
    gap: 10px;
  }
  
  .typing-area {
    margin-bottom: 20px;
  }
  
  .text-display {
    background: rgba(40, 40, 80, 0.5);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    min-height: 150px;
    line-height: 1.6;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.1rem;
    position: relative;
    overflow: hidden;
  }
  
  .placeholder-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-style: italic;
    color: rgba(255, 255, 255, 0.4);
    text-align: center;
  }
  
  .text-display span {
    position: relative;
  }
  
  .text-display span.correct {
    color: #2ecc71;
  }
  
  .text-display span.incorrect {
    color: #e74c3c;
    text-decoration: underline;
  }
  
  .text-display span.current {
    background-color: rgba(106, 90, 224, 0.3);
    border-radius: 2px;
  }
  
  .typing-input {
    width: 100%;
    background: rgba(40, 40, 80, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 15px;
    color: white;
    font-size: 1.1rem;
    resize: none;
    height: 100px;
    transition: all 0.3s ease;
  }
  
  .typing-input:focus {
    outline: none;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(106, 90, 224, 0.3);
  }
  
  .typing-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }
  
  .typing-input:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }
  
  .typing-footer {
    margin-top: 20px;
  }
  
  .typing-settings {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  
  .setting-group {
    flex: 1;
    min-width: 180px;
  }
  
  .setting-group label {
    display: block;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 8px;
    font-size: 0.9rem;
  }
  
  .button-group {
    display: flex;
    gap: 5px;
  }
  
  .setting-btn {
    flex: 1;
    padding: 5px;
    background: rgba(40, 40, 80, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    color: white;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .setting-btn.active {
    background: rgba(106, 90, 224, 0.6);
    border-color: var(--accent-color);
  }
  
  .typing-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .modal-content {
    background: rgba(25, 25, 45, 0.95);
    border-radius: 15px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    text-align: center;
  }
  
  .modal-content h2 {
    color: var(--accent-color);
    margin-bottom: 25px;
  }
  
  .result-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
  }
  
  .result-item {
    text-align: center;
  }
  
  .result-value {
    font-size: 2.2rem;
    font-weight: 700;
    color: white;
    margin-bottom: 5px;
  }
  
  .result-label {
    color: var(--accent-color);
    font-size: 1rem;
  }
  
  .result-details {
    background: rgba(40, 40, 80, 0.5);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    text-align: left;
  }
  
  .detail-item {
    display: flex;
    justify-content: space-between;
  }
  
  .detail-label {
    color: rgba(255, 255, 255, 0.7);
  }
  
  .detail-value {
    color: white;
    font-weight: 600;
  }
  
  .result-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  
  /* Responsive Adjustments */
  @media (max-width: 768px) {
    .typing-header {
      flex-direction: column;
      align-items: stretch;
    }
    
    .typing-stats {
      justify-content: space-between;
    }
    
    .typing-controls {
      justify-content: space-between;
    }
    
    .result-stats {
      flex-direction: column;
      gap: 15px;
    }
    
    .result-details {
      grid-template-columns: 1fr;
    }
    
    .result-actions {
      flex-direction: column;
    }
    
    .result-actions .btn {
      width: 100%;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log("typingSpeed oyunu modernize edildi.");
  
  // DOM Elements
  const startTestBtn = document.getElementById('start-test');
  const restartTestBtn = document.getElementById('restart-test');
  const textDisplay = document.getElementById('text-display');
  const typingInput = document.getElementById('typing-input');
  const wpmDisplay = document.getElementById('wpm');
  const accuracyDisplay = document.getElementById('accuracy');
  const timerDisplay = document.getElementById('timer');
  const resultModal = document.getElementById('result-modal');
  const resultWpm = document.getElementById('result-wpm');
  const resultAccuracy = document.getElementById('result-accuracy');
  const resultCpm = document.getElementById('result-cpm');
  const correctWords = document.getElementById('correct-words');
  const wrongWords = document.getElementById('wrong-words');
  const missedWords = document.getElementById('missed-words');
  const totalKeystrokes = document.getElementById('total-keystrokes');
  const saveResultsBtn = document.getElementById('save-results');
  const tryAgainBtn = document.getElementById('try-again');
  
  const difficultyBtns = document.querySelectorAll('[data-difficulty]');
  const timeBtns = document.querySelectorAll('[data-time]');
  const textTypeBtns = document.querySelectorAll('[data-text-type]');
  
  // Test variables
  let timer;
  let timeLeft;
  let timeLimit = 60;
  let isTestActive = false;
  let wpm = 0;
  let accuracy = 100;
  let totalTyped = 0;
  let correctTyped = 0;
  let currentWordIndex = 0;
  let wordList = [];
  let testStartTime;
  let keystrokes = 0;
  let difficulty = 'easy';
  let textType = 'paragraphs';
  
  // Text corpus for different difficulties and types
  const textCorpus = {
    paragraphs: {
      easy: [
        "Güneşli bir yaz günüydü. Herkes parkta güzel vakit geçiriyordu. Çocuklar oyun oynuyor, kuşlar ağaçlarda ötüyordu. Hava çok güzeldi ve insanlar piknik yapıyordu.",
        "Kitap okumak benim en sevdiğim aktivitelerden biridir. Her akşam yatmadan önce en az yarım saat kitap okurum. Bu alışkanlık bana hem bilgi hem de huzur veriyor.",
        "Sağlıklı beslenme ve düzenli egzersiz yapmak çok önemlidir. Her gün en az otuz dakika yürüyüş yapmak bile sağlığımız için faydalıdır. Ayrıca bol su içmek de unutulmamalıdır."
      ],
      medium: [
        "Teknolojinin hayatımızdaki yeri giderek artıyor. Akıllı telefonlar, tabletler ve bilgisayarlar günlük yaşantımızın vazgeçilmez parçaları haline geldi. Ancak bu cihazların aşırı kullanımı bazı sağlık sorunlarına yol açabiliyor.",
        "Küresel ısınma, dünyamızın karşı karşıya olduğu en büyük çevresel sorunlardan biridir. Son yıllarda artan sıcaklıklar, eriyen buzullar ve değişen iklim koşulları, acil önlemler almamız gerektiğini gösteriyor.",
        "Eğitim, bir toplumun gelişmesi için en önemli faktörlerden biridir. Kaliteli bir eğitim sistemi, bireylerin potansiyellerini tam olarak gerçekleştirmelerine ve topluma katkıda bulunmalarına olanak tanır."
      ],
      hard: [
        "Kuantum fiziği, maddenin ve ışığın temel yapısını ve davranışını açıklamaya çalışan fizik dalıdır. Klasik fizik yasalarının geçerli olmadığı atomik ve subatomik seviyede çalışır. Kuantum mekaniği, parçacıkların aynı anda hem dalga hem de parçacık özelliği gösterebileceğini öne süren dalga-parçacık ikiliği gibi sezgisel olmayan kavramlar içerir.",
        "Nörobilim, sinir sisteminin yapısını, işlevini ve gelişimini inceleyen bilim dalıdır. Beynin nasıl çalıştığını, düşüncelerin nasıl oluştuğunu ve hafızanın nasıl işlediğini anlamaya çalışır. Modern görüntüleme teknikleri sayesinde, nörobilimciler beyin aktivitesini gerçek zamanlı olarak izleyebilir ve çeşitli zihinsel süreçlerin altında yatan mekanizmaları araştırabilirler.",
        "Yapay zeka, insan zekasını taklit eden ve öğrenme, problem çözme ve karar verme gibi bilişsel yetenekleri sergileyen bilgisayar sistemlerini ifade eder. Makine öğrenimi, derin öğrenme ve doğal dil işleme gibi alt alanları içerir. Yapay zeka teknolojileri, sağlık hizmetlerinden finansal analize, otonom araçlardan kişisel dijital asistanlara kadar birçok sektörde devrim yaratmaktadır."
      ]
    },
    quotes: {
      easy: [
        "Hayatta en hakiki mürşit ilimdir. - Mustafa Kemal Atatürk",
        "Düşünmek en büyük erdemdir. - Thales",
        "Bilgi güçtür. - Francis Bacon",
        "Kendini bil. - Sokrates"
      ],
      medium: [
        "Mutluluk bir yolculuktur, bir varış noktası değil. - Ralph Waldo Emerson",
        "Başarı, başarısızlıktan başarısızlığa coşkuyu kaybetmeden geçebilmektir. - Winston Churchill",
        "Hayat, yaşadığın şeyler değil, hatırladığın ve nasıl hatırladığın şeylerdir. - Gabriel Garcia Marquez",
        "İnsanların düşündüklerinden korkmayın, asıl düşünmemelerinden korkun. - Blaise Pascal"
      ],
      hard: [
        "Belirsizliğe tahammül edemeyen insan, hayatın güzelliğinden bir yaprak bile çeviremez. - Khalil Gibran",
        "Hayat karşılaştığınız kişilerle değil, bu karşılaşmalarda birlikte yarattığınız titreşimlerle ilgilidir. - Neale Donald Walsch",
        "Anlayabildiğim kadarıyla, hayatımızda sahip olduğumuz tek gerçek değer, her anın bilincinde olma kabiliyetidir. - Albert Einstein",
        "İçimdeki en güçlü dürtü, kendimi ifade etmektir. Bu, benim için yemek yemek, uyumak veya karşı cinse duyulan çekim kadar temeldir. - Carl Gustav Jung"
      ]
    },
    code: {
      easy: [
        "function selamVer() {\n  console.log('Merhaba, Dünya!');\n}\n\nselamVer();",
        "const sayilar = [1, 2, 3, 4, 5];\nlet toplam = 0;\n\nfor (let i = 0; i < sayilar.length; i++) {\n  toplam += sayilar[i];\n}\n\nconsole.log('Toplam:', toplam);",
        "class Kullanici {\n  constructor(ad, soyad) {\n    this.ad = ad;\n    this.soyad = soyad;\n  }\n  \n  tamAd() {\n    return this.ad + ' ' + this.soyad;\n  }\n}\n\nconst kullanici = new Kullanici('Ali', 'Yılmaz');\nconsole.log(kullanici.tamAd());"
      ],
      medium: [
        "function asal(sayi) {\n  if (sayi <= 1) return false;\n  if (sayi <= 3) return true;\n  \n  if (sayi % 2 === 0 || sayi % 3 === 0) return false;\n  \n  for (let i = 5; i * i <= sayi; i += 6) {\n    if (sayi % i === 0 || sayi % (i + 2) === 0) return false;\n  }\n  \n  return true;\n}\n\nconsole.log(asal(17));",
        "const fetchVeri = async (id) => {\n  try {\n    const yanit = await fetch(`https://api.ornek.com/veri/${id}`);\n    if (!yanit.ok) {\n      throw new Error('Veri alınamadı');\n    }\n    const veri = await yanit.json();\n    return veri;\n  } catch (hata) {\n    console.error('Hata:', hata.message);\n    return null;\n  }\n};",
        "function mergeSort(dizi) {\n  if (dizi.length <= 1) return dizi;\n  \n  const orta = Math.floor(dizi.length / 2);\n  const sol = dizi.slice(0, orta);\n  const sag = dizi.slice(orta);\n  \n  return birlestir(mergeSort(sol), mergeSort(sag));\n}\n\nfunction birlestir(sol, sag) {\n  let sonuc = [];\n  let solIndex = 0;\n  let sagIndex = 0;\n  \n  while (solIndex < sol.length && sagIndex < sag.length) {\n    if (sol[solIndex] < sag[sagIndex]) {\n      sonuc.push(sol[solIndex]);\n      solIndex++;\n    } else {\n      sonuc.push(sag[sagIndex]);\n      sagIndex++;\n    }\n  }\n  \n  return sonuc.concat(sol.slice(solIndex)).concat(sag.slice(sagIndex));\n}"
      ],
      hard: [
        "class DugumAgaci {\n  constructor(deger) {\n    this.deger = deger;\n    this.sol = null;\n    this.sag = null;\n  }\n}\n\nfunction agaciDengele(kok) {\n  const dugumler = [];\n  \n  function inorderGez(dugum) {\n    if (!dugum) return;\n    inorderGez(dugum.sol);\n    dugumler.push(dugum);\n    inorderGez(dugum.sag);\n  }\n  \n  function dengeliAgacOlustur(baslangic, bitis) {\n    if (baslangic > bitis) return null;\n    \n    const orta = Math.floor((baslangic + bitis) / 2);\n    const kok = dugumler[orta];\n    \n    kok.sol = dengeliAgacOlustur(baslangic, orta - 1);\n    kok.sag = dengeliAgacOlustur(orta + 1, bitis);\n    \n    return kok;\n  }\n  \n  inorderGez(kok);\n  return dengeliAgacOlustur(0, dugumler.length - 1);\n}",
        "function promiseAll(promises) {\n  return new Promise((resolve, reject) => {\n    if (!Array.isArray(promises)) {\n      return reject(new TypeError('Argüman bir dizi olmalıdır'));\n    }\n    \n    const sonuclar = new Array(promises.length);\n    let tamamlanan = 0;\n    \n    if (promises.length === 0) {\n      return resolve(sonuclar);\n    }\n    \n    promises.forEach((promise, index) => {\n      Promise.resolve(promise).then(\n        (deger) => {\n          sonuclar[index] = deger;\n          tamamlanan++;\n          \n          if (tamamlanan === promises.length) {\n            resolve(sonuclar);\n          }\n        },\n        (hata) => {\n          reject(hata);\n        }\n      );\n    });\n  });\n}",
        "class LRUCache {\n  constructor(kapasite) {\n    this.kapasite = kapasite;\n    this.onbellek = new Map();\n    this.kullanim = new DoublyLinkedList();\n  }\n  \n  get(anahtar) {\n    if (!this.onbellek.has(anahtar)) return -1;\n    \n    const dugum = this.onbellek.get(anahtar);\n    this.kullanim.sil(dugum);\n    this.kullanim.sonaEkle(dugum);\n    \n    return dugum.deger;\n  }\n  \n  put(anahtar, deger) {\n    if (this.onbellek.has(anahtar)) {\n      const dugum = this.onbellek.get(anahtar);\n      dugum.deger = deger;\n      this.kullanim.sil(dugum);\n      this.kullanim.sonaEkle(dugum);\n      return;\n    }\n    \n    if (this.onbellek.size >= this.kapasite) {\n      const eskiDugum = this.kullanim.basindakiniSil();\n      this.onbellek.delete(eskiDugum.anahtar);\n    }\n    \n    const yeniDugum = new ListNode(anahtar, deger);\n    this.kullanim.sonaEkle(yeniDugum);\n    this.onbellek.set(anahtar, yeniDugum);\n  }\n}"
      ]
    }
  };
  
  // Event listeners
  startTestBtn.addEventListener('click', startTest);
  restartTestBtn.addEventListener('click', restartTest);
  typingInput.addEventListener('input', processTyping);
  
  // Setting buttons
  difficultyBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      difficulty = this.getAttribute('data-difficulty');
      updateButtonState(difficultyBtns, this);
    });
  });
  
  timeBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      timeLimit = parseInt(this.getAttribute('data-time'));
      updateButtonState(timeBtns, this);
    });
  });
  
  textTypeBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      textType = this.getAttribute('data-text-type');
      updateButtonState(textTypeBtns, this);
    });
  });
  
  // Result modal actions
  saveResultsBtn.addEventListener('click', saveResults);
  tryAgainBtn.addEventListener('click', function() {
    resultModal.style.display = 'none';
    restartTest();
  });
  
  // Functions
  function updateButtonState(buttons, activeButton) {
    buttons.forEach(btn => btn.classList.remove('active'));
    activeButton.classList.add('active');
  }
  
  function getRandomText() {
    const texts = textCorpus[textType][difficulty];
    return texts[Math.floor(Math.random() * texts.length)];
  }
  
  function startTest() {
    isTestActive = true;
    totalTyped = 0;
    correctTyped = 0;
    currentWordIndex = 0;
    keystrokes = 0;
    
    // Enable typing and focus input
    typingInput.disabled = false;
    typingInput.value = '';
    typingInput.focus();
    
    // Generate and display text
    const testText = getRandomText();
    wordList = textType === 'code' ? [testText] : testText.split(' ');
    
    displayText();
    
    // Update UI
    startTestBtn.disabled = true;
    restartTestBtn.disabled = false;
    
    // Start timer
    timeLeft = timeLimit;
    timerDisplay.textContent = timeLeft;
    testStartTime = new Date();
    
    timer = setInterval(() => {
      timeLeft--;
      timerDisplay.textContent = timeLeft;
      
      if (timeLeft <= 0) {
        endTest();
      }
    }, 1000);
    
    // Play start sound
    try {
      const startSound = new Audio('/static/sounds/start.mp3');
      startSound.play();
    } catch (error) {
      console.log("Start sound playback prevented", error);
    }
  }
  
  function restartTest() {
    // Clear timer
    clearInterval(timer);
    
    // Reset displays
    wpmDisplay.textContent = '0';
    accuracyDisplay.textContent = '100%';
    
    // Start a new test
    startTest();
  }
  
  function displayText() {
    // Clear previous text
    textDisplay.innerHTML = '';
    textDisplay.classList.remove('placeholder-text');
    
    // Create spans for each word
    if (textType === 'code') {
      // For code, we need to preserve whitespace and line breaks
      const preElement = document.createElement('pre');
      preElement.className = 'code-display';
      
      wordList[0].split('').forEach((char, index) => {
        const span = document.createElement('span');
        span.textContent = char;
        if (index === 0) span.className = 'current';
        preElement.appendChild(span);
      });
      
      textDisplay.appendChild(preElement);
    } else {
      // For normal text
      wordList.forEach((word, index) => {
        const wordSpan = document.createElement('span');
        wordSpan.className = index === 0 ? 'current' : '';
        wordSpan.textContent = word + ' ';
        textDisplay.appendChild(wordSpan);
      });
    }
  }
  
  function processTyping(event) {
    if (!isTestActive) return;
    
    keystrokes++;
    
    const typedText = typingInput.value;
    
    if (textType === 'code') {
      // For code typing, compare character by character
      const codeText = wordList[0];
      let correctCount = 0;
      
      const codeSpans = textDisplay.querySelectorAll('pre span');
      
      for (let i = 0; i < typedText.length; i++) {
        if (i < codeText.length) {
          if (typedText[i] === codeText[i]) {
            codeSpans[i].className = 'correct';
            correctCount++;
          } else {
            codeSpans[i].className = 'incorrect';
          }
        }
      }
      
      // Mark current character
      if (typedText.length < codeText.length) {
        codeSpans[typedText.length].className = 'current';
      }
      
      // Update accuracy
      accuracy = typedText.length > 0 ? (correctCount / typedText.length) * 100 : 100;
      
      // Check if code typing is complete
      if (typedText.length >= codeText.length && typedText === codeText) {
        endTest();
      }
    } else {
      // For normal text typing
      const currentWordSpan = textDisplay.querySelectorAll('span')[currentWordIndex];
      const currentWord = wordList[currentWordIndex];
      
      // Check if space is typed (word completed)
      if (event.data === ' ') {
        const typedWord = typedText.trim();
        
        // Check if typed word matches the current word
        if (typedWord === currentWord) {
          currentWordSpan.className = 'correct';
          correctTyped++;
        } else {
          currentWordSpan.className = 'incorrect';
        }
        
        totalTyped++;
        typingInput.value = '';
        
        // Move to next word
        currentWordIndex++;
        if (currentWordIndex < wordList.length) {
          const nextWordSpan = textDisplay.querySelectorAll('span')[currentWordIndex];
          nextWordSpan.className = 'current';
          
          // Update accuracy
          accuracy = (correctTyped / totalTyped) * 100;
        } else {
          // All words completed
          endTest();
        }
      } else {
        // Word in progress
        // Real-time feedback could be added here if desired
      }
    }
    
    // Calculate and update WPM
    const timeElapsed = (new Date() - testStartTime) / 60000; // in minutes
    if (textType === 'code') {
      // For code, calculate by characters
      const charCount = typingInput.value.length;
      wpm = Math.round(charCount / 5 / timeElapsed); // 5 characters = 1 word
    } else {
      // For normal text, calculate by words
      wpm = Math.round(totalTyped / timeElapsed);
    }
    
    // Update displays
    wpmDisplay.textContent = wpm;
    accuracyDisplay.textContent = Math.round(accuracy) + '%';
  }
  
  function endTest() {
    isTestActive = false;
    clearInterval(timer);
    
    // Disable typing
    typingInput.disabled = true;
    
    // Enable restart button
    startTestBtn.disabled = false;
    
    // Calculate final statistics
    const timeElapsed = Math.min(timeLimit, timeLimit - timeLeft) / 60; // in minutes
    
    let finalWpm = 0;
    let finalCpm = 0;
    let finalAccuracy = accuracy;
    let finalCorrectWords = correctTyped;
    let finalWrongWords = totalTyped - correctTyped;
    let finalMissedWords = wordList.length - totalTyped;
    
    if (textType === 'code') {
      const typedChars = typingInput.value.length;
      const totalChars = wordList[0].length;
      
      finalWpm = Math.round(typedChars / 5 / timeElapsed);
      finalCpm = Math.round(typedChars / timeElapsed);
      
      // Count correct/incorrect characters for code
      let correctChars = 0;
      for (let i = 0; i < typedChars; i++) {
        if (i < totalChars && typingInput.value[i] === wordList[0][i]) {
          correctChars++;
        }
      }
      
      finalAccuracy = typedChars > 0 ? (correctChars / typedChars) * 100 : 0;
      finalCorrectWords = Math.round(correctChars / 5); // convert to "words"
      finalWrongWords = Math.round((typedChars - correctChars) / 5);
      finalMissedWords = Math.round((totalChars - typedChars) / 5);
    } else {
      finalWpm = Math.round(correctTyped / timeElapsed);
      finalCpm = Math.round(correctTyped * 5 / timeElapsed); // assuming 5 chars per word
    }
    
    // Update result modal
    resultWpm.textContent = finalWpm;
    resultAccuracy.textContent = Math.round(finalAccuracy) + '%';
    resultCpm.textContent = finalCpm;
    correctWords.textContent = finalCorrectWords;
    wrongWords.textContent = finalWrongWords;
    missedWords.textContent = finalMissedWords;
    totalKeystrokes.textContent = keystrokes;
    
    // Show result modal
    resultModal.style.display = 'flex';
    
    // Play completion sound
    try {
      const completeSound = new Audio('/static/sounds/levelUp.mp3');
      completeSound.play();
    } catch (error) {
      console.log("Sound play error:", error);
    }
  }
  
  function saveResults() {
    // Prepare data for saving
    const gameStats = {
      wpm: parseInt(resultWpm.textContent),
      accuracy: parseInt(resultAccuracy.textContent.replace('%', '')),
      cpm: parseInt(resultCpm.textContent),
      correct_words: parseInt(correctWords.textContent),
      wrong_words: parseInt(wrongWords.textContent),
      missed_words: parseInt(missedWords.textContent),
      keystrokes: keystrokes,
      text_type: textType,
      time_limit: timeLimit
    };
    
    // Calculate score (weighted combination of WPM and accuracy)
    const score = Math.round(gameStats.wpm * (gameStats.accuracy / 100));
    
    // Post score to backend
    fetch('/api/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        game_type: 'typing_speed',
        score: score,
        difficulty: difficulty,
        playtime: timeLimit - timeLeft,
        game_stats: gameStats
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log("Score saved:", data);
      if (data.success) {
        saveResultsBtn.disabled = true;
        saveResultsBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Sonuçlar Kaydedildi';
        
        // Play success sound
        try {
          const successSound = new Audio('/static/sounds/correct.mp3');
          successSound.play();
        } catch (error) {
          console.log("Sound play error:", error);
        }
      }
    })
    .catch(error => {
      console.error("Error saving score:", error);
    });
  }
});
</script>
{% endblock %}
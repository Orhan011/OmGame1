{% extends "layout.html" %}

{% block content %}
<div class="container">
  <div class="game-header text-center mb-4">
    <h1>Mayın Tarlası</h1>
    <p class="text-muted">Mayınları bulup işaretleyin ve alanı temizleyin</p>
  </div>

  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0">Oyun Tahtası</h5>
            <div>
              <span id="mine-counter" class="badge bg-danger me-2">
                <i class="fas fa-bomb me-1"></i><span id="mines-left">10</span>
              </span>
              <span id="timer" class="badge bg-light text-dark">
                <i class="fas fa-clock me-1"></i>00:00
              </span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="mine-field" class="mb-3 mx-auto">
            <!-- JavaScript ile mayın tarlası burada oluşturulacak -->
          </div>
          <div class="game-controls d-flex justify-content-center">
            <button id="new-game-btn" class="btn btn-primary me-2">Yeni Oyun</button>
            <button id="restart-btn" class="btn btn-warning">Yeniden Başlat</button>
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="m-0">Oyun Ayarları</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="difficulty-select" class="form-label">Zorluk Seviyesi:</label>
              <select id="difficulty-select" class="form-select">
                <option value="beginner">Başlangıç (9x9, 10 mayın)</option>
                <option value="intermediate">Orta (16x16, 40 mayın)</option>
                <option value="expert">Uzman (16x30, 99 mayın)</option>
              </select>
            </div>
            <div class="col-md-6">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="first-click-safe" checked>
                <label class="form-check-label" for="first-click-safe">
                  İlk Tıklama Güvenli
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto-flag" checked>
                <label class="form-check-label" for="auto-flag">
                  Otomatik Bayrak (Numaraların etrafındaki son hücreyi işaretle)
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="m-0">Nasıl Oynanır?</h5>
        </div>
        <div class="card-body">
          <p>Mayın Tarlası, mantık ve hafıza becerilerinizi kullanan klasik bir bulmaca oyunudır.</p>
          <ul>
            <li><strong>Sol Tıklama:</strong> Hücreyi açar. Mayına tıklarsanız oyun biter!</li>
            <li><strong>Sağ Tıklama:</strong> Hücreyi bayrak ile işaretler (mayın olduğunu düşündüğünüz hücreler için).</li>
            <li><strong>Çift Tıklama / Orta Tıklama:</strong> Bir sayının etrafındaki işaretlenmemiş hücreleri açar (sayı ile işaretli mayın sayısı eşitse).</li>
          </ul>
          <p>Görev, tüm mayınları doğru bir şekilde işaretlemek ve mayın olmayan tüm hücreleri açmaktır.</p>
          <p>Sayılar, o hücrenin etrafındaki mayın sayısını gösterir. Bu ipuçlarını kullanarak mayınların yerini tespit edebilirsiniz.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sonuç Modalı -->
<div class="modal fade" id="result-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title">Tebrikler!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="win-message">
          <p>Mayın tarlasını başarıyla temizlediniz!</p>
          <div class="text-center mb-3">
            <i class="fas fa-trophy fa-3x text-warning"></i>
          </div>
        </div>
        <div id="lose-message" style="display:none;">
          <p>Mayına bastınız!</p>
          <div class="text-center mb-3">
            <i class="fas fa-bomb fa-3x text-danger"></i>
          </div>
        </div>
        <div class="result-stats p-3 bg-light rounded">
          <div class="row text-center">
            <div class="col-4">
              <div class="stat-label">Süre</div>
              <div class="stat-value" id="result-time">00:00</div>
            </div>
            <div class="col-4">
              <div class="stat-label">Zorluk</div>
              <div class="stat-value" id="result-difficulty">Başlangıç</div>
            </div>
            <div class="col-4">
              <div class="stat-label">Mayınlar</div>
              <div class="stat-value" id="result-mines">10</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button type="button" class="btn btn-primary" id="new-game-modal">Yeni Oyun</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Mayın tarlası konteynerı */
  #mine-field {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    grid-gap: 1px;
    max-width: 450px;
    border: 2px solid #333;
    user-select: none;
  }
  
  /* Hücre stilleri */
  .cell {
    width: 100%;
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #bdbdbd;
    border: 2px solid;
    border-color: #fff #7d7d7d #7d7d7d #fff;
    font-weight: bold;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.1s;
  }
  
  .cell:hover:not(.revealed) {
    background-color: #d4d4d4;
  }
  
  .cell.revealed {
    background-color: #e0e0e0;
    border: 1px solid #bdbdbd;
  }
  
  /* Bayrak ve soru işareti */
  .cell.flagged {
    background-color: #bdbdbd;
    color: #ff0000;
  }
  
  .cell.question {
    background-color: #bdbdbd;
    color: #0000ff;
  }
  
  /* Patlayan mayın */
  .cell.mine-exploded {
    background-color: #ff0000;
    color: #000;
  }
  
  /* Sayı renkleri */
  .cell.revealed[data-mines="1"] { color: #0000ff; }
  .cell.revealed[data-mines="2"] { color: #008000; }
  .cell.revealed[data-mines="3"] { color: #ff0000; }
  .cell.revealed[data-mines="4"] { color: #000080; }
  .cell.revealed[data-mines="5"] { color: #800000; }
  .cell.revealed[data-mines="6"] { color: #008080; }
  .cell.revealed[data-mines="7"] { color: #000000; }
  .cell.revealed[data-mines="8"] { color: #808080; }
  
  /* Mobil uyumlu ekstra stiller */
  @media (max-width: 576px) {
    .cell {
      font-size: 0.9rem;
    }
    
    #mine-field {
      max-width: 100%;
    }
  }
  
  /* İstatistik stilleri */
  .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
  }
  
  .stat-value {
    font-size: 1.1rem;
    font-weight: bold;
    color: #212529;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Oyun durumu
    let gameState = {
      width: 9,
      height: 9,
      mines: 10,
      board: [],
      firstClick: true,
      gameOver: false,
      minesMarked: 0,
      cellsRevealed: 0,
      timer: 0,
      timerInterval: null,
      difficulty: 'beginner'
    };
    
    // DOM elementleri
    const mineField = document.getElementById('mine-field');
    const minesLeftDisplay = document.getElementById('mines-left');
    const timerDisplay = document.getElementById('timer');
    const difficultySelect = document.getElementById('difficulty-select');
    const firstClickSafe = document.getElementById('first-click-safe');
    const autoFlag = document.getElementById('auto-flag');
    const newGameBtn = document.getElementById('new-game-btn');
    const restartBtn = document.getElementById('restart-btn');
    const resultModal = new bootstrap.Modal(document.getElementById('result-modal'));
    const modalTitle = document.getElementById('modal-title');
    const winMessage = document.getElementById('win-message');
    const loseMessage = document.getElementById('lose-message');
    const resultTime = document.getElementById('result-time');
    const resultDifficulty = document.getElementById('result-difficulty');
    const resultMines = document.getElementById('result-mines');
    const newGameModalBtn = document.getElementById('new-game-modal');
    
    // Yeni oyun başlat
    function initGame() {
      // Zorluk seviyesine göre ayarlamaları yap
      setDifficultySettings();
      
      // Tahtayı sıfırla
      gameState.board = [];
      gameState.firstClick = true;
      gameState.gameOver = false;
      gameState.minesMarked = 0;
      gameState.cellsRevealed = 0;
      
      // Zamanlayıcıyı sıfırla
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
      }
      gameState.timer = 0;
      updateTimerDisplay();
      
      // Mayın sayacını güncelle
      updateMineCounter();
      
      // Oyun tahtasını oluştur
      createBoard();
    }
    
    function setDifficultySettings() {
      gameState.difficulty = difficultySelect.value;
      
      switch (gameState.difficulty) {
        case 'beginner':
          gameState.width = 9;
          gameState.height = 9;
          gameState.mines = 10;
          break;
        case 'intermediate':
          gameState.width = 16;
          gameState.height = 16;
          gameState.mines = 40;
          break;
        case 'expert':
          gameState.width = 30;
          gameState.height = 16;
          gameState.mines = 99;
          break;
      }
      
      // Grid kolonlarını ayarla
      mineField.style.gridTemplateColumns = `repeat(${gameState.width}, 1fr)`;
    }
    
    // Tahtayı oluştur
    function createBoard() {
      mineField.innerHTML = '';
      
      // Boş tahtayı oluştur
      for (let y = 0; y < gameState.height; y++) {
        let row = [];
        for (let x = 0; x < gameState.width; x++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.x = x;
          cell.dataset.y = y;
          
          // Sol tıklama - hücreyi aç
          cell.addEventListener('click', (e) => {
            if (gameState.gameOver) return;
            revealCell(x, y);
          });
          
          // Sağ tıklama - bayrak işaretle
          cell.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (gameState.gameOver) return;
            toggleFlag(x, y);
          });
          
          // Çift tıklama - etraftaki hücreleri aç
          cell.addEventListener('dblclick', (e) => {
            if (gameState.gameOver) return;
            chordCells(x, y);
          });
          
          mineField.appendChild(cell);
          
          // Hücre durumu: { isMine: false, isRevealed: false, isFlagged: false, neighborMines: 0 }
          row.push({
            isMine: false,
            isRevealed: false,
            isFlagged: false,
            isQuestion: false,
            neighborMines: 0
          });
        }
        gameState.board.push(row);
      }
    }
    
    // Mayınları yerleştir
    function placeMines(clickX, clickY) {
      let minesPlaced = 0;
      
      // İlk tıklanan hücre ve komşuları için güvenli alan oluştur
      const safeArea = [];
      if (firstClickSafe.checked) {
        for (let y = Math.max(0, clickY - 1); y <= Math.min(gameState.height - 1, clickY + 1); y++) {
          for (let x = Math.max(0, clickX - 1); x <= Math.min(gameState.width - 1, clickX + 1); x++) {
            safeArea.push({x, y});
          }
        }
      } else {
        safeArea.push({x: clickX, y: clickY});
      }
      
      // Mayınları rastgele yerleştir
      while (minesPlaced < gameState.mines) {
        const x = Math.floor(Math.random() * gameState.width);
        const y = Math.floor(Math.random() * gameState.height);
        
        // Güvenli alanda mayın olmamalı
        if (safeArea.some(pos => pos.x === x && pos.y === y)) {
          continue;
        }
        
        // Bu konumda zaten mayın var mı kontrol et
        if (!gameState.board[y][x].isMine) {
          gameState.board[y][x].isMine = true;
          minesPlaced++;
        }
      }
      
      // Komşu mayın sayılarını hesapla
      calculateNeighborMines();
    }
    
    // Hücrenin komşu mayın sayısını hesapla
    function calculateNeighborMines() {
      for (let y = 0; y < gameState.height; y++) {
        for (let x = 0; x < gameState.width; x++) {
          if (gameState.board[y][x].isMine) continue;
          
          let count = 0;
          
          // Etraftaki 8 hücreyi kontrol et
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              if (dx === 0 && dy === 0) continue;
              
              const nx = x + dx;
              const ny = y + dy;
              
              if (nx >= 0 && nx < gameState.width && ny >= 0 && ny < gameState.height) {
                if (gameState.board[ny][nx].isMine) {
                  count++;
                }
              }
            }
          }
          
          gameState.board[y][x].neighborMines = count;
        }
      }
    }
    
    // Hücreyi aç
    function revealCell(x, y) {
      // Bayrak işaretli ise açma
      if (gameState.board[y][x].isFlagged || gameState.board[y][x].isQuestion) {
        return;
      }
      
      // Zaten açılmış ise bir şey yapma
      if (gameState.board[y][x].isRevealed) {
        return;
      }
      
      // İlk tıklama ise mayınları yerleştir ve zamanlayıcıyı başlat
      if (gameState.firstClick) {
        placeMines(x, y);
        gameState.firstClick = false;
        startTimer();
      }
      
      // Mayın ise oyun biter
      if (gameState.board[y][x].isMine) {
        gameOver(false);
        
        // Tıklanan mayını patlayan mayın olarak göster
        const cell = getCellElement(x, y);
        cell.classList.add('revealed', 'mine-exploded');
        cell.innerHTML = '<i class="fas fa-bomb"></i>';
        
        return;
      }
      
      // Hücreyi aç
      gameState.board[y][x].isRevealed = true;
      gameState.cellsRevealed++;
      
      const cell = getCellElement(x, y);
      cell.classList.add('revealed');
      
      // Komşu mayın sayısını göster
      const neighborMines = gameState.board[y][x].neighborMines;
      if (neighborMines > 0) {
        cell.textContent = neighborMines;
        cell.dataset.mines = neighborMines;
      }
      
      // Komşu mayını olmayan hücrelerin komşularını otomatik aç
      if (neighborMines === 0) {
        for (let dy = -1; dy <= 1; dy++) {
          for (let dx = -1; dx <= 1; dx++) {
            if (dx === 0 && dy === 0) continue;
            
            const nx = x + dx;
            const ny = y + dy;
            
            if (nx >= 0 && nx < gameState.width && ny >= 0 && ny < gameState.height) {
              revealCell(nx, ny);
            }
          }
        }
      }
      
      // Kazanma durumunu kontrol et
      checkWinCondition();
    }
    
    // Kazanma durumunu kontrol et
    function checkWinCondition() {
      const totalNonMineCells = gameState.width * gameState.height - gameState.mines;
      
      if (gameState.cellsRevealed === totalNonMineCells) {
        gameOver(true);
      }
    }
    
    // Bayrak işaretini aç/kapat
    function toggleFlag(x, y) {
      // Açılmış hücrelere bayrak koyulamaz
      if (gameState.board[y][x].isRevealed) {
        return;
      }
      
      const cell = getCellElement(x, y);
      
      if (!gameState.board[y][x].isFlagged && !gameState.board[y][x].isQuestion) {
        // Bayrak koy
        gameState.board[y][x].isFlagged = true;
        cell.classList.add('flagged');
        cell.innerHTML = '<i class="fas fa-flag"></i>';
        gameState.minesMarked++;
      } else if (gameState.board[y][x].isFlagged) {
        // Soru işareti koy
        gameState.board[y][x].isFlagged = false;
        gameState.board[y][x].isQuestion = true;
        cell.classList.remove('flagged');
        cell.classList.add('question');
        cell.innerHTML = '<i class="fas fa-question"></i>';
        gameState.minesMarked--;
      } else {
        // İşareti kaldır
        gameState.board[y][x].isQuestion = false;
        cell.classList.remove('question');
        cell.innerHTML = '';
      }
      
      updateMineCounter();
    }
    
    // Bir sayının etrafındaki hücreleri aç (çift tıklama)
    function chordCells(x, y) {
      // Hücrenin açılmış ve sayı olması gerekiyor
      if (!gameState.board[y][x].isRevealed || gameState.board[y][x].neighborMines === 0) {
        return;
      }
      
      // Etraftaki bayrak sayısını hesapla
      let flaggedCount = 0;
      let cellsToReveal = [];
      
      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          if (dx === 0 && dy === 0) continue;
          
          const nx = x + dx;
          const ny = y + dy;
          
          if (nx >= 0 && nx < gameState.width && ny >= 0 && ny < gameState.height) {
            if (gameState.board[ny][nx].isFlagged) {
              flaggedCount++;
            } else if (!gameState.board[ny][nx].isRevealed) {
              cellsToReveal.push({x: nx, y: ny});
            }
          }
        }
      }
      
      // Bayraklar sayıya eşitse etraftaki hücreleri aç
      if (flaggedCount === gameState.board[y][x].neighborMines) {
        cellsToReveal.forEach(pos => {
          revealCell(pos.x, pos.y);
        });
      }
    }
    
    // Oyun sonu
    function gameOver(isWin) {
      gameState.gameOver = true;
      clearInterval(gameState.timerInterval);
      
      // Tüm mayınları ve yanlış bayrakları göster
      if (!isWin) {
        for (let y = 0; y < gameState.height; y++) {
          for (let x = 0; x < gameState.width; x++) {
            const cell = getCellElement(x, y);
            
            if (gameState.board[y][x].isMine && !gameState.board[y][x].isFlagged) {
              // Açılmamış mayınları göster
              cell.classList.add('revealed');
              cell.innerHTML = '<i class="fas fa-bomb"></i>';
            } else if (gameState.board[y][x].isFlagged && !gameState.board[y][x].isMine) {
              // Yanlış bayrakları göster
              cell.classList.add('revealed');
              cell.innerHTML = '<i class="fas fa-times text-danger"></i>';
            }
          }
        }
      } else {
        // Kazandıysa tüm mayınlara bayrak koy
        for (let y = 0; y < gameState.height; y++) {
          for (let x = 0; x < gameState.width; x++) {
            if (gameState.board[y][x].isMine && !gameState.board[y][x].isFlagged) {
              const cell = getCellElement(x, y);
              cell.classList.add('flagged');
              cell.innerHTML = '<i class="fas fa-flag"></i>';
            }
          }
        }
        gameState.minesMarked = gameState.mines;
        updateMineCounter();
      }
      
      // Sonuç ekranını göster
      modalTitle.textContent = isWin ? 'Tebrikler!' : 'Oyun Bitti!';
      winMessage.style.display = isWin ? 'block' : 'none';
      loseMessage.style.display = isWin ? 'none' : 'block';
      
      // Sonuç istatistiklerini göster
      resultTime.textContent = formatTime(gameState.timer);
      
      switch (gameState.difficulty) {
        case 'beginner':
          resultDifficulty.textContent = 'Başlangıç';
          break;
        case 'intermediate':
          resultDifficulty.textContent = 'Orta';
          break;
        case 'expert':
          resultDifficulty.textContent = 'Uzman';
          break;
      }
      
      resultMines.textContent = gameState.mines;
      
      // Modalı göster
      resultModal.show();
    }
    
    // Zamanlayıcıyı başlat
    function startTimer() {
      gameState.timerInterval = setInterval(() => {
        gameState.timer++;
        updateTimerDisplay();
      }, 1000);
    }
    
    // Zamanlayıcıyı güncelle
    function updateTimerDisplay() {
      timerDisplay.innerHTML = `<i class="fas fa-clock me-1"></i>${formatTime(gameState.timer)}`;
    }
    
    // Mayın sayacını güncelle
    function updateMineCounter() {
      const minesLeft = gameState.mines - gameState.minesMarked;
      minesLeftDisplay.textContent = minesLeft;
    }
    
    // Zamanı formatla
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Hücre elementini bul
    function getCellElement(x, y) {
      return document.querySelector(`.cell[data-x="${x}"][data-y="${y}"]`);
    }
    
    // Event Listeners
    newGameBtn.addEventListener('click', initGame);
    restartBtn.addEventListener('click', initGame);
    newGameModalBtn.addEventListener('click', () => {
      resultModal.hide();
      initGame();
    });
    
    difficultySelect.addEventListener('change', initGame);
    
    // İlk yükleme
    initGame();
  });
</script>
{% endblock %}
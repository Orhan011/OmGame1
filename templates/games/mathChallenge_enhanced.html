{% extends 'layout.html' %}

{% block title %}Matematik Mücadelesi - ZekaPark{% endblock %}

{% block content %}
<div class="page-container">
  <div class="game-container">
    <div class="game-header">
      <h1>Matematik Mücadelesi <span class="badge">Sayısal Beceri</span></h1>
      <p class="game-description">Hızlı düşünme ve matematiksel becerilerinizi test edin.</p>
    </div>

    <div class="math-container">
      <div class="game-status">
        <div class="status-item">
          <div class="status-label">Skor</div>
          <div class="status-value" id="score">0</div>
        </div>
        <div class="status-item">
          <div class="status-label">En İyi</div>
          <div class="status-value" id="best-score">0</div>
        </div>
        <div class="status-item">
          <div class="status-label">Doğru</div>
          <div class="status-value" id="correct-count">0</div>
        </div>
        <div class="status-item">
          <div class="status-label">Seviye</div>
          <div class="status-value" id="level-display">1</div>
        </div>
        <div class="status-item timer-container">
          <div class="status-label">Süre</div>
          <div class="status-value" id="timer">60</div>
          <div class="timer-bar-small-container">
            <div id="timer-bar-small" class="timer-bar-small"></div>
          </div>
        </div>
      </div>
      
      <div id="start-screen" class="math-screen">
        <h2>Matematik Mücadelesine Hoş Geldiniz!</h2>
        <p>Verilen süre içinde matematik problemlerini çözmeye çalışın.</p>
        
        <div class="game-options">
          <div class="option-section">
            <h3>Zorluk Seviyesi</h3>
            <div class="button-group">
              <button class="option-button active" data-difficulty="easy">Kolay</button>
              <button class="option-button" data-difficulty="medium">Orta</button>
              <button class="option-button" data-difficulty="hard">Zor</button>
            </div>
          </div>
          
          <div class="option-section">
            <h3>Süre</h3>
            <div class="button-group">
              <button class="option-button" data-time="30">30 Saniye</button>
              <button class="option-button active" data-time="60">60 Saniye</button>
              <button class="option-button" data-time="120">2 Dakika</button>
            </div>
          </div>
          
          <div class="option-section">
            <h3>İşlem Türleri</h3>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" checked data-operation="addition"> Toplama
              </label>
              <label class="checkbox-label">
                <input type="checkbox" checked data-operation="subtraction"> Çıkarma
              </label>
              <label class="checkbox-label">
                <input type="checkbox" checked data-operation="multiplication"> Çarpma
              </label>
              <label class="checkbox-label">
                <input type="checkbox" data-operation="division"> Bölme
              </label>
              <label class="checkbox-label">
                <input type="checkbox" data-operation="exponent"> Üs Alma
              </label>
              <label class="checkbox-label">
                <input type="checkbox" data-operation="percentage"> Yüzde
              </label>
            </div>
          </div>
          
          <div class="option-section" id="game-mode-section">
            <h3>Oyun Modu</h3>
            <div class="button-group">
              <button class="mode-button active" data-mode="standard">Standart</button>
              <button class="mode-button" data-mode="blitz">Hızlı</button>
              <button class="mode-button" data-mode="endless">Sonsuz</button>
            </div>
          </div>
          
          <div class="option-section" id="visual-effects-section">
            <h3>Görsel Efektler</h3>
            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="enable-particles" checked> Parçacık Efektleri
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="enable-animations" checked> Animasyonlar
              </label>
            </div>
          </div>
        </div>
        
        <button id="start-game" class="btn btn-primary btn-lg">
          <i class="fas fa-play me-2"></i>Oyuna Başla
        </button>
      </div>

      <div id="game-screen" class="math-screen" style="display: none;">
        <div id="countdown" class="countdown">3</div>
        
        <div class="level-indicator" id="level-indicator">Seviye 1</div>
        
        <div class="math-problem-container">
          <div class="problem-card">
            <div id="problem-text">5 + 3 = ?</div>
            <div class="problem-timer-bar-container">
              <div class="problem-timer-bar" id="problem-timer-bar"></div>
            </div>
          </div>
        </div>

        <div class="answer-input">
          <input type="number" id="answer-input" placeholder="Cevabınız">
          <button id="submit-answer" class="btn btn-primary">
            <i class="fas fa-check me-2"></i>Kontrol Et
          </button>
        </div>

        <div id="feedback" class="feedback"></div>
        
        <div class="streak-bar">
          <div class="streak-counter">
            <span id="streak-count">0</span> Seri
          </div>
          <div class="streak-icons" id="streak-icons"></div>
        </div>
        
        <div class="timer-bar-container">
          <div id="timer-bar" class="timer-bar"></div>
        </div>
      </div>

      <div id="result-screen" class="math-screen" style="display: none;">
        <h2>Oyun Bitti!</h2>
        
        <div class="result-stats">
          <div class="result-stat">
            <div class="result-value" id="final-score">0</div>
            <div class="result-label">Toplam Puan</div>
          </div>
          <div class="result-stat">
            <div class="result-value" id="final-correct">0</div>
            <div class="result-label">Doğru</div>
          </div>
          <div class="result-stat">
            <div class="result-value" id="final-incorrect">0</div>
            <div class="result-label">Yanlış</div>
          </div>
          <div class="result-stat">
            <div class="result-value" id="final-level">1</div>
            <div class="result-label">Seviye</div>
          </div>
        </div>
        
        <div class="result-details">
          <div class="detail-item">
            <span class="detail-label">Doğruluk Oranı:</span>
            <span class="detail-value" id="accuracy">0%</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">En Uzun Seri:</span>
            <span class="detail-value" id="max-streak">0</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Ortalama Yanıt Süresi:</span>
            <span class="detail-value" id="avg-time">0 saniye</span>
          </div>
        </div>
        
        <div class="result-actions">
          <button id="play-again" class="btn btn-primary btn-lg">
            <i class="fas fa-redo-alt me-2"></i>Tekrar Oyna
          </button>
          <a href="{{ url_for('all_games') }}" class="btn btn-outline-light btn-lg">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>
    </div>
    
    <div id="notification" class="game-notification">
      <div class="notification-content">
        <p id="notification-message"></p>
        <button id="close-notification" class="btn-close"><i class="fas fa-times"></i></button>
      </div>
    </div>
  </div>
</div>

<style>
  .math-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 10px;
  }
  
  .game-status {
    display: flex;
    justify-content: space-between;
    background: rgba(25, 25, 45, 0.7);
    border-radius: 10px;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .status-item {
    flex: 1;
    text-align: center;
    padding: 15px 10px;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
  }

  .status-item:last-child {
    border-right: none;
  }

  .status-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 5px;
  }

  .status-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent-color);
  }
  
  .timer-container {
    position: relative;
  }
  
  .timer-bar-small-container {
    position: absolute;
    bottom: 5px;
    left: 15px;
    right: 15px;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
  }
  
  .timer-bar-small {
    height: 100%;
    background: var(--accent-color);
    width: 100%;
    transition: width linear 0.1s;
  }
  
  .timer-warning .timer-bar-small {
    background: #FF4B2B;
  }

  .math-screen {
    background: rgba(25, 25, 45, 0.7);
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
  }

  .math-screen h2 {
    color: var(--accent-color);
    font-size: 2rem;
    margin-bottom: 20px;
  }

  .math-screen p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 25px;
    font-size: 1.1rem;
  }
  
  .countdown {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 5rem;
    font-weight: 700;
    color: white;
    opacity: 0;
    animation: countdownAnimation 1s ease-in-out;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    z-index: 10;
  }
  
  @keyframes countdownAnimation {
    0% {
      transform: translate(-50%, -50%) scale(1.5);
      opacity: 0;
    }
    20% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    80% {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
    100% {
      transform: translate(-50%, -50%) scale(0.5);
      opacity: 0;
    }
  }
  
  .level-indicator {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(106, 90, 224, 0.3);
    border: 1px solid rgba(106, 90, 224, 0.5);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.9rem;
    color: white;
    font-weight: 600;
  }

  .game-options {
    margin-bottom: 30px;
  }
  
  .option-section {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
  }

  .option-section h3 {
    color: white;
    font-size: 1.2rem;
    margin-bottom: 10px;
    text-align: center;
  }

  .button-group {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .option-button, .mode-button {
    flex: 1;
    padding: 10px 20px;
    background: rgba(30, 30, 60, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .option-button:hover, .mode-button:hover {
    background: rgba(40, 40, 80, 0.5);
  }

  .option-button.active, .mode-button.active {
    background: var(--accent-color);
    border-color: var(--accent-color);
  }

  .checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    padding: 0 10px;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    color: white;
    cursor: pointer;
  }

  .checkbox-label input {
    margin-right: 8px;
  }

  /* Math Problem */
  .math-problem-container {
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 30px;
  }
  
  .problem-card {
    background: rgba(40, 40, 80, 0.5);
    border-radius: 10px;
    padding: 30px;
    min-width: 70%;
    position: relative;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  #problem-text {
    font-size: 2.5rem;
    font-weight: 700;
    color: white;
    margin-bottom: 20px;
    transition: all 0.3s ease;
  }
  
  .problem-timer-bar-container {
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    overflow: hidden;
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
  }
  
  .problem-timer-bar {
    height: 100%;
    background: var(--accent-color);
    width: 100%;
    transition: width linear 0.1s;
  }

  /* Answer Input */
  .answer-input {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  #answer-input {
    flex: 1;
    padding: 12px 15px;
    background: rgba(30, 30, 60, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    color: white;
    font-size: 1.2rem;
    text-align: center;
  }

  #answer-input:focus {
    outline: none;
    border-color: var(--accent-color);
  }

  /* Feedback */
  .feedback {
    font-size: 1.2rem;
    font-weight: 600;
    height: 30px;
    transition: all 0.3s ease;
    margin-bottom: 20px;
  }

  .feedback.correct {
    color: #4CAF50;
  }

  .feedback.incorrect {
    color: #F44336;
  }
  
  /* Streak Bar */
  .streak-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .streak-counter {
    background: rgba(30, 30, 60, 0.5);
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    color: white;
  }
  
  .streak-icons {
    display: flex;
    gap: 5px;
  }
  
  .streak-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.7rem;
    color: white;
  }
  
  .streak-icon.correct {
    background: #4CAF50;
  }
  
  .streak-icon.incorrect {
    background: #F44336;
  }

  .timer-bar-container {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .timer-bar {
    height: 100%;
    background: var(--accent-color);
    width: 100%;
    border-radius: 4px;
    transition: width linear 0.1s;
  }

  /* Result Screen */
  .result-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
  }

  .result-stat {
    background: rgba(40, 40, 80, 0.5);
    border-radius: 10px;
    padding: 20px;
    min-width: 120px;
    text-align: center;
  }

  .result-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 5px;
  }

  .result-label {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .result-details {
    background: rgba(40, 40, 80, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 30px;
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .detail-item:last-child {
    border-bottom: none;
  }

  .detail-label {
    color: rgba(255, 255, 255, 0.7);
  }

  .detail-value {
    color: white;
    font-weight: 600;
  }

  .result-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 300px;
    margin: 0 auto;
  }
  
  .game-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(25, 25, 45, 0.9);
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    max-width: 300px;
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
  }
  
  .game-notification.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: all;
  }
  
  .notification-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .notification-content p {
    margin: 0;
    color: white;
    font-size: 0.9rem;
  }
  
  .btn-close {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    font-size: 1rem;
    padding: 0;
    margin-left: 10px;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .math-screen {
      padding: 20px;
    }

    #problem-text {
      font-size: 2rem;
    }

    .answer-input {
      flex-direction: column;
    }

    #answer-input {
      padding: 10px;
      font-size: 1.1rem;
    }

    .result-value {
      font-size: 2rem;
    }

    .result-label {
      font-size: 0.9rem;
    }
  }

  @media (max-width: 480px) {
    .status-value {
      font-size: 1.5rem;
    }

    .game-screen h2 {
      font-size: 1.5rem;
    }

    #problem-text {
      font-size: 1.8rem;
    }

    .checkbox-group {
      grid-template-columns: 1fr 1fr;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const resultScreen = document.getElementById('result-screen');
  
  const difficultyButtons = document.querySelectorAll('[data-difficulty]');
  const timeButtons = document.querySelectorAll('[data-time]');
  const operationCheckboxes = document.querySelectorAll('[data-operation]');
  const modeButtons = document.querySelectorAll('.mode-button');
  const enableParticles = document.getElementById('enable-particles');
  const enableAnimations = document.getElementById('enable-animations');
  
  const startGameBtn = document.getElementById('start-game');
  const playAgainBtn = document.getElementById('play-again');
  
  const problemText = document.getElementById('problem-text');
  const answerInput = document.getElementById('answer-input');
  const submitAnswerBtn = document.getElementById('submit-answer');
  const feedbackEl = document.getElementById('feedback');
  const problemTimerBar = document.getElementById('problem-timer-bar');
  const countdown = document.getElementById('countdown');
  
  const scoreEl = document.getElementById('score');
  const bestScoreEl = document.getElementById('best-score');
  const correctEl = document.getElementById('correct-count');
  const levelEl = document.getElementById('level-display');
  const levelIndicator = document.getElementById('level-indicator');
  const timerEl = document.getElementById('timer');
  const timerBar = document.getElementById('timer-bar');
  const timerBarSmall = document.getElementById('timer-bar-small');
  
  const streakCount = document.getElementById('streak-count');
  const streakIcons = document.getElementById('streak-icons');
  
  const finalScoreEl = document.getElementById('final-score');
  const finalCorrectEl = document.getElementById('final-correct');
  const finalIncorrectEl = document.getElementById('final-incorrect');
  const finalLevelEl = document.getElementById('final-level');
  const accuracyEl = document.getElementById('accuracy');
  const maxStreakEl = document.getElementById('max-streak');
  const avgTimeEl = document.getElementById('avg-time');
  
  const notification = document.getElementById('notification');
  const notificationMessage = document.getElementById('notification-message');
  const closeNotification = document.getElementById('close-notification');

  // Game Configuration
  let difficulty = 'easy';
  let gameTime = 60; // seconds
  let operations = ['addition', 'subtraction', 'multiplication'];
  let gameMode = 'standard';
  let particlesEnabled = true;
  let animationsEnabled = true;
  
  // Game State
  let score = 0;
  let bestScore = 0;
  let correctAnswers = 0;
  let incorrectAnswers = 0;
  let currentAnswer = 0;
  let timer = null;
  let problemTimer = null;
  let timeRemaining = 0;
  let startTimestamp = 0;
  let totalResponseTime = 0;
  let problemStartTime = 0;
  let currentLevel = 1;
  let countdownActive = false;
  let streak = 0;
  let maxStreak = 0;
  let streakHistory = [];
  let problemTimeLimit = 10; // seconds per problem
  let problemTimeRemaining = problemTimeLimit;
  
  // Check for stored best score
  if (localStorage.getItem('mathChallengeBestScore')) {
    bestScore = parseInt(localStorage.getItem('mathChallengeBestScore'));
    bestScoreEl.textContent = bestScore;
  }

  // Sounds
  const correctSound = new Audio('/static/sounds/correct.mp3');
  const wrongSound = new Audio('/static/sounds/wrong.mp3');
  const gameOverSound = new Audio('/static/sounds/game-over.mp3');
  const levelUpSound = new Audio('/static/sounds/level-up.mp3');
  const countdownSound = new Audio('/static/sounds/click.mp3');

  // Event Listeners for Configuration
  difficultyButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update difficulty
      difficulty = this.getAttribute('data-difficulty');
      
      // Update UI
      difficultyButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });

  timeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update game time
      gameTime = parseInt(this.getAttribute('data-time'));
      
      // Update UI
      timeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });
  
  modeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update game mode
      gameMode = this.getAttribute('data-mode');
      
      // Update UI
      modeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // Update game time based on mode
      if (gameMode === 'blitz') {
        document.querySelectorAll('[data-time]').forEach(btn => {
          if (parseInt(btn.getAttribute('data-time')) === 30) {
            btn.click();
          }
        });
      }
    });
  });
  
  // Visual effects toggles
  enableParticles.addEventListener('change', function() {
    particlesEnabled = this.checked;
  });
  
  enableAnimations.addEventListener('change', function() {
    animationsEnabled = this.checked;
  });

  // Start Game Button
  startGameBtn.addEventListener('click', function() {
    // Get selected operations
    operations = [];
    operationCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        operations.push(checkbox.getAttribute('data-operation'));
      }
    });
    
    // Make sure at least one operation is selected
    if (operations.length === 0) {
      showNotification('Lütfen en az bir işlem türü seçin!');
      return;
    }
    
    // Start the game
    startGame();
  });

  // Submit Answer Button
  submitAnswerBtn.addEventListener('click', checkAnswer);

  // Answer Input Enter Key
  answerInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      checkAnswer();
    }
  });

  // Play Again Button
  playAgainBtn.addEventListener('click', function() {
    showScreen(startScreen);
  });
  
  // Close notification
  closeNotification.addEventListener('click', function() {
    notification.classList.remove('show');
  });

  // Functions
  function startGame() {
    // Reset game state
    score = 0;
    correctAnswers = 0;
    incorrectAnswers = 0;
    totalResponseTime = 0;
    currentLevel = 1;
    streak = 0;
    maxStreak = 0;
    streakHistory = [];
    
    // Reset UI
    scoreEl.textContent = score;
    correctEl.textContent = correctAnswers;
    levelEl.textContent = currentLevel;
    levelIndicator.textContent = `Seviye ${currentLevel}`;
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';
    streakCount.textContent = streak;
    streakIcons.innerHTML = '';
    
    // Set timer
    timeRemaining = gameMode === 'endless' ? Infinity : gameTime;
    timerEl.textContent = gameMode === 'endless' ? '∞' : timeRemaining;
    timerBar.style.width = '100%';
    timerBarSmall.style.width = '100%';
    
    // Show game screen
    showScreen(gameScreen);
    
    // Start countdown
    startCountdown();
  }
  
  function startCountdown() {
    countdownActive = true;
    let count = 3;
    countdown.textContent = count;
    countdown.style.opacity = 0;
    
    const countInterval = setInterval(() => {
      countdownSound.play();
      countdown.style.opacity = 0;
      setTimeout(() => {
        count--;
        if (count > 0) {
          countdown.textContent = count;
          countdown.style.opacity = 1;
          setTimeout(() => {
            countdown.style.opacity = 0;
          }, 800);
        } else {
          clearInterval(countInterval);
          countdownActive = false;
          
          // Focus answer input
          answerInput.value = '';
          answerInput.focus();
          
          // Generate first problem
          generateProblem();
          
          // Start timer
          startTimestamp = Date.now();
          
          // Start game timer if not in endless mode
          if (gameMode !== 'endless') {
            timer = setInterval(updateTimer, 1000);
          }
        }
      }, 200);
    }, 1000);
    
    setTimeout(() => {
      countdown.textContent = count;
      countdown.style.opacity = 1;
      setTimeout(() => {
        countdown.style.opacity = 0;
      }, 800);
    }, 200);
  }

  function generateProblem() {
    // Stop problem timer if running
    if (problemTimer) {
      clearInterval(problemTimer);
    }
    
    // Choose random operation from selected operations
    const operation = operations[Math.floor(Math.random() * operations.length)];
    
    let num1, num2, problem, answer;
    
    // Generate numbers based on difficulty and operation
    switch (operation) {
      case 'addition':
        if (difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 10) + 1;
        } else if (difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 50) + 1;
          num2 = Math.floor(Math.random() * 50) + 1;
        } else { // hard
          num1 = Math.floor(Math.random() * 100) + 1;
          num2 = Math.floor(Math.random() * 100) + 1;
        }
        problem = `${num1} + ${num2} = ?`;
        answer = num1 + num2;
        break;
        
      case 'subtraction':
        if (difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * num1) + 1;
        } else if (difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 50) + 10;
          num2 = Math.floor(Math.random() * num1) + 1;
        } else { // hard
          num1 = Math.floor(Math.random() * 100) + 20;
          num2 = Math.floor(Math.random() * num1) + 1;
        }
        problem = `${num1} - ${num2} = ?`;
        answer = num1 - num2;
        break;
        
      case 'multiplication':
        if (difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 5) + 1;
          num2 = Math.floor(Math.random() * 5) + 1;
        } else if (difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 10) + 1;
        } else { // hard
          num1 = Math.floor(Math.random() * 12) + 1;
          num2 = Math.floor(Math.random() * 12) + 1;
        }
        problem = `${num1} × ${num2} = ?`;
        answer = num1 * num2;
        break;
        
      case 'division':
        // For division, first generate the answer, then multiply to get the dividend
        if (difficulty === 'easy') {
          answer = Math.floor(Math.random() * 5) + 1;
          num2 = Math.floor(Math.random() * 5) + 1;
        } else if (difficulty === 'medium') {
          answer = Math.floor(Math.random() * 10) + 1;
          num2 = Math.floor(Math.random() * 10) + 1;
        } else { // hard
          answer = Math.floor(Math.random() * 12) + 1;
          num2 = Math.floor(Math.random() * 12) + 1;
        }
        num1 = answer * num2; // This ensures whole number answers
        problem = `${num1} ÷ ${num2} = ?`;
        break;
        
      case 'exponent':
        if (difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 5) + 1;
          num2 = 2;
        } else if (difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 8) + 2;
          num2 = Math.floor(Math.random() * 2) + 2; // 2 or 3
        } else { // hard
          num1 = Math.floor(Math.random() * 10) + 2;
          num2 = Math.floor(Math.random() * 3) + 2; // 2, 3, or 4
        }
        problem = `${num1}<sup>${num2}</sup> = ?`;
        answer = Math.pow(num1, num2);
        break;
        
      case 'percentage':
        if (difficulty === 'easy') {
          num1 = Math.floor(Math.random() * 10) * 10; // 0, 10, 20, ..., 90
          num2 = 100;
        } else if (difficulty === 'medium') {
          num1 = Math.floor(Math.random() * 20) * 5; // 0, 5, 10, 15, ..., 95
          num2 = Math.floor(Math.random() * 9 + 2) * 10; // 20, 30, ..., 100
        } else { // hard
          num1 = Math.floor(Math.random() * 100); // 0-99
          num2 = Math.floor(Math.random() * 99 + 2); // 2-100
        }
        problem = `${num1}% of ${num2} = ?`;
        answer = Math.round((num1 / 100) * num2);
        break;
    }
    
    // Update UI
    problemText.innerHTML = problem;
    currentAnswer = answer;
    
    // Reset input
    answerInput.value = '';
    answerInput.focus();
    
    // Reset feedback
    feedbackEl.textContent = '';
    feedbackEl.className = 'feedback';
    
    // Record problem start time
    problemStartTime = Date.now();
    
    // Set up problem timer based on difficulty and mode
    setupProblemTimer();
  }
  
  function setupProblemTimer() {
    // Determine time limit for problem based on difficulty and game mode
    if (gameMode === 'blitz') {
      problemTimeLimit = difficulty === 'easy' ? 5 : (difficulty === 'medium' ? 4 : 3);
    } else {
      problemTimeLimit = difficulty === 'easy' ? 10 : (difficulty === 'medium' ? 8 : 6);
    }
    
    // Adjust for level
    problemTimeLimit = Math.max(2, problemTimeLimit - (currentLevel - 1));
    
    problemTimeRemaining = problemTimeLimit;
    problemTimerBar.style.width = '100%';
    
    // Start problem timer
    problemTimer = setInterval(() => {
      problemTimeRemaining -= 0.1;
      
      // Update timer bar
      const percentLeft = (problemTimeRemaining / problemTimeLimit) * 100;
      problemTimerBar.style.width = `${percentLeft}%`;
      
      // Change color when time is running out
      if (problemTimeRemaining <= problemTimeLimit * 0.3) {
        problemTimerBar.style.backgroundColor = '#F44336';
      } else {
        problemTimerBar.style.backgroundColor = 'var(--accent-color)';
      }
      
      // Check if time is up for this problem
      if (problemTimeRemaining <= 0) {
        clearInterval(problemTimer);
        
        // Time's up for this problem
        timeUpForProblem();
      }
    }, 100);
  }
  
  function timeUpForProblem() {
    // Count as wrong answer
    incorrectAnswers++;
    
    // Update streak
    if (streak > 0) {
      streak = 0;
      streakCount.textContent = streak;
      updateStreakIcons(false);
    }
    
    // Show correct answer
    feedbackEl.textContent = `Süre doldu! Doğru cevap: ${currentAnswer}`;
    feedbackEl.className = 'feedback incorrect';
    
    // Generate new problem after a short delay
    setTimeout(generateProblem, 1500);
  }

  function checkAnswer() {
    // Get user's answer
    const userAnswer = parseInt(answerInput.value);
    
    // If input is empty or not a number, do nothing
    if (isNaN(userAnswer)) {
      return;
    }
    
    // Stop problem timer
    clearInterval(problemTimer);
    
    // Calculate response time
    const responseTime = (Date.now() - problemStartTime) / 1000;
    totalResponseTime += responseTime;
    
    // Check if answer is correct
    if (userAnswer === currentAnswer) {
      // Correct answer
      feedbackEl.textContent = 'Doğru!';
      feedbackEl.className = 'feedback correct';
      
      // Update score (faster answers get more points)
      const timeBonus = Math.max(0, 10 - Math.floor(responseTime));
      const difficultyMultiplier = difficulty === 'easy' ? 1 : (difficulty === 'medium' ? 2 : 3);
      const streakMultiplier = 1 + Math.min(streak, 10) / 10;
      const levelBonus = currentLevel - 1;
      
      const pointsEarned = Math.round((10 + timeBonus * difficultyMultiplier) * streakMultiplier) + levelBonus;
      
      score += pointsEarned;
      correctAnswers++;
      
      // Update streak
      streak++;
      if (streak > maxStreak) maxStreak = streak;
      streakCount.textContent = streak;
      updateStreakIcons(true);
      
      // Check for level up
      if (correctAnswers > 0 && correctAnswers % 10 === 0) {
        levelUp();
      }
      
      // Play sound
      correctSound.play();
      
      // Show particles if enabled
      if (particlesEnabled) {
        createCorrectParticles();
      }
    } else {
      // Incorrect answer
      feedbackEl.textContent = `Yanlış! Doğru cevap: ${currentAnswer}`;
      feedbackEl.className = 'feedback incorrect';
      
      incorrectAnswers++;
      
      // Reset streak
      if (streak > 0) {
        streak = 0;
        streakCount.textContent = streak;
        updateStreakIcons(false);
      }
      
      // Play sound
      wrongSound.play();
      
      // Show particles if enabled
      if (particlesEnabled) {
        createWrongParticles();
      }
    }
    
    // Update UI
    scoreEl.textContent = score;
    correctEl.textContent = correctAnswers;
    
    // Generate new problem after a short delay
    setTimeout(generateProblem, 1500);
  }
  
  function updateStreakIcons(isCorrect) {
    // Add to streak history (limit to last 10)
    streakHistory.push(isCorrect);
    if (streakHistory.length > 10) {
      streakHistory.shift();
    }
    
    // Update streak icons
    streakIcons.innerHTML = '';
    streakHistory.forEach(correct => {
      const icon = document.createElement('div');
      icon.className = `streak-icon ${correct ? 'correct' : 'incorrect'}`;
      icon.innerHTML = correct ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
      streakIcons.appendChild(icon);
    });
  }
  
  function levelUp() {
    currentLevel++;
    
    // Update UI
    levelEl.textContent = currentLevel;
    levelIndicator.textContent = `Seviye ${currentLevel}`;
    
    // Play level up sound
    levelUpSound.play();
    
    // Show notification
    showNotification(`Seviye ${currentLevel}'e yükseldiniz!`);
    
    // Show particles if enabled
    if (particlesEnabled) {
      createLevelUpParticles();
    }
  }

  function updateTimer() {
    timeRemaining--;
    
    // Update UI
    timerEl.textContent = timeRemaining;
    const percentLeft = (timeRemaining / gameTime) * 100;
    timerBar.style.width = `${percentLeft}%`;
    timerBarSmall.style.width = `${percentLeft}%`;
    
    // Change color when time is running out
    if (timeRemaining <= 10) {
      document.querySelector('.timer-container').classList.add('timer-warning');
    }
    
    // Check if time is up
    if (timeRemaining <= 0) {
      endGame();
    }
  }

  function endGame() {
    // Stop timer
    clearInterval(timer);
    clearInterval(problemTimer);
    
    // Play sound
    gameOverSound.play();
    
    // Calculate statistics
    const totalAnswers = correctAnswers + incorrectAnswers;
    const accuracy = totalAnswers > 0 ? Math.round((correctAnswers / totalAnswers) * 100) : 0;
    const avgTime = totalAnswers > 0 ? (totalResponseTime / totalAnswers).toFixed(1) : 0;
    
    // Update result screen
    finalScoreEl.textContent = score;
    finalCorrectEl.textContent = correctAnswers;
    finalIncorrectEl.textContent = incorrectAnswers;
    finalLevelEl.textContent = currentLevel;
    accuracyEl.textContent = `${accuracy}%`;
    maxStreakEl.textContent = maxStreak;
    avgTimeEl.textContent = `${avgTime} saniye`;
    
    // Update best score if needed
    if (score > bestScore) {
      bestScore = score;
      bestScoreEl.textContent = bestScore;
      localStorage.setItem('mathChallengeBestScore', bestScore);
    }
    
    // Save score
    saveScore(score);
    
    // Show result screen
    showScreen(resultScreen);
  }

  function showScreen(screen) {
    // Hide all screens
    startScreen.style.display = 'none';
    gameScreen.style.display = 'none';
    resultScreen.style.display = 'none';
    
    // Show the specified screen
    screen.style.display = 'block';
  }
  
  function showNotification(message) {
    notificationMessage.textContent = message;
    notification.classList.add('show');
    
    // Auto hide after 3 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }
  
  // Visual effects functions
  function createCorrectParticles() {
    const container = document.querySelector('.math-problem-container');
    for (let i = 0; i < 15; i++) {
      createParticle(container, '#4CAF50');
    }
  }
  
  function createWrongParticles() {
    const container = document.querySelector('.math-problem-container');
    for (let i = 0; i < 15; i++) {
      createParticle(container, '#F44336');
    }
  }
  
  function createLevelUpParticles() {
    const container = document.querySelector('.level-indicator');
    for (let i = 0; i < 30; i++) {
      createParticle(container, '#6a5ae0');
    }
  }
  
  function createParticle(container, color) {
    const particle = document.createElement('div');
    particle.style.position = 'absolute';
    particle.style.width = Math.random() * 10 + 5 + 'px';
    particle.style.height = particle.style.width;
    particle.style.backgroundColor = color;
    particle.style.borderRadius = '50%';
    particle.style.opacity = '0.7';
    particle.style.pointerEvents = 'none';
    
    // Position particle
    const rect = container.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;
    
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    
    // Add to DOM
    document.body.appendChild(particle);
    
    // Animate particle
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 100 + 50;
    const moveX = Math.cos(angle) * speed;
    const moveY = Math.sin(angle) * speed;
    
    // Animate with CSS
    particle.animate([
      { transform: 'translate(0, 0) scale(1)', opacity: 0.7 },
      { transform: `translate(${moveX}px, ${moveY}px) scale(0)`, opacity: 0 }
    ], {
      duration: Math.random() * 1000 + 500,
      easing: 'cubic-bezier(0, .9, .57, 1)'
    });
    
    // Remove particle after animation
    setTimeout(() => {
      particle.remove();
    }, 1500);
  }
  
  // Function to save score to the server
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        game_type: 'math_challenge',
        score: score
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Score saved:', data);
      if (!data.success && data.message === 'Oturum açık değil!') {
        showNotification('Skorunuzu kaydetmek için giriş yapmalısınız!');
      }
    })
    .catch(error => {
      console.error('Error saving score:', error);
    });
  }
});
</script>
{% endblock %}

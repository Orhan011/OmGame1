{% extends 'layout.html' %}

{% block title %}Galaktik Mücadele - OmGame{% endblock %}

{% block content %}
<div class="page-container">
  <div class="galactic-game-wrapper">
    <div class="game-header">
      <h1><i class="fas fa-rocket"></i> Galaktik Mücadele <span class="badge">Uzay Macerası</span></h1>
      <p class="game-description">Uzayın derinliklerinde yeteneklerinizi test edin ve stratejik düşünme becerilerinizi geliştirin</p>
    </div>

    <div class="game-dashboard">
      <!-- Sol panel - Oyun alanı -->
      <div class="game-area-panel">
        <div class="galactic-game-container">
          <!-- Başlangıç ekranı -->
          <div id="start-screen" class="game-screen">
            <div class="game-mode-selection">
              <h2>Oyun Modu Seçin</h2>
              <div class="game-modes">
                <div class="game-mode-card active" data-mode="asteroid">
                  <div class="mode-icon"><i class="fas fa-meteor"></i></div>
                  <div class="mode-title">Asteroid Avı</div>
                  <div class="mode-description">Asteroidleri yok edin ve puanları toplayın</div>
                </div>
                
                <div class="game-mode-card" data-mode="navigation">
                  <div class="mode-icon"><i class="fas fa-route"></i></div>
                  <div class="mode-title">Galaksi Labirenti</div>
                  <div class="mode-description">En kısa rotayı bulun</div>
                </div>
                
                <div class="game-mode-card" data-mode="defense">
                  <div class="mode-icon"><i class="fas fa-shield-alt"></i></div>
                  <div class="mode-title">Gezegen Savunması</div>
                  <div class="mode-description">Gezegeninizi koruyun</div>
                </div>
              </div>
              
              <div class="difficulty-selection">
                <h3>Zorluk Seviyesi</h3>
                <div class="difficulty-slider-container">
                  <div class="difficulty-labels">
                    <span>Kolay</span>
                    <span>Orta</span>
                    <span>Zor</span>
                  </div>
                  <input type="range" min="1" max="3" value="2" class="difficulty-slider" id="difficulty-selector">
                </div>
              </div>
              
              <div class="game-settings">
                <div class="time-setting">
                  <label for="time-selector">Süre:</label>
                  <select id="time-selector" class="form-select">
                    <option value="60">1 Dakika</option>
                    <option value="120" selected>2 Dakika</option>
                    <option value="300">5 Dakika</option>
                  </select>
                </div>
                
                <div class="questions-setting">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="sound-toggle" checked>
                    <label class="form-check-label" for="sound-toggle">Ses Efektleri</label>
                  </div>
                </div>
              </div>
              
              <button id="start-game-btn" class="btn btn-primary btn-lg btn-pulse">
                <i class="fas fa-play"></i> OYUNU BAŞLAT
              </button>
            </div>
          </div>
          
          <!-- Oyun ekranı -->
          <div id="game-screen" class="game-screen" style="display: none;">
            <div class="game-header-bar">
              <div class="game-stats">
                <div class="stat">
                  <span class="stat-label">Skor</span>
                  <span class="stat-value" id="score-display">0</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Seviye</span>
                  <span class="stat-value" id="level-display">1</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Yaşam</span>
                  <span class="stat-value" id="lives-display">3</span>
                </div>
              </div>
              
              <div class="game-timer">
                <div class="progress-container">
                  <div class="progress-bar" id="time-progress"></div>
                </div>
                <div class="timer-display" id="timer-display">02:00</div>
              </div>
            </div>
            
            <!-- Asteroid Avı modu -->
            <div id="asteroid-mode" class="game-mode-content">
              <div class="game-canvas-container">
                <canvas id="asteroid-canvas"></canvas>
              </div>
              <div class="game-controls">
                <button id="pause-btn" class="btn btn-secondary">
                  <i class="fas fa-pause"></i> Duraklat
                </button>
              </div>
            </div>
            
            <!-- Galaksi Labirenti modu -->
            <div id="navigation-mode" class="game-mode-content" style="display:none;">
              <div class="game-canvas-container">
                <canvas id="navigation-canvas"></canvas>
              </div>
              <div class="game-controls">
                <div class="navigation-controls">
                  <button id="nav-up" class="btn btn-control"><i class="fas fa-chevron-up"></i></button>
                  <div class="nav-middle">
                    <button id="nav-left" class="btn btn-control"><i class="fas fa-chevron-left"></i></button>
                    <button id="nav-right" class="btn btn-control"><i class="fas fa-chevron-right"></i></button>
                  </div>
                  <button id="nav-down" class="btn btn-control"><i class="fas fa-chevron-down"></i></button>
                </div>
              </div>
            </div>
            
            <!-- Gezegen Savunması modu -->
            <div id="defense-mode" class="game-mode-content" style="display:none;">
              <div class="game-canvas-container">
                <canvas id="defense-canvas"></canvas>
              </div>
              <div class="defense-controls">
                <button id="defense-left" class="btn btn-control"><i class="fas fa-chevron-left"></i></button>
                <button id="defense-fire" class="btn btn-danger"><i class="fas fa-meteor"></i> Ateş</button>
                <button id="defense-right" class="btn btn-control"><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
          
          <!-- Oyun sonu ekranı -->
          <div id="game-over-screen" class="game-screen" style="display: none;">
            <div class="game-over-content">
              <h2>Oyun Bitti</h2>
              <div class="final-score">
                <div class="score-label">Toplam Puanınız</div>
                <div class="score-value" id="final-score">0</div>
              </div>
              
              <div class="game-stats-summary">
                <div class="stat-item">
                  <div class="stat-icon"><i class="fas fa-star"></i></div>
                  <div class="stat-info">
                    <div class="stat-title">Seviye</div>
                    <div class="stat-value" id="final-level">1</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon"><i class="fas fa-stopwatch"></i></div>
                  <div class="stat-info">
                    <div class="stat-title">Süre</div>
                    <div class="stat-value" id="final-time">00:00</div>
                  </div>
                </div>
                
                <div class="stat-item">
                  <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                  <div class="stat-info">
                    <div class="stat-title">Sıralama</div>
                    <div class="stat-value" id="final-rank">-</div>
                  </div>
                </div>
              </div>
              
              <div class="action-buttons">
                <button id="play-again-btn" class="btn btn-primary">
                  <i class="fas fa-redo"></i> Tekrar Oyna
                </button>
                
                <button id="share-score-btn" class="btn btn-outline-primary">
                  <i class="fas fa-share-alt"></i> Skoru Paylaş
                </button>
                
                <a href="/all-games" class="btn btn-outline-secondary">
                  <i class="fas fa-th-large"></i> Tüm Oyunlar
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sağ panel - Oyun bilgileri -->
      <div class="game-info-panel">
        <div class="info-card leaderboard-card">
          <div class="card-header">
            <h3><i class="fas fa-trophy"></i> En Yüksek Skorlar</h3>
          </div>
          <div class="card-body">
            <ul class="leaderboard-list" id="leaderboard-list">
              <li class="loading-item">Yükleniyor...</li>
            </ul>
          </div>
        </div>
        
        <div class="info-card">
          <div class="card-header">
            <h3><i class="fas fa-lightbulb"></i> İpuçları</h3>
          </div>
          <div class="card-body">
            <div class="tip-content" id="tip-content">
              <p>Asteroid Avı'nda hızlı tepki verme becerinizi artırın.</p>
              <p>Galaksi Labirenti'nde mantıksal düşünme yeteneğinizi geliştirin.</p>
              <p>Gezegen Savunması'nda stratejik planlama yapın.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'games/modernizer.html' %}

<style>
  /* Ana Konteyner Stilleri */
  .galactic-game-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .game-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .game-header h1 {
    color: #fff;
    font-size: 2.5rem;
    font-weight: 700;
    text-shadow: 0 0 10px rgba(106, 90, 224, 0.8);
    margin-bottom: 10px;
  }
  
  .game-header .badge {
    background: linear-gradient(135deg, #6a5ae0, #a992ff);
    color: white;
    padding: 5px 15px;
    border-radius: 30px;
    font-size: 1rem;
    font-weight: 400;
    vertical-align: middle;
    box-shadow: 0 2px 10px rgba(106, 90, 224, 0.5);
  }
  
  .game-header p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
  }
  
  /* Dashboard layout */
  .game-dashboard {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .game-area-panel {
    flex: 1;
    min-width: 320px;
  }
  
  .game-info-panel {
    width: 320px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  /* Oyun Konteyner Stilleri */
  .galactic-game-container {
    background: rgba(20, 20, 40, 0.8);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 0 15px rgba(106, 90, 224, 0.3);
    overflow: hidden;
    border: 1px solid rgba(106, 90, 224, 0.3);
    position: relative;
    min-height: 600px;
    display: flex;
    flex-direction: column;
  }
  
  .game-screen {
    padding: 30px;
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  
  /* Başlangıç Ekranı */
  .game-mode-selection {
    text-align: center;
  }
  
  .game-mode-selection h2 {
    color: white;
    font-size: 1.8rem;
    margin-bottom: 25px;
  }
  
  .game-modes {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .game-mode-card {
    background: linear-gradient(135deg, rgba(40, 40, 80, 0.9), rgba(30, 30, 50, 0.9));
    border-radius: 15px;
    padding: 20px;
    width: 170px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  
  .game-mode-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
  }
  
  .game-mode-card.active {
    border-color: #6a5ae0;
    background: linear-gradient(135deg, rgba(60, 60, 100, 0.9), rgba(40, 40, 70, 0.9));
  }
  
  .mode-icon {
    font-size: 2rem;
    color: #6a5ae0;
    margin-bottom: 15px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .mode-title {
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
  }
  
  .mode-description {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    line-height: One;
  }
  
  .difficulty-selection {
    margin-bottom: 30px;
  }
  
  .difficulty-selection h3 {
    color: white;
    font-size: 1.3rem;
    margin-bottom: 15px;
  }
  
  .difficulty-slider-container {
    max-width: 400px;
    margin: 0 auto;
  }
  
  .difficulty-labels {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
  }
  
  .difficulty-slider {
    width: 100%;
    height: 8px;
    -webkit-appearance: none;
    background: rgba(106, 90, 224, 0.3);
    border-radius: 4px;
    outline: none;
  }
  
  .difficulty-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #6a5ae0;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .difficulty-slider::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 0 10px rgba(106, 90, 224, 0.8);
  }
  
  .game-settings {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 30px;
    flex-wrap: wrap;
  }
  
  .time-setting, .questions-setting {
    background: rgba(40, 40, 80, 0.5);
    padding: 10px 20px;
    border-radius: 10px;
    color: white;
  }
  
  .form-select {
    background-color: rgba(60, 60, 100, 0.5);
    color: white;
    border: 1px solid rgba(106, 90, 224, 0.5);
    border-radius: 5px;
    padding: 5px 10px;
  }
  
  /* Oyun Ekranı Stilleri */
  .game-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(30, 30, 50, 0.7);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }
  
  .game-stats {
    display: flex;
    gap: 20px;
  }
  
  .stat {
    text-align: center;
  }
  
  .stat-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
    margin-bottom: 5px;
  }
  
  .stat-value {
    color: white;
    font-size: 1.5rem;
    font-weight: 600;
  }
  
  .game-timer {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 100px;
  }
  
  .progress-container {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 5px;
  }
  
  .progress-bar {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #ff6b6b, #6a5ae0);
    transition: width 1s linear;
  }
  
  .timer-display {
    color: white;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .game-canvas-container {
    background: rgba(20, 20, 40, 0.5);
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 20px;
    position: relative;
    flex: 1;
    min-height: 400px;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }
  
  canvas {
    background: transparent;
    max-width: 100%;
    max-height: 100%;
    display: block;
  }
  
  .game-controls, .navigation-controls, .defense-controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }
  
  .navigation-controls {
    flex-direction: column;
    align-items: center;
  }
  
  .nav-middle {
    display: flex;
    gap: 20px;
    margin: 10px 0;
  }
  
  .btn-control {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(106, 90, 224, 0.3);
    color: white;
    border: 1px solid rgba(106, 90, 224, 0.5);
    transition: all 0.2s;
  }
  
  .btn-control:hover {
    background: rgba(106, 90, 224, 0.5);
    transform: scale(1.1);
  }
  
  .btn-danger {
    background: linear-gradient(135deg, #ff6b6b, #ee5253);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .btn-danger:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
  }
  
  /* Oyun Sonu Ekranı */
  .game-over-content {
    background: rgba(30, 30, 50, 0.8);
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    max-width: 500px;
    margin: 0 auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  
  .game-over-content h2 {
    color: white;
    font-size: 2.5rem;
    margin-bottom: 20px;
    text-shadow: 0 0 10px rgba(106, 90, 224, 0.5);
  }
  
  .final-score {
    margin-bottom: 30px;
  }
  
  .score-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
    margin-bottom: 10px;
  }
  
  .score-value {
    font-size: 3rem;
    font-weight: 700;
    color: #6a5ae0;
    text-shadow: 0 0 10px rgba(106, 90, 224, 0.5);
  }
  
  .game-stats-summary {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
  }
  
  .stat-item {
    text-align: center;
    flex: 1;
  }
  
  .stat-icon {
    font-size: 1.5rem;
    color: #6a5ae0;
    margin-bottom: 10px;
  }
  
  .stat-title {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.8rem;
    margin-bottom: 5px;
  }
  
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
  }
  
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
    margin: 5px;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #6a5ae0, #a992ff);
    border: none;
    color: white;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(106, 90, 224, 0.4);
  }
  
  .btn-outline-primary {
    background: transparent;
    border: 2px solid #6a5ae0;
    color: #6a5ae0;
  }
  
  .btn-outline-primary:hover {
    background: rgba(106, 90, 224, 0.1);
  }
  
  .btn-outline-secondary {
    background: transparent;
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
  }
  
  .btn-outline-secondary:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  
  .btn-pulse {
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(106, 90, 224, 0.7);
    }
    70% {
      box-shadow: 0 0 0 15px rgba(106, 90, 224, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(106, 90, 224, 0);
    }
  }
  
  /* Info Panel Stilleri */
  .info-card {
    background: rgba(30, 30, 50, 0.8);
    border-radius: 15px;
    overflow: hidden;
    border: 1px solid rgba(106, 90, 224, 0.3);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }
  
  .card-header {
    background: rgba(40, 40, 80, 0.8);
    padding: 15px;
    border-bottom: 1px solid rgba(106, 90, 224, 0.3);
  }
  
  .card-header h3 {
    color: white;
    font-size: 1.2rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .card-header h3 i {
    color: #6a5ae0;
  }
  
  .card-body {
    padding: 15px;
  }
  
  .leaderboard-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .leaderboard-list li {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
  }
  
  .leaderboard-list li:last-child {
    border-bottom: none;
  }
  
  .loading-item {
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
    padding: 15px 0;
  }
  
  .tip-content {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    line-height: 1.6;
  }
  
  .tip-content p {
    margin-bottom: 10px;
  }
  
  /* Responsive Düzenlemeler */
  @media (max-width: 991px) {
    .game-dashboard {
      flex-direction: column;
    }
    
    .game-info-panel {
      width: 100%;
    }
  }
  
  @media (max-width: 767px) {
    .game-header h1 {
      font-size: 2rem;
    }
    
    .game-modes {
      flex-direction: column;
      align-items: center;
    }
    
    .game-mode-card {
      width: 80%;
      max-width: 250px;
    }
    
    .game-stats {
      flex-direction: column;
      gap: 10px;
    }
    
    .game-header-bar {
      flex-direction: column;
      gap: 15px;
    }
    
    .btn {
      width: 100%;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM elementleri
  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const gameOverScreen = document.getElementById('game-over-screen');
  const startGameBtn = document.getElementById('start-game-btn');
  const playAgainBtn = document.getElementById('play-again-btn');
  const gameModes = document.querySelectorAll('.game-mode-card');
  const difficultySlider = document.getElementById('difficulty-selector');
  const timeSelector = document.getElementById('time-selector');
  const soundToggle = document.getElementById('sound-toggle');
  
  // Asteroid modu kanvası
  const asteroidCanvas = document.getElementById('asteroid-canvas');
  const asteroidCtx = asteroidCanvas.getContext('2d');
  
  // Galaksi labirenti kanvası
  const navigationCanvas = document.getElementById('navigation-canvas');
  const navigationCtx = navigationCanvas.getContext('2d');
  
  // Gezegen savunması kanvası
  const defenseCanvas = document.getElementById('defense-canvas');
  const defenseCtx = defenseCanvas.getContext('2d');
  
  // Oyun değişkenleri
  let currentMode = 'asteroid';
  let difficulty = 2;
  let gameTime = 120;
  let soundEnabled = true;
  let gameScore = 0;
  let gameLevel = 1;
  let lives = 3;
  let gameInterval;
  let timeInterval;
  let timeLeft;
  
  // Canvas boyutları
  function resizeCanvas() {
    const container = document.querySelector('.game-canvas-container');
    const width = container.clientWidth - 20;
    const height = Math.min(window.innerHeight * 0.6, 500);
    
    [asteroidCanvas, navigationCanvas, defenseCanvas].forEach(canvas => {
      canvas.width = width;
      canvas.height = height;
    });
    
    // Canvas'ları yeniden çiz
    if (gameScreen.style.display !== 'none') {
      drawGame();
    }
  }
  
  // Pencere boyutu değiştiğinde canvas'ı yeniden boyutlandır
  window.addEventListener('resize', resizeCanvas);
  
  // Oyun modu seçimi
  gameModes.forEach(mode => {
    mode.addEventListener('click', function() {
      gameModes.forEach(m => m.classList.remove('active'));
      this.classList.add('active');
      currentMode = this.dataset.mode;
      
      // İlgili ipuçlarını güncelle
      updateTips(currentMode);
    });
  });
  
  // İpuçlarını güncelleme
  function updateTips(mode) {
    const tipContent = document.getElementById('tip-content');
    
    switch(mode) {
      case 'asteroid':
        tipContent.innerHTML = `
          <p>Asteroidleri vurarak puan kazanın.</p>
          <p>Küçük asteroitler daha hızlı ve daha fazla puan kazandırır.</p>
          <p>Uzay gemisine çarpan asteroidler can kaybettirir.</p>
        `;
        break;
      case 'navigation':
        tipContent.innerHTML = `
          <p>En kısa rotayı bulmak için zekâ ve mantığınızı kullanın.</p>
          <p>Her seviye daha karmaşık labirentler içerir.</p>
          <p>Hızlı çözümler bonus puanlar kazandırır.</p>
        `;
        break;
      case 'defense':
        tipContent.innerHTML = `
          <p>Gezegeninize düşman saldırılarına karşı savunun.</p>
          <p>Savunma kuleleri stratejik konumlara yerleştirin.</p>
          <p>Kaynaklarınızı akıllıca yönetin.</p>
        `;
        break;
    }
  }
  
  // Oyun başlatma
  startGameBtn.addEventListener('click', function() {
    difficulty = parseInt(difficultySlider.value);
    gameTime = parseInt(timeSelector.value);
    soundEnabled = soundToggle.checked;
    
    startScreen.style.display = 'none';
    gameScreen.style.display = 'flex';
    
    // Seçilen modu göster, diğerlerini gizle
    document.querySelectorAll('.game-mode-content').forEach(mode => {
      mode.style.display = 'none';
    });
    document.getElementById(currentMode + '-mode').style.display = 'block';
    
    // Canvas'ı hazırla
    resizeCanvas();
    
    // Oyunu başlat
    startGame();
  });
  
  // Oyun başlatma fonksiyonu
  function startGame() {
    // Değişkenleri sıfırla
    gameScore = 0;
    gameLevel = 1;
    lives = 3;
    timeLeft = gameTime;
    
    // Skorları güncelle
    updateStats();
    
    // Zamanlayıcıyı başlat
    updateTimer();
    timeInterval = setInterval(updateTimer, 1000);
    
    // Oyun moduna göre oyunu başlat
    switch(currentMode) {
      case 'asteroid':
        startAsteroidGame();
        break;
      case 'navigation':
        startNavigationGame();
        break;
      case 'defense':
        startDefenseGame();
        break;
    }
    
    // Skorboard verileri
    fetchLeaderboard();
  }
  
  // Oyun bitirme fonksiyonu
  function endGame() {
    clearInterval(timeInterval);
    clearInterval(gameInterval);
    
    // Son skorları güncelle
    document.getElementById('final-score').textContent = gameScore;
    document.getElementById('final-level').textContent = gameLevel;
    document.getElementById('final-time').textContent = formatTime(gameTime - timeLeft);
    
    // Skorları sunucuya gönder
    saveScore();
    
    // Oyun sonu ekranını göster
    gameScreen.style.display = 'none';
    gameOverScreen.style.display = 'flex';
  }
  
  // Tekrar oynama
  playAgainBtn.addEventListener('click', function() {
    gameOverScreen.style.display = 'none';
    startScreen.style.display = 'flex';
  });
  
  // Skorları güncelleme
  function updateStats() {
    document.getElementById('score-display').textContent = gameScore;
    document.getElementById('level-display').textContent = gameLevel;
    document.getElementById('lives-display').textContent = lives;
  }
  
  // Zamanlayıcı güncelleme
  function updateTimer() {
    if (timeLeft <= 0) {
      endGame();
      return;
    }
    
    timeLeft--;
    document.getElementById('timer-display').textContent = formatTime(timeLeft);
    
    // İlerleme çubuğunu güncelle
    const progress = (timeLeft / gameTime) * 100;
    document.getElementById('time-progress').style.width = progress + '%';
  }
  
  // Zamanı biçimlendirme
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  // Puan kaydetme
  function saveScore() {
    // Ajax ile skoru kaydetme
    fetch('/save_score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        game_type: 'galactic_challenge',
        score: gameScore,
        difficulty: ['easy', 'medium', 'hard'][difficulty - 1],
        mode: currentMode,
        time_spent: gameTime - timeLeft,
        level_reached: gameLevel
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('final-rank').textContent = data.rank || '-';
      } else if (data.login_required) {
        document.getElementById('final-rank').textContent = 'Giriş Yapın';
      }
    })
    .catch(error => {
      console.error('Skor kaydedilirken hata oluştu:', error);
    });
  }
  
  // Liderlik tablosunu getir
  function fetchLeaderboard() {
    const leaderboardList = document.getElementById('leaderboard-list');
    leaderboardList.innerHTML = '<li class="loading-item">Yükleniyor...</li>';
    
    fetch(`/get_leaderboard/galactic_challenge`)
      .then(response => response.json())
      .then(data => {
        if (data.length > 0) {
          leaderboardList.innerHTML = '';
          data.forEach((item, index) => {
            leaderboardList.innerHTML += `
              <li>
                <span>${index + 1}. ${item.username || 'Misafir'}</span>
                <span>${item.score}</span>
              </li>
            `;
          });
        } else {
          leaderboardList.innerHTML = '<li class="loading-item">Henüz skor yok</li>';
        }
      })
      .catch(error => {
        console.error('Skor tablosu yüklenirken hata:', error);
        leaderboardList.innerHTML = '<li class="loading-item">Yüklenemedi</li>';
      });
  }
  
  // Asteroid oyunu başlat
  function startAsteroidGame() {
    // Oyun değişkenleri
    const asteroids = [];
    const bullets = [];
    let ship = {
      x: asteroidCanvas.width / 2,
      y: asteroidCanvas.height - 30,
      width: 30,
      height: 40,
      speed: 5
    };
    
    // Tuş kontrolü
    const keys = {};
    
    window.addEventListener('keydown', function(e) {
      keys[e.code] = true;
    });
    
    window.addEventListener('keyup', function(e) {
      keys[e.code] = false;
    });
    
    // Rastgele asteroid oluşturma
    function createAsteroid() {
      const size = Math.random() * 30 + 15;
      return {
        x: Math.random() * asteroidCanvas.width,
        y: -size,
        size: size,
        speed: (Math.random() * 2 + 1) * (difficulty * 0.5)
      };
    }
    
    // Mermi oluşturma
    function createBullet() {
      return {
        x: ship.x + ship.width / 2,
        y: ship.y,
        width: 3,
        height: 10,
        speed: 7
      };
    }
    
    // Çarpışma kontrolü
    function checkCollision(obj1, obj2) {
      return obj1.x < obj2.x + obj2.size &&
             obj1.x + obj1.width > obj2.x &&
             obj1.y < obj2.y + obj2.size &&
             obj1.y + obj1.height > obj2.y;
    }
    
    // Mermi asteroide çarpma kontrolü
    function checkBulletCollision(bullet, asteroid) {
      return bullet.x < asteroid.x + asteroid.size &&
             bullet.x + bullet.width > asteroid.x &&
             bullet.y < asteroid.y + asteroid.size &&
             bullet.y + bullet.height > asteroid.y;
    }
    
    // Her kare için oyunu güncelle
    function updateAsteroidGame() {
      // Arkaplanı temizle
      asteroidCtx.clearRect(0, 0, asteroidCanvas.width, asteroidCanvas.height);
      
      // Gemiyi çiz
      asteroidCtx.fillStyle = '#6a5ae0';
      asteroidCtx.beginPath();
      asteroidCtx.moveTo(ship.x + ship.width / 2, ship.y);
      asteroidCtx.lineTo(ship.x, ship.y + ship.height);
      asteroidCtx.lineTo(ship.x + ship.width, ship.y + ship.height);
      asteroidCtx.closePath();
      asteroidCtx.fill();
      
      // Gemiyi hareket ettir
      if (keys['ArrowLeft'] && ship.x > 0) {
        ship.x -= ship.speed;
      }
      if (keys['ArrowRight'] && ship.x < asteroidCanvas.width - ship.width) {
        ship.x += ship.speed;
      }
      
      // Mermileri çiz ve güncelle
      for (let i = 0; i < bullets.length; i++) {
        asteroidCtx.fillStyle = '#fff';
        asteroidCtx.fillRect(bullets[i].x, bullets[i].y, bullets[i].width, bullets[i].height);
        
        bullets[i].y -= bullets[i].speed;
        
        // Ekran dışına çıkan mermileri temizle
        if (bullets[i].y < 0) {
          bullets.splice(i, 1);
          i--;
        }
      }
      
      // Asteroidleri çiz ve güncelle
      for (let i = 0; i < asteroids.length; i++) {
        asteroidCtx.fillStyle = '#aaa';
        asteroidCtx.beginPath();
        asteroidCtx.arc(asteroids[i].x, asteroids[i].y, asteroids[i].size, 0, Math.PI * 2);
        asteroidCtx.fill();
        
        asteroids[i].y += asteroids[i].speed;
        
        // Ekran dışına çıkan asteroidleri temizle
        if (asteroids[i].y > asteroidCanvas.height) {
          asteroids.splice(i, 1);
          i--;
          continue;
        }
        
        // Gemi ile asteroid çarpışma kontrolü
        if (checkCollision(ship, asteroids[i])) {
          asteroids.splice(i, 1);
          i--;
          lives--;
          updateStats();
          
          if (lives <= 0) {
            endGame();
            return;
          }
          
          continue;
        }
        
        // Mermi ile asteroid çarpışma kontrolü
        for (let j = 0; j < bullets.length; j++) {
          if (checkBulletCollision(bullets[j], asteroids[i])) {
            // Puan kazanma (küçük asteroidler daha çok puan)
            const points = Math.floor(50 / asteroids[i].size * 10) * difficulty;
            gameScore += points;
            
            // Her 500 puanda seviye atlama
            if (Math.floor(gameScore / 500) > gameLevel - 1) {
              gameLevel++;
            }
            
            updateStats();
            
            asteroids.splice(i, 1);
            bullets.splice(j, 1);
            i--;
            break;
          }
        }
      }
      
      // Rastgele asteroid oluştur
      if (Math.random() < 0.02 * difficulty) {
        asteroids.push(createAsteroid());
      }
      
      // Mermileri otomatik ateşle (her 20 karede bir)
      if (gameScreen.style.display !== 'none' && asteroidCanvas.width > 0) {
        if (Math.random() < 0.1) {
          bullets.push(createBullet());
        }
      }
    }
    
    // Oyun döngüsünü başlat
    gameInterval = setInterval(updateAsteroidGame, 1000 / 60);
  }
  
  // Galaksi labirenti oyunu başlat
  function startNavigationGame() {
    // Basit labirent oluştur
    const grid = [];
    const gridSize = 10;
    const cellSize = Math.min(navigationCanvas.width, navigationCanvas.height) / gridSize;
    
    let playerX = 0;
    let playerY = 0;
    let targetX = gridSize - 1;
    let targetY = gridSize - 1;
    
    // Labirent oluştur
    function createMaze() {
      for (let y = 0; y < gridSize; y++) {
        grid[y] = [];
        for (let x = 0; x < gridSize; x++) {
          grid[y][x] = {
            x: x,
            y: y,
            wall: Math.random() < 0.3 * difficulty / 3,
            visited: false
          };
        }
      }
      
      // Başlangıç ve bitiş noktalarını temizle
      grid[playerY][playerX].wall = false;
      grid[targetY][targetX].wall = false;
      
      // En azından bir yol olduğundan emin ol
      createPath(playerX, playerY, targetX, targetY);
    }
    
    // Başlangıçtan bitişe basit bir yol oluştur
    function createPath(startX, startY, endX, endY) {
      let currentX = startX;
      let currentY = startY;
      
      while (currentX !== endX || currentY !== endY) {
        grid[currentY][currentX].wall = false;
        
        if (currentX < endX && Math.random() < 0.5) {
          currentX++;
        } else if (currentY < endY) {
          currentY++;
        } else if (currentX < endX) {
          currentX++;
        }
      }
      
      grid[endY][endX].wall = false;
    }
    
    // Labirenti çiz
    function drawMaze() {
      navigationCtx.clearRect(0, 0, navigationCanvas.width, navigationCanvas.height);
      
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          const cell = grid[y][x];
          
          if (cell.wall) {
            navigationCtx.fillStyle = '#333';
          } else if (cell.visited) {
            navigationCtx.fillStyle = 'rgba(106, 90, 224, 0.3)';
          } else {
            navigationCtx.fillStyle = '#111';
          }
          
          navigationCtx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
          navigationCtx.strokeStyle = '#222';
          navigationCtx.strokeRect(x * cellSize, y * cellSize, cellSize, cellSize);
        }
      }
      
      // Oyuncuyu çiz
      navigationCtx.fillStyle = '#6a5ae0';
      navigationCtx.beginPath();
      navigationCtx.arc(
        playerX * cellSize + cellSize / 2,
        playerY * cellSize + cellSize / 2,
        cellSize / 3,
        0,
        Math.PI * 2
      );
      navigationCtx.fill();
      
      // Hedefi çiz
      navigationCtx.fillStyle = '#ff6b6b';
      navigationCtx.beginPath();
      navigationCtx.arc(
        targetX * cellSize + cellSize / 2,
        targetY * cellSize + cellSize / 2,
        cellSize / 3,
        0,
        Math.PI * 2
      );
      navigationCtx.fill();
    }
    
    // Labirentte hareket
    function movePlayer(dx, dy) {
      const newX = playerX + dx;
      const newY = playerY + dy;
      
      // Sınırlar içinde ve duvar değilse hareket et
      if (
        newX >= 0 && newX < gridSize &&
        newY >= 0 && newY < gridSize &&
        !grid[newY][newX].wall
      ) {
        playerX = newX;
        playerY = newY;
        grid[playerY][playerX].visited = true;
        
        // Hedefe ulaşıldı mı?
        if (playerX === targetX && playerY === targetY) {
          // Puan ekle
          gameScore += 100 * difficulty;
          
          // Yeni seviye
          gameLevel++;
          
          // Yeni labirent oluştur
          createMaze();
          
          updateStats();
        }
      }
    }
    
    // Tuş basımlarını dinle
    const navControls = {
      'nav-up': () => movePlayer(0, -1),
      'nav-down': () => movePlayer(0, 1),
      'nav-left': () => movePlayer(-1, 0),
      'nav-right': () => movePlayer(1, 0)
    };
    
    // Butonlara tıklama olayları ekle
    Object.keys(navControls).forEach(id => {
      document.getElementById(id).addEventListener('click', navControls[id]);
    });
    
    // Klavye tuşları için event dinleyicileri
    window.addEventListener('keydown', function(e) {
      if (currentMode !== 'navigation' || gameScreen.style.display === 'none') return;
      
      switch(e.code) {
        case 'ArrowUp':
          movePlayer(0, -1);
          break;
        case 'ArrowDown':
          movePlayer(0, 1);
          break;
        case 'ArrowLeft':
          movePlayer(-1, 0);
          break;
        case 'ArrowRight':
          movePlayer(1, 0);
          break;
      }
    });
    
    // İlk labirenti oluştur
    createMaze();
    grid[playerY][playerX].visited = true;
    
    // Oyun döngüsü
    gameInterval = setInterval(function() {
      drawMaze();
    }, 1000 / 30);
  }
  
  // Gezegen savunması oyunu başlat
  function startDefenseGame() {
    const planetSize = 50;
    let planetHealth = 100;
    
    // Savunma kulesi
    const turret = {
      x: defenseCanvas.width / 2,
      y: defenseCanvas.height - planetSize - 20,
      width: 30,
      height: 20,
      angle: 0,
      rotationSpeed: 2
    };
    
    // Düşmanlar
    const enemies = [];
    
    // Mermiler
    const bullets = [];
    
    // Düşman oluştur
    function createEnemy() {
      return {
        x: Math.random() * defenseCanvas.width,
        y: -20,
        size: Math.random() * 10 + 10,
        speed: (Math.random() * 1 + 0.5) * difficulty,
        health: Math.floor(Math.random() * 2) + 1
      };
    }
    
    // Mermi oluştur
    function fireBullet() {
      return {
        x: turret.x,
        y: turret.y,
        angle: turret.angle,
        speed: 5,
        size: 3
      };
    }
    
    // Defans oyununu güncelle
    function updateDefenseGame() {
      defenseCtx.clearRect(0, 0, defenseCanvas.width, defenseCanvas.height);
      
      // Gezegeni çiz
      defenseCtx.fillStyle = '#4e73df';
      defenseCtx.beginPath();
      defenseCtx.arc(
        defenseCanvas.width / 2,
        defenseCanvas.height - planetSize / 2,
        planetSize,
        0,
        Math.PI * 2
      );
      defenseCtx.fill();
      
      // Sağlık çubuğu
      defenseCtx.fillStyle = '#333';
      defenseCtx.fillRect(
        defenseCanvas.width / 2 - 50,
        defenseCanvas.height - 10,
        100,
        10
      );
      
      defenseCtx.fillStyle = planetHealth > 30 ? '#1cc88a' : '#ff6b6b';
      defenseCtx.fillRect(
        defenseCanvas.width / 2 - 50,
        defenseCanvas.height - 10,
        planetHealth,
        10
      );
      
      // Savunma kulesini çiz
      defenseCtx.save();
      defenseCtx.translate(turret.x, turret.y);
      defenseCtx.rotate(turret.angle);
      
      defenseCtx.fillStyle = '#6a5ae0';
      defenseCtx.fillRect(-turret.width / 2, -turret.height / 2, turret.width, turret.height);
      defenseCtx.fillRect(-2, -turret.height / 2 - 15, 4, 15);
      
      defenseCtx.restore();
      
      // Düşmanları hareket ettir ve çiz
      for (let i = 0; i < enemies.length; i++) {
        const enemy = enemies[i];
        enemy.y += enemy.speed;
        
        // Düşmanları çiz
        defenseCtx.fillStyle = enemy.health > 1 ? '#ff6b6b' : '#ff9999';
        defenseCtx.beginPath();
        defenseCtx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
        defenseCtx.fill();
        
        // Gezegene çarpışma kontrolü
        const dx = enemy.x - defenseCanvas.width / 2;
        const dy = enemy.y - (defenseCanvas.height - planetSize / 2);
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < planetSize + enemy.size) {
          planetHealth -= enemy.health * 5;
          enemies.splice(i, 1);
          i--;
          
          if (planetHealth <= 0) {
            endGame();
            return;
          }
          
          continue;
        }
        
        // Ekrandan çıkan düşmanları temizle
        if (enemy.y > defenseCanvas.height + enemy.size) {
          enemies.splice(i, 1);
          i--;
        }
      }
      
      // Mermileri hareket ettir ve çiz
      for (let i = 0; i < bullets.length; i++) {
        const bullet = bullets[i];
        
        bullet.x += Math.sin(bullet.angle) * bullet.speed;
        bullet.y -= Math.cos(bullet.angle) * bullet.speed;
        
        // Mermileri çiz
        defenseCtx.fillStyle = '#fff';
        defenseCtx.beginPath();
        defenseCtx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
        defenseCtx.fill();
        
        // Ekrandan çıkan mermileri temizle
        if (
          bullet.x < 0 ||
          bullet.x > defenseCanvas.width ||
          bullet.y < 0 ||
          bullet.y > defenseCanvas.height
        ) {
          bullets.splice(i, 1);
          i--;
          continue;
        }
        
        // Düşmanlara çarpışma kontrolü
        for (let j = 0; j < enemies.length; j++) {
          const enemy = enemies[j];
          const dx = bullet.x - enemy.x;
          const dy = bullet.y - enemy.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          
          if (distance < enemy.size + bullet.size) {
            enemy.health--;
            bullets.splice(i, 1);
            i--;
            
            if (enemy.health <= 0) {
              // Puanı arttır (küçük düşmanlar daha fazla puan)
              gameScore += Math.floor(30 / enemy.size * 10);
              
              // Seviye atlama
              if (Math.floor(gameScore / 300) > gameLevel - 1) {
                gameLevel++;
              }
              
              updateStats();
              
              enemies.splice(j, 1);
              j--;
            }
            
            break;
          }
        }
      }
      
      // Rastgele düşman oluştur
      if (Math.random() < 0.01 * difficulty) {
        enemies.push(createEnemy());
      }
      
      // Taret kontrolü için klavye dinleme
      if (keys['ArrowLeft'] && turret.x > turret.width / 2) {
        turret.x -= 3;
      }
      
      if (keys['ArrowRight'] && turret.x < defenseCanvas.width - turret.width / 2) {
        turret.x += 3;
      }
      
      // Otomatik ateş etme
      if (Math.random() < 0.05) {
        bullets.push(fireBullet());
      }
    }
    
    // Savunma kontrolleri için eventler
    document.getElementById('defense-left').addEventListener('mousedown', function() {
      keys['ArrowLeft'] = true;
    });
    
    document.getElementById('defense-left').addEventListener('mouseup', function() {
      keys['ArrowLeft'] = false;
    });
    
    document.getElementById('defense-right').addEventListener('mousedown', function() {
      keys['ArrowRight'] = true;
    });
    
    document.getElementById('defense-right').addEventListener('mouseup', function() {
      keys['ArrowRight'] = false;
    });
    
    document.getElementById('defense-fire').addEventListener('click', function() {
      bullets.push(fireBullet());
    });
    
    // Oyun döngüsü
    gameInterval = setInterval(updateDefenseGame, 1000 / 60);
  }
  
  // Paylaş butonu için
  document.getElementById('share-score-btn').addEventListener('click', function() {
    const score = document.getElementById('final-score').textContent;
    const text = `OmGame'de Galaktik Mücadele oyununda ${score} puan kazandım! Siz de deneyin: ${window.location.href}`;
    
    try {
      if (navigator.share) {
        navigator.share({
          title: 'OmGame Skorumu Paylaş',
          text: text,
          url: window.location.href
        });
      } else {
        // Kopyalama işlevi
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Skorunuz panoya kopyalandı!');
      }
    } catch (e) {
      console.error('Paylaşım hatası:', e);
    }
  });
  
  // İlk yükleme
  updateTips('asteroid');
  resizeCanvas();
});
</script>
{% endblock %}
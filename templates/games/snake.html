{% extends "layout.html" %}

{% block title %}Snake{% endblock %}

{% block content %}
<div class="container">
  <div class="game-container">
    <h2>Snake Oyunu</h2>
    <canvas id="snakeCanvas" width="400" height="400" style="border:1px solid #fff;"></canvas>
    <div class="game-controls">
      <button id="startGame" class="btn btn-primary">Başlat</button>
      <button id="pauseGame" class="btn btn-warning">Duraklat</button>
    </div>
    <div class="score">Skor: <span id="score">0</span></div>
    <div>En Yüksek Skor: <span id="highScore">0</span></div> </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const canvas = document.getElementById('snakeCanvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startGame');
const pauseBtn = document.getElementById('pauseGame');
const scoreElement = document.getElementById('score');
const highScoreElement = document.getElementById('highScore');

let snake = [];
let food = {};
let direction = 'right';
let gameLoop = null;
let score = 0;
let highScore = 0;
let isPaused = false;

function initGame() {
  snake = [{x: 10, y: 10}];
  direction = 'right';
  score = 0;
  scoreElement.textContent = score;
  highScoreElement.textContent = highScore; // Added to initialize high score display
  createFood();
  if (gameLoop) clearInterval(gameLoop);
  gameLoop = setInterval(update, 100);
}

function createFood() {
  food = {
    x: Math.floor(Math.random() * (canvas.width / 20)) * 20,
    y: Math.floor(Math.random() * (canvas.height / 20)) * 20
  };
}

function update() {
  if (isPaused) return;

  const head = {x: snake[0].x, y: snake[0].y};

  switch(direction) {
    case 'up': head.y -= 20; break;
    case 'down': head.y += 20; break;
    case 'left': head.x -= 20; break;
    case 'right': head.x += 20; break;
  }

  if (head.x < 0) head.x = canvas.width - 20;
  if (head.x >= canvas.width) head.x = 0;
  if (head.y < 0) head.y = canvas.height - 20;
  if (head.y >= canvas.height) head.y = 0;

  if (head.x === food.x && head.y === food.y) {
    score += 10;
    scoreElement.textContent = score;
    createFood();
  } else {
    snake.pop();
  }

  // Çarpışma kontrolü
  for (let i = 1; i < snake.length; i++) { // Start from index 1 to avoid comparing head with itself
    if (head.x === snake[i].x && head.y === snake[i].y) {
      gameOver();
      return;
    }
  }

  snake.unshift(head);
  draw();
}

function draw() {
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = '#0f0';
  snake.forEach(segment => {
    ctx.fillRect(segment.x, segment.y, 18, 18);
  });

  ctx.fillStyle = '#f00';
  ctx.fillRect(food.x, food.y, 18, 18);
}

function gameOver() {
  if (score > highScore) {
    highScore = score;
    highScoreElement.textContent = highScore;
    saveScore(score);
  }
  clearInterval(gameLoop);
  gameLoop = null;
  alert('Oyun Bitti! Skorunuz: ' + score);
}

function saveScore(score) {
  fetch('/api/save-score', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      score: score,
      gameType: 'snake'
    })
  });
}


document.addEventListener('keydown', (e) => {
  if (!gameLoop) return;

  switch(e.key) {
    case 'ArrowUp':
      if (direction !== 'down') direction = 'up';
      break;
    case 'ArrowDown':
      if (direction !== 'up') direction = 'down';
      break;
    case 'ArrowLeft':
      if (direction !== 'right') direction = 'left';
      break;
    case 'ArrowRight':
      if (direction !== 'left') direction = 'right';
      break;
  }
});

startBtn.addEventListener('click', () => {
  if (!gameLoop) {
    initGame();
  }
});

pauseBtn.addEventListener('click', () => {
  isPaused = !isPaused;
  pauseBtn.textContent = isPaused ? 'Devam Et' : 'Duraklat';
});

draw();
</script>
{% endblock %}
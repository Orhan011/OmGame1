{% extends "layout.html" %}

{% block content %}
<div class="container">
  <div class="game-header text-center mb-4">
    <h1>Sudoku</h1>
    <p class="text-muted">Her satır, sütun ve 3x3 kutuda 1'den 9'a kadar tüm rakamları yerleştirin</p>
  </div>

  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0">Oyun Tahtası</h5>
            <div>
              <span id="timer" class="badge bg-light text-dark me-2">00:00</span>
              <span id="difficulty-badge" class="badge bg-info">Kolay</span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="sudoku-board" class="mb-3">
            <!-- JavaScript ile sudoku tahtası burada oluşturulacak -->
          </div>
          <div class="number-controls text-center mb-3">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-light digit" data-digit="1">1</button>
              <button type="button" class="btn btn-light digit" data-digit="2">2</button>
              <button type="button" class="btn btn-light digit" data-digit="3">3</button>
              <button type="button" class="btn btn-light digit" data-digit="4">4</button>
              <button type="button" class="btn btn-light digit" data-digit="5">5</button>
              <button type="button" class="btn btn-light digit" data-digit="6">6</button>
              <button type="button" class="btn btn-light digit" data-digit="7">7</button>
              <button type="button" class="btn btn-light digit" data-digit="8">8</button>
              <button type="button" class="btn btn-light digit" data-digit="9">9</button>
              <button type="button" class="btn btn-secondary digit" data-digit="0">Sil</button>
            </div>
          </div>
          <div class="game-controls d-flex justify-content-center">
            <button id="new-game-btn" class="btn btn-primary me-2">Yeni Oyun</button>
            <button id="hint-btn" class="btn btn-info me-2">İpucu</button>
            <button id="solve-btn" class="btn btn-warning me-2">Çözümü Göster</button>
            <button id="check-btn" class="btn btn-success">Kontrol Et</button>
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <h5 class="m-0">Oyun Ayarları</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group mb-3">
                <label for="difficulty-select">Zorluk Seviyesi:</label>
                <select id="difficulty-select" class="form-select">
                  <option value="easy">Kolay</option>
                  <option value="medium">Orta</option>
                  <option value="hard">Zor</option>
                  <option value="expert">Uzman</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="highlight-conflicts">
                <label class="form-check-label" for="highlight-conflicts">
                  Çakışmaları Vurgula
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto-check">
                <label class="form-check-label" for="auto-check">
                  Otomatik Kontrol
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="m-0">Nasıl Oynanır?</h5>
        </div>
        <div class="card-body">
          <p>Sudoku, 9x9 boyutundaki ızgarayı, her satır, sütun ve 3x3'lük bloklarda 1'den 9'a kadar her rakamın birer kez yer alacağı şekilde doldurma bulmacasıdır.</p>
          <ol>
            <li>Oyuna başlamak için zorluk seviyesini seçin ve "Yeni Oyun" düğmesine tıklayın.</li>
            <li>Bir hücreyi doldurmak için önce hücreye, ardından rakam düğmesine tıklayın.</li>
            <li>Hücreyi silmek için hücreyi seçip "Sil" düğmesine tıklayın.</li>
            <li>Zorluk çektiğinizde bir ipucu almak için "İpucu" düğmesine tıklayın.</li>
            <li>Çözümünüzü kontrol etmek için "Kontrol Et" düğmesine tıklayın.</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sonuç Modalı -->
<div class="modal fade" id="result-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modal-title">Tebrikler!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="result-message">Sudoku bulmacasını başarıyla tamamladınız!</p>
        <div class="text-center mb-3">
          <i class="fas fa-trophy fa-3x text-warning"></i>
        </div>
        <div class="result-stats">
          <div class="row">
            <div class="col-6 text-center">
              <div class="stat-label">Süre</div>
              <div class="stat-value" id="result-time">00:00</div>
            </div>
            <div class="col-6 text-center">
              <div class="stat-label">Zorluk</div>
              <div class="stat-value" id="result-difficulty">Kolay</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button type="button" class="btn btn-primary" id="new-game-modal">Yeni Oyun</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  #sudoku-board {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    grid-gap: 1px;
    max-width: 450px;
    margin: 0 auto;
    border: 2px solid #333;
  }
  
  .sudoku-cell {
    width: 100%;
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .sudoku-cell.given {
    background-color: #e9ecef;
    font-weight: bolder;
    color: #212529;
  }
  
  .sudoku-cell.selected {
    background-color: #cfe2ff;
    color: #0d6efd;
  }
  
  .sudoku-cell.conflict {
    background-color: #f8d7da;
    color: #dc3545;
  }
  
  .sudoku-cell.correct {
    background-color: #d1e7dd;
    color: #198754;
  }
  
  /* Sudoku ızgarasını 3x3 bloklara bölme */
  .sudoku-cell:nth-child(3n+3):not(:nth-child(9n)) {
    border-right: 2px solid #333;
  }
  
  .sudoku-cell:nth-child(n+19):nth-child(-n+27),
  .sudoku-cell:nth-child(n+46):nth-child(-n+54) {
    border-bottom: 2px solid #333;
  }
  
  /* Rakam butonları */
  .number-controls .btn-group {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 1rem;
  }
  
  .number-controls .digit {
    min-width: 40px;
    margin: 0.25rem;
  }
  
  /* Küçük ekranlar için responsiveness */
  @media (max-width: 576px) {
    .sudoku-cell {
      font-size: 1rem;
    }
    
    .number-controls .digit {
      min-width: 32px;
      font-size: 0.9rem;
      padding: 0.375rem 0.5rem;
    }
  }
  
  /* İstatistik stilleri */
  .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
  }
  
  .stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #212529;
  }
  
  .result-stats {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sudoku tahtası ve oyun durumu
    let board = Array(9).fill().map(() => Array(9).fill(0));
    let solution = Array(9).fill().map(() => Array(9).fill(0));
    let givenCells = Array(9).fill().map(() => Array(9).fill(false));
    let selectedCell = null;
    let gameStarted = false;
    let timer = 0;
    let timerInterval = null;
    let hintsUsed = 0;
    let difficulty = 'easy';
    
    // DOM elementleri
    const boardElement = document.getElementById('sudoku-board');
    const timerElement = document.getElementById('timer');
    const difficultySelect = document.getElementById('difficulty-select');
    const difficultyBadge = document.getElementById('difficulty-badge');
    const newGameBtn = document.getElementById('new-game-btn');
    const hintBtn = document.getElementById('hint-btn');
    const solveBtn = document.getElementById('solve-btn');
    const checkBtn = document.getElementById('check-btn');
    const highlightConflicts = document.getElementById('highlight-conflicts');
    const autoCheck = document.getElementById('auto-check');
    const digitBtns = document.querySelectorAll('.digit');
    const resultModal = new bootstrap.Modal(document.getElementById('result-modal'));
    const resultTime = document.getElementById('result-time');
    const resultDifficulty = document.getElementById('result-difficulty');
    const newGameModalBtn = document.getElementById('new-game-modal');
    
    // Tahta oluştur
    function createBoard() {
      boardElement.innerHTML = '';
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cell = document.createElement('div');
          cell.className = 'sudoku-cell';
          cell.dataset.row = row;
          cell.dataset.col = col;
          cell.addEventListener('click', () => selectCell(row, col));
          boardElement.appendChild(cell);
        }
      }
    }
    
    // Hücre seç
    function selectCell(row, col) {
      if (!gameStarted) return;
      
      // Önceki seçili hücreyi temizle
      if (selectedCell) {
        document.querySelector(`.sudoku-cell[data-row="${selectedCell.row}"][data-col="${selectedCell.col}"]`).classList.remove('selected');
      }
      
      // Yeni hücreyi seç
      selectedCell = { row, col };
      document.querySelector(`.sudoku-cell[data-row="${row}"][data-col="${col}"]`).classList.add('selected');
    }
    
    // Tahtayı güncelle
    function updateBoard() {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cell = document.querySelector(`.sudoku-cell[data-row="${row}"][data-col="${col}"]`);
          cell.textContent = board[row][col] || '';
          
          // Sınıfları temizle ve yeniden uygula
          cell.className = 'sudoku-cell';
          if (givenCells[row][col]) {
            cell.classList.add('given');
          }
          
          if (highlightConflicts.checked && board[row][col] !== 0) {
            if (!isValidPlacement(row, col, board[row][col])) {
              cell.classList.add('conflict');
            }
          }
          
          if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
            cell.classList.add('selected');
          }
        }
      }
    }
    
    // Yeni oyun
    function newGame() {
      difficulty = difficultySelect.value;
      difficultyBadge.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
      
      // Zorluk seviyesine göre boş hücre sayısı
      let emptyCells;
      switch (difficulty) {
        case 'easy':
          emptyCells = 35;
          break;
        case 'medium':
          emptyCells = 45;
          break;
        case 'hard':
          emptyCells = 55;
          break;
        case 'expert':
          emptyCells = 62;
          break;
        default:
          emptyCells = 35;
      }
      
      // Sudoku tahtasını oluştur ve başlat
      generateSudoku(emptyCells);
      gameStarted = true;
      hintsUsed = 0;
      
      // Zamanlayıcıyı başlat
      if (timerInterval) clearInterval(timerInterval);
      timer = 0;
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }
    
    // Sudoku oluştur
    function generateSudoku(emptyCells) {
      // Çözüm oluştur
      generateSolution();
      
      // Çözümden tahtayı oluştur
      board = solution.map(row => [...row]);
      
      // Boş hücreleri belirle
      givenCells = Array(9).fill().map(() => Array(9).fill(true));
      const positions = [];
      
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          positions.push({ row, col });
        }
      }
      
      // Pozisyonları karıştır
      shuffleArray(positions);
      
      // Belirli sayıda hücreyi boşalt
      for (let i = 0; i < emptyCells; i++) {
        const { row, col } = positions[i];
        board[row][col] = 0;
        givenCells[row][col] = false;
      }
      
      updateBoard();
    }
    
    // Basit bir şekilde Sudoku çözümü oluştur
    function generateSolution() {
      solution = Array(9).fill().map(() => Array(9).fill(0));
      
      // 1'den 9'a kadar rakamları hücrelere yerleştir
      const digits = [1, 2, 3, 4, 5, 6, 7, 8, 9];
      
      // İlk sırayı karıştır
      shuffleArray(digits);
      solution[0] = [...digits];
      
      // Geri kalan sıraları doldur
      for (let row = 1; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const offset = (row < 3) ? 3 : (row < 6) ? 1 : -2;
          solution[row][col] = solution[row-1][(col+offset)%9];
        }
      }
    }
    
    // Rakam yerleştirme geçerli mi kontrol et
    function isValidPlacement(row, col, num) {
      // Verilen hücrelere dokunulmaması gerektiğini kontrol et
      if (givenCells[row][col]) return false;
      
      // Satırda aynı rakam var mı
      for (let c = 0; c < 9; c++) {
        if (c !== col && board[row][c] === num) return false;
      }
      
      // Sütunda aynı rakam var mı
      for (let r = 0; r < 9; r++) {
        if (r !== row && board[r][col] === num) return false;
      }
      
      // 3x3 blokta aynı rakam var mı
      const blockRow = Math.floor(row / 3) * 3;
      const blockCol = Math.floor(col / 3) * 3;
      
      for (let r = blockRow; r < blockRow + 3; r++) {
        for (let c = blockCol; c < blockCol + 3; c++) {
          if ((r !== row || c !== col) && board[r][c] === num) return false;
        }
      }
      
      return true;
    }
    
    // Rakam yerleştir
    function placeDigit(digit) {
      if (!selectedCell || !gameStarted) return;
      
      const { row, col } = selectedCell;
      
      // Verilen hücrelere dokunma
      if (givenCells[row][col]) return;
      
      board[row][col] = digit;
      updateBoard();
      
      // Otomatik kontrol
      if (autoCheck.checked) {
        checkBoard();
      }
      
      // Oyun tamamlandı mı kontrol et
      if (isBoardFilled() && isBoardValid()) {
        gameComplete();
      }
    }
    
    // Tahtayı kontrol et
    function checkBoard() {
      let isCorrect = true;
      
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (board[row][col] !== 0 && board[row][col] !== solution[row][col]) {
            isCorrect = false;
            const cell = document.querySelector(`.sudoku-cell[data-row="${row}"][data-col="${col}"]`);
            cell.classList.add('conflict');
          }
        }
      }
      
      return isCorrect;
    }
    
    // İpucu ver
    function giveHint() {
      if (!selectedCell || !gameStarted) return;
      
      const { row, col } = selectedCell;
      
      // Verilen hücrelere ipucu verme
      if (givenCells[row][col]) return;
      
      // Doğru değeri yerleştir
      board[row][col] = solution[row][col];
      updateBoard();
      
      // İpucu sayısını artır
      hintsUsed++;
      
      // Oyun tamamlandı mı kontrol et
      if (isBoardFilled() && isBoardValid()) {
        gameComplete();
      }
    }
    
    // Çözümü göster
    function showSolution() {
      if (!gameStarted) return;
      
      // Tüm hücreleri çözümle doldur
      board = solution.map(row => [...row]);
      updateBoard();
      
      // Oyunu tamamlanmış kabul et
      gameComplete();
    }
    
    // Tahta dolu mu kontrol et
    function isBoardFilled() {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (board[row][col] === 0) return false;
        }
      }
      return true;
    }
    
    // Tahta geçerli mi kontrol et
    function isBoardValid() {
      // Satırları kontrol et
      for (let row = 0; row < 9; row++) {
        const values = new Set();
        for (let col = 0; col < 9; col++) {
          if (board[row][col] !== 0) values.add(board[row][col]);
        }
        if (values.size !== board[row].filter(val => val !== 0).length) return false;
      }
      
      // Sütunları kontrol et
      for (let col = 0; col < 9; col++) {
        const values = new Set();
        for (let row = 0; row < 9; row++) {
          if (board[row][col] !== 0) values.add(board[row][col]);
        }
        if (values.size !== board.map(row => row[col]).filter(val => val !== 0).length) return false;
      }
      
      // 3x3 blokları kontrol et
      for (let blockRow = 0; blockRow < 3; blockRow++) {
        for (let blockCol = 0; blockCol < 3; blockCol++) {
          const values = new Set();
          for (let row = blockRow * 3; row < blockRow * 3 + 3; row++) {
            for (let col = blockCol * 3; col < blockCol * 3 + 3; col++) {
              if (board[row][col] !== 0) values.add(board[row][col]);
            }
          }
          
          let count = 0;
          for (let row = blockRow * 3; row < blockRow * 3 + 3; row++) {
            for (let col = blockCol * 3; col < blockCol * 3 + 3; col++) {
              if (board[row][col] !== 0) count++;
            }
          }
          
          if (values.size !== count) return false;
        }
      }
      
      return true;
    }
    
    // Oyun tamamlandı
    function gameComplete() {
      // Zamanlayıcıyı durdur
      clearInterval(timerInterval);
      
      // Sonuç bilgilerini göster
      resultTime.textContent = formatTime(timer);
      resultDifficulty.textContent = difficultyBadge.textContent;
      
      // Modalı göster
      resultModal.show();
      
      // Oyun durumunu güncelle
      gameStarted = false;
    }
    
    // Zamanlayıcıyı güncelle
    function updateTimer() {
      timer++;
      timerElement.textContent = formatTime(timer);
    }
    
    // Zamanı formatla
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Diziyi karıştır
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    
    // Event listeners
    digitBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const digit = parseInt(btn.dataset.digit);
        placeDigit(digit);
      });
    });
    
    newGameBtn.addEventListener('click', newGame);
    hintBtn.addEventListener('click', giveHint);
    solveBtn.addEventListener('click', showSolution);
    checkBtn.addEventListener('click', checkBoard);
    newGameModalBtn.addEventListener('click', () => {
      resultModal.hide();
      newGame();
    });
    
    highlightConflicts.addEventListener('change', updateBoard);
    
    // Klavye kontrollerini ekle
    document.addEventListener('keydown', e => {
      if (!gameStarted) return;
      
      if (e.key >= '1' && e.key <= '9') {
        placeDigit(parseInt(e.key));
      } else if (e.key === '0' || e.key === 'Backspace' || e.key === 'Delete') {
        placeDigit(0);
      } else if (e.key === 'ArrowUp' && selectedCell) {
        if (selectedCell.row > 0) {
          selectCell(selectedCell.row - 1, selectedCell.col);
        }
      } else if (e.key === 'ArrowDown' && selectedCell) {
        if (selectedCell.row < 8) {
          selectCell(selectedCell.row + 1, selectedCell.col);
        }
      } else if (e.key === 'ArrowLeft' && selectedCell) {
        if (selectedCell.col > 0) {
          selectCell(selectedCell.row, selectedCell.col - 1);
        }
      } else if (e.key === 'ArrowRight' && selectedCell) {
        if (selectedCell.col < 8) {
          selectCell(selectedCell.row, selectedCell.col + 1);
        }
      }
    });
    
    // İlk başlangıç
    createBoard();
    newGame();
  });
</script>
{% endblock %}
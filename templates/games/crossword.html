{% extends "layout.html" %}

{% block content %}
<div class="container">
  <div class="game-header text-center mb-4">
    <h1>Bulmaca</h1>
    <p class="text-muted">İpuçlarını çözün ve karelajı doldurun</p>
  </div>

  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0">Bulmaca Tahtası</h5>
            <div>
              <span id="difficulty-badge" class="badge bg-info me-2">Kolay</span>
              <span id="timer" class="badge bg-light text-dark">
                <i class="fas fa-clock me-1"></i>00:00
              </span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-7">
              <div id="crossword-grid" class="mb-4">
                <!-- JavaScript ile bulmaca karelajı burada oluşturulacak -->
              </div>
              <div class="d-flex justify-content-center mb-4">
                <div class="btn-group me-2">
                  <button id="check-btn" class="btn btn-outline-success">
                    <i class="fas fa-check"></i> Kontrol Et
                  </button>
                  <button id="reveal-letter-btn" class="btn btn-outline-info">
                    <i class="fas fa-lightbulb"></i> Harf Göster
                  </button>
                  <button id="reveal-word-btn" class="btn btn-outline-warning">
                    <i class="fas fa-lightbulb"></i> Kelime Göster
                  </button>
                </div>
                <button id="new-game-btn" class="btn btn-primary">
                  <i class="fas fa-sync"></i> Yeni Bulmaca
                </button>
              </div>
            </div>
            <div class="col-md-5">
              <div id="clues-container">
                <ul class="nav nav-tabs" id="clues-tabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="across-tab" data-bs-toggle="tab" data-bs-target="#across-clues" type="button" role="tab">
                      Soldan Sağa
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="down-tab" data-bs-toggle="tab" data-bs-target="#down-clues" type="button" role="tab">
                      Yukarıdan Aşağıya
                    </button>
                  </li>
                </ul>
                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="clues-content">
                  <div class="tab-pane fade show active" id="across-clues" role="tabpanel">
                    <div class="clues-list" id="across-clues-list">
                      <!-- Soldan sağa ipuçları burada listelenecek -->
                    </div>
                  </div>
                  <div class="tab-pane fade" id="down-clues" role="tabpanel">
                    <div class="clues-list" id="down-clues-list">
                      <!-- Yukarıdan aşağıya ipuçları burada listelenecek -->
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="mt-4">
                <div class="form-group mb-3">
                  <label for="difficulty-select" class="form-label">Zorluk Seviyesi:</label>
                  <select id="difficulty-select" class="form-select">
                    <option value="easy">Kolay</option>
                    <option value="medium">Orta</option>
                    <option value="hard">Zor</option>
                  </select>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="show-errors">
                  <label class="form-check-label" for="show-errors">
                    Hataları Göster
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="m-0">Nasıl Oynanır?</h5>
        </div>
        <div class="card-body">
          <p>Bulmaca oyunu, ipuçlarından yararlanarak karelajdaki boşlukları doldurmaya dayalı bir kelime oyunudur.</p>
          <ul>
            <li><strong>Hücre Seçme:</strong> Bir hücreye tıklayarak o hücreye odaklanabilirsiniz.</li>
            <li><strong>Yön Değiştirme:</strong> Aynı hücreye iki kez tıklayarak yazma yönünü değiştirebilirsiniz (soldan sağa / yukarıdan aşağıya).</li>
            <li><strong>İpucu Görüntüleme:</strong> Aktif ipucu her zaman vurgulanır, daha fazla bilgi için ipucu listeleri arasında geçiş yapabilirsiniz.</li>
            <li><strong>Kontrol Etme:</strong> "Kontrol Et" düğmesi ile cevaplarınızın doğruluğunu kontrol edebilirsiniz.</li>
            <li><strong>İpucu Alma:</strong> Zorlanırsanız, "Harf Göster" veya "Kelime Göster" düğmelerini kullanabilirsiniz.</li>
          </ul>
          <p>Bulmacayı mümkün olduğunca az ipucu kullanarak ve hızlı bir şekilde tamamlamaya çalışın. İyi eğlenceler!</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bulmaca Tamamlama Modalı -->
<div class="modal fade" id="completion-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tebrikler!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i class="fas fa-trophy fa-3x text-warning"></i>
        </div>
        <p>Bulmacayı başarıyla tamamladınız!</p>
        <div class="result-stats p-3 bg-light rounded">
          <div class="row text-center">
            <div class="col-4">
              <div class="stat-label">Süre</div>
              <div class="stat-value" id="result-time">00:00</div>
            </div>
            <div class="col-4">
              <div class="stat-label">Zorluk</div>
              <div class="stat-value" id="result-difficulty">Kolay</div>
            </div>
            <div class="col-4">
              <div class="stat-label">İpuçları</div>
              <div class="stat-value" id="result-hints">0</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button type="button" class="btn btn-primary" id="new-puzzle-btn">Yeni Bulmaca</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Bulmaca grid konteynerı */
  #crossword-grid {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
    max-width: 500px;
    margin: 0 auto;
  }
  
  /* Bulmaca satırı */
  .crossword-row {
    display: flex;
    gap: 1px;
  }
  
  /* Bulmaca hücresi */
  .crossword-cell {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    border: 1px solid #ccc;
  }
  
  .crossword-cell.active {
    background-color: #e6f7ff;
    border-color: #1890ff;
  }
  
  .crossword-cell.highlight {
    background-color: #f0f7ff;
  }
  
  .crossword-cell.correct {
    background-color: #d4edda;
  }
  
  .crossword-cell.incorrect {
    background-color: #f8d7da;
  }
  
  /* Boş hücre (doldurulmayacak) */
  .crossword-cell.black {
    background-color: #333;
    border-color: #333;
  }
  
  /* Hücre içeriği */
  .crossword-cell input {
    width: 100%;
    height: 100%;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 1.2rem;
    text-transform: uppercase;
    font-weight: bold;
    color: #333;
    outline: none;
  }
  
  /* Hücre numarası */
  .cell-number {
    position: absolute;
    top: 2px;
    left: 2px;
    font-size: 0.6rem;
    color: #666;
  }
  
  /* İpuçları konteynerı */
  #clues-container {
    height: 400px;
    overflow-y: auto;
  }
  
  /* İpuçları listesi */
  .clues-list {
    height: 350px;
    overflow-y: auto;
  }
  
  /* İpucu öğesi */
  .clue-item {
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .clue-item:hover {
    background-color: #f5f5f5;
  }
  
  .clue-item.active {
    background-color: #e6f7ff;
    border-left: 3px solid #1890ff;
  }
  
  .clue-item .clue-number {
    font-weight: bold;
    margin-right: 5px;
    color: #1890ff;
  }
  
  /* İstatistik stilleri */
  .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
  }
  
  .stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #212529;
  }
  
  /* Mobil uyumluluk */
  @media (max-width: 768px) {
    .crossword-cell {
      width: 32px;
      height: 32px;
    }
    
    .crossword-cell input {
      font-size: 1rem;
    }
    
    .cell-number {
      font-size: 0.5rem;
    }
    
    #clues-container {
      height: 250px;
      margin-top: 20px;
    }
    
    .clues-list {
      height: 200px;
    }
  }
  
  @media (max-width: 576px) {
    .crossword-cell {
      width: 28px;
      height: 28px;
    }
    
    .crossword-cell input {
      font-size: 0.9rem;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM elementleri
    const crosswordGrid = document.getElementById('crossword-grid');
    const acrossCluesList = document.getElementById('across-clues-list');
    const downCluesList = document.getElementById('down-clues-list');
    const timerDisplay = document.getElementById('timer');
    const difficultyBadge = document.getElementById('difficulty-badge');
    const difficultySelect = document.getElementById('difficulty-select');
    const showErrorsCheckbox = document.getElementById('show-errors');
    
    const checkBtn = document.getElementById('check-btn');
    const revealLetterBtn = document.getElementById('reveal-letter-btn');
    const revealWordBtn = document.getElementById('reveal-word-btn');
    const newGameBtn = document.getElementById('new-game-btn');
    
    const completionModal = new bootstrap.Modal(document.getElementById('completion-modal'));
    const resultTime = document.getElementById('result-time');
    const resultDifficulty = document.getElementById('result-difficulty');
    const resultHints = document.getElementById('result-hints');
    const newPuzzleBtn = document.getElementById('new-puzzle-btn');
    
    // Oyun durumu
    let gameState = {
      grid: [],
      solution: [],
      clues: { across: {}, down: {} },
      activeCell: { row: 0, col: 0 },
      activeDirection: 'across',
      activeClueNumber: null,
      timer: 0,
      timerInterval: null,
      hintsUsed: 0,
      isComplete: false,
      difficulty: 'easy'
    };
    
    // Örnek bulmacalar (basitleştirilmiş)
    const puzzles = {
      easy: {
        grid: [
          [1, 2, 3, 4, 0, 5, 6, 7, 8],
          [9, 0, 0, 0, 0, 0, 0, 0, 0],
          [10, 0, 0, 0, 11, 0, 0, 0, 0],
          [12, 0, 0, 0, 0, 0, 13, 0, 0],
          [0, 0, 0, 0, 14, 0, 0, 0, 0],
          [15, 16, 0, 0, 0, 0, 0, 0, 0],
          [0, 17, 0, 0, 0, 18, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [19, 0, 0, 0, 0, 0, 0, 0, 0]
        ],
        solution: [
          ['K', 'A', 'L', 'E', '#', 'K', 'A', 'S', 'A'],
          ['İ', '#', '#', '#', '#', '#', '#', '#', '#'],
          ['T', '#', '#', '#', 'P', '#', '#', '#', '#'],
          ['A', '#', '#', '#', '#', '#', 'K', '#', '#'],
          ['P', '#', '#', '#', 'S', '#', '#', '#', '#'],
          ['#', 'D', 'E', 'F', 'T', 'E', 'R', '#', '#'],
          ['#', 'E', '#', '#', '#', 'L', '#', '#', '#'],
          ['#', '#', '#', '#', '#', '#', '#', '#', '#'],
          ['S', 'A', 'A', 'T', '#', '#', '#', '#', '#']
        ],
        clues: {
          across: {
            1: 'Korunaklı yapı, hisar',
            5: 'Para saklamak için kullanılan kutu',
            9: 'Basılı kitap',
            10: 'Sayfaları olan ve yazı yazmak için kullanılan nesne',
            19: 'Zamanı gösteren alet'
          },
          down: {
            1: 'Kedinin büyük akrabası',
            2: 'Yiyecek maddesi, besin',
            3: 'Taktığımız aksesuvar',
            4: 'Siyah-beyaz çizgili hayvan',
            11: 'İçinde kitap saklanan mobilya',
            13: 'Okunmak için yazılmış sayfalar bütünü',
            17: 'Gökyüzündeki ışık kaynağı',
            18: 'Su üzerinde gidebilen araç'
          }
        }
      },
      medium: {
        // Orta zorlukta bulmaca burada olacak
        grid: [
          [1, 2, 3, 0, 4, 5, 6, 7, 8],
          [9, 0, 0, 0, 0, 0, 0, 0, 0],
          [10, 0, 0, 11, 0, 0, 0, 0, 0],
          [0, 0, 0, 12, 0, 0, 0, 0, 0],
          [13, 0, 0, 0, 0, 14, 0, 0, 0],
          [15, 0, 0, 0, 0, 16, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [17, 0, 0, 0, 0, 0, 0, 0, 0]
        ],
        solution: [
          ['B', 'İ', 'L', '#', 'K', 'A', 'L', 'E', 'M'],
          ['A', '#', '#', '#', '#', '#', '#', '#', '#'],
          ['L', '#', '#', 'T', '#', '#', '#', '#', '#'],
          ['#', '#', '#', 'A', '#', '#', '#', '#', '#'],
          ['M', 'A', 'S', 'A', '#', 'O', '#', '#', '#'],
          ['T', '#', '#', '#', '#', 'K', '#', '#', '#'],
          ['#', '#', '#', '#', '#', 'U', '#', '#', '#'],
          ['#', '#', '#', '#', '#', 'L', '#', '#', '#'],
          ['K', 'İ', 'T', 'A', 'P', '#', '#', '#', '#']
        ],
        clues: {
          across: {
            1: 'Bir şeyi anlama yeteneği',
            4: 'Yazı yazmak için kullanılan araç',
            9: 'Balık yakalamak için kullanılan araç',
            10: 'Üzerinde yemek yenen eşya',
            17: 'Sayfalardan oluşan okuma materyali'
          },
          down: {
            1: 'Küçük bahçe bitkisi',
            2: 'Zeka oyunu',
            3: 'Sıvı tutan kap',
            11: 'Kullanılmak istendiğinde açılan, sonra katlanan kumaş',
            14: 'Okul, öğrenim yeri',
            16: 'Kulaklarımızla duyduğumuz'
          }
        }
      },
      hard: {
        // Zor zorlukta bulmaca burada olacak
        grid: [
          [1, 0, 2, 0, 3, 0, 4, 5, 6],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [7, 0, 0, 0, 8, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [9, 0, 0, 10, 0, 0, 0, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [11, 12, 0, 0, 0, 0, 13, 0, 0],
          [0, 0, 0, 0, 0, 0, 0, 0, 0],
          [14, 0, 0, 0, 0, 0, 0, 0, 0]
        ],
        solution: [
          ['M', '#', 'T', '#', 'A', '#', 'S', 'E', 'S'],
          ['Ü', '#', 'E', '#', 'Y', '#', '#', '#', '#'],
          ['Z', '#', 'L', '#', 'N', '#', '#', '#', '#'],
          ['İ', '#', 'E', '#', 'A', '#', '#', '#', '#'],
          ['K', 'İ', 'F', 'O', 'N', '#', '#', '#', '#'],
          ['#', '#', 'O', '#', '#', '#', '#', '#', '#'],
          ['D', 'O', 'N', '#', '#', '#', 'R', '#', '#'],
          ['#', '#', '#', '#', '#', '#', 'Ü', '#', '#'],
          ['P', 'E', 'N', 'C', 'E', 'R', 'E', '#', '#']
        ],
        clues: {
          across: {
            1: 'Sanat dalı, melodiler bütünü',
            3: 'Duyma organı ile algılanan',
            7: 'Giysi, kıyafet',
            9: 'Giyim eşyası, şifon',
            11: 'Kışın giyilen kalın giysi',
            14: 'Cam takılı duvar açıklığı'
          },
          down: {
            1: 'Ses çıkaran kişi',
            2: 'Bir görevi olan, vazifeli',
            4: 'Yemek beklerken çıkarılan örtü',
            5: 'Su kabı',
            6: 'Serinletici içecek',
            13: 'Gece görülen hayal'
          }
        }
      }
    };
    
    // Bulmaca tahtası oluştur
    function createPuzzleGrid(puzzleData) {
      crosswordGrid.innerHTML = '';
      
      const grid = puzzleData.grid;
      const solution = puzzleData.solution;
      
      gameState.grid = [];
      gameState.solution = [];
      
      for (let i = 0; i < grid.length; i++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'crossword-row';
        
        gameState.grid[i] = [];
        gameState.solution[i] = [];
        
        for (let j = 0; j < grid[i].length; j++) {
          const cellDiv = document.createElement('div');
          cellDiv.className = 'crossword-cell';
          cellDiv.dataset.row = i;
          cellDiv.dataset.col = j;
          
          gameState.solution[i][j] = solution[i][j];
          
          if (solution[i][j] === '#') {
            // Siyah hücre (doldurulmaz)
            cellDiv.classList.add('black');
            gameState.grid[i][j] = '#';
          } else {
            // Doldurulabilir hücre
            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = 1;
            input.dataset.row = i;
            input.dataset.col = j;
            
            // Girdi olayları
            input.addEventListener('input', handleCellInput);
            input.addEventListener('keydown', handleCellKeydown);
            input.addEventListener('focus', function() {
              selectCell(i, j);
            });
            
            cellDiv.appendChild(input);
            gameState.grid[i][j] = '';
            
            // Hücre numaraları
            const cellNumber = grid[i][j];
            if (cellNumber > 0) {
              const numSpan = document.createElement('span');
              numSpan.className = 'cell-number';
              numSpan.textContent = cellNumber;
              cellDiv.appendChild(numSpan);
            }
          }
          
          // Hücre tıklama
          cellDiv.addEventListener('click', function() {
            if (!cellDiv.classList.contains('black')) {
              selectCell(i, j);
              toggleDirection();
            }
          });
          
          rowDiv.appendChild(cellDiv);
        }
        
        crosswordGrid.appendChild(rowDiv);
      }
      
      // İpuçlarını oluştur
      createClues(puzzleData.clues);
    }
    
    // İpuçlarını oluştur
    function createClues(clues) {
      acrossCluesList.innerHTML = '';
      downCluesList.innerHTML = '';
      
      // Soldan sağa ipuçları
      for (const [number, clue] of Object.entries(clues.across)) {
        const clueDiv = document.createElement('div');
        clueDiv.className = 'clue-item';
        clueDiv.dataset.direction = 'across';
        clueDiv.dataset.number = number;
        
        const clueNumberSpan = document.createElement('span');
        clueNumberSpan.className = 'clue-number';
        clueNumberSpan.textContent = number;
        
        clueDiv.appendChild(clueNumberSpan);
        clueDiv.appendChild(document.createTextNode(clue));
        
        clueDiv.addEventListener('click', function() {
          selectClue('across', parseInt(number));
        });
        
        acrossCluesList.appendChild(clueDiv);
      }
      
      // Yukarıdan aşağıya ipuçları
      for (const [number, clue] of Object.entries(clues.down)) {
        const clueDiv = document.createElement('div');
        clueDiv.className = 'clue-item';
        clueDiv.dataset.direction = 'down';
        clueDiv.dataset.number = number;
        
        const clueNumberSpan = document.createElement('span');
        clueNumberSpan.className = 'clue-number';
        clueNumberSpan.textContent = number;
        
        clueDiv.appendChild(clueNumberSpan);
        clueDiv.appendChild(document.createTextNode(clue));
        
        clueDiv.addEventListener('click', function() {
          selectClue('down', parseInt(number));
        });
        
        downCluesList.appendChild(clueDiv);
      }
      
      gameState.clues = clues;
    }
    
    // Hücre seç
    function selectCell(row, col) {
      // Önceki seçimleri temizle
      clearSelection();
      
      // Hücre mevcutsa ve siyah değilse seç
      if (gameState.solution[row][col] && gameState.solution[row][col] !== '#') {
        // Aktif hücre ve yönü ayarla
        gameState.activeCell = { row, col };
        
        // Hücreyi ve kelimeyi vurgula
        highlightActiveWord();
        
        // Aktif ipucunu belirle
        findActiveClue();
        
        // Aktif ipucunu vurgula
        highlightActiveClue();
        
        // Hücreye odaklan
        const input = document.querySelector(`.crossword-cell[data-row="${row}"][data-col="${col}"] input`);
        if (input) {
          input.focus();
        }
      }
    }
    
    // Yön değiştir
    function toggleDirection() {
      gameState.activeDirection = gameState.activeDirection === 'across' ? 'down' : 'across';
      
      // Aktif kelimeyi vurgula
      highlightActiveWord();
      
      // Aktif ipucunu belirle
      findActiveClue();
      
      // Aktif ipucunu vurgula
      highlightActiveClue();
    }
    
    // İpucu seç
    function selectClue(direction, number) {
      // Yön ayarla
      gameState.activeDirection = direction;
      
      // İpucu numarasını ayarla
      gameState.activeClueNumber = number;
      
      // İpucu için başlangıç hücresini bul
      const startCell = findClueStartCell(number);
      
      if (startCell) {
        // Başlangıç hücresini seç
        selectCell(startCell.row, startCell.col);
      }
    }
    
    // İpucu başlangıç hücresini bul
    function findClueStartCell(number) {
      // Grid'i tara ve ipucu numarasına sahip hücreyi bul
      for (let i = 0; i < gameState.solution.length; i++) {
        for (let j = 0; j < gameState.solution[i].length; j++) {
          const cell = document.querySelector(`.crossword-cell[data-row="${i}"][data-col="${j}"]`);
          const cellNumber = cell.querySelector('.cell-number');
          
          if (cellNumber && parseInt(cellNumber.textContent) === number) {
            return { row: i, col: j };
          }
        }
      }
      
      return null;
    }
    
    // Aktif kelimeyi vurgula
    function highlightActiveWord() {
      // Önce tüm vurgulamaları temizle
      clearHighlights();
      
      const { row, col } = gameState.activeCell;
      const direction = gameState.activeDirection;
      
      // Aktif hücreyi işaretle
      const activeCell = document.querySelector(`.crossword-cell[data-row="${row}"][data-col="${col}"]`);
      if (activeCell) {
        activeCell.classList.add('active');
      }
      
      // Kelimenin başlangıcını ve sonunu bul
      let startRow = row;
      let startCol = col;
      let endRow = row;
      let endCol = col;
      
      if (direction === 'across') {
        // Kelimenin başlangıcını bul
        while (startCol > 0 && gameState.solution[startRow][startCol - 1] !== '#') {
          startCol--;
        }
        
        // Kelimenin sonunu bul
        while (endCol < gameState.solution[endRow].length - 1 && gameState.solution[endRow][endCol + 1] !== '#') {
          endCol++;
        }
        
        // Kelimeyi vurgula
        for (let j = startCol; j <= endCol; j++) {
          const cell = document.querySelector(`.crossword-cell[data-row="${startRow}"][data-col="${j}"]`);
          if (cell) {
            cell.classList.add('highlight');
          }
        }
      } else if (direction === 'down') {
        // Kelimenin başlangıcını bul
        while (startRow > 0 && gameState.solution[startRow - 1][startCol] !== '#') {
          startRow--;
        }
        
        // Kelimenin sonunu bul
        while (endRow < gameState.solution.length - 1 && gameState.solution[endRow + 1][endCol] !== '#') {
          endRow++;
        }
        
        // Kelimeyi vurgula
        for (let i = startRow; i <= endRow; i++) {
          const cell = document.querySelector(`.crossword-cell[data-row="${i}"][data-col="${startCol}"]`);
          if (cell) {
            cell.classList.add('highlight');
          }
        }
      }
    }
    
    // Vurguları temizle
    function clearHighlights() {
      const cells = document.querySelectorAll('.crossword-cell');
      cells.forEach(cell => {
        cell.classList.remove('highlight', 'active');
      });
    }
    
    // Seçimi temizle
    function clearSelection() {
      clearHighlights();
      
      const clueItems = document.querySelectorAll('.clue-item');
      clueItems.forEach(item => {
        item.classList.remove('active');
      });
    }
    
    // Aktif ipucunu bul
    function findActiveClue() {
      const { row, col } = gameState.activeCell;
      const direction = gameState.activeDirection;
      
      // Geçerli hücrenin ipucu numarasını bul
      let startRow = row;
      let startCol = col;
      
      if (direction === 'across') {
        // Kelimenin başlangıcını bul
        while (startCol > 0 && gameState.solution[startRow][startCol - 1] !== '#') {
          startCol--;
        }
      } else if (direction === 'down') {
        // Kelimenin başlangıcını bul
        while (startRow > 0 && gameState.solution[startRow - 1][startCol] !== '#') {
          startRow--;
        }
      }
      
      // Başlangıç hücresinin numarasını bul
      const startCell = document.querySelector(`.crossword-cell[data-row="${startRow}"][data-col="${startCol}"]`);
      const cellNumber = startCell.querySelector('.cell-number');
      
      if (cellNumber) {
        gameState.activeClueNumber = parseInt(cellNumber.textContent);
      }
    }
    
    // Aktif ipucunu vurgula
    function highlightActiveClue() {
      const direction = gameState.activeDirection;
      const number = gameState.activeClueNumber;
      
      // Önce tüm vurgulamaları temizle
      const clueItems = document.querySelectorAll('.clue-item');
      clueItems.forEach(item => {
        item.classList.remove('active');
      });
      
      // Aktif ipucuyu vurgula
      const activeClue = document.querySelector(`.clue-item[data-direction="${direction}"][data-number="${number}"]`);
      if (activeClue) {
        activeClue.classList.add('active');
        
        // İpucunu görünür kıl (otomatik kaydır)
        if (direction === 'across') {
          acrossCluesList.scrollTop = activeClue.offsetTop - acrossCluesList.offsetTop - 10;
          
          // İpucu sekmesini etkinleştir
          document.getElementById('across-tab').click();
        } else {
          downCluesList.scrollTop = activeClue.offsetTop - downCluesList.offsetTop - 10;
          
          // İpucu sekmesini etkinleştir
          document.getElementById('down-tab').click();
        }
      }
    }
    
    // Hücre girdisi
    function handleCellInput(e) {
      const input = e.target;
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      
      // Sadece harf girişine izin ver
      const value = input.value.toUpperCase();
      if (/^[A-ZĞÜŞİÖÇ]$/.test(value) || value === '') {
        gameState.grid[row][col] = value;
        
        // Sonraki hücreye geç
        if (value !== '') {
          moveToNextCell();
        }
      } else {
        input.value = '';
        gameState.grid[row][col] = '';
      }
      
      // Hataları göster özelliği açıksa, doğruluğu kontrol et
      if (showErrorsCheckbox.checked && gameState.grid[row][col] !== '') {
        if (gameState.grid[row][col] === gameState.solution[row][col]) {
          input.parentElement.classList.add('correct');
          input.parentElement.classList.remove('incorrect');
        } else {
          input.parentElement.classList.add('incorrect');
          input.parentElement.classList.remove('correct');
        }
      } else {
        input.parentElement.classList.remove('correct', 'incorrect');
      }
      
      // Bulmaca tamamlandı mı kontrol et
      checkCompletion();
    }
    
    // Tuş basımı
    function handleCellKeydown(e) {
      const input = e.target;
      const row = parseInt(input.dataset.row);
      const col = parseInt(input.dataset.col);
      
      switch (e.key) {
        case 'ArrowUp':
          moveSelection(row - 1, col);
          e.preventDefault();
          break;
        case 'ArrowDown':
          moveSelection(row + 1, col);
          e.preventDefault();
          break;
        case 'ArrowLeft':
          moveSelection(row, col - 1);
          e.preventDefault();
          break;
        case 'ArrowRight':
          moveSelection(row, col + 1);
          e.preventDefault();
          break;
        case 'Backspace':
          if (input.value === '') {
            // Hücre boşsa, öncekine git
            moveToPrevCell();
            e.preventDefault();
          }
          break;
        case 'Delete':
          input.value = '';
          gameState.grid[row][col] = '';
          e.preventDefault();
          break;
        case 'Tab':
          // Tab tuşu ile ipuçları arasında gezin
          if (e.shiftKey) {
            // Shift+Tab: Önceki ipucu
            moveToPrevClue();
          } else {
            // Tab: Sonraki ipucu
            moveToNextClue();
          }
          e.preventDefault();
          break;
        case 'Enter':
          // Enter tuşu ile yön değiştir
          toggleDirection();
          e.preventDefault();
          break;
      }
    }
    
    // Seçimi taşı
    function moveSelection(row, col) {
      // Tahtanın sınırları içinde mi kontrol et
      if (row >= 0 && row < gameState.solution.length && col >= 0 && col < gameState.solution[0].length) {
        // Hedef hücre doldurulabilir mi kontrol et
        if (gameState.solution[row][col] !== '#') {
          selectCell(row, col);
        }
      }
    }
    
    // Sonraki hücreye geç
    function moveToNextCell() {
      const { row, col } = gameState.activeCell;
      const direction = gameState.activeDirection;
      
      if (direction === 'across') {
        // Yatay yönde bir sonraki hücreye geç
        if (col < gameState.solution[row].length - 1 && gameState.solution[row][col + 1] !== '#') {
          moveSelection(row, col + 1);
        }
      } else {
        // Dikey yönde bir sonraki hücreye geç
        if (row < gameState.solution.length - 1 && gameState.solution[row + 1][col] !== '#') {
          moveSelection(row + 1, col);
        }
      }
    }
    
    // Önceki hücreye geç
    function moveToPrevCell() {
      const { row, col } = gameState.activeCell;
      const direction = gameState.activeDirection;
      
      if (direction === 'across') {
        // Yatay yönde bir önceki hücreye geç
        if (col > 0 && gameState.solution[row][col - 1] !== '#') {
          moveSelection(row, col - 1);
        }
      } else {
        // Dikey yönde bir önceki hücreye geç
        if (row > 0 && gameState.solution[row - 1][col] !== '#') {
          moveSelection(row - 1, col);
        }
      }
    }
    
    // Sonraki ipucuya geç
    function moveToNextClue() {
      // Mevcut ipucu ve yön
      let direction = gameState.activeDirection;
      let number = gameState.activeClueNumber;
      
      // İpucu listesini al
      const clues = direction === 'across' ? gameState.clues.across : gameState.clues.down;
      
      // İpucu numaralarını al ve sırala
      const numbers = Object.keys(clues).map(Number).sort((a, b) => a - b);
      
      // Mevcut numaranın indeksini bul
      const currentIndex = numbers.indexOf(number);
      
      // Sonraki numara
      if (currentIndex < numbers.length - 1) {
        // Aynı yönde sonraki ipucu
        number = numbers[currentIndex + 1];
      } else {
        // Diğer yöne geç ve ilk ipucuyu al
        direction = direction === 'across' ? 'down' : 'across';
        const otherClues = direction === 'across' ? gameState.clues.across : gameState.clues.down;
        number = Object.keys(otherClues).map(Number).sort((a, b) => a - b)[0];
      }
      
      // İpucunu seç
      selectClue(direction, number);
    }
    
    // Önceki ipucuya geç
    function moveToPrevClue() {
      // Mevcut ipucu ve yön
      let direction = gameState.activeDirection;
      let number = gameState.activeClueNumber;
      
      // İpucu listesini al
      const clues = direction === 'across' ? gameState.clues.across : gameState.clues.down;
      
      // İpucu numaralarını al ve sırala
      const numbers = Object.keys(clues).map(Number).sort((a, b) => a - b);
      
      // Mevcut numaranın indeksini bul
      const currentIndex = numbers.indexOf(number);
      
      // Önceki numara
      if (currentIndex > 0) {
        // Aynı yönde önceki ipucu
        number = numbers[currentIndex - 1];
      } else {
        // Diğer yöne geç ve son ipucuyu al
        direction = direction === 'across' ? 'down' : 'across';
        const otherClues = direction === 'across' ? gameState.clues.across : gameState.clues.down;
        const otherNumbers = Object.keys(otherClues).map(Number).sort((a, b) => a - b);
        number = otherNumbers[otherNumbers.length - 1];
      }
      
      // İpucunu seç
      selectClue(direction, number);
    }
    
    // Bulmacayı doğrula
    function checkPuzzle() {
      // Tüm hücreleri kontrol et
      for (let i = 0; i < gameState.grid.length; i++) {
        for (let j = 0; j < gameState.grid[i].length; j++) {
          // Sadece oynanabilir hücreleri kontrol et
          if (gameState.solution[i][j] !== '#') {
            const cell = document.querySelector(`.crossword-cell[data-row="${i}"][data-col="${j}"]`);
            
            if (gameState.grid[i][j] === gameState.solution[i][j]) {
              cell.classList.add('correct');
              cell.classList.remove('incorrect');
            } else if (gameState.grid[i][j] !== '') {
              cell.classList.add('incorrect');
              cell.classList.remove('correct');
            } else {
              cell.classList.remove('correct', 'incorrect');
            }
          }
        }
      }
    }
    
    // Harf göster
    function revealLetter() {
      const { row, col } = gameState.activeCell;
      
      // Doğru harfi yerleştir
      gameState.grid[row][col] = gameState.solution[row][col];
      
      // Input'u güncelle
      const input = document.querySelector(`.crossword-cell[data-row="${row}"][data-col="${col}"] input`);
      if (input) {
        input.value = gameState.solution[row][col];
        input.parentElement.classList.add('correct');
      }
      
      // İpucu sayısını artır
      gameState.hintsUsed++;
      
      // Bulmaca tamamlandı mı kontrol et
      checkCompletion();
    }
    
    // Kelime göster
    function revealWord() {
      const { row, col } = gameState.activeCell;
      const direction = gameState.activeDirection;
      
      // Kelimenin başlangıcını ve sonunu bul
      let startRow = row;
      let startCol = col;
      let endRow = row;
      let endCol = col;
      
      if (direction === 'across') {
        // Kelimenin başlangıcını bul
        while (startCol > 0 && gameState.solution[startRow][startCol - 1] !== '#') {
          startCol--;
        }
        
        // Kelimenin sonunu bul
        while (endCol < gameState.solution[endRow].length - 1 && gameState.solution[endRow][endCol + 1] !== '#') {
          endCol++;
        }
        
        // Kelimeyi göster
        for (let j = startCol; j <= endCol; j++) {
          gameState.grid[startRow][j] = gameState.solution[startRow][j];
          
          // Input'u güncelle
          const input = document.querySelector(`.crossword-cell[data-row="${startRow}"][data-col="${j}"] input`);
          if (input) {
            input.value = gameState.solution[startRow][j];
            input.parentElement.classList.add('correct');
          }
        }
      } else if (direction === 'down') {
        // Kelimenin başlangıcını bul
        while (startRow > 0 && gameState.solution[startRow - 1][startCol] !== '#') {
          startRow--;
        }
        
        // Kelimenin sonunu bul
        while (endRow < gameState.solution.length - 1 && gameState.solution[endRow + 1][endCol] !== '#') {
          endRow++;
        }
        
        // Kelimeyi göster
        for (let i = startRow; i <= endRow; i++) {
          gameState.grid[i][startCol] = gameState.solution[i][startCol];
          
          // Input'u güncelle
          const input = document.querySelector(`.crossword-cell[data-row="${i}"][data-col="${startCol}"] input`);
          if (input) {
            input.value = gameState.solution[i][startCol];
            input.parentElement.classList.add('correct');
          }
        }
      }
      
      // İpucu sayısını artır
      gameState.hintsUsed += 5;
      
      // Bulmaca tamamlandı mı kontrol et
      checkCompletion();
    }
    
    // Tamamlama kontrolü
    function checkCompletion() {
      // Tüm hücreler doğru mu kontrol et
      let isComplete = true;
      
      for (let i = 0; i < gameState.grid.length; i++) {
        for (let j = 0; j < gameState.grid[i].length; j++) {
          // Sadece oynanabilir hücreleri kontrol et
          if (gameState.solution[i][j] !== '#') {
            if (gameState.grid[i][j] !== gameState.solution[i][j]) {
              isComplete = false;
              break;
            }
          }
        }
        if (!isComplete) break;
      }
      
      // Bulmaca tamamlandıysa
      if (isComplete && !gameState.isComplete) {
        gameState.isComplete = true;
        
        // Zamanlayıcıyı durdur
        clearInterval(gameState.timerInterval);
        
        // Sonuç bilgilerini güncelle
        resultTime.textContent = formatTime(gameState.timer);
        resultDifficulty.textContent = difficultyBadge.textContent;
        resultHints.textContent = gameState.hintsUsed;
        
        // Tamamlama modalını göster
        completionModal.show();
      }
    }
    
    // Yeni bulmaca
    function newPuzzle() {
      // Zorluk seviyesini al
      gameState.difficulty = difficultySelect.value;
      
      // Bulmaca verilerini al
      const puzzleData = puzzles[gameState.difficulty];
      
      // Bulmaca tahtasını oluştur
      createPuzzleGrid(puzzleData);
      
      // Oyun durumunu sıfırla
      gameState.activeCell = { row: 0, col: 0 };
      gameState.activeDirection = 'across';
      gameState.activeClueNumber = null;
      gameState.hintsUsed = 0;
      gameState.isComplete = false;
      
      // İlk hücreyi seç
      for (let i = 0; i < gameState.solution.length; i++) {
        for (let j = 0; j < gameState.solution[i].length; j++) {
          if (gameState.solution[i][j] !== '#') {
            selectCell(i, j);
            i = gameState.solution.length; // dış döngüden çıkmak için
            break;
          }
        }
      }
      
      // Zamanlayıcıyı sıfırla ve başlat
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
      }
      
      gameState.timer = 0;
      updateTimerDisplay();
      
      gameState.timerInterval = setInterval(() => {
        gameState.timer++;
        updateTimerDisplay();
      }, 1000);
      
      // Zorluk rozeti
      updateDifficultyBadge();
    }
    
    // Zamanlayıcı güncelleme
    function updateTimerDisplay() {
      const minutes = Math.floor(gameState.timer / 60);
      const seconds = gameState.timer % 60;
      timerDisplay.innerHTML = `<i class="fas fa-clock me-1"></i>${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Zamanı formatla
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Zorluk rozeti güncelleme
    function updateDifficultyBadge() {
      switch (gameState.difficulty) {
        case 'easy':
          difficultyBadge.textContent = 'Kolay';
          difficultyBadge.className = 'badge bg-info me-2';
          break;
        case 'medium':
          difficultyBadge.textContent = 'Orta';
          difficultyBadge.className = 'badge bg-warning me-2';
          break;
        case 'hard':
          difficultyBadge.textContent = 'Zor';
          difficultyBadge.className = 'badge bg-danger me-2';
          break;
      }
    }
    
    // Event Listeners
    checkBtn.addEventListener('click', checkPuzzle);
    revealLetterBtn.addEventListener('click', revealLetter);
    revealWordBtn.addEventListener('click', revealWord);
    newGameBtn.addEventListener('click', newPuzzle);
    newPuzzleBtn.addEventListener('click', () => {
      completionModal.hide();
      newPuzzle();
    });
    
    difficultySelect.addEventListener('change', () => {
      gameState.difficulty = difficultySelect.value;
      updateDifficultyBadge();
    });
    
    // İlk yükleme
    newPuzzle();
  });
</script>
{% endblock %}
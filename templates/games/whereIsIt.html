
{% extends "layout.html" %}

{% block title %}Kim Nerede?{% endblock %}

{% block content %}
<div class="container position-relative">
  <a href="/" class="back-button"><i class="fas fa-chevron-left"></i></a>
  <h1 class="game-title text-center mb-4">Kim Nerede?</h1>
  
  <!-- Oyun İstatistikleri Bölümü -->
  <div class="game-stats-container">
    <div class="game-stat-item">
      <i class="fas fa-trophy"></i>
      <div class="game-stat-value" id="score-display">0</div>
      <div class="game-stat-label">PUAN</div>
    </div>
    
    <div class="game-stat-item">
      <i class="fas fa-hourglass-half"></i>
      <div class="game-stat-value" id="timer-display">00:30</div>
      <div class="game-stat-label">SÜRE</div>
    </div>
    
    <div class="game-stat-item">
      <i class="fas fa-map-marker-alt"></i>
      <div class="game-stat-value" id="level-display">1</div>
      <div class="game-stat-label">SEVİYE</div>
    </div>
    
    <div class="game-stat-item">
      <i class="fas fa-check-circle"></i>
      <div class="game-stat-value" id="correct-display">0</div>
      <div class="game-stat-label">DOĞRU</div>
    </div>
  </div>
  
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Intro Section -->
      <div class="glass-panel where-is-it-intro mb-4" id="intro-section">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h3 class="mb-3">Türkiye'nin İllerini Bul!</h3>
            <p>Bu oyunda, verilen il adını Türkiye haritası üzerinde bulmanız gerekiyor. Her doğru tahmin için puan kazanırsınız, ancak dikkat edin - süreniz sınırlı!</p>
            <ul class="game-instructions-list">
              <li><i class="fas fa-check-circle"></i> İl ismini okuyun ve haritada bulun</li>
              <li><i class="fas fa-clock"></i> Hızlı cevap verin, süre kısıtlı!</li>
              <li><i class="fas fa-star"></i> Doğru cevaplar için ekstra puan kazanın</li>
              <li><i class="fas fa-level-up-alt"></i> Zorlaştıkça daha fazla puan kazanın</li>
            </ul>
            <button id="start-game-btn" class="btn btn-lg btn-primary mt-3">
              <i class="fas fa-play me-2"></i>Oyunu Başlat
            </button>
          </div>
          <div class="col-md-6 text-center">
            <img src="/static/images/turkey_map_preview.png" alt="Türkiye Haritası" class="img-fluid rounded shadow-sm" style="max-height: 300px;">
          </div>
        </div>
      </div>
      
      <!-- Game Area -->
      <div class="glass-panel game-panel mb-4" id="game-area" style="display: none;">
        <div class="row">
          <div class="col-12 text-center mb-3">
            <div class="current-province-container">
              <h3 class="mb-0">Bul: <span id="current-province" class="fw-bold">İstanbul</span></h3>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-12 position-relative">
            <div class="map-container">
              <object id="turkey-map" data="/static/images/turkey_map.svg" type="image/svg+xml" class="img-fluid"></object>
              
              <!-- İpucu butonu -->
              <button id="hint-btn" class="hint-button position-absolute top-0 end-0 m-2">
                <i class="fas fa-lightbulb"></i> İpucu
                <span id="hint-count" class="hint-count">3</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Level Complete Modal -->
      <div class="modal-overlay" id="level-complete-modal" style="display: none;">
        <div class="game-modal">
          <div class="modal-content level-complete-content text-center">
            <div class="success-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <h2>Seviye Tamamlandı!</h2>
            <div class="score-summary">
              <div class="score-row">
                <span>Doğru Sayısı:</span>
                <span id="level-correct-count">0</span>
              </div>
              <div class="score-row">
                <span>Toplam Puan:</span>
                <span id="level-points">0</span>
              </div>
              <div class="score-row bonus">
                <span>Zaman Bonusu:</span>
                <span id="time-bonus">0</span>
              </div>
              <div class="score-row total">
                <span>Toplam Skor:</span>
                <span id="total-score">0</span>
              </div>
            </div>
            <div class="buttons-container">
              <button id="next-level-btn" class="btn btn-primary">
                <i class="fas fa-arrow-right me-2"></i>Sonraki Seviye
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Game Over Modal -->
      <div class="modal-overlay" id="game-over-modal" style="display: none;">
        <div class="game-modal">
          <div class="modal-content game-over-content text-center">
            <div class="game-over-icon">
              <i class="fas fa-trophy"></i>
            </div>
            <h2>Oyun Bitti!</h2>
            <p>Türkiye coğrafyasına hakimiyetinizi gösterdiniz!</p>
            <div class="score-summary">
              <div class="score-row">
                <span>Tamamlanan Seviye:</span>
                <span id="final-level">0</span>
              </div>
              <div class="score-row">
                <span>Doğru Tahmin:</span>
                <span id="final-correct">0</span>
              </div>
              <div class="score-row total">
                <span>Toplam Puan:</span>
                <span id="final-score">0</span>
              </div>
            </div>
            <div class="buttons-container">
              <button id="play-again-btn" class="btn btn-primary">
                <i class="fas fa-redo me-2"></i>Tekrar Oyna
              </button>
              <button id="back-to-menu-btn" class="btn btn-secondary">
                <i class="fas fa-home me-2"></i>Ana Menü
              </button>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</div>

<!-- İl bilgileri tooltips için -->
<div id="province-tooltip" class="province-tooltip" style="display: none;">
  <span id="tooltip-text">İl Adı</span>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Oyun değişkenleri
    let score = 0;
    let level = 1;
    let timeLeft = 30; // Başlangıç süresi (saniye)
    let correctAnswers = 0;
    let totalCorrectAnswers = 0;
    let timer;
    let currentProvince = "";
    let provinces = [];
    let svgDocument = null;
    let isGameActive = false;
    let hintCount = 3;
    let usedProvinces = [];
    
    // Ses efektleri
    const correctSound = new Audio('/static/sounds/correct.mp3');
    const wrongSound = new Audio('/static/sounds/wrong.mp3');
    const levelCompleteSound = new Audio('/static/sounds/level-complete.mp3');
    const gameOverSound = new Audio('/static/sounds/game-over.mp3');
    
    // Ses çalma fonksiyonu (hataları yakala)
    function playSound(sound) {
      try {
        sound.currentTime = 0;
        sound.play().catch(err => {
          console.log("Sound play error:", err);
        });
      } catch (err) {
        console.log("Sound play error:", err);
      }
    }
    
    // DOM öğeleri
    const startGameBtn = document.getElementById('start-game-btn');
    const introSection = document.getElementById('intro-section');
    const gameArea = document.getElementById('game-area');
    const scoreDisplay = document.getElementById('score-display');
    const timerDisplay = document.getElementById('timer-display');
    const levelDisplay = document.getElementById('level-display');
    const correctDisplay = document.getElementById('correct-display');
    const currentProvinceDisplay = document.getElementById('current-province');
    const turkeyMap = document.getElementById('turkey-map');
    const levelCompleteModal = document.getElementById('level-complete-modal');
    const gameOverModal = document.getElementById('game-over-modal');
    const nextLevelBtn = document.getElementById('next-level-btn');
    const playAgainBtn = document.getElementById('play-again-btn');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');
    const hintBtn = document.getElementById('hint-btn');
    const hintCountDisplay = document.getElementById('hint-count');
    const provinceTooltip = document.getElementById('province-tooltip');
    const tooltipText = document.getElementById('tooltip-text');
    
    // Seviye tamamlama modal içeriği
    const levelCorrectCount = document.getElementById('level-correct-count');
    const levelPointsDisplay = document.getElementById('level-points');
    const timeBonusDisplay = document.getElementById('time-bonus');
    const totalScoreDisplay = document.getElementById('total-score');
    
    // Oyun sonu modal içeriği
    const finalLevelDisplay = document.getElementById('final-level');
    const finalCorrectDisplay = document.getElementById('final-correct');
    const finalScoreDisplay = document.getElementById('final-score');
    
    // SVG yükleme
    turkeyMap.addEventListener('load', function() {
      svgDocument = turkeyMap.contentDocument;
      setupProvinces();
    });
    
    // Başlangıç butonuna tıklama
    startGameBtn.addEventListener('click', startGame);
    
    // Sonraki seviye butonuna tıklama
    nextLevelBtn.addEventListener('click', function() {
      levelCompleteModal.style.display = 'none';
      startNextLevel();
    });
    
    // Tekrar oyna butonuna tıklama
    playAgainBtn.addEventListener('click', function() {
      gameOverModal.style.display = 'none';
      resetGame();
      startGame();
    });
    
    // Ana menüye dön butonuna tıklama
    backToMenuBtn.addEventListener('click', function() {
      gameOverModal.style.display = 'none';
      resetGame();
      gameArea.style.display = 'none';
      introSection.style.display = 'block';
    });
    
    // İpucu butonuna tıklama
    hintBtn.addEventListener('click', giveHint);
    
    // İlleri ayarla
    function setupProvinces() {
      if (!svgDocument) return;
      
      // Tüm il elemanlarını seç
      const provinceElements = svgDocument.querySelectorAll('.province');
      
      provinces = Array.from(provinceElements).map(el => {
        const name = el.getAttribute('data-name');
        return {
          element: el,
          name: name
        };
      });
      
      // Her il için event listener ekle
      provinces.forEach(province => {
        // Hover efektleri
        province.element.addEventListener('mouseover', function(e) {
          if (!isGameActive) return;
          
          this.style.fill = '#e0e0e0';
          showTooltip(province.name, e);
        });
        
        province.element.addEventListener('mouseout', function() {
          if (!isGameActive) return;
          
          this.style.fill = '';
          hideTooltip();
        });
        
        province.element.addEventListener('mousemove', function(e) {
          if (!isGameActive) return;
          
          updateTooltipPosition(e);
        });
        
        // Tıklama olayı
        province.element.addEventListener('click', function() {
          if (!isGameActive) return;
          
          checkAnswer(province.name);
        });
      });
    }
    
    // Oyunu başlat
    function startGame() {
      isGameActive = true;
      introSection.style.display = 'none';
      gameArea.style.display = 'block';
      
      // Değerleri sıfırla
      score = 0;
      level = 1;
      correctAnswers = 0;
      totalCorrectAnswers = 0;
      usedProvinces = [];
      timeLeft = 30 + (level - 1) * 5; // Her seviye için +5 saniye
      hintCount = 3;
      
      // Ekranı güncelle
      updateDisplay();
      
      // İlk soruyu seç
      selectRandomProvince();
      
      // Zamanlayıcıyı başlat
      startTimer();
    }
    
    // Zamanlayıcıyı başlat
    function startTimer() {
      clearInterval(timer);
      timer = setInterval(function() {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(timer);
          endLevel();
        }
      }, 1000);
    }
    
    // Zamanlayıcıyı güncelle
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Son 10 saniye kırmızı yanıp sönsün
      if (timeLeft <= 10) {
        timerDisplay.classList.add('time-warning');
      } else {
        timerDisplay.classList.remove('time-warning');
      }
    }
    
    // Rastgele il seç
    function selectRandomProvince() {
      let availableProvinces = provinces.filter(p => !usedProvinces.includes(p.name));
      
      // Eğer tüm iller kullanıldıysa, listeyi sıfırla
      if (availableProvinces.length === 0) {
        usedProvinces = [];
        availableProvinces = provinces;
      }
      
      // Rastgele bir il seç
      const randomIndex = Math.floor(Math.random() * availableProvinces.length);
      currentProvince = availableProvinces[randomIndex].name;
      
      // Kullanılan iller listesine ekle
      usedProvinces.push(currentProvince);
      
      // Ekranı güncelle
      currentProvinceDisplay.textContent = currentProvince;
    }
    
    // Cevabı kontrol et
    function checkAnswer(selectedProvince) {
      if (selectedProvince === currentProvince) {
        // Doğru cevap
        playSound(correctSound);
        
        // İl elemanını geçici olarak yeşile boyayalım
        const provinceElement = provinces.find(p => p.name === selectedProvince).element;
        const originalFill = provinceElement.style.fill;
        provinceElement.style.fill = '#4CAF50';
        
        // Puanı artır
        const pointsEarned = 100 * level;
        score += pointsEarned;
        
        // Doğru sayısını artır
        correctAnswers++;
        totalCorrectAnswers++;
        
        // Puan animasyonu göster
        showPointsAnimation(pointsEarned);
        
        // Ekranı güncelle
        updateDisplay();
        
        // 1 saniye sonra rengi normale döndürüp yeni soruya geç
        setTimeout(function() {
          provinceElement.style.fill = originalFill;
          
          // Seviye tamamlandı mı kontrol et
          if (correctAnswers >= 5) { // Her seviyede 5 doğru cevap gerekiyor
            endLevel();
          } else {
            selectRandomProvince();
          }
        }, 800);
      } else {
        // Yanlış cevap
        playSound(wrongSound);
        
        // İl elemanını geçici olarak kırmızıya boyayalım
        const provinceElement = provinces.find(p => p.name === selectedProvince).element;
        const originalFill = provinceElement.style.fill;
        provinceElement.style.fill = '#F44336';
        
        // Yanlış cevap için puan düşürme
        score = Math.max(0, score - 25);
        updateDisplay();
        
        // 1 saniye sonra rengi normale döndür
        setTimeout(function() {
          provinceElement.style.fill = originalFill;
        }, 500);
      }
    }
    
    // Ekranı güncelle
    function updateDisplay() {
      scoreDisplay.textContent = score;
      levelDisplay.textContent = level;
      correctDisplay.textContent = totalCorrectAnswers;
      hintCountDisplay.textContent = hintCount;
      
      // İpucu butonu aktif/pasif durumunu güncelle
      if (hintCount <= 0) {
        hintBtn.classList.add('disabled');
      } else {
        hintBtn.classList.remove('disabled');
      }
    }
    
    // Seviyeyi bitir
    function endLevel() {
      clearInterval(timer);
      isGameActive = false;
      
      // Zaman bonusu (kalan her saniye için +10 puan)
      const timeBonus = timeLeft * 10;
      score += timeBonus;
      
      // Seviye tamamlandı modalını göster
      levelCorrectCount.textContent = correctAnswers;
      levelPointsDisplay.textContent = score - timeBonus;
      timeBonusDisplay.textContent = timeBonus;
      totalScoreDisplay.textContent = score;
      
      if (correctAnswers >= 5) {
        // Seviye tamamlandı
        playSound(levelCompleteSound);
        levelCompleteModal.style.display = 'flex';
      } else {
        // Oyun bitti
        playSound(gameOverSound);
        finalLevelDisplay.textContent = level;
        finalCorrectDisplay.textContent = totalCorrectAnswers;
        finalScoreDisplay.textContent = score;
        gameOverModal.style.display = 'flex';
        
        // Skoru kaydet
        saveScore();
      }
    }
    
    // Sonraki seviyeye geç
    function startNextLevel() {
      level++;
      correctAnswers = 0;
      timeLeft = 30 + (level - 1) * 5; // Her seviye için +5 saniye
      
      // İlave ipucu
      if (level % 2 === 0) {
        hintCount += 1;
      }
      
      updateDisplay();
      updateTimerDisplay();
      
      // Yeni soruyu seç
      selectRandomProvince();
      
      // Zamanlayıcıyı başlat
      isGameActive = true;
      startTimer();
    }
    
    // Oyunu sıfırla
    function resetGame() {
      clearInterval(timer);
      score = 0;
      level = 1;
      correctAnswers = 0;
      totalCorrectAnswers = 0;
      timeLeft = 30;
      hintCount = 3;
      usedProvinces = [];
      
      updateDisplay();
      updateTimerDisplay();
    }
    
    // İpucu ver
    function giveHint() {
      if (hintCount <= 0 || !isGameActive) return;
      
      hintCount--;
      updateDisplay();
      
      // Doğru ili vurgula
      const provinceElement = provinces.find(p => p.name === currentProvince).element;
      const originalFill = provinceElement.style.fill;
      provinceElement.style.fill = '#FFD700'; // Altın rengi
      
      // 2 saniye sonra vurguyu kaldır
      setTimeout(function() {
        provinceElement.style.fill = originalFill;
      }, 2000);
    }
    
    // Tooltip göster
    function showTooltip(text, event) {
      tooltipText.textContent = text;
      provinceTooltip.style.display = 'block';
      updateTooltipPosition(event);
    }
    
    // Tooltip'i gizle
    function hideTooltip() {
      provinceTooltip.style.display = 'none';
    }
    
    // Tooltip pozisyonunu güncelle
    function updateTooltipPosition(event) {
      const mapRect = turkeyMap.getBoundingClientRect();
      const x = event.clientX - mapRect.left;
      const y = event.clientY - mapRect.top;
      
      provinceTooltip.style.left = (x + 10) + 'px';
      provinceTooltip.style.top = (y + 10) + 'px';
    }
    
    // Puan animasyonu göster
    function showPointsAnimation(points) {
      const pointsElement = document.createElement('div');
      pointsElement.className = 'points-animation';
      pointsElement.textContent = '+' + points;
      
      // Map container içine ekle
      const mapContainer = document.querySelector('.map-container');
      mapContainer.appendChild(pointsElement);
      
      // Animasyon bittikten sonra elementi kaldır
      setTimeout(() => {
        mapContainer.removeChild(pointsElement);
      }, 1500);
    }
    
    // Skor kaydetme
    function saveScore() {
      if (score <= 0) return;
      
      fetch('/api/save-score', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          game_type: 'whereIsIt',
          score: score
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log('Skor başarıyla kaydedildi:', data);
          
          // XP kazanımı mesajı
          if (data.xp_gained) {
            showXpNotification(data.xp_gained, data.is_level_up);
          }
        } else {
          console.log('Skor kaydedilemedi:', data.message);
        }
      })
      .catch(err => {
        console.log('Skor kaydedilirken hata:', err);
      });
    }
    
    // XP kazanımı bildirimini göster
    function showXpNotification(xp, isLevelUp) {
      const notification = document.createElement('div');
      notification.className = 'xp-notification';
      
      if (isLevelUp) {
        notification.textContent = `+${xp} XP Kazandınız! Seviye Atladınız!`;
        notification.classList.add('level-up');
      } else {
        notification.textContent = `+${xp} XP Kazandınız!`;
      }
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 500);
      }, 3000);
    }
  });
</script>

<style>
  /* Harita Stil */
  .map-container {
    position: relative;
    width: 100%;
    min-height: 400px;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }
  
  /* SVG stil */
  #turkey-map {
    width: 100%;
    height: auto;
    max-height: 600px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }
  
  /* Mevcut il stil */
  .current-province-container {
    background-color: rgba(66, 133, 244, 0.1);
    border-left: 4px solid #4285f4;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 15px;
    display: inline-block;
  }
  
  /* Modal Overlay */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  /* Game Modal */
  .game-modal {
    background-color: #fff;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    animation: modalFadeIn 0.3s ease;
  }
  
  @keyframes modalFadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }
  
  /* Modal Content */
  .modal-content {
    padding: 30px;
  }
  
  /* Success Icon */
  .success-icon {
    font-size: 60px;
    color: #4CAF50;
    margin-bottom: 20px;
  }
  
  .game-over-icon {
    font-size: 60px;
    color: #FFC107;
    margin-bottom: 20px;
  }
  
  /* Score Summary */
  .score-summary {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    text-align: left;
  }
  
  .score-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
  }
  
  .score-row.bonus {
    border-top: 1px dashed #ddd;
    padding-top: 12px;
    margin-top: 4px;
    color: #4CAF50;
  }
  
  .score-row.total {
    border-top: 2px solid #ddd;
    padding-top: 12px;
    margin-top: 4px;
    font-weight: bold;
    font-size: 1.1em;
  }
  
  /* Buttons Container */
  .buttons-container {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  
  /* Tooltip */
  .province-tooltip {
    position: absolute;
    background-color: rgba(0,0,0,0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 14px;
    pointer-events: none;
    z-index: 100;
  }
  
  /* İpucu Butonu */
  .hint-button {
    background-color: #FFC107;
    color: #333;
    border: none;
    border-radius: 4px;
    padding: 5px 10px;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .hint-button:hover {
    background-color: #FFD54F;
  }
  
  .hint-button.disabled {
    background-color: #e0e0e0;
    color: #9e9e9e;
    cursor: not-allowed;
  }
  
  .hint-count {
    background-color: rgba(0,0,0,0.1);
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: 5px;
    font-weight: bold;
  }
  
  /* Timer Warning */
  .time-warning {
    color: #F44336;
    animation: blink 1s infinite;
  }
  
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }
  
  /* Puan Animasyonu */
  .points-animation {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #4CAF50;
    font-size: 36px;
    font-weight: bold;
    text-shadow: 0 0 5px white;
    animation: pointsFadeOut 1.5s ease-out forwards;
    z-index: 10;
  }
  
  @keyframes pointsFadeOut {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
    80% { opacity: 1; transform: translate(-50%, -30%) scale(1); }
    100% { opacity: 0; transform: translate(-50%, -100%) scale(0.8); }
  }
  
  /* XP Bildirim */
  .xp-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s, transform 0.3s;
    z-index: 1100;
  }
  
  .xp-notification.level-up {
    background-color: #2196F3;
  }
  
  .xp-notification.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
{% endblock %}

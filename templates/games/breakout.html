{% extends "layout.html" %}

{% block title %}Breakout{% endblock %}

{% block content %}
<div class="game-container">
  <div class="breakout-container">
    <div class="game-stats">
      <div>Skor: <span id="score">0</span></div>
    </div>
    <canvas id="breakoutCanvas" width="480" height="320"></canvas>
    <div class="game-controls">
      <button id="startGame" class="btn btn-primary">Başlat</button>
      <button id="pauseGame" class="btn btn-warning">Duraklat</button>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
.breakout-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
}

.game-stats {
  font-size: 20px;
  color: var(--accent-color);
}

#breakoutCanvas {
  background: linear-gradient(45deg, #1a1a2e, #16213e);
  border: 2px solid var(--accent-color);
  border-radius: 10px;
}

.game-controls {
  display: flex;
  gap: 10px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const canvas = document.getElementById('breakoutCanvas');
const ctx = canvas.getContext('2d');
const scoreElement = document.getElementById('score');
const startBtn = document.getElementById('startGame');
const pauseBtn = document.getElementById('pauseGame');

let score = 0;
let lives = 3;
let gameLoop = null;
let isPaused = false;

// Ball properties
const ball = {
  x: canvas.width / 2,
  y: canvas.height - 30,
  dx: 4,
  dy: -4,
  radius: 10
};

// Paddle properties
const paddle = {
  width: 75,
  height: 10,
  x: (canvas.width - 75) / 2
};

// Brick properties
const brickRowCount = 3;
const brickColumnCount = 5;
const brickWidth = 75;
const brickHeight = 20;
const brickPadding = 10;
const brickOffsetTop = 30;
const brickOffsetLeft = 30;

const bricks = [];
for (let c = 0; c < brickColumnCount; c++) {
  bricks[c] = [];
  for (let r = 0; r < brickRowCount; r++) {
    bricks[c][r] = { x: 0, y: 0, status: 1 };
  }
}

function drawBall() {
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
  ctx.fillStyle = '#0095DD';
  ctx.fill();
  ctx.closePath();
}

function drawPaddle() {
  ctx.beginPath();
  ctx.rect(paddle.x, canvas.height - paddle.height, paddle.width, paddle.height);
  ctx.fillStyle = '#0095DD';
  ctx.fill();
  ctx.closePath();
}

function drawBricks() {
  for (let c = 0; c < brickColumnCount; c++) {
    for (let r = 0; r < brickRowCount; r++) {
      if (bricks[c][r].status === 1) {
        const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
        const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
        bricks[c][r].x = brickX;
        bricks[c][r].y = brickY;
        ctx.beginPath();
        ctx.rect(brickX, brickY, brickWidth, brickHeight);
        ctx.fillStyle = '#0095DD';
        ctx.fill();
        ctx.closePath();
      }
    }
  }
}

function collisionDetection() {
  for (let c = 0; c < brickColumnCount; c++) {
    for (let r = 0; r < brickRowCount; r++) {
      const b = bricks[c][r];
      if (b.status === 1) {
        if (ball.x > b.x && ball.x < b.x + brickWidth && ball.y > b.y && ball.y < b.y + brickHeight) {
          ball.dy = -ball.dy;
          b.status = 0;
          score += 10;
          scoreElement.textContent = score;

          if (score === brickRowCount * brickColumnCount * 10) {
            alert('Tebrikler, Kazandınız!');
            saveScore(score);
            document.location.reload();
          }
        }
      }
    }
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBricks();
  drawBall();
  drawPaddle();
  collisionDetection();

  if (ball.x + ball.dx > canvas.width - ball.radius || ball.x + ball.dx < ball.radius) {
    ball.dx = -ball.dx;
  }

  if (ball.y + ball.dy < ball.radius) {
    ball.dy = -ball.dy;
  } else if (ball.y + ball.dy > canvas.height - ball.radius) {
    if (ball.x > paddle.x && ball.x < paddle.x + paddle.width) {
      ball.dy = -ball.dy;
    } else {
      lives--;
      if (!lives) {
        alert('Oyun Bitti');
        saveScore(score);
        document.location.reload();
      } else {
        ball.x = canvas.width / 2;
        ball.y = canvas.height - 30;
        ball.dx = 4;
        ball.dy = -4;
        paddle.x = (canvas.width - paddle.width) / 2;
      }
    }
  }

  ball.x += ball.dx;
  ball.y += ball.dy;
}

function saveScore(score) {
  fetch('/api/save-score', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      score: score,
      gameType: 'breakout'
    })
  });
}

function movePaddle(e) {
  const relativeX = e.clientX - canvas.offsetLeft;
  if (relativeX > 0 && relativeX < canvas.width) {
    paddle.x = relativeX - paddle.width / 2;
  }
}

function update() {
  if (!isPaused) {
    draw();
  }
  gameLoop = requestAnimationFrame(update);
}

document.addEventListener('mousemove', movePaddle);

startBtn.addEventListener('click', () => {
  if (!gameLoop) {
    update();
  }
});

pauseBtn.addEventListener('click', () => {
  isPaused = !isPaused;
  pauseBtn.textContent = isPaused ? 'Devam Et' : 'Duraklat';
});
</script>
{% endblock %}
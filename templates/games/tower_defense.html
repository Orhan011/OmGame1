{% extends "layout.html" %}

{% block title %}Tower Defense - ZekaPark{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game-modernizer.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/game-responsive-modernizer.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/score-display.css') }}">
<style>
    .game-container {
        background-color: #1a1a2e;
        width: 100%;
        height: 600px;
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    
    .game-bg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #16213e;
        background-image: url('/static/images/tower_defense_bg.jpg');
        background-size: cover;
        background-position: center;
        opacity: 0.6;
    }
    
    .game-canvas {
        position: relative;
        z-index: 2;
        width: 100%;
        height: 100%;
    }
    
    .game-sidebar {
        position: absolute;
        top: 0;
        right: 0;
        width: 150px;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 3;
        color: white;
        padding: 10px;
        display: flex;
        flex-direction: column;
    }
    
    .tower-selection {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    .tower-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        padding: 5px;
        transition: all 0.2s;
    }
    
    .tower-option:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }
    
    .tower-option img {
        width: 40px;
        height: 40px;
    }
    
    .tower-option.selected {
        background-color: rgba(82, 190, 128, 0.4);
        border: 2px solid #52be80;
    }
    
    .stats-container {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: auto;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
    }
    
    .wave-indicator {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .game-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 10;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
    }
    
    .overlay-content {
        max-width: 400px;
        text-align: center;
    }
    
    .overlay-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    
    @media (max-width: 768px) {
        .game-container {
            height: 500px;
        }
        
        .game-sidebar {
            width: 120px;
        }
        
        .tower-option img {
            width: 30px;
            height: 30px;
        }
    }
    
    @media (max-width: 576px) {
        .game-container {
            height: 400px;
        }
        
        .game-sidebar {
            width: 100px;
        }
        
        .wave-indicator {
            font-size: 18px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="game-wrapper">
    <div class="game-header">
        <h1>Tower Defense</h1>
        <p class="game-description">Stratejik kule savunma oyunuyla düşman dalgalarını durdurun. Kuleleri akıllıca yerleştirin ve düşman birliklerini etkisiz hale getirin!</p>
    </div>
    
    <div class="game-container">
        <div class="game-bg"></div>
        <div class="game-canvas" id="gameCanvas"></div>
        
        <div class="game-sidebar">
            <div class="wave-indicator">Dalga: <span id="waveNumber">1</span></div>
            
            <h3>Kuleler</h3>
            <div class="tower-selection">
                <div class="tower-option" data-tower="basic">
                    <img src="{{ url_for('static', filename='images/basic_tower.svg') }}" alt="Temel Kule">
                    <span>Temel (10)</span>
                </div>
                <div class="tower-option" data-tower="cannon">
                    <img src="{{ url_for('static', filename='images/cannon_tower.svg') }}" alt="Top Kulesi">
                    <span>Top (25)</span>
                </div>
                <div class="tower-option" data-tower="sniper">
                    <img src="{{ url_for('static', filename='images/sniper_tower.svg') }}" alt="Nişancı Kulesi">
                    <span>Nişancı (40)</span>
                </div>
            </div>
            
            <div class="stats-container">
                <div class="stat-item">
                    <span>Altın:</span>
                    <span id="goldAmount">100</span>
                </div>
                <div class="stat-item">
                    <span>Skor:</span>
                    <span id="scoreValue">0</span>
                </div>
                <div class="stat-item">
                    <span>Can:</span>
                    <span id="livesValue">20</span>
                </div>
            </div>
        </div>
        
        <div class="game-overlay" id="startOverlay">
            <div class="overlay-content">
                <h2>Tower Defense</h2>
                <p>Düşman dalgalarını durdurabilmek için stratejik kuleleri yerleştirin. Kuleleri yerleştirmek için önce soldaki menüden bir kule seçin, sonra haritada yerleştirmek istediğiniz noktaya tıklayın.</p>
                <div class="difficulty-selection">
                    <button class="difficulty-btn" data-difficulty="easy">Kolay</button>
                    <button class="difficulty-btn" data-difficulty="medium">Orta</button>
                    <button class="difficulty-btn" data-difficulty="hard">Zor</button>
                </div>
                <div class="overlay-buttons">
                    <button id="startGameBtn" class="btn-primary">Oyunu Başlat</button>
                </div>
            </div>
        </div>
        
        <div class="game-overlay" id="gameOverOverlay" style="display: none;">
            <div class="overlay-content">
                <h2>Oyun Bitti!</h2>
                <p>Düşman birlikleri kalenizi ele geçirdi.</p>
                <div id="finalScore"></div>
                <div class="score-display-container" id="scoreDisplay">
                    <div class="score-display-header">
                        <h3>Oyun Sonucu</h3>
                    </div>
                    <div class="score-display-content">
                        <div class="score-display-item">
                            <span>Toplam Puan:</span>
                            <span id="totalPoints">0</span>
                        </div>
                        <div class="score-display-breakdown">
                            <div class="score-breakdown-item">
                                <span>Temel Puan:</span>
                                <span id="basePoints">0</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span>Zorluk Çarpanı:</span>
                                <span id="difficultyMultiplier">x1.0</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span>Bonus:</span>
                                <span id="bonusPoints">0</span>
                            </div>
                        </div>
                        <div class="score-display-xp">
                            <span>Kazanılan XP:</span>
                            <span id="xpEarned">0</span>
                        </div>
                    </div>
                </div>
                <div class="overlay-buttons">
                    <button id="playAgainBtn" class="btn-primary">Tekrar Oyna</button>
                    <button id="returnBtn" class="btn-secondary">Ana Sayfa</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/score-display.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Oyun değişkenleri
    let game = {
        started: false,
        gameOver: false,
        difficulty: 'medium',
        score: 0,
        gold: 100,
        lives: 20,
        wave: 1,
        towers: [],
        enemies: [],
        projectiles: [],
        selectedTower: null,
        lastUpdateTime: 0,
        gameTime: 0,
        difficultyMultipliers: {
            easy: 0.75,
            medium: 1.0,
            hard: 1.5
        },
        paths: [
            [
                {x: -50, y: 150},
                {x: 100, y: 150},
                {x: 100, y: 300},
                {x: 300, y: 300},
                {x: 300, y: 150},
                {x: 500, y: 150},
                {x: 500, y: 450},
                {x: 700, y: 450}
            ]
        ],
        currentPath: 0,
        canvas: document.getElementById('gameCanvas'),
        ctx: null,
        enemySpawnInterval: null,
        animationFrame: null
    };
    
    // Canvas ve context oluşturma
    game.canvas.width = game.canvas.offsetWidth;
    game.canvas.height = game.canvas.offsetHeight;
    game.ctx = game.canvas.getContext('2d');
    
    // Kule sınıfları
    class Tower {
        constructor(x, y, type) {
            this.x = x;
            this.y = y;
            this.type = type;
            this.level = 1;
            this.lastShot = 0;
            
            switch(type) {
                case 'basic':
                    this.radius = 120;
                    this.damage = 10;
                    this.fireRate = 1000; // ms
                    this.cost = 10;
                    this.color = '#52be80';
                    break;
                case 'cannon':
                    this.radius = 100;
                    this.damage = 25;
                    this.fireRate = 2000; // ms
                    this.cost = 25;
                    this.color = '#e74c3c';
                    break;
                case 'sniper':
                    this.radius = 200;
                    this.damage = 50;
                    this.fireRate = 3000; // ms
                    this.cost = 40;
                    this.color = '#3498db';
                    break;
            }
        }
        
        draw() {
            // Kule menzili
            game.ctx.beginPath();
            game.ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            game.ctx.fillStyle = `${this.color}20`;
            game.ctx.fill();
            game.ctx.strokeStyle = this.color;
            game.ctx.stroke();
            
            // Kule görüntüsü
            game.ctx.beginPath();
            game.ctx.arc(this.x, this.y, 20, 0, Math.PI * 2);
            game.ctx.fillStyle = this.color;
            game.ctx.fill();
            
            // Seviye göstergesi
            game.ctx.fillStyle = 'white';
            game.ctx.textAlign = 'center';
            game.ctx.textBaseline = 'middle';
            game.ctx.font = '16px Arial';
            game.ctx.fillText(this.level, this.x, this.y);
        }
        
        update(currentTime) {
            // En yakın düşmanı bul
            let closestEnemy = null;
            let closestDistance = Infinity;
            
            game.enemies.forEach(enemy => {
                const distance = Math.sqrt(
                    Math.pow(this.x - enemy.x, 2) + 
                    Math.pow(this.y - enemy.y, 2)
                );
                
                if (distance < this.radius && distance < closestDistance) {
                    closestEnemy = enemy;
                    closestDistance = distance;
                }
            });
            
            // Düşmana ateş et
            if (closestEnemy && currentTime - this.lastShot >= this.fireRate) {
                this.shoot(closestEnemy);
                this.lastShot = currentTime;
            }
        }
        
        shoot(enemy) {
            game.projectiles.push(new Projectile(
                this.x, this.y, enemy, this.damage, this.type
            ));
        }
        
        upgrade() {
            const upgradeCost = this.cost * this.level;
            
            if (game.gold >= upgradeCost) {
                game.gold -= upgradeCost;
                this.level++;
                this.damage *= 1.5;
                this.radius *= 1.2;
                this.fireRate *= 0.8;
                updateStats();
                return true;
            }
            
            return false;
        }
    }
    
    // Düşman sınıfı
    class Enemy {
        constructor(type = 'normal') {
            this.type = type;
            this.pathIndex = 0;
            this.waypoint = 0;
            const startPoint = game.paths[game.currentPath][0];
            this.x = startPoint.x;
            this.y = startPoint.y;
            this.targetX = game.paths[game.currentPath][1].x;
            this.targetY = game.paths[game.currentPath][1].y;
            
            switch(type) {
                case 'normal':
                    this.health = 50 * (1 + (game.wave - 1) * 0.2);
                    this.maxHealth = this.health;
                    this.speed = 1;
                    this.reward = 5;
                    this.damage = 1;
                    this.size = 15;
                    this.color = '#e67e22';
                    break;
                case 'fast':
                    this.health = 30 * (1 + (game.wave - 1) * 0.2);
                    this.maxHealth = this.health;
                    this.speed = 2;
                    this.reward = 3;
                    this.damage = 1;
                    this.size = 12;
                    this.color = '#3498db';
                    break;
                case 'tank':
                    this.health = 120 * (1 + (game.wave - 1) * 0.3);
                    this.maxHealth = this.health;
                    this.speed = 0.5;
                    this.reward = 10;
                    this.damage = 2;
                    this.size = 20;
                    this.color = '#7f8c8d';
                    break;
                case 'boss':
                    this.health = 300 * (1 + (game.wave - 1) * 0.4);
                    this.maxHealth = this.health;
                    this.speed = 0.6;
                    this.reward = 30;
                    this.damage = 5;
                    this.size = 30;
                    this.color = '#9b59b6';
                    break;
            }
            
            // Difficulty adjustments
            this.health *= game.difficultyMultipliers[game.difficulty];
            this.maxHealth = this.health;
            this.speed *= game.difficultyMultipliers[game.difficulty];
        }
        
        draw() {
            // Düşman gövdesi
            game.ctx.beginPath();
            game.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            game.ctx.fillStyle = this.color;
            game.ctx.fill();
            
            // Can çubuğu
            const healthPercentage = this.health / this.maxHealth;
            const healthBarWidth = this.size * 2;
            const actualWidth = healthBarWidth * healthPercentage;
            
            game.ctx.fillStyle = 'red';
            game.ctx.fillRect(this.x - this.size, this.y - this.size - 10, healthBarWidth, 5);
            
            game.ctx.fillStyle = 'green';
            game.ctx.fillRect(this.x - this.size, this.y - this.size - 10, actualWidth, 5);
        }
        
        update() {
            // Hedefe hareket
            const dx = this.targetX - this.x;
            const dy = this.targetY - this.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < this.speed) {
                this.waypoint++;
                
                if (this.waypoint >= game.paths[this.pathIndex].length) {
                    // Yol sonuna ulaşıldı, oyuncunun canını azalt
                    game.lives -= this.damage;
                    updateStats();
                    return true;
                }
                
                const nextPoint = game.paths[this.pathIndex][this.waypoint];
                this.targetX = nextPoint.x;
                this.targetY = nextPoint.y;
            } else {
                // Hedefe doğru hareket et
                const vx = (dx / distance) * this.speed;
                const vy = (dy / distance) * this.speed;
                
                this.x += vx;
                this.y += vy;
            }
            
            // Oyun alanından çıkıp çıkmadığını kontrol et
            if (this.health <= 0) {
                game.gold += this.reward;
                game.score += this.reward * 2;
                updateStats();
                return true;
            }
            
            return false;
        }
        
        takeDamage(damage) {
            this.health -= damage;
        }
    }
    
    // Mermi sınıfı
    class Projectile {
        constructor(x, y, target, damage, towerType) {
            this.x = x;
            this.y = y;
            this.target = target;
            this.damage = damage;
            this.speed = 5;
            this.towerType = towerType;
            
            switch(towerType) {
                case 'basic':
                    this.size = 5;
                    this.color = '#52be80';
                    break;
                case 'cannon':
                    this.size = 8;
                    this.color = '#e74c3c';
                    this.splashRadius = 50;
                    break;
                case 'sniper':
                    this.size = 4;
                    this.color = '#3498db';
                    break;
            }
        }
        
        draw() {
            game.ctx.beginPath();
            game.ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            game.ctx.fillStyle = this.color;
            game.ctx.fill();
        }
        
        update() {
            // Target might have been destroyed
            if (!this.target || this.target.health <= 0) {
                return true;
            }
            
            // Move towards target
            const dx = this.target.x - this.x;
            const dy = this.target.y - this.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance < this.speed) {
                // Hit the target
                if (this.towerType === 'cannon') {
                    // Splash damage
                    game.enemies.forEach(enemy => {
                        const distToEnemy = Math.sqrt(
                            Math.pow(this.target.x - enemy.x, 2) + 
                            Math.pow(this.target.y - enemy.y, 2)
                        );
                        
                        if (distToEnemy <= this.splashRadius) {
                            const damageMultiplier = 1 - (distToEnemy / this.splashRadius);
                            enemy.takeDamage(this.damage * damageMultiplier);
                        }
                    });
                } else {
                    // Direct damage
                    this.target.takeDamage(this.damage);
                }
                return true;
            } else {
                // Move projectile
                const vx = (dx / distance) * this.speed;
                const vy = (dy / distance) * this.speed;
                
                this.x += vx;
                this.y += vy;
            }
            
            return false;
        }
    }
    
    // Oyun istatistiklerini güncelleme
    function updateStats() {
        document.getElementById('scoreValue').textContent = game.score;
        document.getElementById('goldAmount').textContent = game.gold;
        document.getElementById('livesValue').textContent = game.lives;
        document.getElementById('waveNumber').textContent = game.wave;
        
        // Oyun bitti mi kontrol et
        if (game.lives <= 0) {
            endGame();
        }
    }
    
    // Oyunu başlat
    function startGame() {
        if (game.started) return;
        
        game.started = true;
        game.gameOver = false;
        document.getElementById('startOverlay').style.display = 'none';
        
        // Dalga oluştur
        startWave();
        
        // Oyun döngüsünü başlat
        game.lastUpdateTime = performance.now();
        gameLoop();
    }
    
    // Yeni dalga başlat
    function startWave() {
        let enemyCount = 10 + (game.wave * 2);
        let spawnDelay = 1500 - (game.wave * 50);
        spawnDelay = Math.max(spawnDelay, 500);
        
        let enemiesSpawned = 0;
        
        game.enemySpawnInterval = setInterval(() => {
            if (enemiesSpawned >= enemyCount) {
                clearInterval(game.enemySpawnInterval);
                return;
            }
            
            let enemyType = 'normal';
            
            // Düşman tipini belirle
            const roll = Math.random();
            if (game.wave >= 5 && roll < 0.1) {
                enemyType = 'boss';
            } else if (game.wave >= 3 && roll < 0.3) {
                enemyType = 'tank';
            } else if (roll < 0.4) {
                enemyType = 'fast';
            }
            
            game.enemies.push(new Enemy(enemyType));
            enemiesSpawned++;
            
            // Tüm düşmanlar öldürüldü mü kontrol et
            if (enemiesSpawned >= enemyCount && game.enemies.length === 0) {
                game.wave++;
                startWave();
            }
        }, spawnDelay);
    }
    
    // Oyun döngüsü
    function gameLoop(currentTime) {
        if (game.gameOver) return;
        
        // Delta zamanı hesapla
        if (!game.lastUpdateTime) {
            game.lastUpdateTime = currentTime;
        }
        
        const deltaTime = currentTime - game.lastUpdateTime;
        game.lastUpdateTime = currentTime;
        game.gameTime += deltaTime;
        
        // Canvas'ı temizle
        game.ctx.clearRect(0, 0, game.canvas.width, game.canvas.height);
        
        // Yolları çiz
        drawPaths();
        
        // Kuleleri güncelle ve çiz
        game.towers.forEach(tower => {
            tower.update(currentTime);
            tower.draw();
        });
        
        // Düşmanları güncelle ve çiz
        for (let i = game.enemies.length - 1; i >= 0; i--) {
            if (game.enemies[i].update()) {
                game.enemies.splice(i, 1);
            } else {
                game.enemies[i].draw();
            }
        }
        
        // Mermileri güncelle ve çiz
        for (let i = game.projectiles.length - 1; i >= 0; i--) {
            if (game.projectiles[i].update()) {
                game.projectiles.splice(i, 1);
            } else {
                game.projectiles[i].draw();
            }
        }
        
        // Sonraki kareyi çağır
        game.animationFrame = requestAnimationFrame(gameLoop);
    }
    
    // Oyun yollarını çiz
    function drawPaths() {
        game.ctx.beginPath();
        game.paths.forEach(path => {
            game.ctx.moveTo(path[0].x, path[0].y);
            
            for (let i = 1; i < path.length; i++) {
                game.ctx.lineTo(path[i].x, path[i].y);
            }
        });
        
        game.ctx.strokeStyle = '#f39c12';
        game.ctx.lineWidth = 30;
        game.ctx.stroke();
        
        // Yol kenarları
        game.ctx.beginPath();
        game.paths.forEach(path => {
            game.ctx.moveTo(path[0].x, path[0].y);
            
            for (let i = 1; i < path.length; i++) {
                game.ctx.lineTo(path[i].x, path[i].y);
            }
        });
        
        game.ctx.strokeStyle = '#e67e22';
        game.ctx.lineWidth = 32;
        game.ctx.setLineDash([5, 10]);
        game.ctx.stroke();
        game.ctx.setLineDash([]);
    }
    
    // Oyunu bitir
    function endGame() {
        game.gameOver = true;
        clearInterval(game.enemySpawnInterval);
        cancelAnimationFrame(game.animationFrame);
        
        // Skor hesaplama
        const basePoints = calculateBasePoints();
        const difficultyMultiplier = calculateDifficultyMultiplier();
        const bonusPoints = calculateBonusPoints();
        const totalPoints = Math.floor((basePoints * difficultyMultiplier) + bonusPoints);
        const xpEarned = calculateXP();
        
        // Skor gösterimini ayarla
        document.getElementById('basePoints').textContent = basePoints;
        document.getElementById('difficultyMultiplier').textContent = `x${difficultyMultiplier.toFixed(1)}`;
        document.getElementById('bonusPoints').textContent = bonusPoints;
        document.getElementById('totalPoints').textContent = totalPoints;
        document.getElementById('xpEarned').textContent = xpEarned;
        
        // Game stats
        const gameStats = {
            difficulty: game.difficulty,
            wavesCompleted: game.wave - 1,
            towersBuilt: game.towers.length,
            gameTime: Math.floor(game.gameTime / 1000), // saniye cinsinden
            score: game.score
        };
        
        // Submit score
        if ({{session.get('user_id', 0)}} > 0) {
            submitScore(totalPoints, gameStats, xpEarned);
        }
        
        // Oyun bitti ekranını göster
        document.getElementById('gameOverOverlay').style.display = 'flex';
    }
    
    // Skor hesaplama fonksiyonları
    function calculateBasePoints() {
        return Math.min(Math.max(game.score, 10), 100);
    }
    
    function calculateDifficultyMultiplier() {
        return game.difficultyMultipliers[game.difficulty];
    }
    
    function calculateBonusPoints() {
        // Bonus puanlar - dalga sayısı, hayatta kalma süresi ve kule sayısına göre
        const waveBonus = (game.wave - 1) * 5;
        const timeBonus = Math.floor(game.gameTime / 1000 / 10);
        return Math.min(waveBonus + timeBonus, 20);
    }
    
    function calculateXP() {
        // XP hesaplaması - oyun süresi ve zorluk seviyesine göre
        const baseXP = Math.floor(game.gameTime / 1000 / 12); // Her 12 saniye için 1 XP
        const difficultyBonus = baseXP * (game.difficultyMultipliers[game.difficulty] - 0.5);
        return Math.floor(baseXP + difficultyBonus);
    }
    
    // Skoru sunucuya gönder
    function submitScore(score, gameStats, xp) {
        fetch('/save-score', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                score: score,
                game_type: 'tower_defense',
                game_stats: gameStats,
                xp_earned: xp
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Score saved:', data);
        })
        .catch(error => {
            console.error('Error saving score:', error);
        });
    }
    
    // Event listeners
    document.addEventListener('click', function(e) {
        // Kule seçimi
        if (e.target.closest('.tower-option')) {
            const towerOption = e.target.closest('.tower-option');
            const towerType = towerOption.dataset.tower;
            
            const allOptions = document.querySelectorAll('.tower-option');
            allOptions.forEach(option => option.classList.remove('selected'));
            
            towerOption.classList.add('selected');
            game.selectedTower = towerType;
        }
        
        // Canvas üzerine kule yerleştirme
        if (e.target === game.canvas && game.started && !game.gameOver && game.selectedTower) {
            const rect = game.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Kule maliyetini kontrol et
            let cost = 0;
            switch(game.selectedTower) {
                case 'basic': cost = 10; break;
                case 'cannon': cost = 25; break;
                case 'sniper': cost = 40; break;
            }
            
            if (game.gold >= cost) {
                // Kule oluştur
                game.gold -= cost;
                game.towers.push(new Tower(x, y, game.selectedTower));
                updateStats();
            }
        }
    });
    
    // Zorluk seviyesi seçimi
    document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            game.difficulty = this.dataset.difficulty;
            
            const allBtns = document.querySelectorAll('.difficulty-btn');
            allBtns.forEach(b => b.classList.remove('selected'));
            
            this.classList.add('selected');
        });
    });
    
    // Oyun başlatma butonu
    document.getElementById('startGameBtn').addEventListener('click', startGame);
    
    // Tekrar oynama butonu
    document.getElementById('playAgainBtn').addEventListener('click', function() {
        // Oyunu sıfırla
        game = {
            started: false,
            gameOver: false,
            difficulty: game.difficulty,
            score: 0,
            gold: 100,
            lives: 20,
            wave: 1,
            towers: [],
            enemies: [],
            projectiles: [],
            selectedTower: null,
            lastUpdateTime: 0,
            gameTime: 0,
            difficultyMultipliers: game.difficultyMultipliers,
            paths: game.paths,
            currentPath: 0,
            canvas: game.canvas,
            ctx: game.ctx
        };
        
        document.getElementById('gameOverOverlay').style.display = 'none';
        document.getElementById('startOverlay').style.display = 'flex';
        updateStats();
    });
    
    // Ana sayfaya dönme butonu
    document.getElementById('returnBtn').addEventListener('click', function() {
        window.location.href = '/';
    });
    
    // Pencere boyutu değiştiğinde canvas'ı yeniden boyutlandır
    window.addEventListener('resize', function() {
        game.canvas.width = game.canvas.offsetWidth;
        game.canvas.height = game.canvas.offsetHeight;
    });
    
    // Başlangıç durumunu ayarla
    updateStats();
});
</script>
{% endblock %}
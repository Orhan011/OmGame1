{% extends 'layout.html' %}

{% block title %}Simon Says - ZekaPark{% endblock %}

{% block content %}
<div class="page-container">
  <div class="game-container">
    <div class="game-header">
      <h1>Simon Says <span class="badge">Hafıza Oyunu</span></h1>
      <p class="game-description">Renkli düğmelerin yanma sırasını hatırlayarak hafızanızı güçlendirin.</p>
    </div>

    <div class="simon-game-container">
      <div class="simon-board">
        <div class="simon-button" id="green" data-color="green"></div>
        <div class="simon-button" id="red" data-color="red"></div>
        <div class="simon-button" id="yellow" data-color="yellow"></div>
        <div class="simon-button" id="blue" data-color="blue"></div>
        <div class="simon-center">
          <div class="simon-score">Seviye: <span id="level">1</span></div>
          <button id="start-button" class="btn btn-primary">Başla</button>
        </div>
      </div>

      <div class="game-controls">
        <button id="restart-game" class="btn btn-outline-warning">
          <i class="fas fa-redo-alt me-2"></i>Yeniden Başlat
        </button>
        <a href="{{ url_for('all_games') }}" class="btn btn-outline-secondary">
          <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
        </a>
      </div>

      <div class="game-instructions mt-4">
        <h4 class="instruction-title"><i class="fas fa-info-circle"></i>Nasıl Oynanır?</h4>
        <ul class="instruction-list">
          <li>"Başla" düğmesine basarak oyunu başlatın.</li>
          <li>Renkli düğmeler belirli bir sırayla yanıp sönecek.</li>
          <li>Bu düğmelere aynı sırayla tıklamanız gerekiyor.</li>
          <li>Her doğru turda, dizi bir adım daha uzar.</li>
          <li>Yanlış bir düğmeye basarsanız, oyun biter.</li>
        </ul>
      </div>
    </div>

    <div id="game-over-modal" class="memory-results-container" style="display: none;">
      <div class="memory-results-header">
        <h2><i class="fas fa-trophy me-2"></i>Oyun Bitti!</h2>
        <p>Tebrikler! İşte sonuçlarınız:</p>
      </div>

      <div class="memory-results-stats">
        <div class="memory-stat-item">
          <div class="memory-stat-value" id="final-level">0</div>
          <div class="memory-stat-label">Ulaşılan Seviye</div>
        </div>
      </div>

      <div class="memory-results-footer">
        <button id="play-again" class="btn btn-primary btn-lg">
          <i class="fas fa-redo-alt me-2"></i>Tekrar Oyna
        </button>
        <a href="{{ url_for('all_games') }}" class="btn btn-outline-light btn-lg">
          <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  .simon-game-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 15px;
  }

  .simon-board {
    width: 90vw;
    max-width: 400px;
    height: 90vw;
    max-height: 400px;
    border-radius: 50%;
    margin: 20px auto;
    position: relative;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 20px;
    padding: 20px;
    background-color: #333;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }

  .simon-button {
    border-radius: 100%;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s;
  }

  #green {
    background-color: green;
    border-top-left-radius: 100%;
  }

  #red {
    background-color: red;
    border-top-right-radius: 100%;
  }

  #yellow {
    background-color: yellow;
    border-bottom-left-radius: 100%;
  }

  #blue {
    background-color: blue;
    border-bottom-right-radius: 100%;
  }

  .simon-button.active {
    opacity: 1;
    box-shadow: 0 0 20px white;
  }

  .simon-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 35%;
    height: 35%;
    background-color: #111;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
  }

  .simon-score {
    font-size: 1.2rem;
    color: white;
    margin-bottom: 10px;
  }

  #start-button {
    padding: 8px 16px;
  }
  
  .game-instructions {
    margin-top: 20px;
    margin-bottom: 20px;
  }
  
  .instruction-title {
    font-size: 1.2rem;
    margin-bottom: 10px;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .instruction-list {
    background: rgba(25, 25, 45, 0.7);
    border-radius: 10px;
    padding: 15px 15px 15px 35px;
    margin: 0;
  }
  
  .instruction-list li {
    margin-bottom: 8px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
  }
  
  .instruction-list li:last-child {
    margin-bottom: 0;
  }
  
  .game-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
  }
  
  /* Mobil Optimizasyonlar */
  @media (max-width: 768px) {
    .game-container {
      padding: 15px 10px;
    }
    
    .game-header h1 {
      font-size: 1.5rem;
    }
    
    .game-header .badge {
      font-size: 0.8rem;
    }
    
    .game-description {
      font-size: 0.9rem;
    }
    
    .simon-board {
      width: 85vw;
      height: 85vw;
      gap: 10px;
      padding: 10px;
    }
    
    .simon-center {
      width: 40%;
      height: 40%;
    }
    
    .simon-score {
      font-size: 1rem;
      margin-bottom: 5px;
    }
    
    #start-button {
      padding: 5px 10px;
      font-size: 0.9rem;
    }
    
    .instruction-title {
      font-size: 1.1rem;
    }
    
    .instruction-list li {
      font-size: 0.85rem;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const buttons = document.querySelectorAll('.simon-button');
  const startButton = document.getElementById('start-button');
  const restartButton = document.getElementById('restart-game');
  const levelDisplay = document.getElementById('level');
  const finalLevelDisplay = document.getElementById('final-level');
  const gameOverModal = document.getElementById('game-over-modal');
  const playAgainButton = document.getElementById('play-again');

  const colors = ['green', 'red', 'yellow', 'blue'];
  let gamePattern = [];
  let userPattern = [];
  let level = 0;
  let isGameStarted = false;

  // Audio elements for different sounds
  const sounds = {};

  colors.forEach(color => {
    sounds[color] = new Audio(`/static/sounds/note${colors.indexOf(color) + 1}.mp3`);
  });

  const gameOverSound = new Audio('/static/sounds/game-over.mp3');
  const successSound = new Audio('/static/sounds/success.mp3');

  function nextSequence() {
    userPattern = [];
    level++;
    levelDisplay.textContent = level;

    const randomColor = colors[Math.floor(Math.random() * 4)];
    gamePattern.push(randomColor);

    // Play the pattern after a short delay
    setTimeout(() => {
      playPattern(gamePattern);
    }, 500);
  }

  function playPattern(pattern) {
    let i = 0;
    const interval = setInterval(() => {
      if (i >= pattern.length) {
        clearInterval(interval);
        return;
      }

      flashButton(pattern[i]);
      i++;
    }, 600);
  }

  function flashButton(color) {
    const button = document.getElementById(color);
    if (button) {
      button.classList.add('active');
      if (sounds[color]) {
        sounds[color].play().catch(err => console.log('Ses çalma hatası:', err));
      }

      setTimeout(() => {
        button.classList.remove('active');
      }, 400);
    }
  }

  function checkAnswer(currentLevel) {
    if (userPattern[currentLevel] === gamePattern[currentLevel]) {
      if (userPattern.length === gamePattern.length) {
        successSound.play().catch(err => console.log('Ses çalma hatası:', err));
        setTimeout(() => {
          nextSequence();
        }, 1000);
      }
    } else {
      gameOver();
    }
  }

  function gameOver() {
    gameOverSound.play().catch(err => console.log('Ses çalma hatası:', err));
    finalLevelDisplay.textContent = level;
    gameOverModal.style.display = 'block';
    isGameStarted = false;
    
    // Save score to the server
    saveScore(level);
  }
  
  // Function to save score to the server
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        game_type: 'simon_says',
        score: score
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Score saved:', data);
    })
    .catch(error => {
      console.error('Error saving score:', error);
    });
  }

  function resetGame() {
    gamePattern = [];
    userPattern = [];
    level = 0;
    isGameStarted = false;
    gameOverModal.style.display = 'none';
  }

  // Event Listeners
  startButton.addEventListener('click', function() {
    if (!isGameStarted) {
      isGameStarted = true;
      resetGame();
      nextSequence();
    }
  });

  if (buttons) {
    buttons.forEach(button => {
      button.addEventListener('click', function() {
        if (isGameStarted) {
          const chosenColor = this.getAttribute('data-color');
          userPattern.push(chosenColor);

          flashButton(chosenColor);
          checkAnswer(userPattern.length - 1);
        }
      });
    });
  }

  if (restartButton) {
    restartButton.addEventListener('click', function() {
      resetGame();
    });
  }

  if (playAgainButton) {
    playAgainButton.addEventListener('click', function() {
      resetGame();
      isGameStarted = true;
      nextSequence();
    });
  }
});
</script>
{% endblock %}

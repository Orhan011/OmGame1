{% extends 'layout.html' %}

{% block title %}Yazma Hızı Testi - ZekaPark{% endblock %}

{% block content %}
<div class="page-container">
  <div class="game-container">
    <div class="game-header">
      <h1>Yazma Hızı <span class="badge">Klavye Hız Testi</span></h1>
      <p class="game-description">Belirli metinleri hızlı ve doğru bir şekilde yazarak yazma becerilerinizi geliştirin.</p>
    </div>

    <div class="typing-container">
      <div class="typing-test-wrapper">
        <div class="typing-header">
          <div class="typing-stats">
            <div class="stat-item">
              <div class="stat-label">Süre</div>
              <div class="stat-value" id="timer">60</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Kelime/DK</div>
              <div class="stat-value" id="wpm">0</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Doğruluk</div>
              <div class="stat-value" id="accuracy">100%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Hatalar</div>
              <div class="stat-value" id="errors">0</div>
            </div>
          </div>

          <div class="typing-mode">
            <button id="mode-words" class="mode-button active">Kelime Modu</button>
            <button id="mode-time" class="mode-button">Zaman Modu</button>
          </div>
        </div>

        <div class="typing-content">
          <div id="test-intro" class="test-intro active">
            <h3>Yazma Hız Testine Hoş Geldiniz</h3>
            <p>Bu test yazma hızınızı ve doğruluğunuzu ölçmek için tasarlanmıştır.</p>
            
            <div class="test-options">
              <div class="option-section">
                <h4>Mod Seçin:</h4>
                <div class="radio-group">
                  <div class="radio-option">
                    <input type="radio" id="words-mode" name="test-mode" value="words" checked>
                    <label for="words-mode">Kelime Modu</label>
                    <span class="help-text">Belirli sayıda kelimeyi tamamlayarak hızınızı ölçün</span>
                  </div>
                  <div class="radio-option">
                    <input type="radio" id="time-mode" name="test-mode" value="time">
                    <label for="time-mode">Zaman Modu</label>
                    <span class="help-text">Belirli bir süre içinde yazarak hızınızı ölçün</span>
                  </div>
                </div>
              </div>
              
              <div class="option-section" id="words-option">
                <h4>Kelime Sayısı:</h4>
                <div class="button-group">
                  <button class="option-button" data-words="10">10</button>
                  <button class="option-button active" data-words="25">25</button>
                  <button class="option-button" data-words="50">50</button>
                  <button class="option-button" data-words="100">100</button>
                </div>
              </div>
              
              <div class="option-section" id="time-option" style="display: none;">
                <h4>Süre (saniye):</h4>
                <div class="button-group">
                  <button class="option-button" data-time="30">30</button>
                  <button class="option-button active" data-time="60">60</button>
                  <button class="option-button" data-time="120">120</button>
                  <button class="option-button" data-time="300">300</button>
                </div>
              </div>
              
              <div class="option-section">
                <h4>Zorluk Seviyesi:</h4>
                <div class="button-group">
                  <button class="difficulty-button active" data-difficulty="easy">Kolay</button>
                  <button class="difficulty-button" data-difficulty="medium">Orta</button>
                  <button class="difficulty-button" data-difficulty="hard">Zor</button>
                </div>
              </div>
            </div>
            
            <button id="start-test" class="btn btn-primary btn-lg">
              <i class="fas fa-keyboard me-2"></i>Teste Başla
            </button>
          </div>

          <div id="typing-text-area" class="typing-text-area">
            <div class="typing-text" id="typing-text"></div>
            <input type="text" id="input-field" class="input-field" placeholder="Yazmaya başlamak için buraya tıklayın..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
          </div>
        </div>

        <div class="typing-controls">
          <button id="restart-test" class="btn btn-outline-warning">
            <i class="fas fa-redo-alt me-2"></i>Yeniden Başlat
          </button>
          <a href="{{ url_for('all_games') }}" class="btn btn-outline-secondary">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>

      <div id="results-screen" class="typing-results" style="display: none;">
        <h2><i class="fas fa-chart-line me-2"></i>Test Sonuçları</h2>

        <div class="results-summary">
          <div class="results-item result-main">
            <div class="result-value" id="result-wpm">0</div>
            <div class="result-label">Kelime/Dakika (WPM)</div>
          </div>
          <div class="results-item result-main">
            <div class="result-value" id="result-accuracy">100%</div>
            <div class="result-label">Doğruluk</div>
          </div>
        </div>

        <div class="results-details">
          <div class="results-column">
            <div class="results-item">
              <div class="result-label">Karakterler</div>
              <div class="result-value" id="result-characters">0</div>
            </div>
            <div class="results-item">
              <div class="result-label">Hatalar</div>
              <div class="result-value" id="result-errors">0</div>
            </div>
          </div>
          <div class="results-column">
            <div class="results-item">
              <div class="result-label">Doğru Kelimeler</div>
              <div class="result-value" id="result-correct-words">0</div>
            </div>
            <div class="results-item">
              <div class="result-label">Yanlış Kelimeler</div>
              <div class="result-value" id="result-wrong-words">0</div>
            </div>
          </div>
          <div class="results-column">
            <div class="results-item">
              <div class="result-label">Doğru Vuruşlar</div>
              <div class="result-value" id="result-correct-chars">0</div>
            </div>
            <div class="results-item">
              <div class="result-label">Kullandığınız Süre</div>
              <div class="result-value" id="result-time-used">0</div>
            </div>
          </div>
        </div>

        <div class="results-actions">
          <button id="retry-test" class="btn btn-primary btn-lg">
            <i class="fas fa-redo-alt me-2"></i>Tekrar Dene
          </button>
          <a href="{{ url_for('all_games') }}" class="btn btn-outline-light btn-lg">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .typing-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 10px;
  }

  .typing-test-wrapper {
    background: rgba(25, 25, 45, 0.7);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .typing-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
  }

  .typing-stats {
    display: flex;
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    overflow: hidden;
    flex-wrap: wrap;
    width: 100%;
  }

  .stat-item {
    padding: 10px 15px;
    text-align: center;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    flex-grow: 1;
    flex-basis: 0;
    min-width: 70px;
  }

  .stat-item:last-child {
    border-right: none;
  }

  .stat-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 3px;
  }

  .stat-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: #fff;
  }

  #wpm, #result-wpm {
    color: var(--accent-color);
  }

  #errors, #result-errors {
    color: #ff4757;
  }

  .typing-mode {
    display: flex;
    overflow: hidden;
    border-radius: 10px;
    width: 100%;
    margin-top: 10px;
  }

  .mode-button {
    padding: 8px 12px;
    background: rgba(30, 30, 60, 0.5);
    border: none;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    flex-grow: 1;
    text-align: center;
  }

  .mode-button.active {
    background: var(--accent-color);
  }

  .mode-button:first-child {
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
  }

  .mode-button:last-child {
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
  }

  .typing-content {
    position: relative;
    margin-bottom: 20px;
  }

  .test-intro {
    display: none;
    text-align: center;
    padding: 15px;
  }

  .test-intro.active {
    display: block;
  }

  .test-intro h3 {
    color: var(--accent-color);
    margin-bottom: 10px;
    font-weight: 600;
    font-size: 1.4rem;
  }

  .test-intro p {
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 20px;
    font-size: 0.95rem;
  }

  .test-options {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .option-section {
    margin-bottom: 12px;
  }

  .option-section:last-child {
    margin-bottom: 0;
  }

  .option-section h4 {
    font-size: 0.9rem;
    color: #fff;
    margin-bottom: 8px;
  }

  .button-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .option-button, .difficulty-button {
    padding: 6px 12px;
    background: rgba(40, 40, 80, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
  }

  .option-button:hover, .difficulty-button:hover {
    background: rgba(60, 60, 100, 0.5);
  }

  .option-button.active, .difficulty-button.active {
    background: rgba(106, 90, 224, 0.6);
    border-color: var(--accent-color);
  }

  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .radio-option {
    display: flex;
    align-items: center;
    position: relative;
  }

  .radio-option input[type="radio"] {
    margin-right: 8px;
  }

  .radio-option label {
    color: #fff;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .help-text {
    margin-left: 8px;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    display: inline-block;
  }

  .typing-text-area {
    display: none;
    margin-bottom: 15px;
  }

  .typing-text {
    background: rgba(30, 30, 60, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    font-size: 1.1rem;
    line-height: 1.6;
    min-height: 120px;
    margin-bottom: 12px;
    color: rgba(255, 255, 255, 0.7);
    user-select: none;
    overflow-wrap: break-word;
  }

  .input-field {
    width: 100%;
    padding: 12px;
    background: rgba(40, 40, 80, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .input-field:focus {
    outline: none;
    border-color: var(--accent-color);
  }

  .typing-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  /* Text Character Styling */
  .char {
    display: inline-block;
    position: relative;
  }

  .correct {
    color: #6ab04c;
  }

  .incorrect {
    color: #ff4757;
    text-decoration: underline;
  }

  .active {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
  }

  /* Results Screen */
  .typing-results {
    background: rgba(25, 25, 45, 0.7);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
  }

  .typing-results h2 {
    color: var(--accent-color);
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  .results-summary {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .result-main {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 15px;
    padding: 15px;
    min-width: 150px;
    flex-grow: 1;
  }

  .result-main .result-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 5px;
  }

  .result-main .result-label {
    font-size: 0.9rem;
  }

  .results-details {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
  }

  .results-column {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    flex-grow: 1;
    max-width: 220px;
    min-width: 150px;
  }

  .results-item {
    margin-bottom: 10px;
  }

  .results-column .results-item:last-child {
    margin-bottom: 0;
  }

  .results-item .result-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 3px;
  }

  .results-item .result-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: #fff;
  }

  .results-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  /* Mobil Optimizasyonlar */
  @media (max-width: 768px) {
    .game-container {
      padding: 10px;
    }
    
    .typing-test-wrapper, .typing-results {
      padding: 15px;
    }
    
    .typing-header {
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .stat-item {
      padding: 8px;
    }
    
    .stat-label {
      font-size: 0.7rem;
    }
    
    .stat-value {
      font-size: 1rem;
    }
    
    .test-intro h3 {
      font-size: 1.2rem;
    }
    
    .test-intro p {
      font-size: 0.85rem;
    }
    
    .test-options {
      padding: 12px;
    }
    
    .option-section h4 {
      font-size: 0.8rem;
    }
    
    .option-button, .difficulty-button {
      padding: 5px 10px;
      font-size: 0.8rem;
    }
    
    .radio-option label {
      font-size: 0.8rem;
    }
    
    .help-text {
      font-size: 0.7rem;
    }
    
    .typing-text {
      font-size: 1rem;
      padding: 12px;
      min-height: 100px;
    }
    
    .input-field {
      padding: 10px;
    }
    
    .results-summary {
      gap: 10px;
    }
    
    .result-main {
      padding: 12px;
      min-width: 120px;
    }
    
    .result-main .result-value {
      font-size: 2rem;
    }
    
    .results-column {
      padding: 12px;
      min-width: 120px;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const testIntro = document.getElementById('test-intro');
  const typingTextArea = document.getElementById('typing-text-area');
  const resultsScreen = document.getElementById('results-screen');
  
  const wordsMode = document.getElementById('words-mode');
  const timeMode = document.getElementById('time-mode');
  const wordsOption = document.getElementById('words-option');
  const timeOption = document.getElementById('time-option');
  
  const wordButtons = document.querySelectorAll('[data-words]');
  const timeButtons = document.querySelectorAll('[data-time]');
  const difficultyButtons = document.querySelectorAll('[data-difficulty]');
  
  const startTestBtn = document.getElementById('start-test');
  const restartTestBtn = document.getElementById('restart-test');
  const retryTestBtn = document.getElementById('retry-test');
  
  const typingText = document.getElementById('typing-text');
  const inputField = document.getElementById('input-field');
  
  const timerElement = document.getElementById('timer');
  const wpmElement = document.getElementById('wpm');
  const accuracyElement = document.getElementById('accuracy');
  const errorsElement = document.getElementById('errors');
  
  const resultWpm = document.getElementById('result-wpm');
  const resultAccuracy = document.getElementById('result-accuracy');
  const resultCharacters = document.getElementById('result-characters');
  const resultErrors = document.getElementById('result-errors');
  const resultCorrectWords = document.getElementById('result-correct-words');
  const resultWrongWords = document.getElementById('result-wrong-words');
  const resultCorrectChars = document.getElementById('result-correct-chars');
  const resultTimeUsed = document.getElementById('result-time-used');

  // Sample texts for different difficulty levels
  const texts = {
    easy: [
      "Güneşli bir günde parkta yürüyüş yapmak insana huzur verir. Doğanın sesleri ve temiz hava zihnimizi temizler.",
      "Kitap okumak en sevdiğim aktivitelerden biridir. Her kitap beni farklı dünyalara götürür ve yeni bilgiler edinmemi sağlar.",
      "Sağlıklı beslenmek için sebze ve meyve tüketimini artırmak gerekir. Düzenli egzersiz yapmak da sağlığımız için çok önemlidir."
    ],
    medium: [
      "Teknolojinin hızla gelişmesi günlük yaşantımızı büyük ölçüde değiştiriyor. Akıllı telefonlar ve bilgisayarlar artık hayatımızın vazgeçilmez bir parçası haline geldi. Bu araçların bilinçli kullanımı, dijital çağda başarılı olmak için önemlidir.",
      "Küresel ısınma, dünyanın karşı karşıya olduğu en büyük çevresel sorunlardan biridir. Fosil yakıtların kullanımı, ormansızlaşma ve endüstriyel faaliyetler sera gazı emisyonlarını artırarak iklim değişikliğine neden olmaktadır.",
      "Eğitim, bir toplumun gelişmesinde en önemli faktörlerden biridir. Kaliteli bir eğitim sistemi, bireylerin potansiyellerini tam olarak gerçekleştirmelerine ve topluma değerli katkılar sunmalarına olanak tanır."
    ],
    hard: [
      "Kuantum fiziği, maddenin ve enerjinin en temel seviyede nasıl davrandığını inceleyen bir fizik dalıdır. Klasik fiziğin açıklayamadığı mikro düzeydeki olayları açıklamak için geliştirilmiştir. Kuantum mekaniği, parçacıkların hem dalga hem de parçacık özelliği gösterebildiğini ve belirli fiziksel özelliklerin yalnızca olasılıklar olarak ifade edilebileceğini öne sürer.",
      "Yapay zekâ ve makine öğrenimi günümüzde birçok sektörde devrim yaratıyor. Doğal dil işleme, görüntü tanıma ve karar verme algoritmalarındaki ilerlemeler, makinelerin insan benzeri görevleri giderek daha etkili bir şekilde yerine getirmesini sağlıyor. Bu teknolojilerin sorumlu ve etik bir şekilde geliştirilmesi, toplum üzerindeki potansiyel olumsuz etkilerini en aza indirmek için kritik öneme sahiptir.",
      "Nöroloji ve bilişsel psikoloji alanlarındaki araştırmalar, insan beyninin işleyişi hakkında önemli bilgiler sunmaktadır. Beynin nöroplastisitesi, yani yeni bağlantılar oluşturabilme ve mevcut bağlantıları yeniden düzenleyebilme yeteneği, öğrenme ve bellek oluşturma süreçlerinin temelini oluşturur. Bu anlayış, eğitim metodolojilerinin geliştirilmesine ve çeşitli nörodejeneratif hastalıkların tedavisine katkıda bulunmaktadır."
    ]
  };

  // Test Configuration
  let testMode = 'words'; // 'words' or 'time'
  let wordCount = 25;
  let timeLimit = 60; // seconds
  let difficulty = 'easy';
  let currentText = '';
  
  // Test State
  let time = 0;
  let timer;
  let isTyping = false;
  let charIndex = 0;
  let mistakes = 0;
  let correctWords = 0;
  let wrongWords = 0;
  let correctChars = 0;
  let currentWordIndex = 0;
  let lastWord = '';

  // Event listeners for test configuration
  wordsMode.addEventListener('change', function() {
    if (this.checked) {
      testMode = 'words';
      wordsOption.style.display = 'block';
      timeOption.style.display = 'none';
      
      document.getElementById('mode-words').classList.add('active');
      document.getElementById('mode-time').classList.remove('active');
    }
  });

  timeMode.addEventListener('change', function() {
    if (this.checked) {
      testMode = 'time';
      wordsOption.style.display = 'none';
      timeOption.style.display = 'block';
      
      document.getElementById('mode-words').classList.remove('active');
      document.getElementById('mode-time').classList.add('active');
    }
  });

  document.getElementById('mode-words').addEventListener('click', function() {
    wordsMode.checked = true;
    wordsMode.dispatchEvent(new Event('change'));
  });

  document.getElementById('mode-time').addEventListener('click', function() {
    timeMode.checked = true;
    timeMode.dispatchEvent(new Event('change'));
  });

  wordButtons.forEach(button => {
    button.addEventListener('click', function() {
      wordButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      wordCount = parseInt(this.getAttribute('data-words'));
    });
  });

  timeButtons.forEach(button => {
    button.addEventListener('click', function() {
      timeButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      timeLimit = parseInt(this.getAttribute('data-time'));
    });
  });

  difficultyButtons.forEach(button => {
    button.addEventListener('click', function() {
      difficultyButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      difficulty = this.getAttribute('data-difficulty');
    });
  });

  // Start test
  startTestBtn.addEventListener('click', function() {
    initTest();
  });

  // Restart test
  restartTestBtn.addEventListener('click', function() {
    initTest();
  });

  // Retry test
  retryTestBtn.addEventListener('click', function() {
    testIntro.classList.add('active');
    resultsScreen.style.display = 'none';
  });

  // Initialize test
  function initTest() {
    // Reset state
    resetTest();
    
    // Get random text based on difficulty
    const textArray = texts[difficulty];
    const randomIndex = Math.floor(Math.random() * textArray.length);
    currentText = textArray[randomIndex];
    
    // Prepare text for display
    typingText.innerHTML = '';
    currentText.split('').forEach(char => {
      const charSpan = document.createElement('span');
      charSpan.textContent = char;
      charSpan.className = 'char';
      typingText.appendChild(charSpan);
    });
    
    // Set timer display
    if (testMode === 'time') {
      timerElement.textContent = timeLimit;
    } else {
      const wordsInText = currentText.split(' ').length;
      if (wordsInText < wordCount) {
        // If the text has fewer words than requested, repeat the text
        let repeatedText = currentText;
        while (repeatedText.split(' ').length < wordCount) {
          repeatedText += ' ' + currentText;
        }
        
        // Trim to exact word count
        const words = repeatedText.split(' ');
        repeatedText = words.slice(0, wordCount).join(' ');
        
        // Update current text and display
        currentText = repeatedText;
        typingText.innerHTML = '';
        currentText.split('').forEach(char => {
          const charSpan = document.createElement('span');
          charSpan.textContent = char;
          charSpan.className = 'char';
          typingText.appendChild(charSpan);
        });
      }
      
      // Set counter to word count
      timerElement.textContent = 0;
    }
    
    // Show typing area
    testIntro.classList.remove('active');
    typingTextArea.style.display = 'block';
    
    // Focus input field
    setTimeout(() => {
      inputField.focus();
    }, 200);
  }

  // Reset test state
  function resetTest() {
    isTyping = false;
    charIndex = 0;
    mistakes = 0;
    correctWords = 0;
    wrongWords = 0;
    correctChars = 0;
    time = 0;
    currentWordIndex = 0;
    lastWord = '';
    
    // Clear input field
    inputField.value = '';
    
    // Reset display elements
    wpmElement.textContent = '0';
    accuracyElement.textContent = '100%';
    errorsElement.textContent = '0';
    
    // Clear any existing timer
    clearInterval(timer);
  }

  // Process typing input
  inputField.addEventListener('input', function(e) {
    // Start timer on first input
    if (!isTyping) {
      isTyping = true;
      
      // Start timer
      if (testMode === 'time') {
        time = timeLimit;
        timer = setInterval(updateTimeTimer, 1000);
      } else {
        timer = setInterval(updateWordTimer, 1000);
      }
    }
    
    const typedChar = e.target.value.charAt(e.target.value.length - 1);
    const characters = typingText.querySelectorAll('.char');
    
    // Check if we've reached the end of the text
    if (charIndex >= characters.length) {
      if (testMode === 'words') {
        // In word mode, end the test when all text is typed
        clearInterval(timer);
        endTest();
      }
      return;
    }
    
    // Check the typed character
    if (typedChar === characters[charIndex].textContent) {
      characters[charIndex].classList.add('correct');
      correctChars++;
    } else {
      characters[charIndex].classList.add('incorrect');
      mistakes++;
    }
    
    // Move active cursor to next character
    charIndex++;
    
    // Set active character
    if (charIndex < characters.length) {
      characters.forEach(char => char.classList.remove('active'));
      characters[charIndex].classList.add('active');
    }
    
    // Check for completed words
    if (typedChar === ' ' || charIndex >= characters.length) {
      const typedWord = e.target.value.trim();
      const currentWord = getCurrentWord(currentWordIndex);
      
      if (typedWord === currentWord) {
        correctWords++;
      } else {
        wrongWords++;
      }
      
      currentWordIndex++;
      inputField.value = '';
    }
    
    // Update stats
    updateStats();
  });

  // Get current word from text
  function getCurrentWord(index) {
    const words = currentText.split(' ');
    return words[index] || '';
  }

  // Update typing statistics
  function updateStats() {
    // Calculate WPM
    const elapsedTime = testMode === 'time' ? (timeLimit - time) / 60 : time / 60;
    if (elapsedTime > 0) {
      const wpm = Math.round(((charIndex - mistakes) / 5) / elapsedTime);
      wpmElement.textContent = wpm;
    }
    
    // Calculate accuracy
    const accuracy = charIndex > 0 
      ? Math.round(((charIndex - mistakes) / charIndex) * 100) 
      : 100;
    
    accuracyElement.textContent = `${accuracy}%`;
    errorsElement.textContent = mistakes;
  }

  // Update timer for time mode
  function updateTimeTimer() {
    if (time > 0) {
      time--;
      timerElement.textContent = time;
      
      // Update styles for last 10 seconds
      if (time <= 10) {
        timerElement.style.color = '#ff4757';
      }
      
      // Update WPM in real-time
      updateStats();
    } else {
      clearInterval(timer);
      endTest();
    }
  }

  // Update timer for word mode
  function updateWordTimer() {
    time++;
    timerElement.textContent = time;
    
    // Update WPM in real-time
    updateStats();
  }

  // Function to end the test
  function endTest() {
    // Calculate final stats
    const timeElapsed = time / 60; // convert to minutes
    const wpm = Math.round(((charIndex - mistakes) / 5) / timeElapsed);
    const accuracy = charIndex > 0 
      ? Math.round(((charIndex - mistakes) / charIndex) * 100) 
      : 100;

    // Update results
    resultWpm.textContent = wpm;
    resultAccuracy.textContent = `${accuracy}%`;
    resultCharacters.textContent = charIndex;
    resultErrors.textContent = mistakes;
    resultCorrectWords.textContent = correctWords;
    resultWrongWords.textContent = wrongWords;
    resultCorrectChars.textContent = correctChars;
    
    // Save score to the server
    saveScore(wpm);
    
    // Format time
    const formattedTime = formatTime(testMode === 'time' ? timeLimit : time);
    resultTimeUsed.textContent = formattedTime;
    
    // Show results screen
    typingTextArea.style.display = 'none';
    resultsScreen.style.display = 'block';
  }

  // Function to format time (seconds to MM:SS)
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  }
  
  // Function to save score to the server
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        game_type: 'typing_speed',
        score: score
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Score saved:', data);
    })
    .catch(error => {
      console.error('Error saving score:', error);
    });
  }
});
</script>
{% endblock %}

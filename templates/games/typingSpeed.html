{% extends "layout.html" %}

{% block title %}Yazma Hızı Testi | ZekaPark{% endblock %}

{% block head %}
{{ super() }}
<style>
  .game-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .typing-test-wrapper {
    background: rgba(30, 30, 50, 0.7);
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    margin-bottom: 20px;
    padding: 25px;
    position: relative;
  }
  
  .typing-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .header-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    flex: 1;
  }
  
  .header-stats {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  
  .stat-item {
    background: rgba(40, 40, 70, 0.8);
    border-radius: 8px;
    padding: 10px 15px;
    min-width: 80px;
    text-align: center;
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: var(--muted-color);
    margin-bottom: 2px;
  }
  
  .stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--accent-color);
  }
  
  .test-intro {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(30, 30, 50, 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  .test-intro.active {
    opacity: 1;
    pointer-events: all;
  }
  
  .test-intro h3 {
    font-size: 1.5rem;
    margin-bottom: 15px;
    color: var(--text-color);
    text-align: center;
  }
  
  .test-intro p {
    font-size: 1rem;
    color: var(--muted-color);
    text-align: center;
    max-width: 600px;
    margin-bottom: 30px;
    padding: 0 20px;
  }
  
  .test-options {
    background: rgba(40, 40, 70, 0.8);
    border-radius: 10px;
    padding: 20px;
    width: 100%;
    max-width: 600px;
    margin-bottom: 30px;
  }
  
  .option-section {
    margin-bottom: 20px;
  }
  
  .option-section:last-child {
    margin-bottom: 0;
  }
  
  .option-section h4 {
    font-size: 1rem;
    color: var(--text-color);
    margin-bottom: 10px;
  }
  
  .option-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .option-button, .difficulty-button {
    background: rgba(50, 50, 80, 0.6);
    border: 1px solid rgba(80, 80, 120, 0.5);
    border-radius: 6px;
    color: var(--text-color);
    padding: 8px 15px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .option-button:hover, .difficulty-button:hover {
    background: rgba(60, 60, 100, 0.5);
  }

  .option-button.active, .difficulty-button.active {
    animation: pulse 2s infinite;
    background: rgba(106, 90, 224, 0.6);
    border-color: var(--accent-color);
  }

  .radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .radio-option {
    display: flex;
    align-items: center;
    position: relative;
  }

  .radio-option input[type="radio"] {
    position: absolute;
    opacity: 0;
  }

  .radio-option label {
    display: flex;
    align-items: center;
    color: var(--text-color);
    font-size: 0.9rem;
    cursor: pointer;
  }

  .radio-option label:before {
    content: '';
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid var(--muted-color);
    margin-right: 10px;
    transition: all 0.2s ease;
  }

  .radio-option input[type="radio"]:checked + label:before {
    border-color: var(--accent-color);
    background: var(--accent-color);
    box-shadow: inset 0 0 0 4px rgba(30, 30, 50, 1);
  }

  .hidden-options {
    margin-top: 15px;
    display: none;
  }

  .help-text {
    font-size: 0.8rem;
    color: var(--muted-color);
    margin-top: 5px;
  }

  .mode-header {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }

  .mode-tab {
    padding: 10px 20px;
    background: rgba(50, 50, 80, 0.6);
    color: var(--muted-color);
    border-radius: 6px;
    margin: 0 5px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .mode-tab.active {
    background: rgba(106, 90, 224, 0.6);
    color: var(--text-color);
  }

  .typing-text {
    background: rgba(40, 40, 70, 0.3);
    border-radius: 10px;
    padding: 20px;
    font-size: 1.2rem;
    line-height: 1.6;
    margin-bottom: 20px;
    min-height: 150px;
    color: var(--muted-color);
    position: relative;
  }

  .char {
    transition: color 0.2s ease;
    position: relative;
    letter-spacing: 0.5px;
    margin-right: 0.5px;
  }

  .char.active {
    position: relative;
  }

  .char.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--accent-color);
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .input-field {
    width: 100%;
    background: rgba(40, 40, 70, 0.5);
    border: 1px solid rgba(80, 80, 120, 0.5);
    border-radius: 8px;
    color: var(--text-color);
    font-size: 1.1rem;
    padding: 15px;
    outline: none;
    transition: border-color 0.2s ease;
    caret-color: var(--accent-color);
  }

  .input-field:focus {
    border-color: var(--accent-color);
  }

  .typing-results {
    background: rgba(30, 30, 50, 0.7);
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    padding: 25px;
    display: none;
  }

  .results-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-color);
    margin-bottom: 20px;
    text-align: center;
  }

  .results-summary {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
  }

  .result-main {
    background: rgba(40, 40, 70, 0.8);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    min-width: 150px;
  }

  .result-main .result-label {
    font-size: 0.9rem;
    color: var(--muted-color);
    margin-bottom: 5px;
  }

  .result-main .result-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent-color);
  }

  .result-main .result-unit {
    font-size: 0.9rem;
    color: var(--muted-color);
  }

  .results-details {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 30px;
  }

  .results-column {
    flex: 1;
    min-width: 200px;
    background: rgba(40, 40, 70, 0.5);
    border-radius: 10px;
    padding: 15px;
  }

  .results-item {
    margin-bottom: 15px;
  }

  .results-item:last-child {
    margin-bottom: 0;
  }

  .result-label {
    font-size: 0.8rem;
    color: var(--muted-color);
    margin-bottom: 3px;
  }

  .result-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--text-color);
  }

  .results-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  .btn {
    background: rgba(106, 90, 224, 0.7);
    border: none;
    border-radius: 8px;
    color: white;
    padding: 12px 24px;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn:hover {
    background: rgba(126, 110, 244, 0.8);
  }

  .btn-secondary {
    background: rgba(70, 70, 100, 0.7);
  }

  .btn-secondary:hover {
    background: rgba(90, 90, 120, 0.8);
  }

  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes slideInUp {
    from { 
      transform: translateY(20px);
      opacity: 0;
    }
    to { 
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  @keyframes highlightChar {
    0% { background-color: rgba(106, 90, 224, 0.3); }
    100% { background-color: transparent; }
  }
  
  /* Visual feedback for correct/incorrect typing */
  .char.correct {
    color: #6ab04c;
    animation: highlightChar 0.3s ease-out;
  }
  
  .char.incorrect {
    color: #ff4757;
    text-decoration: underline;
    animation: shake 0.3s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
  }
  
  .char.active {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    animation: pulse 1s infinite;
  }
  
  /* Results animations */
  .typing-results {
    animation: fadeIn 0.5s ease-out;
  }
  
  .results-summary, .results-details, .results-actions {
    animation: slideInUp 0.5s ease-out;
    animation-fill-mode: both;
  }
  
  .results-details {
    animation-delay: 0.1s;
  }
  
  .results-actions {
    animation-delay: 0.2s;
  }
  
  /* Improved button styles */
  .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .btn:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }
  
  .btn:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }
  
  @keyframes ripple {
    0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    20% {
      transform: scale(25, 25);
      opacity: 0.3;
    }
    100% {
      opacity: 0;
      transform: scale(40, 40);
    }
  }

  /* Mobil Optimizasyonlar */
  @media (max-width: 768px) {
    /* Improve touch experience */
    .option-button, .difficulty-button {
      min-height: 40px;
      min-width: 40px;
    }
    
    .input-field {
      font-size: 16px; /* Prevent auto-zoom on iOS */
    }
    .game-container {
      padding: 10px;
    }
    
    .typing-test-wrapper, .typing-results {
      padding: 15px;
    }
    
    .typing-header {
      gap: 5px;
      margin-bottom: 15px;
    }
    
    .stat-item {
      padding: 8px;
    }
    
    .stat-label {
      font-size: 0.7rem;
    }
    
    .stat-value {
      font-size: 1rem;
    }
    
    .test-intro h3 {
      font-size: 1.2rem;
    }
    
    .test-intro p {
      font-size: 0.85rem;
    }
    
    .test-options {
      padding: 12px;
    }
    
    .option-section h4 {
      font-size: 0.8rem;
    }
    
    .option-button, .difficulty-button {
      padding: 5px 10px;
      font-size: 0.8rem;
    }
    
    .radio-option label {
      font-size: 0.8rem;
    }
    
    .help-text {
      font-size: 0.7rem;
    }
    
    .typing-text {
      font-size: 1rem;
      padding: 12px;
      min-height: 100px;
    }
    
    .input-field {
      padding: 10px;
    }
    
    .results-summary {
      gap: 10px;
    }
    
    .result-main {
      padding: 12px;
      min-width: 120px;
    }
    
    .result-main .result-value {
      font-size: 2rem;
    }
    
    .results-column {
      padding: 12px;
      min-width: 120px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
  <div class="typing-test-wrapper">
    <div class="typing-header">
      <div class="header-title">Yazma Hızı Testi</div>
      <div class="header-stats">
        <div class="stat-item">
          <div class="stat-label">Zaman</div>
          <div class="stat-value" id="timer">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">KPM</div>
          <div class="stat-value" id="wpm">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Doğruluk</div>
          <div class="stat-value" id="accuracy">100%</div>
        </div>
      </div>
    </div>
    
    <div class="test-intro active" id="test-intro">
      <h3>Yazma Hızı Testi</h3>
      <p>
        Klavye yazma hızınızı ve doğruluğunuzu test edin. 
        Test modu, zorluk ve diğer seçenekleri ayarlayabilirsiniz.
      </p>
      
      <div class="test-options">
        <div class="mode-header">
          <div class="mode-tab active" id="mode-words">Kelime Modu</div>
          <div class="mode-tab" id="mode-time">Zaman Modu</div>
        </div>
        
        <div class="option-section">
          <h4>Test Türü</h4>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="words-mode" name="test-mode" checked>
              <label for="words-mode">Kelime Sayısı</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="time-mode" name="test-mode">
              <label for="time-mode">Süre Sınırı</label>
            </div>
          </div>
        </div>
        
        <div class="option-section" id="words-option">
          <h4>Kelime Sayısı</h4>
          <div class="option-buttons">
            <button class="option-button" data-words="10">10</button>
            <button class="option-button active" data-words="25">25</button>
            <button class="option-button" data-words="50">50</button>
            <button class="option-button" data-words="100">100</button>
          </div>
        </div>
        
        <div class="option-section" id="time-option" style="display: none;">
          <h4>Süre (Saniye)</h4>
          <div class="option-buttons">
            <button class="option-button time-button" data-time="30">30</button>
            <button class="option-button time-button active" data-time="60">60</button>
            <button class="option-button time-button" data-time="120">120</button>
            <button class="option-button time-button" data-time="300">300</button>
          </div>
        </div>
        
        <div class="option-section">
          <h4>Zorluk</h4>
          <div class="option-buttons">
            <button class="difficulty-button active" data-difficulty="easy">Kolay</button>
            <button class="difficulty-button" data-difficulty="medium">Orta</button>
            <button class="difficulty-button" data-difficulty="hard">Zor</button>
          </div>
          <p class="help-text">
            Kolay: Basit ve kısa kelimeler
            <br>Orta: Orta uzunlukta kelimeler
            <br>Zor: Uzun ve karmaşık kelimeler
          </p>
        </div>
      </div>
      
      <button class="btn" id="start-test">Testi Başlat</button>
    </div>
    
    <div id="typing-text-area" style="display: none;">
      <div class="typing-text" id="typing-text"></div>
      <input type="text" class="input-field" id="input-field" placeholder="Yazmaya başlayın..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
  </div>
  
  <div class="typing-results" id="results-screen">
    <div class="results-title">Test Sonuçları</div>
    
    <div class="results-summary">
      <div class="result-main">
        <div class="result-label">Yazma Hızı</div>
        <div class="result-value" id="result-wpm">0</div>
        <div class="result-unit">KPM</div>
      </div>
      <div class="result-main">
        <div class="result-label">Doğruluk</div>
        <div class="result-value" id="result-accuracy">0%</div>
      </div>
    </div>
    
    <div class="results-details">
      <div class="results-column">
        <div class="results-item">
          <div class="result-label">Karakterler</div>
          <div class="result-value" id="result-characters">0</div>
        </div>
        <div class="results-item">
          <div class="result-label">Hatalar</div>
          <div class="result-value" id="result-errors">0</div>
        </div>
      </div>
      <div class="results-column">
        <div class="results-item">
          <div class="result-label">Doğru Kelimeler</div>
          <div class="result-value" id="result-correct-words">0</div>
        </div>
        <div class="results-item">
          <div class="result-label">Yanlış Kelimeler</div>
          <div class="result-value" id="result-wrong-words">0</div>
        </div>
      </div>
      <div class="results-column">
        <div class="results-item">
          <div class="result-label">Doğru Karakterler</div>
          <div class="result-value" id="result-correct-chars">0</div>
        </div>
      </div>
    </div>
    
    <div class="results-actions">
      <button class="btn" id="restart-test">Yeniden Başlat</button>
      <button class="btn btn-secondary" id="retry-test">Ayarları Değiştir</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const testIntro = document.getElementById('test-intro');
  const typingTextArea = document.getElementById('typing-text-area');
  const resultsScreen = document.getElementById('results-screen');
  
  const wordsMode = document.getElementById('words-mode');
  const timeMode = document.getElementById('time-mode');
  const wordsOption = document.getElementById('words-option');
  const timeOption = document.getElementById('time-option');
  
  const typingText = document.getElementById('typing-text');
  const inputField = document.getElementById('input-field');
  const timerElement = document.getElementById('timer');
  const wpmElement = document.getElementById('wpm');
  const accuracyElement = document.getElementById('accuracy');
  
  const startTestBtn = document.getElementById('start-test');
  const restartTestBtn = document.getElementById('restart-test');
  const retryTestBtn = document.getElementById('retry-test');
  
  const resultWpm = document.getElementById('result-wpm');
  const resultAccuracy = document.getElementById('result-accuracy');
  const resultCharacters = document.getElementById('result-characters');
  const resultErrors = document.getElementById('result-errors');
  const resultCorrectWords = document.getElementById('result-correct-words');
  const resultWrongWords = document.getElementById('result-wrong-words');
  const resultCorrectChars = document.getElementById('result-correct-chars');
  
  // Options
  const wordButtons = document.querySelectorAll('[data-words]');
  const timeButtons = document.querySelectorAll('[data-time]');
  const difficultyButtons = document.querySelectorAll('[data-difficulty]');
  
  // Variables
  let testMode = 'words'; // words or time
  let wordCount = 25;
  let timeLimit = 60;
  let difficulty = 'easy';
  
  let currentText = '';
  let currentWordIndex = 0;
  let charIndex = 0;
  let mistakes = 0;
  let correctChars = 0;
  let correctWords = 0;
  let wrongWords = 0;
  let isTyping = false;
  let time = 0;
  let timer;
  
  // Text Samples by Difficulty
  const textSamples = {
    easy: [
      "Bu yazma testi ile klavye hızınızı ölçebilirsiniz. Her kelimeyi doğru yazmaya çalışın.",
      "Yazma hızı, klavye kullanım becerisinin önemli bir göstergesidir. Düzenli pratik yaparak geliştirebilirsiniz.",
      "Hızlı yazabilmek için doğru parmak pozisyonu çok önemlidir. Parmaklarınızı F ve J tuşlarındaki çıkıntılar üzerine yerleştirin.",
      "İyi bir yazma hızı, bilgisayar kullanımında size büyük avantaj sağlar. Özellikle ofis işlerinde verimli çalışmayı sağlar.",
    ],
    medium: [
      "Yazma hızınızı geliştirmek için düzenli olarak pratik yapmanız gerekmektedir. Günde on beş dakikalık alıştırmalar bile faydalı olabilir.",
      "Klavye kısayollarını öğrenmek, bilgisayar kullanımında size zaman kazandıracaktır. En sık kullanılan kısayolları ezberleyin.",
      "Dokunmatik yazı yazmayı öğrenmek, ekrana bakmadan yazabilme becerisi kazandırır. Bu şekilde yazı yazarken hızınız önemli ölçüde artacaktır.",
      "Farklı dillerde yazı yazma pratiği yapmak, yazma hızınızı geliştirmenin yanı sıra dil becerilerinizi de geliştirecektir.",
    ],
    hard: [
      "Profesyonel yazı yazanlar, genellikle dakikada yüz kelimeden fazla yazabilirler. Bu seviyeye ulaşmak için sistematik ve düzenli çalışma gereklidir.",
      "Ergonomik klavyeler, uzun süreli yazı yazarken bilek ve parmak yorgunluğunu azaltarak konfor sağlar ve potansiyel sağlık sorunlarını önlemeye yardımcı olur.",
      "Sürükle-bırak yerine kısayol tuşlarını kullanmak, çoklu görev yaparken verimlilik açısından büyük önem taşır ve iş akışınızı hızlandırır.",
      "İnsan-bilgisayar etkileşiminde, veri girişi hızı ve doğruluğu, kullanıcı deneyimini etkileyen önemli faktörlerdendir ve yazılım tasarımında dikkate alınması gereken unsurlardır.",
    ]
  };
  
  // Mode Selection
  wordsMode.addEventListener('change', function() {
    if (this.checked) {
      testMode = 'words';
      wordsOption.style.display = 'block';
      timeOption.style.display = 'none';
      
      document.getElementById('mode-words').classList.add('active');
      document.getElementById('mode-time').classList.remove('active');
    }
  });

  timeMode.addEventListener('change', function() {
    if (this.checked) {
      testMode = 'time';
      wordsOption.style.display = 'none';
      timeOption.style.display = 'block';
      
      document.getElementById('mode-words').classList.remove('active');
      document.getElementById('mode-time').classList.add('active');
    }
  });

  document.getElementById('mode-words').addEventListener('click', function() {
    wordsMode.checked = true;
    wordsMode.dispatchEvent(new Event('change'));
    playSound("click");
  });

  document.getElementById('mode-time').addEventListener('click', function() {
    timeMode.checked = true;
    timeMode.dispatchEvent(new Event('change'));
    playSound("click");
  });

  wordButtons.forEach(button => {
    button.addEventListener('click', function() {
      wordButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      wordCount = parseInt(this.getAttribute('data-words'));
      playSound("click");
    });
  });

  timeButtons.forEach(button => {
    button.addEventListener('click', function() {
      timeButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      timeLimit = parseInt(this.getAttribute('data-time'));
    });
  });

  difficultyButtons.forEach(button => {
    button.addEventListener('click', function() {
      difficultyButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      difficulty = this.getAttribute('data-difficulty');
    });
  });
  
  // Sound functions
  function playSound(soundType) {
    try {
      let sound;
      switch(soundType) {
        case 'start':
          sound = new Audio('/static/sounds/success.mp3');
          break;
        case 'key':
          sound = new Audio('/static/sounds/click.mp3');
          sound.volume = 0.1;
          break;
        case 'error':
          sound = new Audio('/static/sounds/wrong.mp3');
          sound.volume = 0.2;
          break;
        case 'complete':
          sound = new Audio('/static/sounds/game-complete.mp3');
          break;
        default:
          return;
      }
      sound.play().catch(e => console.log('Sound playback prevented', e));
    } catch (e) {
      console.log('Sound error:', e);
    }
  }

  // Start test
  startTestBtn.addEventListener('click', function() {
    playSound('start');
    initTest();
  });

  // Restart test
  restartTestBtn.addEventListener('click', function() {
    playSound('start');
    initTest();
  });

  // Retry test
  retryTestBtn.addEventListener('click', function() {
    playSound('start');
    testIntro.classList.add('active');
    resultsScreen.style.display = 'none';
  });
  
  // Initialize test
  function initTest() {
    // Reset variables
    charIndex = 0;
    mistakes = 0;
    correctChars = 0;
    correctWords = 0;
    wrongWords = 0;
    isTyping = false;
    time = 0;
    currentWordIndex = 0;
    
    // Clear any existing timer
    clearInterval(timer);
    
    // Reset statistics
    timerElement.textContent = '0';
    wpmElement.textContent = '0';
    accuracyElement.textContent = '100%';
    
    // Reset input field
    inputField.value = '';
    
    // Hide results screen
    resultsScreen.style.display = 'none';
    
    // Select random text based on difficulty
    let randomIndex = Math.floor(Math.random() * textSamples[difficulty].length);
    let testText = textSamples[difficulty][randomIndex];
    
    // Prepare text based on test mode
    if (testMode === 'words') {
      // Extract exact number of words
      const words = testText.split(' ');
      if (words.length < wordCount) {
        // Repeat text to get enough words
        let repeatedText = '';
        while (repeatedText.split(' ').length < wordCount) {
          repeatedText += testText + ' ';
        }
        
        // Trim to exact word count
        const words = repeatedText.split(' ');
        repeatedText = words.slice(0, wordCount).join(' ');
        
        // Update current text and display
        currentText = repeatedText;
        typingText.innerHTML = '';
        
        // Create spans for each character with proper spacing
        currentText.split('').forEach(char => {
          const charSpan = document.createElement('span');
          charSpan.textContent = char;
          charSpan.className = 'char';
          if (char === ' ') {
            charSpan.style.marginRight = '4px'; // Add extra space for spaces
          }
          typingText.appendChild(charSpan);
        });
        
        // Set first character as active
        const firstChar = typingText.querySelector('.char');
        if (firstChar) {
          firstChar.classList.add('active');
        }
      }
      
      // Set counter to word count
      timerElement.textContent = 0;
    }
    
    // Show typing area
    testIntro.classList.remove('active');
    typingTextArea.style.display = 'block';
    
    // Focus input field
    setTimeout(() => {
      inputField.focus();
    }, 200);
  }

  // Reset test state
  function resetTest() {
    clearInterval(timer);
    initTest();
  }
  
  // Timer update functions
  function updateWordTimer() {
    time++;
    timerElement.textContent = time;
    
    // Update WPM in real-time
    const timeInMinutes = time / 60;
    if (timeInMinutes > 0) {
      const wpm = Math.round(((charIndex - mistakes) / 5) / timeInMinutes);
      wpmElement.textContent = wpm;
      
      // Update accuracy
      if (charIndex > 0) {
        const accuracy = Math.round(((charIndex - mistakes) / charIndex) * 100);
        accuracyElement.textContent = `${accuracy}%`;
      }
    }
  }
  
  function updateTimeTimer() {
    time--;
    timerElement.textContent = time;
    
    // Update WPM in real-time
    const timeElapsed = (timeLimit - time) / 60;
    if (timeElapsed > 0) {
      const wpm = Math.round(((charIndex - mistakes) / 5) / timeElapsed);
      wpmElement.textContent = wpm;
      
      // Update accuracy
      if (charIndex > 0) {
        const accuracy = Math.round(((charIndex - mistakes) / charIndex) * 100);
        accuracyElement.textContent = `${accuracy}%`;
      }
    }
    
    // End test when time runs out
    if (time <= 0) {
      clearInterval(timer);
      endTest();
    }
  }
  
  // Helper Functions
  function getCurrentWord(index) {
    return currentText.split(' ')[index];
  }
  
  // Process typing input
  inputField.addEventListener('input', function(e) {
    // Start timer on first input
    if (!isTyping) {
      isTyping = true;
      
      // Start timer
      if (testMode === 'time') {
        time = timeLimit;
        timer = setInterval(updateTimeTimer, 1000);
      } else {
        timer = setInterval(updateWordTimer, 1000);
      }
    }
    
    // Only play sound for actual typing, not for deletions
    if(e.inputType !== "deleteContentBackward") {
      playSound("key");
    }
    
    const typedChar = e.target.value.charAt(e.target.value.length - 1);
    const characters = typingText.querySelectorAll('.char');
    
    // Check if we've reached the end of the text
    if (charIndex >= characters.length) {
      if (testMode === 'words') {
        // In word mode, end the test when all text is typed
        clearInterval(timer);
        endTest();
      }
      return;
    }
    
    // Check the typed character
    if (typedChar === characters[charIndex].textContent) {
      characters[charIndex].classList.add('correct');
      correctChars++;
    } else {
      if(e.inputType !== "deleteContentBackward") {
        playSound("error");
      }
      characters[charIndex].classList.add('incorrect');
      mistakes++;
    }
    
    // Move active cursor to next character
    charIndex++;
    
    // Set active character
    if (charIndex < characters.length) {
      characters.forEach(char => char.classList.remove('active'));
      characters[charIndex].classList.add('active');
    }
    
    // Check for completed words
    if (typedChar === ' ' || charIndex >= characters.length) {
      const typedWord = e.target.value.trim();
      const currentWord = getCurrentWord(currentWordIndex);
      
      if (typedWord === currentWord) {
        correctWords++;
      } else {
        wrongWords++;
      }
      
      // Move to next word
      currentWordIndex++;
      
      // Clear input field for next word
      e.target.value = '';
    }
  });

  function endTest() {
    // Play completion sound
    playSound('complete');
  
    // Calculate final stats
    const timeElapsed = time / 60; // convert to minutes
    const wpm = Math.round(((charIndex - mistakes) / 5) / timeElapsed);
    const accuracy = charIndex > 0 
      ? Math.round(((charIndex - mistakes) / charIndex) * 100) 
      : 100;

    // Update results
    resultWpm.textContent = '0';
    resultAccuracy.textContent = '0%';
    resultCharacters.textContent = charIndex;
    resultErrors.textContent = mistakes;
    resultCorrectWords.textContent = correctWords;
    resultWrongWords.textContent = wrongWords;
    resultCorrectChars.textContent = correctChars;
    
    // Animate the results
    let wpmCounter = 0;
    let accuracyCounter = 0;
    
    const wpmInterval = setInterval(() => {
      wpmCounter += Math.ceil(wpm / 30);
      if (wpmCounter >= wpm) {
        wpmCounter = wpm;
        clearInterval(wpmInterval);
      }
      resultWpm.textContent = wpmCounter;
    }, 30);
    
    const accuracyInterval = setInterval(() => {
      accuracyCounter += Math.ceil(accuracy / 30);
      if (accuracyCounter >= accuracy) {
        accuracyCounter = accuracy;
        clearInterval(accuracyInterval);
      }
      resultAccuracy.textContent = `${accuracyCounter}%`;
    }, 30);
    
    // Save score to the server
    fetch('/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        gameType: 'typingSpeed',
        score: wpm
      })
    })
    .catch(error => console.error('Error saving score:', error));
    
    // Hide typing area and show results
    typingTextArea.style.display = 'none';
    resultsScreen.style.display = 'block';
  }
});
</script>
{% endblock %}

{% extends 'layout.html' %}

{% block title %}Yazma Hızı Testi - ZekaPark{% endblock %}

{% block content %}
<div class="modernized-game-container">
  <div class="modernized-game-section">
    <div class="modernized-game-header">
      <h1>Yazma Hızı Testi</h1>
    </div>

    <div class="typing-container">
      <div id="test-intro" class="typing-intro active">
        <div class="intro-container">
          <h3>Yazma Hızınızı Test Edin</h3>
          <p>Metni olabildiğince hızlı ve doğru yazarak yazma becerinizi ölçün.</p>

          <div class="test-settings">
            <div class="setting-group">
              <span class="setting-label">Süre: </span>
              <div class="setting-options">
                <button class="setting-option" data-time="30">30 sn</button>
                <button class="setting-option active" data-time="60">1 dk</button>
                <button class="setting-option" data-time="120">2 dk</button>
              </div>
            </div>
          </div>

          <button id="start-test" class="modernized-btn modernized-btn-primary">
            <i class="fas fa-keyboard me-2"></i>Teste Başla
          </button>
        </div>
      </div>

      <div id="typing-area" class="typing-area" style="display: none;">
        <div class="typing-stats horizontal-stats">
          <div class="stat-item">
            <div class="stat-label">Süre</div>
            <div class="stat-value" id="timer">60</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Kelime/DK</div>
            <div class="stat-value" id="wpm">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Doğruluk</div>
            <div class="stat-value" id="accuracy">100%</div>
          </div>
        </div>

        <div class="typing-text" id="typing-text"></div>
        <input type="text" id="input-field" class="input-field" placeholder="Yazmaya başlamak için tıklayın..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

        <div class="typing-controls">
          <button id="restart-test" class="modernized-btn modernized-btn-secondary">
            <i class="fas fa-redo-alt me-2"></i>Yeniden Başlat
          </button>
          <a href="{{ url_for('all_games') }}" class="modernized-btn modernized-btn-secondary">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>

      <div id="results-screen" class="typing-results" style="display: none;">
        <h2><i class="fas fa-chart-line me-2"></i>Test Sonuçları</h2>

        <div class="results-summary">
          <div class="results-item">
            <div class="result-value" id="result-wpm">0</div>
            <div class="result-label">Kelime/Dakika (WPM)</div>
          </div>
          <div class="results-item">
            <div class="result-value" id="result-accuracy">100%</div>
            <div class="result-label">Doğruluk</div>
          </div>
        </div>

        <div class="results-details">
          <div class="results-row">
            <div class="results-label">Karakterler:</div>
            <div class="results-value" id="result-characters">0</div>
          </div>
          <div class="results-row">
            <div class="results-label">Hatalar:</div>
            <div class="results-value" id="result-errors">0</div>
          </div>
          <div class="results-row">
            <div class="results-label">Doğru Kelimeler:</div>
            <div class="results-value" id="result-correct-words">0</div>
          </div>
          <div class="results-row">
            <div class="results-label">Kullanılan Süre:</div>
            <div class="results-value" id="result-time-used">0</div>
          </div>
        </div>

        <div class="results-actions">
          <button id="retry-test" class="modernized-btn modernized-btn-primary">
            <i class="fas fa-redo-alt me-2"></i>Tekrar Dene
          </button>
          <a href="{{ url_for('all_games') }}" class="modernized-btn modernized-btn-secondary">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .modernized-game-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 15px;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 70vh;
  }

  .modernized-game-section {
    background: rgba(25, 25, 45, 0.7);
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    width: 100%;
    max-width: 700px;
  }

  .typing-intro {
    display: none;
    text-align: center;
  }

  .typing-intro.active {
    display: block;
  }

  .intro-container {
    padding: 20px;
  }

  .typing-intro h3 {
    color: var(--accent-color);
    margin-bottom: 10px;
    font-size: 1.5rem;
  }

  .typing-intro p {
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 20px;
  }

  .test-settings {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .setting-group {
    margin-bottom: 10px;
  }

  .setting-label {
    display: block;
    margin-bottom: 5px;
    color: #fff;
    font-size: 0.9rem;
  }

  .setting-options {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .setting-option {
    background: rgba(40, 40, 80, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    padding: 8px 15px;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .setting-option.active {
    background: rgba(106, 90, 224, 0.6);
    border-color: var(--accent-color);
  }

  .typing-area {
    margin-bottom: 20px;
  }

  .typing-stats {
    display: flex;
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 15px;
  }
  
  .horizontal-stats {
    flex-direction: row;
    align-items: center;
    justify-content: space-around;
    padding: 8px 10px;
    height: 50px;
    max-width: 100%;
  }

  .horizontal-stats .stat-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    padding: 0 10px;
    text-align: left;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .horizontal-stats .stat-item:last-child {
    border-right: none;
  }

  .horizontal-stats .stat-label {
    font-size: 0.8rem;
    margin-bottom: 0;
    white-space: nowrap;
  }

  .horizontal-stats .stat-value {
    font-size: 1.1rem;
    white-space: nowrap;
  }
  
  .stat-item {
    flex: 1;
    padding: 10px 15px;
    text-align: center;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .stat-item:last-child {
    border-right: none;
  }

  .stat-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 3px;
  }

  .stat-value {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--accent-color);
  }

  .typing-text {
    background: rgba(30, 30, 60, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    font-size: 1.1rem;
    line-height: 1.6;
    min-height: 120px;
    margin-bottom: 15px;
    color: rgba(255, 255, 255, 0.7);
    user-select: none;
    overflow-wrap: break-word;
  }

  .input-field {
    width: 100%;
    padding: 12px;
    background: rgba(40, 40, 80, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 1rem;
    transition: border-color 0.3s ease;
    margin-bottom: 15px;
  }

  .input-field:focus {
    outline: none;
    border-color: var(--accent-color);
  }

  .typing-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .char {
    display: inline-block;
    position: relative;
  }

  .char.correct {
    color: #4CAF50;
  }

  .char.incorrect {
    color: #F44336;
    text-decoration: underline;
  }

  .char.active {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
  }

  .typing-results {
    text-align: center;
  }

  .typing-results h2 {
    color: var(--accent-color);
    margin-bottom: 20px;
    font-size: 1.5rem;
  }

  .results-summary {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .results-item {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    min-width: 120px;
    flex-grow: 1;
  }

  .result-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 5px;
    color: var(--accent-color);
  }

  .result-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .results-details {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .results-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .results-row:last-child {
    border-bottom: none;
  }

  .results-label {
    color: rgba(255, 255, 255, 0.8);
  }

  .results-value {
    font-weight: 600;
    color: #fff;
  }

  .results-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
  }

  .modernized-btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .modernized-btn-primary {
    background: linear-gradient(135deg, #6a5ae0, #9277FF);
    color: white;
  }

  .modernized-btn-secondary {
    background: rgba(40, 40, 80, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    text-decoration: none;
  }

  @media (max-width: 768px) {
    .typing-text {
      font-size: 1rem;
      min-height: 100px;
    }

    .modernized-game-section {
      padding: 15px;
    }

    .results-summary {
      flex-direction: column;
      gap: 10px;
    }

    .results-actions {
      flex-direction: column;
    }

    .modernized-btn {
      width: 100%;
    }

    .typing-controls {
      flex-direction: column;
    }
    
    .horizontal-stats {
      height: auto;
      padding: 5px;
    }
    
    .horizontal-stats .stat-item {
      padding: 5px 8px;
    }
    
    .horizontal-stats .stat-label {
      font-size: 0.7rem;
    }
    
    .horizontal-stats .stat-value {
      font-size: 1rem;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elementleri
  const testIntro = document.getElementById('test-intro');
  const typingArea = document.getElementById('typing-area');
  const resultsScreen = document.getElementById('results-screen');

  const timeOptions = document.querySelectorAll('.setting-option[data-time]');
  const startTestBtn = document.getElementById('start-test');
  const restartTestBtn = document.getElementById('restart-test');
  const retryTestBtn = document.getElementById('retry-test');

  const typingText = document.getElementById('typing-text');
  const inputField = document.getElementById('input-field');

  const timerElement = document.getElementById('timer');
  const wpmElement = document.getElementById('wpm');
  const accuracyElement = document.getElementById('accuracy');

  const resultWpm = document.getElementById('result-wpm');
  const resultAccuracy = document.getElementById('result-accuracy');
  const resultCharacters = document.getElementById('result-characters');
  const resultErrors = document.getElementById('result-errors');
  const resultCorrectWords = document.getElementById('result-correct-words');
  const resultTimeUsed = document.getElementById('result-time-used');

  // Örnek metinler
  const texts = [
    "Güneşli bir günde parkta yürüyüş yapmak insana huzur verir. Doğanın sesleri ve temiz hava zihnimizi temizler.",
    "Kitap okumak en sevdiğim aktivitelerden biridir. Her kitap beni farklı dünyalara götürür ve yeni bilgiler edinmemi sağlar.",
    "Teknolojinin hızla gelişmesi günlük yaşantımızı büyük ölçüde değiştiriyor. Akıllı telefonlar ve bilgisayarlar artık hayatımızın vazgeçilmez bir parçası haline geldi."
  ];

  // Test Ayarları
  let timeLimit = 60; // saniye

  // Test Durumu
  let time = 0;
  let timer;
  let isTyping = false;
  let charIndex = 0;
  let mistakes = 0;
  let correctWords = 0;
  let currentWordIndex = 0;

  // Süre seçimi
  timeOptions.forEach(option => {
    option.addEventListener('click', function() {
      timeOptions.forEach(opt => opt.classList.remove('active'));
      this.classList.add('active');
      timeLimit = parseInt(this.getAttribute('data-time'));
    });
  });

  // Testi başlat
  startTestBtn.addEventListener('click', function() {
    initTest();
  });

  // Testi yeniden başlat
  restartTestBtn.addEventListener('click', function() {
    initTest();
  });

  // Testi tekrar dene
  retryTestBtn.addEventListener('click', function() {
    resultsScreen.style.display = 'none';
    testIntro.classList.add('active');
  });

  // Testi başlat
  function initTest() {
    // Durumu sıfırla
    resetTest();

    // Rastgele metin seç
    const randomIndex = Math.floor(Math.random() * texts.length);
    const currentText = texts[randomIndex];

    // Metni görüntülemek için hazırla
    typingText.innerHTML = '';
    currentText.split('').forEach(char => {
      const charSpan = document.createElement('span');
      charSpan.textContent = char;
      charSpan.className = 'char';
      typingText.appendChild(charSpan);
    });

    // Zaman görüntüsünü ayarla
    timerElement.textContent = timeLimit;

    // Yazma alanını göster
    testIntro.classList.remove('active');
    typingArea.style.display = 'block';
    resultsScreen.style.display = 'none';

    // Giriş alanına odaklan
    setTimeout(() => {
      inputField.focus();
    }, 200);
  }

  // Test durumunu sıfırla
  function resetTest() {
    isTyping = false;
    charIndex = 0;
    mistakes = 0;
    correctWords = 0;
    time = timeLimit;
    currentWordIndex = 0;

    // Giriş alanını temizle
    inputField.value = '';

    // Görüntüleme elemanlarını sıfırla
    wpmElement.textContent = '0';
    accuracyElement.textContent = '100%';

    // Varolan zamanlayıcıyı temizle
    clearInterval(timer);
  }

  // Yazma işlemini işle
  inputField.addEventListener('input', function(e) {
    // İlk girişte zamanlayıcıyı başlat
    if (!isTyping) {
      isTyping = true;
      timer = setInterval(updateTimer, 1000);
    }

    const typedChar = e.target.value.charAt(e.target.value.length - 1);
    const characters = typingText.querySelectorAll('.char');

    // Metnin sonuna ulaşıldı mı kontrol et
    if (charIndex >= characters.length) {
      clearInterval(timer);
      endTest();
      return;
    }

    // Yazılan karakteri kontrol et
    if (typedChar === characters[charIndex].textContent) {
      characters[charIndex].classList.add('correct');
    } else {
      characters[charIndex].classList.add('incorrect');
      mistakes++;
    }

    // Aktif karakteri sonraki karaktere taşı
    charIndex++;

    // Sonraki karakteri aktif olarak işaretle
    if (charIndex < characters.length) {
      characters.forEach(char => char.classList.remove('active'));
      characters[charIndex].classList.add('active');
    }

    // Tamamlanan kelimeleri kontrol et
    if (typedChar === ' ' || charIndex >= characters.length) {
      correctWords++;
    }

    // İstatistikleri güncelle
    updateStats();
  });

  // İstatistikleri güncelle
  function updateStats() {
    // WPM hesapla
    const elapsedTime = (timeLimit - time) / 60;
    if (elapsedTime > 0) {
      const wpm = Math.round(((charIndex - mistakes) / 5) / elapsedTime);
      wpmElement.textContent = wpm;
    }

    // Doğruluk hesapla
    const accuracy = charIndex > 0 
      ? Math.round(((charIndex - mistakes) / charIndex) * 100) 
      : 100;

    accuracyElement.textContent = `${accuracy}%`;
  }

  // Zamanlayıcıyı güncelle
  function updateTimer() {
    if (time > 0) {
      time--;
      timerElement.textContent = time;

      // Son 10 saniye için stilleri güncelle
      if (time <= 10) {
        timerElement.style.color = '#ff4757';
      }

      // WPM'i gerçek zamanlı güncelle
      updateStats();
    } else {
      clearInterval(timer);
      endTest();
    }
  }

  // Testi bitir
  function endTest() {
    // Son istatistikleri hesapla
    const timeElapsed = (timeLimit - time) / 60; // dakikaya çevir
    const wpm = Math.round(((charIndex - mistakes) / 5) / timeElapsed);
    const accuracy = charIndex > 0 
      ? Math.round(((charIndex - mistakes) / charIndex) * 100) 
      : 100;

    // Sonuçları güncelle
    resultWpm.textContent = wpm;
    resultAccuracy.textContent = `${accuracy}%`;
    resultCharacters.textContent = charIndex;
    resultErrors.textContent = mistakes;
    resultCorrectWords.textContent = correctWords;

    // Zamanı biçimlendir
    const formattedTime = formatTime(timeLimit - time);
    resultTimeUsed.textContent = formattedTime;

    // Skoru kaydet
    saveScore(wpm);

    // Sonuç ekranını göster
    typingArea.style.display = 'none';
    resultsScreen.style.display = 'block';
  }

  // Zamanı biçimlendir (saniye -> MM:SS)
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  // Skoru kaydet
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        game_type: 'typing_speed',
        score: score
      })
    })
    .then(response => response.json())
    .then(data => console.log('Score saved:', data))
    .catch(error => console.error('Error saving score:', error));
  }

  // Metin alanına tıklandığında giriş alanına odaklan
  typingText.addEventListener('click', function() {
    inputField.focus();
  });
});
</script>
{% endblock %}
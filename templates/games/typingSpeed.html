{% extends 'layout.html' %}

{% block title %}Yazma Hızı Testi - ZekaPark{% endblock %}

{% block content %}
<div class="typing-game-container">
  <div class="typing-game-header">
    <h1>Yazma Hızı Testi</h1>
  </div>

  <!-- Oyun Bölümleri -->
  <div class="typing-wrapper">
    <!-- Giriş Ekranı -->
    <div id="intro-screen" class="typing-section active">
      <div class="intro-content">
        <h2>Yazma Becerinizi Test Edin</h2>
        <p>Metni olabildiğince hızlı ve doğru yazarak becerilerinizi geliştirin.</p>

        <div class="test-settings">
          <div class="setting-group">
            <h3>Süre Seçin:</h3>
            <div class="time-options">
              <button class="time-option" data-time="30">30 saniye</button>
              <button class="time-option active" data-time="60">1 dakika</button>
              <button class="time-option" data-time="120">2 dakika</button>
            </div>
          </div>

          <div class="setting-group">
            <h3>Zorluk Seçin:</h3>
            <div class="difficulty-options">
              <button class="difficulty-option" data-difficulty="easy">Kolay</button>
              <button class="difficulty-option active" data-difficulty="medium">Orta</button>
              <button class="difficulty-option" data-difficulty="hard">Zor</button>
            </div>
          </div>
        </div>

        <button id="start-btn" class="typing-btn primary-btn">
          <i class="fas fa-keyboard"></i> Teste Başla
        </button>
      </div>
    </div>

    <!-- Oyun Ekranı -->
    <div id="game-screen" class="typing-section">
      <div class="game-stats">
        <div class="stats-squares compact">
          <div class="stats-square">
            <div class="stat-label">Süre</div>
            <div class="stat-value" id="timer">60</div>
          </div>
          <div class="stats-square">
            <div class="stat-label">Yanlış Harf</div>
            <div class="stat-value" id="error-count">0</div>
          </div>
          <div class="stats-square">
            <div class="stat-label">Doğruluk</div>
            <div class="stat-value" id="accuracy">100%</div>
          </div>
        </div>
      </div>

      <div id="text-display" class="text-display"></div>

      <div class="input-container">
        <input type="text" id="typing-input" class="typing-input" placeholder="Yazmaya başlamak için tıklayın..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      </div>

      <div class="game-controls">
        <button id="restart-btn" class="typing-btn secondary-btn">
          <i class="fas fa-redo-alt"></i> Yeniden Başlat
        </button>
        <a href="{{ url_for('all_games') }}" class="typing-btn secondary-btn">
          <i class="fas fa-th-large"></i> Tüm Oyunlar
        </a>
      </div>
    </div>

    <!-- Sonuç Ekranı -->
    <div id="result-screen" class="typing-section">
      <div class="result-content">
        <h2><i class="fas fa-trophy"></i> Sonuçlarınız</h2>

        <div class="result-summary">
          <div class="result-item primary">
            <div class="result-value" id="result-wpm">0</div>
            <div class="result-label">Kelime/Dakika</div>
          </div>
          <div class="result-item primary">
            <div class="result-value" id="result-accuracy">100%</div>
            <div class="result-label">Doğruluk</div>
          </div>
        </div>

        <div class="result-details">
          <div class="detail-row">
            <div class="detail-label">Toplam Karakter:</div>
            <div class="detail-value" id="result-chars">0</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Doğru Karakter:</div>
            <div class="detail-value" id="result-correct">0</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Hatalı Karakter:</div>
            <div class="detail-value" id="result-errors">0</div>
          </div>
          <div class="detail-row">
            <div class="detail-label">Kullanılan Süre:</div>
            <div class="detail-value" id="result-time">0</div>
          </div>
        </div>

        <div class="result-actions">
          <button id="try-again-btn" class="typing-btn primary-btn">
            <i class="fas fa-redo-alt"></i> Tekrar Dene
          </button>
          <a href="{{ url_for('all_games') }}" class="typing-btn secondary-btn">
            <i class="fas fa-th-large"></i> Tüm Oyunlar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Ana Stiller */
.typing-game-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}

.typing-game-header {
  text-align: center;
  margin-bottom: 20px;
}

.typing-game-header h1 {
  color: var(--accent-color);
  font-size: 2.2rem;
  margin-bottom: 10px;
}

.typing-wrapper {
  background: rgba(25, 25, 45, 0.7);
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(5px);
  width: 100%;
}

/* Bölüm Stili */
.typing-section {
  display: none;
}

.typing-section.active {
  display: block;
}

/* Giriş Ekranı */
.intro-content {
  text-align: center;
  padding: 20px 0;
}

.intro-content h2 {
  color: var(--accent-color);
  font-size: 1.8rem;
  margin-bottom: 15px;
}

.intro-content p {
  color: rgba(255, 255, 255, 0.8);
  font-size: 1.1rem;
  margin-bottom: 25px;
}

.test-settings {
  background: rgba(30, 30, 60, 0.5);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 25px;
}

.setting-group {
  margin-bottom: 15px;
}

.setting-group h3 {
  color: #fff;
  font-size: 1.1rem;
  margin-bottom: 10px;
}

.time-options, .difficulty-options {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
}

.time-option, .difficulty-option {
  background: rgba(40, 40, 80, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: #fff;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

.time-option:hover, .difficulty-option:hover {
  background: rgba(60, 60, 100, 0.5);
  transform: translateY(-2px);
}

.time-option.active, .difficulty-option.active {
  background: rgba(106, 90, 224, 0.5);
  border-color: var(--accent-color);
  color: #fff;
  font-weight: 500;
}

/* Oyun Ekranı */
.game-stats {
  display: flex;
  background: rgba(30, 30, 60, 0.5);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 20px;
}

.stats-squares {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .stats-squares.compact {
    flex-direction: row;
    justify-content: flex-start;
    gap: 10px;
    margin-bottom: 15px;
    width: 100%;
    overflow-x: auto;
    padding: 5px 0;
  }

  .stats-square {
    background: rgba(30, 30, 60, 0.7);
    border-radius: 10px;
    padding: 12px 15px;
    width: 110px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
  }
  
  .stats-squares.compact .stats-square {
    padding: 8px;
    width: 80px;
    height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex-shrink: 0;
  }

  .stats-square:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    border-color: rgba(106, 90, 224, 0.3);
  }

  .stats-square .stat-label {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
  }

  .stats-square .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-color);
  }


.text-display {
  background: rgba(30, 30, 60, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  padding: 20px;
  font-size: 1.2rem;
  line-height: 1.6;
  min-height: 150px;
  margin-bottom: 20px;
  color: rgba(255, 255, 255, 0.8);
  user-select: none;
  overflow-wrap: break-word;
}

.char {
  position: relative;
  display: inline-block;
}

.char.correct {
  color: #4CAF50;
}

.char.incorrect {
  color: #F44336;
  text-decoration: underline;
}

.char.active {
  background-color: rgba(106, 90, 224, 0.3);
  border-radius: 3px;
}

.input-container {
  margin-bottom: 20px;
}

.typing-input {
  width: 100%;
  padding: 15px;
  background: rgba(40, 40, 80, 0.5);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  color: #fff;
  font-size: 1.1rem;
  transition: border-color 0.3s ease;
}

.typing-input:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(106, 90, 224, 0.2);
}

.typing-input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.game-controls {
  display: flex;
  justify-content: center;
  gap: 15px;
}

/* Sonuç Ekranı */
.result-content {
  text-align: center;
  padding: 20px 0;
}

.result-content h2 {
  color: var(--accent-color);
  font-size: 1.8rem;
  margin-bottom: 25px;
}

.result-summary {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-bottom: 30px;
}

.result-item {
  background: rgba(30, 30, 60, 0.5);
  border-radius: 12px;
  padding: 20px;
  min-width: 150px;
}

.result-item.primary {
  border: 1px solid rgba(106, 90, 224, 0.3);
}

.result-value {
  font-size: 2.2rem;
  font-weight: 700;
  color: var(--accent-color);
  margin-bottom: 5px;
}

.result-label {
  font-size: 1rem;
  color: rgba(255, 255, 255, 0.8);
}

.result-details {
  background: rgba(30, 30, 60, 0.5);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 30px;
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.95rem;
}

.detail-value {
  font-weight: 600;
  color: #fff;
  font-size: 0.95rem;
}

.result-actions {
  display: flex;
  justify-content: center;
  gap: 15px;
}

/* Buton Stili */
.typing-btn {
  padding: 12px 25px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.primary-btn {
  background: linear-gradient(135deg, #6a5ae0, #9277FF);
  color: white;
}

.primary-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 7px 15px rgba(106, 90, 224, 0.3);
}

.secondary-btn {
  background: rgba(40, 40, 80, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: white;
}

.secondary-btn:hover {
  background: rgba(50, 50, 100, 0.7);
  transform: translateY(-2px);
}

/* Mobil Cihaz Yanıtlaması */
@media (max-width: 768px) {
  .typing-game-header h1 {
    font-size: 1.8rem;
  }

  .typing-wrapper {
    padding: 15px;
  }

  .text-display {
    font-size: 1rem;
    padding: 15px;
    min-height: 120px;
  }

  .typing-input {
    padding: 12px;
    font-size: 1rem;
  }

  .typing-btn {
    padding: 10px 20px;
    font-size: 0.95rem;
  }

  .result-summary {
    flex-direction: column;
    gap: 15px;
  }

  .result-item {
    min-width: auto;
    width: 100%;
  }

  .game-controls, .result-actions {
    flex-direction: column;
  }

  .stats-squares {
      flex-direction: row;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .stats-squares.compact {
      gap: 6px;
    }

    .stats-square {
      padding: 8px 10px;
      width: 90px;
    }
    
    .stats-squares.compact .stats-square {
      width: 70px;
      height: 70px;
      padding: 6px;
    }

    .stats-square .stat-label {
      font-size: 0.7rem;
    }

    .stats-square .stat-value {
      font-size: 1.2rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elementleri
  const introScreen = document.getElementById('intro-screen');
  const gameScreen = document.getElementById('game-screen');
  const resultScreen = document.getElementById('result-screen');

  const startBtn = document.getElementById('start-btn');
  const restartBtn = document.getElementById('restart-btn');
  const tryAgainBtn = document.getElementById('try-again-btn');

  const timeOptions = document.querySelectorAll('.time-option');
  const difficultyOptions = document.querySelectorAll('.difficulty-option');

  const textDisplay = document.getElementById('text-display');
  const typingInput = document.getElementById('typing-input');

  const timerElement = document.getElementById('timer');
  const wpmElement = document.getElementById('wpm');
  const accuracyElement = document.getElementById('accuracy');
  const errorCountElement = document.getElementById('error-count'); // Added error count element

  const resultWpm = document.getElementById('result-wpm');
  const resultAccuracy = document.getElementById('result-accuracy');
  const resultChars = document.getElementById('result-chars');
  const resultCorrect = document.getElementById('result-correct');
  const resultErrors = document.getElementById('result-errors');
  const resultTime = document.getElementById('result-time');

  // Metin Korpusu - Zorluk Seviyelerine Göre
  const textCorpus = {
    easy: [
      "Güneşli bir günde parkta yürüyüş yapmak huzur vericidir. Temiz hava ve doğa sesleri insanı dinlendirir.",
      "Kitap okumak en güzel hobilerden biridir. Her kitap, farklı dünyalara yolculuk yapmamızı sağlar.",
      "Düzenli spor yapmak sağlığımız için çok önemlidir. Günde en az yarım saat yürüyüş yapmak bile faydalıdır."
    ],
    medium: [
      "İnternet ve sosyal medya günümüzde iletişim kurmanın en hızlı yollarından biridir. Ancak yüz yüze iletişimin yerini asla tutamaz. İnsanlar arasındaki duygusal bağları güçlendirmek için gerçek sohbetler her zaman önemlidir.",
      "Çevre kirliliği dünyamızın en önemli sorunlarından biridir. Plastik atıklar, özellikle denizlerde büyük tahribata yol açmaktadır. Geri dönüşüm yaparak ve tek kullanımlık plastiklerden kaçınarak çevremizi koruyabiliriz.",
      "Sağlıklı beslenme ve düzenli egzersiz, uzun ve kaliteli bir yaşam için vazgeçilmezdir. Dengeli bir diyet ve haftada en az üç gün orta şiddetli egzersiz yapmak, birçok hastalığın önlenmesine yardımcı olabilir."
    ],
    hard: [
      "Yapay zekâ teknolojilerindeki hızlı gelişmeler, günlük yaşantımızdan iş dünyasına kadar birçok alanı etkilemektedir. Makine öğrenimi algoritmaları, büyük veri analizi ve doğal dil işleme gibi teknikler sayesinde, bilgisayarlar insana özgü kabul edilen birçok görevi başarıyla yerine getirebilmektedir. Bu gelişmelerin etik ve sosyal sonuçları ise kapsamlı bir şekilde tartışılmaktadır.",
      "Küresel iklim değişikliği, 21. yüzyılın en büyük çevre sorunlarından biri olarak kabul edilmektedir. Artan sıcaklıklar, yükselen deniz seviyeleri ve aşırı hava olayları, dünya genelinde ekosistemleri ve insan topluluklarını tehdit etmektedir. Karbon emisyonlarını azaltmak ve yenilenebilir enerji kaynaklarına yönelmek, bu soruna karşı alınabilecek en önemli önlemler arasındadır.",
      "Modern toplumda bilgi ve iletişim teknolojileri, bireylerin günlük yaşamlarını ve sosyal etkileşimlerini kökten değiştirmiştir. Akıllı telefonlar, sosyal medya platformları ve anlık mesajlaşma uygulamaları, iletişim kurma biçimlerimizi dönüştürürken, sürekli bağlantıda olma hali ve dijital yorgunluk gibi yeni kavramları da beraberinde getirmiştir."
    ]
  };

  // Test Ayarları
  let timeLimit = 60; // varsayılan süre
  let difficulty = 'medium'; // varsayılan zorluk

  // Test Durumu
  let timer;
  let timeLeft;
  let isTestActive = false;
  let currentText = '';
  let currentCharIndex = 0;
  let totalTyped = 0;
  let correctTyped = 0;
  let errorCount = 0;
  let startTime;

  // Süre seçenekleri
  timeOptions.forEach(option => {
    option.addEventListener('click', () => {
      timeOptions.forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      timeLimit = parseInt(option.getAttribute('data-time'));
    });
  });

  // Zorluk seçenekleri
  difficultyOptions.forEach(option => {
    option.addEventListener('click', () => {
      difficultyOptions.forEach(opt => opt.classList.remove('active'));
      option.classList.add('active');
      difficulty = option.getAttribute('data-difficulty');
    });
  });

  // Testi başlat
  startBtn.addEventListener('click', () => {
    showScreen(gameScreen);
    initTest();
  });

  // Testi yeniden başlat
  restartBtn.addEventListener('click', () => {
    initTest();
  });

  // Tekrar dene
  tryAgainBtn.addEventListener('click', () => {
    showScreen(introScreen);
  });

  // Test başlatma
  function initTest() {
    // Durumu sıfırla
    resetTest();

    // Zorluk seviyesine göre rastgele metin seç
    const randomIndex = Math.floor(Math.random() * textCorpus[difficulty].length);
    currentText = textCorpus[difficulty][randomIndex];

    // Metni karakterlere ayrıştır ve ekranda göster
    textDisplay.innerHTML = '';
    currentText.split('').forEach(char => {
      const charSpan = document.createElement('span');
      charSpan.textContent = char;
      charSpan.className = 'char';
      textDisplay.appendChild(charSpan);
    });

    // İlk karakteri aktif olarak işaretle
    const firstChar = textDisplay.querySelector('.char');
    if (firstChar) {
      firstChar.classList.add('active');
    }

    // Timer'ı ayarla
    timeLeft = timeLimit;
    timerElement.textContent = timeLeft;
    errorCountElement.textContent = 0; // Initialize error count

    // Girdi alanını temizle ve odakla
    typingInput.value = '';
    typingInput.focus();

    // Başlangıç zamanını kaydet
    startTime = new Date().getTime();
  }

  // Test durumunu sıfırla
  function resetTest() {
    clearInterval(timer);
    isTestActive = false;
    currentCharIndex = 0;
    totalTyped = 0;
    correctTyped = 0;
    errorCount = 0;
    wpmElement.textContent = '0';
    accuracyElement.textContent = '100%';
    errorCountElement.textContent = '0'; // Reset error count
  }

  // Ekran gösterme
  function showScreen(screen) {
    introScreen.classList.remove('active');
    gameScreen.classList.remove('active');
    resultScreen.classList.remove('active');

    screen.classList.add('active');
  }

  // Zamanlayıcıyı başlat
  function startTimer() {
    if (!isTestActive) {
      isTestActive = true;
      timer = setInterval(() => {
        if (timeLeft > 0) {
          timeLeft--;
          timerElement.textContent = timeLeft;

          // Son 10 saniye uyarısı
          if (timeLeft <= 10) {
            timerElement.style.color = '#ff4757';
          }
        } else {
          endTest();
        }
      }, 1000);
    }
  }

  // İstatistikleri güncelle
  function updateStats() {
    // Geçen süre (dakika)
    const elapsedTime = (timeLimit - timeLeft) / 60;

    // WPM hesapla (1 kelime = 5 karakter)
    if (elapsedTime > 0) {
      const wpm = Math.round((correctTyped / 5) / elapsedTime);
      wpmElement.textContent = wpm;
    }

    // Doğruluk oranı
    if (totalTyped > 0) {
      const accuracy = Math.floor((correctTyped / totalTyped) * 100);
      accuracyElement.textContent = `${accuracy}%`;
    }
    errorCountElement.textContent = errorCount; // Update error count
  }

  // Testi bitir
  function endTest() {
    clearInterval(timer);
    isTestActive = false;

    // Sonuçları hesapla
    const elapsedTime = (timeLimit - timeLeft) / 60; // dakika
    const wpm = Math.round((correctTyped / 5) / elapsedTime);
    const accuracy = totalTyped > 0 ? Math.floor((correctTyped / totalTyped) * 100) : 100;

    // Sonuç ekranını güncelle
    resultWpm.textContent = wpm;
    resultAccuracy.textContent = `${accuracy}%`;
    resultChars.textContent = totalTyped;
    resultCorrect.textContent = correctTyped;
    resultErrors.textContent = errorCount;

    // Kullanılan süreyi biçimlendir
    const timeUsed = formatTime(timeLimit - timeLeft);
    resultTime.textContent = timeUsed;

    // Skoru kaydet
    saveScore(wpm);

    // Sonuç ekranını göster
    showScreen(resultScreen);
  }

  // Zamanı biçimlendir
  function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  // Skoru kaydet
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        game_type: 'typing_speed',
        score: score,
        difficulty: difficulty
      })
    })
    .then(response => response.json())
    .then(data => console.log('Score saved:', data))
    .catch(error => console.error('Error saving score:', error));
  }

  // Yazma işlemini dinle
  typingInput.addEventListener('input', () => {
    // İlk karakterde timer'ı başlat
    if (!isTestActive) {
      startTimer();
    }

    const typedChar = typingInput.value;
    typingInput.value = ''; // Her karakter girişinden sonra input'u temizle

    if (currentCharIndex < currentText.length) {
      totalTyped++;

      const chars = textDisplay.querySelectorAll('.char');
      const currentChar = chars[currentCharIndex];

      // Doğru karakteri yazıp yazmadığını kontrol et
      if (typedChar === currentText[currentCharIndex]) {
        currentChar.classList.add('correct');
        correctTyped++;
      } else {
        currentChar.classList.add('incorrect');
        errorCount++;
      }

      // Sonraki karaktere geç
      currentCharIndex++;

      // Aktif karakteri güncelle
      if (currentCharIndex < currentText.length) {
        chars.forEach(char => char.classList.remove('active'));
        chars[currentCharIndex].classList.add('active');
      } else {
        // Metnin sonuna ulaşıldı, yeni metin yükle
        initTest();
        return;
      }

      // İstatistikleri güncelle
      updateStats();
    }
  });

  // Kullanıcı input alanına odaklandığında focus efekti
  typingInput.addEventListener('focus', () => {
    typingInput.classList.add('focused');
  });

  typingInput.addEventListener('blur', () => {
    typingInput.classList.remove('focused');
  });

  // Metin alanına tıklandığında input alanına odaklan
  textDisplay.addEventListener('click', () => {
    typingInput.focus();
  });

  // Başlangıçta intro ekranını göster
  showScreen(introScreen);
});
</script>
{% endblock %}
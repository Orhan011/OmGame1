{% extends 'layout.html' %}

{% block title %}Renk Eşleştirme - ZekaPark{% endblock %}

{% block content %}
<div class="page-container">
  <div class="game-container">
    <div class="game-header">
      <h1>Renk Eşleştirme <span class="badge">Odaklanma Oyunu</span></h1>
      <p class="game-description">Kelimelerin anlamı ve rengi arasındaki uyumu kontrol ederek hızlı tepki verin.</p>
    </div>

    <div class="color-match-container">
      <div class="game-status">
        <div class="status-item">
          <div class="status-label">Skor</div>
          <div class="status-value" id="score">0</div>
        </div>
        <div class="status-item">
          <div class="status-label">En İyi</div>
          <div class="status-value" id="best-score">0</div>
        </div>
        <div class="status-item">
          <div class="status-label">Süre</div>
          <div class="status-value" id="timer">60</div>
        </div>
      </div>
      
      <div id="start-screen" class="game-screen">
        <h2>Renk Eşleştirme Oyununa Hoş Geldiniz!</h2>
        <p>Bu oyun zihninizi test etmek ve odaklanma yeteneğinizi geliştirmek için tasarlanmıştır.</p>
        
        <div class="instructions">
          <h3>Nasıl Oynanır?</h3>
          <ul>
            <li>Ekranda renkli kelimeler göreceksiniz.</li>
            <li>Kelimenin <strong>anlamı</strong> ile <strong>rengi</strong> eşleşiyor mu kontrol edin.</li>
            <li>Eşleşiyorsa <span class="key">DOĞRU</span> butonuna basın.</li>
            <li>Eşleşmiyorsa <span class="key">YANLIŞ</span> butonuna basın.</li>
            <li>Doğru cevaplar için puan kazanırsınız, yanlış cevaplar için puan kaybedersiniz.</li>
            <li>Süre dolmadan önce en yüksek skoru elde etmeye çalışın!</li>
          </ul>
        </div>
        
        <div class="difficulty-selector">
          <h3>Zorluk Seviyesi</h3>
          <div class="button-group">
            <button class="difficulty-btn active" data-speed="slow">Kolay</button>
            <button class="difficulty-btn" data-speed="medium">Orta</button>
            <button class="difficulty-btn" data-speed="fast">Zor</button>
          </div>
        </div>
        
        <button id="start-btn" class="btn btn-primary btn-lg">
          <i class="fas fa-play me-2"></i>Oyuna Başla
        </button>
      </div>
      
      <div id="game-screen" class="game-screen" style="display: none;">
        <div class="color-word-container">
          <div id="color-word" class="color-word">MAVİ</div>
        </div>
        
        <div class="game-controls">
          <button id="true-btn" class="answer-btn true-btn">
            <i class="fas fa-check me-2"></i>DOĞRU
          </button>
          <button id="false-btn" class="answer-btn false-btn">
            <i class="fas fa-times me-2"></i>YANLIŞ
          </button>
        </div>
        
        <div id="feedback" class="feedback"></div>
        
        <div class="timer-bar-container">
          <div id="timer-bar" class="timer-bar"></div>
        </div>
      </div>
      
      <div id="result-screen" class="game-screen" style="display: none;">
        <h2>Oyun Bitti!</h2>
        
        <div class="result-stats">
          <div class="result-stat">
            <div class="result-value" id="final-score">0</div>
            <div class="result-label">Toplam Puan</div>
          </div>
          <div class="result-stat">
            <div class="result-value" id="correct-answers">0</div>
            <div class="result-label">Doğru</div>
          </div>
          <div class="result-stat">
            <div class="result-value" id="wrong-answers">0</div>
            <div class="result-label">Yanlış</div>
          </div>
        </div>
        
        <div class="reaction-time">
          <div class="time-label">Ortalama Tepki Süresi:</div>
          <div class="time-value"><span id="avg-reaction-time">0</span> ms</div>
        </div>
        
        <div class="result-actions">
          <button id="play-again-btn" class="btn btn-primary btn-lg">
            <i class="fas fa-redo-alt me-2"></i>Tekrar Oyna
          </button>
          <a href="{{ url_for('all_games') }}" class="btn btn-outline-light btn-lg">
            <i class="fas fa-th-large me-2"></i>Tüm Oyunlar
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .color-match-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0 10px;
  }

  .game-status {
    display: flex;
    justify-content: space-between;
    background: rgba(25, 25, 45, 0.7);
    border-radius: 10px;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .status-item {
    flex: 1;
    text-align: center;
    padding: 15px;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
  }

  .status-item:last-child {
    border-right: none;
  }

  .status-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 5px;
  }

  .status-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--accent-color);
  }

  .game-screen {
    background: rgba(25, 25, 45, 0.7);
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .game-screen h2 {
    color: var(--accent-color);
    font-size: 2rem;
    margin-bottom: 20px;
  }

  .game-screen p {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 25px;
    font-size: 1.1rem;
  }

  .instructions {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 25px;
    text-align: left;
  }

  .instructions h3 {
    color: white;
    font-size: 1.3rem;
    margin-bottom: 15px;
    text-align: center;
  }

  .instructions ul {
    list-style-type: disc;
    padding-left: 20px;
    margin: 0;
  }

  .instructions li {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 10px;
    font-size: 1rem;
    line-height: 1.5;
  }

  .key {
    display: inline-block;
    background: rgba(106, 90, 224, 0.3);
    border: 1px solid rgba(106, 90, 224, 0.5);
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
    color: white;
  }

  .difficulty-selector {
    margin-bottom: 30px;
  }

  .difficulty-selector h3 {
    color: white;
    font-size: 1.2rem;
    margin-bottom: 10px;
  }

  .button-group {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .difficulty-btn {
    flex: 0 0 auto;
    padding: 10px 20px;
    background: rgba(30, 30, 60, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .difficulty-btn:hover {
    background: rgba(40, 40, 80, 0.5);
  }

  .difficulty-btn.active {
    background: var(--accent-color);
    border-color: var(--accent-color);
  }

  /* Game Screen */
  .color-word-container {
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 30px;
  }

  .color-word {
    font-size: 4rem;
    font-weight: 700;
    letter-spacing: 2px;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .game-controls {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
  }

  .answer-btn {
    padding: 15px 30px;
    border: none;
    border-radius: 8px;
    font-size: 1.2rem;
    font-weight: 700;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 150px;
  }

  .true-btn {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
  }

  .true-btn:hover {
    background: linear-gradient(135deg, #5CBD60, #3E8D42);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
  }

  .false-btn {
    background: linear-gradient(135deg, #F44336, #C62828);
    box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
  }

  .false-btn:hover {
    background: linear-gradient(135deg, #FF5346, #D63838);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
  }

  .answer-btn:active {
    transform: translateY(1px);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
  }

  .feedback {
    height: 30px;
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 20px;
    transition: all 0.3s ease;
  }

  .feedback.correct {
    color: #4CAF50;
  }

  .feedback.wrong {
    color: #F44336;
  }

  .timer-bar-container {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .timer-bar {
    height: 100%;
    background: var(--accent-color);
    width: 100%;
    border-radius: 4px;
    transition: width linear 0.1s;
  }

  /* Result Screen */
  .result-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 30px;
  }

  .result-stat {
    text-align: center;
  }

  .result-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent-color);
    margin-bottom: 5px;
  }

  .result-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
  }

  .reaction-time {
    background: rgba(30, 30, 60, 0.5);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .time-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1rem;
  }

  .time-value {
    color: var(--accent-color);
    font-size: 1.2rem;
    font-weight: 600;
  }

  .result-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 300px;
    margin: 0 auto;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .game-screen {
      padding: 20px;
    }

    .color-word {
      font-size: 3.5rem;
    }

    .game-controls {
      flex-direction: column;
      gap: 10px;
    }

    .answer-btn {
      width: 100%;
    }
  }

  @media (max-width: 480px) {
    .status-value {
      font-size: 1.5rem;
    }

    .game-screen h2 {
      font-size: 1.5rem;
    }

    .color-word {
      font-size: 3rem;
    }

    .instructions {
      padding: 15px;
    }

    .instructions li {
      font-size: 0.9rem;
    }

    .result-value {
      font-size: 2rem;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // DOM Elements
  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const resultScreen = document.getElementById('result-screen');
  
  const scoreDisplay = document.getElementById('score');
  const bestScoreDisplay = document.getElementById('best-score');
  const timerDisplay = document.getElementById('timer');
  const timerBar = document.getElementById('timer-bar');
  
  const colorWord = document.getElementById('color-word');
  const feedbackDisplay = document.getElementById('feedback');
  
  const startBtn = document.getElementById('start-btn');
  const trueBtn = document.getElementById('true-btn');
  const falseBtn = document.getElementById('false-btn');
  const playAgainBtn = document.getElementById('play-again-btn');
  
  const finalScoreDisplay = document.getElementById('final-score');
  const correctAnswersDisplay = document.getElementById('correct-answers');
  const wrongAnswersDisplay = document.getElementById('wrong-answers');
  const avgReactionTimeDisplay = document.getElementById('avg-reaction-time');
  
  const difficultyBtns = document.querySelectorAll('.difficulty-btn');
  
  // Game Configuration
  let colors = [
    { name: 'KIRMIZI', code: '#F44336' },
    { name: 'MAVİ', code: '#2196F3' },
    { name: 'YEŞİL', code: '#4CAF50' },
    { name: 'SARI', code: '#FFEB3B' },
    { name: 'MOR', code: '#9C27B0' },
    { name: 'TURUNCU', code: '#FF9800' }
  ];
  
  // Game State
  let score = 0;
  let bestScore = 0;
  let correctAnswers = 0;
  let wrongAnswers = 0;
  let gameTime = 60; // seconds
  let timeRemaining = gameTime;
  let timer = null;
  let currentAnswer = null;
  let gameRunning = false;
  let difficultySpeed = 'slow';
  let wordDisplayTime = 2000; // ms, will be adjusted based on difficulty
  let totalReactionTime = 0;
  let reactionTimeCount = 0;
  let currentWordStartTime = 0;
  
  // Check if there's a stored best score
  if (localStorage.getItem('colorMatchBestScore')) {
    bestScore = parseInt(localStorage.getItem('colorMatchBestScore'));
    bestScoreDisplay.textContent = bestScore;
  }
  
  // Sounds
  const correctSound = new Audio('/static/sounds/correct.mp3');
  const wrongSound = new Audio('/static/sounds/wrong.mp3');
  const gameOverSound = new Audio('/static/sounds/game-over.mp3');
  
  // Event Listeners
  startBtn.addEventListener('click', startGame);
  trueBtn.addEventListener('click', () => checkAnswer(true));
  falseBtn.addEventListener('click', () => checkAnswer(false));
  playAgainBtn.addEventListener('click', () => {
    showScreen(startScreen);
  });
  
  // Difficulty selector
  difficultyBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      difficultySpeed = this.getAttribute('data-speed');
      difficultyBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      // Set word display time based on difficulty
      if (difficultySpeed === 'slow') wordDisplayTime = 2000;
      else if (difficultySpeed === 'medium') wordDisplayTime = 1500;
      else if (difficultySpeed === 'fast') wordDisplayTime = 1000;
    });
  });
  
  // Functions
  function startGame() {
    // Reset game state
    score = 0;
    correctAnswers = 0;
    wrongAnswers = 0;
    timeRemaining = gameTime;
    totalReactionTime = 0;
    reactionTimeCount = 0;
    
    // Update displays
    scoreDisplay.textContent = score;
    timerDisplay.textContent = timeRemaining;
    timerBar.style.width = '100%';
    feedbackDisplay.textContent = '';
    feedbackDisplay.className = 'feedback';
    
    // Show game screen
    showScreen(gameScreen);
    
    // Start game
    gameRunning = true;
    displayNewWord();
    
    // Start timer
    timer = setInterval(updateTimer, 1000);
  }
  
  function displayNewWord() {
    if (!gameRunning) return;
    
    // Clear feedback
    feedbackDisplay.textContent = '';
    feedbackDisplay.className = 'feedback';
    
    // Select random color name and color code
    const colorNameIndex = Math.floor(Math.random() * colors.length);
    const colorCodeIndex = Math.floor(Math.random() * colors.length);
    
    const colorName = colors[colorNameIndex].name;
    const colorCode = colors[colorCodeIndex].code;
    
    // Set the word and color
    colorWord.textContent = colorName;
    colorWord.style.color = colorCode;
    
    // Determine if this is a match
    currentAnswer = (colorNameIndex === colorCodeIndex);
    
    // Record start time for reaction time calculation
    currentWordStartTime = Date.now();
  }
  
  function checkAnswer(userAnswer) {
    if (!gameRunning) return;
    
    // Calculate reaction time
    const reactionTime = Date.now() - currentWordStartTime;
    totalReactionTime += reactionTime;
    reactionTimeCount++;
    
    // Check if answer is correct
    const isCorrect = (userAnswer === currentAnswer);
    
    if (isCorrect) {
      // Correct answer
      score += 10;
      correctAnswers++;
      feedbackDisplay.textContent = 'Doğru!';
      feedbackDisplay.className = 'feedback correct';
      correctSound.play();
    } else {
      // Wrong answer
      score = Math.max(0, score - 5);
      wrongAnswers++;
      feedbackDisplay.textContent = 'Yanlış!';
      feedbackDisplay.className = 'feedback wrong';
      wrongSound.play();
    }
    
    // Update score display
    scoreDisplay.textContent = score;
    
    // Display next word after a short delay
    setTimeout(displayNewWord, 1000);
  }
  
  function updateTimer() {
    timeRemaining--;
    timerDisplay.textContent = timeRemaining;
    
    // Update timer bar
    const percentRemaining = (timeRemaining / gameTime) * 100;
    timerBar.style.width = `${percentRemaining}%`;
    
    // Change color when time is running out
    if (timeRemaining <= 10) {
      timerBar.style.backgroundColor = '#F44336';
    }
    
    // Check if time is up
    if (timeRemaining <= 0) {
      endGame();
    }
  }
  
  function endGame() {
    // Stop the timer
    clearInterval(timer);
    gameRunning = false;
    
    // Play game over sound
    gameOverSound.play();
    
    // Calculate average reaction time
    const avgReactionTime = reactionTimeCount > 0 ? Math.round(totalReactionTime / reactionTimeCount) : 0;
    
    // Update best score if needed
    if (score > bestScore) {
      bestScore = score;
      bestScoreDisplay.textContent = bestScore;
      localStorage.setItem('colorMatchBestScore', bestScore);
    }
    
    // Update result screen
    finalScoreDisplay.textContent = score;
    correctAnswersDisplay.textContent = correctAnswers;
    wrongAnswersDisplay.textContent = wrongAnswers;
    avgReactionTimeDisplay.textContent = avgReactionTime;
    
    // Save score to server
    saveScore(score);
    
    // Show result screen
    showScreen(resultScreen);
  }
  
  function showScreen(screen) {
    // Hide all screens
    startScreen.style.display = 'none';
    gameScreen.style.display = 'none';
    resultScreen.style.display = 'none';
    
    // Show the specified screen
    screen.style.display = 'block';
  }
  
  // Function to save score to the server
  function saveScore(score) {
    fetch('/api/save-score', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        game_type: 'color_match',
        score: score
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Score saved:', data);
    })
    .catch(error => {
      console.error('Error saving score:', error);
    });
  }
});
</script>
{% endblock %}

{% extends "layout.html" %}

{% block content %}
<div class="container">
  <div class="game-header text-center mb-4">
    <h1>Solitaire</h1>
    <p class="text-muted">Klondike türü klasik kart oyunu</p>
  </div>

  <div class="row">
    <div class="col-lg-10 mx-auto">
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="m-0">Oyun Tahtası</h5>
            <div>
              <span id="score-display" class="badge bg-warning me-2">
                <i class="fas fa-star me-1"></i>Skor: <span id="score">0</span>
              </span>
              <span id="moves-display" class="badge bg-info me-2">
                <i class="fas fa-hand-pointer me-1"></i>Hamle: <span id="moves">0</span>
              </span>
              <span id="timer-display" class="badge bg-light text-dark">
                <i class="fas fa-clock me-1"></i><span id="timer">00:00</span>
              </span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div id="solitaire-board" class="mb-3">
            <div class="board-top">
              <!-- Stok alanı -->
              <div class="stock-waste">
                <div id="stock" class="card-pile">
                  <!-- Kalan kartlar buraya -->
                </div>
                <div id="waste" class="card-pile">
                  <!-- Açılan kartlar buraya -->
                </div>
              </div>
              
              <!-- Foundation alanları (A'dan başlayarak kartların dizileceği yer) -->
              <div class="foundations">
                <div id="foundation-1" class="foundation-pile" data-suit="hearts">
                  <!-- Kalp A-K -->
                </div>
                <div id="foundation-2" class="foundation-pile" data-suit="diamonds">
                  <!-- Karo A-K -->
                </div>
                <div id="foundation-3" class="foundation-pile" data-suit="clubs">
                  <!-- Sinek A-K -->
                </div>
                <div id="foundation-4" class="foundation-pile" data-suit="spades">
                  <!-- Maça A-K -->
                </div>
              </div>
            </div>
            
            <div class="board-bottom">
              <!-- Tableaux (oyun kolonları) -->
              <div class="tableaux">
                <div id="tableau-1" class="tableau-pile" data-column="1">
                  <!-- Kolon 1 -->
                </div>
                <div id="tableau-2" class="tableau-pile" data-column="2">
                  <!-- Kolon 2 -->
                </div>
                <div id="tableau-3" class="tableau-pile" data-column="3">
                  <!-- Kolon 3 -->
                </div>
                <div id="tableau-4" class="tableau-pile" data-column="4">
                  <!-- Kolon 4 -->
                </div>
                <div id="tableau-5" class="tableau-pile" data-column="5">
                  <!-- Kolon 5 -->
                </div>
                <div id="tableau-6" class="tableau-pile" data-column="6">
                  <!-- Kolon 6 -->
                </div>
                <div id="tableau-7" class="tableau-pile" data-column="7">
                  <!-- Kolon 7 -->
                </div>
              </div>
            </div>
          </div>
          
          <div class="game-controls d-flex justify-content-center">
            <button id="new-game-btn" class="btn btn-primary me-2">Yeni Oyun</button>
            <button id="undo-btn" class="btn btn-warning me-2">Geri Al</button>
            <button id="hint-btn" class="btn btn-info me-2">İpucu</button>
            <button id="auto-complete-btn" class="btn btn-success">Otomatik Tamamla</button>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="m-0">Nasıl Oynanır?</h5>
        </div>
        <div class="card-body">
          <p>Solitaire (Klondike), tek kişilik popüler bir kart oyunudur. Amacınız, tüm kartları A'dan K'ya doğru sıralı olarak dört foundation alanına yerleştirmektir.</p>
          
          <h6 class="mt-3">Oyun Kuralları:</h6>
          <ul>
            <li>Foundation alanlarına kartlar A'dan başlayarak aynı takımda K'ya kadar dizilir (A, 2, 3, ..., J, Q, K).</li>
            <li>Tableau kolonlarına kartlar K'dan A'ya doğru sırayla ve alternatif renklerde (kırmızı-siyah) dizilir.</li>
            <li>Sol üstteki kapalı desteyi (stock) tıklayarak kartları açabilirsiniz.</li>
            <li>Açık kartı uygun foundation veya tableau alanına taşıyabilirsiniz.</li>
            <li>Tableau'da boş bir kolona sadece K yerleştirilebilir.</li>
            <li>Foundation'da boş bir alana sadece A yerleştirilebilir.</li>
          </ul>
          
          <h6 class="mt-3">Kontroller:</h6>
          <ul>
            <li><strong>Kartları Taşımak:</strong> Kartı sürükle ve bırak veya tıklayarak seç, sonra hedefi tıkla.</li>
            <li><strong>Çift Tıklama:</strong> Otomatik olarak uygun foundation'a taşır (mümkünse).</li>
            <li><strong>Yeni Oyun:</strong> Kartları yeniden karıştırır ve yeni bir oyun başlatır.</li>
            <li><strong>Geri Al:</strong> Son hamleyi geri alır.</li>
            <li><strong>İpucu:</strong> Olası bir hamleyi gösterir.</li>
            <li><strong>Otomatik Tamamla:</strong> Oyun çözülebilir durumdaysa tüm kartları otomatik olarak foundation'lara taşır.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Oyun Sonu Modalı -->
<div class="modal fade" id="game-over-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tebrikler!</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="fas fa-trophy fa-3x text-warning"></i>
        </div>
        <p>Solitaire oyununu başarıyla tamamladınız!</p>
        <div class="result-stats p-3 bg-light rounded">
          <div class="row text-center">
            <div class="col-4">
              <div class="stat-label">Süre</div>
              <div class="stat-value" id="result-time">00:00</div>
            </div>
            <div class="col-4">
              <div class="stat-label">Hamle</div>
              <div class="stat-value" id="result-moves">0</div>
            </div>
            <div class="col-4">
              <div class="stat-label">Skor</div>
              <div class="stat-value" id="result-score">0</div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        <button type="button" class="btn btn-primary" id="new-game-modal">Yeni Oyun</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Solitaire tahtası */
  #solitaire-board {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    background-color: #076324;
    border-radius: 10px;
    padding: 20px;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
  }
  
  /* Üst ve alt alanlar */
  .board-top {
    display: flex;
    justify-content: space-between;
    margin-bottom: 40px;
  }
  
  .board-bottom {
    width: 100%;
  }
  
  /* Stock ve waste alanları */
  .stock-waste {
    display: flex;
    gap: 15px;
  }
  
  /* Foundation alanları */
  .foundations {
    display: flex;
    gap: 15px;
  }
  
  /* Tableau kolonları */
  .tableaux {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    width: 100%;
  }
  
  /* Kart yığını alanları */
  .card-pile, .foundation-pile, .tableau-pile {
    width: 100px;
    height: 140px;
    border-radius: 8px;
    border: 2px dashed rgba(255, 255, 255, 0.3);
    background-color: rgba(0, 0, 0, 0.1);
    position: relative;
  }
  
  .tableau-pile {
    height: 400px;
    flex: 1;
  }
  
  /* Kartlar */
  .card {
    width: 100px;
    height: 140px;
    border-radius: 8px;
    background-color: #fff;
    position: absolute;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    user-select: none;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    transform: translateY(-5px);
    z-index: 10;
  }
  
  .card.face-down {
    background-image: linear-gradient(135deg, #1e5799 0%, #2989d8 50%, #207cca 51%, #7db9e8 100%);
    background-size: 100% 100%;
  }
  
  .card.selected {
    box-shadow: 0 0 0 3px yellow, 0 5px 15px rgba(0, 0, 0, 0.3);
  }
  
  /* Tableau'daki her kart daha altta yer alır */
  .tableau-pile .card:nth-child(1) { top: 0; }
  .tableau-pile .card:nth-child(2) { top: 20px; }
  .tableau-pile .card:nth-child(3) { top: 40px; }
  .tableau-pile .card:nth-child(4) { top: 60px; }
  .tableau-pile .card:nth-child(5) { top: 80px; }
  .tableau-pile .card:nth-child(6) { top: 100px; }
  .tableau-pile .card:nth-child(7) { top: 120px; }
  .tableau-pile .card:nth-child(8) { top: 140px; }
  .tableau-pile .card:nth-child(9) { top: 160px; }
  .tableau-pile .card:nth-child(10) { top: 180px; }
  .tableau-pile .card:nth-child(11) { top: 200px; }
  .tableau-pile .card:nth-child(12) { top: 220px; }
  .tableau-pile .card:nth-child(13) { top: 240px; }
  
  /* Kart çeşitleri */
  .card[data-suit="hearts"], .card[data-suit="diamonds"] {
    color: #e60000;
  }
  
  .card[data-suit="clubs"], .card[data-suit="spades"] {
    color: #000;
  }
  
  /* Kart içeriği */
  .card-content {
    position: absolute;
    top: 5px;
    left: 5px;
    font-size: 1.2rem;
    font-weight: bold;
  }
  
  .card-content-bottom {
    position: absolute;
    bottom: 5px;
    right: 5px;
    font-size: 1.2rem;
    font-weight: bold;
    transform: rotate(180deg);
  }
  
  .card-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
  }
  
  /* Waste kartları yığını */
  #waste .card {
    left: 0;
  }
  
  #waste .card:nth-child(1) { z-index: 1; }
  #waste .card:nth-child(2) { left: 15px; z-index: 2; }
  #waste .card:nth-child(3) { left: 30px; z-index: 3; }
  
  /* İstatistik stilleri */
  .stat-label {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
  }
  
  .stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #212529;
  }
  
  /* Mobil uyumlu stiller */
  @media (max-width: 991px) {
    .card-pile, .foundation-pile, .tableau-pile {
      width: 70px;
      height: 98px;
    }
    
    .card {
      width: 70px;
      height: 98px;
    }
    
    .tableau-pile {
      height: 300px;
    }
    
    .card-content, .card-content-bottom {
      font-size: 1rem;
    }
    
    .card-center {
      font-size: 1.5rem;
    }
  }
  
  @media (max-width: 576px) {
    #solitaire-board {
      padding: 10px;
    }
    
    .board-top {
      flex-direction: column;
      gap: 20px;
    }
    
    .stock-waste, .foundations {
      width: 100%;
      justify-content: space-between;
    }
    
    .card-pile, .foundation-pile {
      width: 60px;
      height: 84px;
    }
    
    .tableau-pile {
      width: 60px;
      height: 250px;
    }
    
    .card {
      width: 60px;
      height: 84px;
    }
    
    .card-content, .card-content-bottom {
      font-size: 0.8rem;
    }
    
    .card-center {
      font-size: 1.2rem;
    }
    
    .game-controls {
      flex-wrap: wrap;
    }
    
    .game-controls .btn {
      margin-bottom: 10px;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // DOM elementleri
    const solitaireBoard = document.getElementById('solitaire-board');
    const stockPile = document.getElementById('stock');
    const wastePile = document.getElementById('waste');
    const foundationPiles = document.querySelectorAll('.foundation-pile');
    const tableauPiles = document.querySelectorAll('.tableau-pile');
    
    const scoreDisplay = document.getElementById('score');
    const movesDisplay = document.getElementById('moves');
    const timerDisplay = document.getElementById('timer');
    
    const newGameBtn = document.getElementById('new-game-btn');
    const undoBtn = document.getElementById('undo-btn');
    const hintBtn = document.getElementById('hint-btn');
    const autoCompleteBtn = document.getElementById('auto-complete-btn');
    
    const gameOverModal = new bootstrap.Modal(document.getElementById('game-over-modal'));
    const resultTime = document.getElementById('result-time');
    const resultMoves = document.getElementById('result-moves');
    const resultScore = document.getElementById('result-score');
    const newGameModalBtn = document.getElementById('new-game-modal');
    
    // Oyun durumu
    let gameState = {
      deck: [],
      stock: [],
      waste: [],
      foundations: [[], [], [], []],
      tableaus: [[], [], [], [], [], [], []],
      selectedCard: null,
      selectedSource: null,
      moves: 0,
      score: 0,
      timer: 0,
      timerInterval: null,
      history: [],
      isGameOver: false
    };
    
    // Kart değerleri ve takımları
    const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
    const suits = ['hearts', 'diamonds', 'clubs', 'spades'];
    const suitSymbols = {
      hearts: '♥',
      diamonds: '♦',
      clubs: '♣',
      spades: '♠'
    };
    
    // Yeni kart yığını oluştur
    function createDeck() {
      const deck = [];
      
      suits.forEach(suit => {
        values.forEach((value, index) => {
          deck.push({
            suit: suit,
            value: value,
            numericValue: index + 1,
            color: (suit === 'hearts' || suit === 'diamonds') ? 'red' : 'black',
            id: `${value}-${suit}`
          });
        });
      });
      
      return deck;
    }
    
    // Kart yığınını karıştır
    function shuffleDeck(deck) {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
      return deck;
    }
    
    // Kartları dağıt
    function dealCards() {
      // Tableau'lara kartları dağıt
      for (let i = 0; i < 7; i++) {
        for (let j = 0; j <= i; j++) {
          const card = gameState.deck.pop();
          card.faceUp = j === i;
          gameState.tableaus[i].push(card);
        }
      }
      
      // Kalan kartları stok piline yerleştir
      gameState.stock = gameState.deck.map(card => {
        card.faceUp = false;
        return card;
      });
      
      gameState.deck = [];
    }
    
    // Yeni oyun
    function newGame() {
      // Mevcut tahta ve oyun durumunu temizle
      clearBoard();
      
      // Oyun durumunu sıfırla
      gameState = {
        deck: createDeck(),
        stock: [],
        waste: [],
        foundations: [[], [], [], []],
        tableaus: [[], [], [], [], [], [], []],
        selectedCard: null,
        selectedSource: null,
        moves: 0,
        score: 0,
        timer: 0,
        timerInterval: null,
        history: [],
        isGameOver: false
      };
      
      // Kartları karıştır
      gameState.deck = shuffleDeck(gameState.deck);
      
      // Kartları dağıt
      dealCards();
      
      // Hamle ve skor sayaçlarını sıfırla
      updateCounters();
      
      // Zamanlayıcıyı başlat
      startTimer();
      
      // Tahtayı güncelle
      updateBoard();
    }
    
    // Tahtayı temizle
    function clearBoard() {
      stockPile.innerHTML = '';
      wastePile.innerHTML = '';
      
      foundationPiles.forEach(pile => {
        pile.innerHTML = '';
      });
      
      tableauPiles.forEach(pile => {
        pile.innerHTML = '';
      });
      
      // Zamanlayıcıyı durdur
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
      }
    }
    
    // Tahtayı güncelle
    function updateBoard() {
      // Stock pile
      updatePile(stockPile, gameState.stock);
      
      // Waste pile
      updatePile(wastePile, gameState.waste);
      
      // Foundation piles
      foundationPiles.forEach((pile, index) => {
        updatePile(pile, gameState.foundations[index]);
      });
      
      // Tableau piles
      tableauPiles.forEach((pile, index) => {
        updatePile(pile, gameState.tableaus[index]);
      });
    }
    
    // Kart yığınını güncelle
    function updatePile(pileElement, cards) {
      pileElement.innerHTML = '';
      
      cards.forEach((card, index) => {
        const cardElement = createCardElement(card);
        pileElement.appendChild(cardElement);
      });
    }
    
    // Kart elementi oluştur
    function createCardElement(card) {
      const cardElement = document.createElement('div');
      cardElement.className = 'card';
      cardElement.dataset.id = card.id;
      
      if (!card.faceUp) {
        cardElement.classList.add('face-down');
        cardElement.addEventListener('click', () => {
          // Kapalı kartı seç (sadece tableaus'ta en alttaki kart veya stock pilesda tıklanabilir)
          handleCardClick(cardElement);
        });
        return cardElement;
      }
      
      cardElement.dataset.suit = card.suit;
      cardElement.dataset.value = card.value;
      cardElement.dataset.numericValue = card.numericValue;
      
      // Kart içeriği
      const contentTop = document.createElement('div');
      contentTop.className = 'card-content';
      contentTop.innerHTML = `${card.value}${suitSymbols[card.suit]}`;
      
      const contentBottom = document.createElement('div');
      contentBottom.className = 'card-content-bottom';
      contentBottom.innerHTML = `${card.value}${suitSymbols[card.suit]}`;
      
      const contentCenter = document.createElement('div');
      contentCenter.className = 'card-center';
      contentCenter.innerHTML = suitSymbols[card.suit];
      
      cardElement.appendChild(contentTop);
      cardElement.appendChild(contentCenter);
      cardElement.appendChild(contentBottom);
      
      // Karta tıklama işleyicisi ekle
      cardElement.addEventListener('click', () => {
        handleCardClick(cardElement);
      });
      
      // Çift tıklama işleyicisi ekle
      cardElement.addEventListener('dblclick', () => {
        handleDoubleClick(cardElement);
      });
      
      return cardElement;
    }
    
    // Karta tıklandığında
    function handleCardClick(cardElement) {
      // Kart kapalıysa ve tableau'da en alttaki ise açabilir
      if (cardElement.classList.contains('face-down')) {
        // Önce hangi yığında olduğunu bul
        const tableauIndex = findTableauIndex(cardElement);
        
        if (tableauIndex !== -1) {
          const tableau = gameState.tableaus[tableauIndex];
          // Son kart ise çevir
          if (tableau[tableau.length - 1].id === cardElement.dataset.id) {
            flipCard(tableauIndex);
            return;
          }
        }
        
        // Stock pile ise kartı waste pile'a taşı
        if (cardElement.parentElement.id === 'stock') {
          drawFromStock();
          return;
        }
        
        return;
      }
      
      // Kart seçiliyse ve aynı karta tıklandıysa seçimi kaldır
      if (gameState.selectedCard && gameState.selectedCard.dataset.id === cardElement.dataset.id) {
        unselectCard();
        return;
      }
      
      // Önce hedef kontrolü - seçili kart varsa ve farklı bir karta tıklandıysa
      if (gameState.selectedCard) {
        const targetElement = cardElement.parentElement;
        
        // Hedef bir foundation ya da tableau alanı mı?
        if (targetElement.classList.contains('foundation-pile')) {
          const foundationIndex = Array.from(foundationPiles).indexOf(targetElement);
          moveToFoundation(foundationIndex);
        } else if (targetElement.classList.contains('tableau-pile')) {
          const tableauIndex = Array.from(tableauPiles).indexOf(targetElement);
          moveToTableau(tableauIndex);
        } else {
          unselectCard();
        }
        
        return;
      }
      
      // Yeni kart seçme
      selectCard(cardElement);
    }
    
    // Çift tıklamada otomatik foundation'a taşı
    function handleDoubleClick(cardElement) {
      // Kapalı kart ise işlem yapma
      if (cardElement.classList.contains('face-down')) {
        return;
      }
      
      // Kartı seç
      selectCard(cardElement);
      
      // Kart bir A ise ve boş foundation varsa oraya taşı
      if (cardElement.dataset.value === 'A') {
        for (let i = 0; i < foundationPiles.length; i++) {
          if (gameState.foundations[i].length === 0) {
            moveToFoundation(i);
            return;
          }
        }
      }
      
      // Diğer kartlar için uygun foundation bul
      const suit = cardElement.dataset.suit;
      const numericValue = parseInt(cardElement.dataset.numericValue);
      
      for (let i = 0; i < foundationPiles.length; i++) {
        const foundation = gameState.foundations[i];
        
        if (foundation.length > 0) {
          const topCard = foundation[foundation.length - 1];
          
          if (topCard.suit === suit && topCard.numericValue === numericValue - 1) {
            moveToFoundation(i);
            return;
          }
        }
      }
      
      // Uygun yer bulunamadıysa seçimi kaldır
      unselectCard();
    }
    
    // Kart seç
    function selectCard(cardElement) {
      // Önceki seçimi temizle
      unselectCard();
      
      // Yeni kartı seç
      gameState.selectedCard = cardElement;
      cardElement.classList.add('selected');
      
      // Kaynak yığını belirle
      gameState.selectedSource = findCardSource(cardElement);
    }
    
    // Kart seçimini kaldır
    function unselectCard() {
      if (gameState.selectedCard) {
        gameState.selectedCard.classList.remove('selected');
        gameState.selectedCard = null;
        gameState.selectedSource = null;
      }
    }
    
    // Kartın hangi yığında olduğunu bul
    function findCardSource(cardElement) {
      const cardId = cardElement.dataset.id;
      
      // Waste pile'da mı kontrol et
      const wasteIndex = gameState.waste.findIndex(card => card.id === cardId);
      if (wasteIndex !== -1) {
        return { type: 'waste', index: wasteIndex };
      }
      
      // Foundation'da mı kontrol et
      for (let i = 0; i < gameState.foundations.length; i++) {
        const foundationIndex = gameState.foundations[i].findIndex(card => card.id === cardId);
        if (foundationIndex !== -1) {
          return { type: 'foundation', pile: i, index: foundationIndex };
        }
      }
      
      // Tableau'da mı kontrol et
      for (let i = 0; i < gameState.tableaus.length; i++) {
        const tableauIndex = gameState.tableaus[i].findIndex(card => card.id === cardId);
        if (tableauIndex !== -1) {
          return { type: 'tableau', pile: i, index: tableauIndex };
        }
      }
      
      return null;
    }
    
    // Hangi tableau'da olduğunu bul
    function findTableauIndex(cardElement) {
      const tableauPilesList = Array.from(tableauPiles);
      let parent = cardElement.parentElement;
      
      return tableauPilesList.indexOf(parent);
    }
    
    // Stock'tan kart çek
    function drawFromStock() {
      // Tarih kaydet
      saveGameState();
      
      if (gameState.stock.length > 0) {
        // Stock'tan 1 kart al ve waste pile'a ekle
        const card = gameState.stock.pop();
        card.faceUp = true;
        gameState.waste.push(card);
        
        // Hareket sayısını artır
        incrementMoves();
        updateCounters();
        
        // Tahtayı güncelle
        updateBoard();
      } else if (gameState.waste.length > 0) {
        // Stock boşsa ve waste pile doluysa, waste pile'ı stock pile'a geri aktar
        gameState.stock = gameState.waste.map(card => {
          card.faceUp = false;
          return card;
        }).reverse();
        
        gameState.waste = [];
        
        // Hareket sayısını artır
        incrementMoves();
        updateCounters();
        
        // Tahtayı güncelle
        updateBoard();
      }
    }
    
    // Kapalı kartı çevir
    function flipCard(tableauIndex) {
      // Tarih kaydet
      saveGameState();
      
      const tableau = gameState.tableaus[tableauIndex];
      
      if (tableau.length > 0 && !tableau[tableau.length - 1].faceUp) {
        tableau[tableau.length - 1].faceUp = true;
        
        // Hareket sayısını artır
        incrementMoves();
        
        // Puan ekle
        gameState.score += 5;
        
        updateCounters();
        updateBoard();
      }
    }
    
    // Kart yığınını foundation'a taşı
    function moveToFoundation(foundationIndex) {
      // Seçili kart yoksa işlem yapma
      if (!gameState.selectedCard || !gameState.selectedSource) {
        return;
      }
      
      const cardElement = gameState.selectedCard;
      const source = gameState.selectedSource;
      const suit = cardElement.dataset.suit;
      const value = cardElement.dataset.value;
      const numericValue = parseInt(cardElement.dataset.numericValue);
      
      const foundation = gameState.foundations[foundationIndex];
      
      // Foundation kuralları kontrol et
      let isValidMove = false;
      
      if (foundation.length === 0) {
        // Boş foundation'a sadece A yerleştirilebilir
        isValidMove = value === 'A';
      } else {
        // Dolu foundation'da sıra ve takım kontrolü
        const topCard = foundation[foundation.length - 1];
        isValidMove = topCard.suit === suit && topCard.numericValue === numericValue - 1;
      }
      
      if (!isValidMove) {
        unselectCard();
        return;
      }
      
      // Tarih kaydet
      saveGameState();
      
      // Kartı kaynaktan çıkar
      let card;
      
      if (source.type === 'waste') {
        card = gameState.waste.pop();
      } else if (source.type === 'foundation') {
        card = gameState.foundations[source.pile].pop();
      } else if (source.type === 'tableau') {
        // Tableau'dan sadece tek kart taşınabilir
        if (source.index < gameState.tableaus[source.pile].length - 1) {
          unselectCard();
          return;
        }
        
        card = gameState.tableaus[source.pile].pop();
        
        // Temizlenen yerden sonraki kart kapalıysa aç
        if (gameState.tableaus[source.pile].length > 0 && !gameState.tableaus[source.pile][gameState.tableaus[source.pile].length - 1].faceUp) {
          gameState.tableaus[source.pile][gameState.tableaus[source.pile].length - 1].faceUp = true;
        }
      }
      
      // Kartı hedefe ekle
      gameState.foundations[foundationIndex].push(card);
      
      // Hareket sayısını artır
      incrementMoves();
      
      // Puan ekle
      gameState.score += 10;
      
      // Tahtayı güncelle
      updateCounters();
      updateBoard();
      unselectCard();
      
      // Oyun sonu kontrolü
      checkGameOver();
    }
    
    // Kartı tableau'ya taşı
    function moveToTableau(tableauIndex) {
      // Seçili kart yoksa işlem yapma
      if (!gameState.selectedCard || !gameState.selectedSource) {
        return;
      }
      
      const cardElement = gameState.selectedCard;
      const source = gameState.selectedSource;
      const color = (cardElement.dataset.suit === 'hearts' || cardElement.dataset.suit === 'diamonds') ? 'red' : 'black';
      const value = cardElement.dataset.value;
      const numericValue = parseInt(cardElement.dataset.numericValue);
      
      const tableau = gameState.tableaus[tableauIndex];
      
      // Tableau kuralları kontrol et
      let isValidMove = false;
      
      if (tableau.length === 0) {
        // Boş tableau'ya sadece K yerleştirilebilir
        isValidMove = value === 'K';
      } else {
        // Dolu tableau'da sıra ve renk kontrolü
        const topCard = tableau[tableau.length - 1];
        isValidMove = topCard.color !== color && topCard.numericValue === numericValue + 1;
      }
      
      if (!isValidMove) {
        unselectCard();
        return;
      }
      
      // Tarih kaydet
      saveGameState();
      
      // Kartı kaynaktan çıkar
      let cards = [];
      
      if (source.type === 'waste') {
        cards.push(gameState.waste.pop());
      } else if (source.type === 'foundation') {
        cards.push(gameState.foundations[source.pile].pop());
      } else if (source.type === 'tableau') {
        // Tableau'dan alt kartları da birlikte taşı
        cards = gameState.tableaus[source.pile].splice(source.index);
        
        // Temizlenen yerden sonraki kart kapalıysa aç
        if (gameState.tableaus[source.pile].length > 0 && !gameState.tableaus[source.pile][gameState.tableaus[source.pile].length - 1].faceUp) {
          gameState.tableaus[source.pile][gameState.tableaus[source.pile].length - 1].faceUp = true;
        }
      }
      
      // Kartları hedefe ekle
      gameState.tableaus[tableauIndex].push(...cards);
      
      // Hareket sayısını artır
      incrementMoves();
      
      // Puan ekle
      gameState.score += 5;
      
      // Tahtayı güncelle
      updateCounters();
      updateBoard();
      unselectCard();
    }
    
    // Hamle sayısını artır
    function incrementMoves() {
      gameState.moves++;
    }
    
    // Sayaçları güncelle
    function updateCounters() {
      scoreDisplay.textContent = gameState.score;
      movesDisplay.textContent = gameState.moves;
    }
    
    // Zamanlayıcıyı başlat
    function startTimer() {
      gameState.timer = 0;
      updateTimerDisplay();
      
      gameState.timerInterval = setInterval(() => {
        gameState.timer++;
        updateTimerDisplay();
      }, 1000);
    }
    
    // Zamanlayıcıyı güncelle
    function updateTimerDisplay() {
      const minutes = Math.floor(gameState.timer / 60);
      const seconds = gameState.timer % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Oyun durumunu kaydet
    function saveGameState() {
      const state = {
        stock: JSON.parse(JSON.stringify(gameState.stock)),
        waste: JSON.parse(JSON.stringify(gameState.waste)),
        foundations: JSON.parse(JSON.stringify(gameState.foundations)),
        tableaus: JSON.parse(JSON.stringify(gameState.tableaus)),
        moves: gameState.moves,
        score: gameState.score
      };
      
      gameState.history.push(state);
    }
    
    // Son hamleyi geri al
    function undoMove() {
      if (gameState.history.length === 0) {
        return;
      }
      
      // Seçili kartı kaldır
      unselectCard();
      
      // Son durumu al
      const lastState = gameState.history.pop();
      
      // Oyun durumunu güncelle
      gameState.stock = lastState.stock;
      gameState.waste = lastState.waste;
      gameState.foundations = lastState.foundations;
      gameState.tableaus = lastState.tableaus;
      gameState.moves = lastState.moves;
      gameState.score = lastState.score;
      
      // Tahtayı güncelle
      updateCounters();
      updateBoard();
    }
    
    // İpucu göster
    function showHint() {
      // TODO: İpucu algoritmasını geliştir
      alert('İpuçları geliştiriliyor...');
    }
    
    // Oyun bitişini kontrol et
    function checkGameOver() {
      // Tüm kartlar foundation'a taşındı mı?
      const allCardsMoved = gameState.foundations.every(foundation => foundation.length === 13);
      
      if (allCardsMoved) {
        // Oyun bitti
        gameState.isGameOver = true;
        
        // Zamanlayıcıyı durdur
        clearInterval(gameState.timerInterval);
        
        // Sonuç ekranını göster
        resultTime.textContent = timerDisplay.textContent;
        resultMoves.textContent = gameState.moves;
        resultScore.textContent = gameState.score;
        
        gameOverModal.show();
      }
    }
    
    // Event listeners
    newGameBtn.addEventListener('click', newGame);
    undoBtn.addEventListener('click', undoMove);
    hintBtn.addEventListener('click', showHint);
    autoCompleteBtn.addEventListener('click', () => {
      // TODO: Otomatik tamamlama algoritması
      alert('Otomatik tamamlama geliştiriliyor...');
    });
    newGameModalBtn.addEventListener('click', () => {
      gameOverModal.hide();
      newGame();
    });
    
    // Solitaire yığını oluştur ve oyunu başlat
    stockPile.addEventListener('click', () => {
      if (!gameState.isGameOver) {
        drawFromStock();
      }
    });
    
    // Boş foundation'a tıklama
    foundationPiles.forEach((pile, index) => {
      pile.addEventListener('click', () => {
        if (gameState.selectedCard && !gameState.isGameOver) {
          moveToFoundation(index);
        }
      });
    });
    
    // Boş tableau'ya tıklama
    tableauPiles.forEach((pile, index) => {
      pile.addEventListener('click', () => {
        if (gameState.selectedCard && !gameState.isGameOver) {
          moveToTableau(index);
        }
      });
    });
    
    // İlk oyunu başlat
    newGame();
  });
</script>
{% endblock %}